61bb48a7ac7965fcbd2911c25fb26bf1916dc7b2
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57704
==================================================
Violeta Georgieva
==================================================
Sat Mar 14 10:59:38 2015 +0000
==================================================
ApplicationContext.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57704
Access instanceManager via get/set methods.
Fix potential NPEs. In web app start if a problem occur prior to instanceManager initialization then:
- SCI.onStart will fail if it tries to use instanceManager
- During web app stop, StandardContext.listenerStop will fail if it tries to use instanceManager


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1666649 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardContext.java
index 97c2bfcbe0..4c8805f2d9 100644
--- a/java/org/apache/catalina/core/ApplicationContext.java
+++ b/java/org/apache/catalina/core/ApplicationContext.java
@@ -1248,16 +1248,18 @@ public class ApplicationContext
     public void addListener(String className) {
 
         try {
-            Object obj = context.getInstanceManager().newInstance(className);
+            if (context.getInstanceManager() != null) {
+                Object obj = context.getInstanceManager().newInstance(className);
 
-            if (!(obj instanceof EventListener)) {
-                throw new IllegalArgumentException(sm.getString(
-                        "applicationContext.addListener.iae.wrongType",
-                        className));
-            }
+                if (!(obj instanceof EventListener)) {
+                    throw new IllegalArgumentException(sm.getString(
+                            "applicationContext.addListener.iae.wrongType",
+                            className));
+                }
 
-            EventListener listener = (EventListener) obj;
-            addListener(listener);
+                EventListener listener = (EventListener) obj;
+                addListener(listener);
+            }
         } catch (IllegalAccessException e) {
             throw new IllegalArgumentException(sm.getString(
                     "applicationContext.addListener.iae.cnfe", className),

==================================================
