c1f1ce0ba0a1520191839ac4f34bf9cabb49c051
==================================================
Better @PathParam handling
==================================================
Mark Emlyn
==================================================
Sun Mar 24 18:34:24 2013 +0000
==================================================
PojoMessageHandlerPartialBase.java
index 6aa6252ed7..69cfc98b70 100644
--- a/java/org/apache/tomcat/websocket/pojo/LocalStrings.properties
+++ b/java/org/apache/tomcat/websocket/pojo/LocalStrings.properties
@@ -18,6 +18,7 @@ pojoEndpointBase.onCloseFail=Failed to call onClose method of POJO end point for
 pojoEndpointBase.onErrorFail=Failed to call onError method of POJO end point for POJO of type [{0}]
 pojoEndpointBase.onOpenFail=Failed to call onOpen method of POJO end point for POJO of type [{0}]
 pojoEndpointServer.getPojoInstanceFail=Failed to create instance of POJO of type [{0}]
+pojoMethodMapping.decodePathParamFail=Failed to decode path parameter value [{0}] to expected type [{1}]
 pojoMethodMapping.duplicateLastParam=Multiple boolean (last) parameters present on the method [{0}] of class [{1}] that was annotated with OnMessage
 pojoMethodMapping.duplicateMessageParam=Multiple message parameters present on the method [{0}] of class [{1}] that was annotated with OnMessage
 pojoMethodMapping.duplicatePongMessageParam=Multiple PongMessage parameters present on the method [{0}] of class [{1}] that was annotated with OnMessage
@@ -28,5 +29,4 @@ pojoMethodMapping.partialInputStream=Invalid InputStream and boolean parameters
 pojoMethodMapping.partialPong=Invalid PongMesssge and boolean parameters present on the method [{0}] of class [{1}] that was annotated with OnMessage
 pojoMethodMapping.partialReader=Invalid Reader and boolean parameters present on the method [{0}] of class [{1}] that was annotated with OnMessage
 pojoMethodMapping.pongWithPayload=Invalid PongMessgae and Message parameters present on the method [{0}] of class [{1}] that was annotated with OnMessage
-pojoMessageHandlerWhole.decodeFail=Failed to decode received message with first matching Decoder instance
 pojoMessageHandlerWhole.decodeIoFail=IO error while decoding message
\ No newline at end of file

==================================================
PojoMessageHandlerWholeBase.java
index d756f8f4ff..7a2b5d9cc8 100644
--- a/java/org/apache/tomcat/websocket/pojo/PojoMessageHandlerPartialBase.java
+++ b/java/org/apache/tomcat/websocket/pojo/PojoMessageHandlerPartialBase.java
@@ -20,9 +20,12 @@ import java.lang.reflect.InvocationTargetException;
 import java.lang.reflect.Method;
 import java.nio.ByteBuffer;
 
+import javax.websocket.DecodeException;
 import javax.websocket.MessageHandler;
 import javax.websocket.Session;
 
+import org.apache.tomcat.websocket.WsSession;
+
 /**
  * Common implementation code for the POJO partial message handlers. All
  * the real work is done in this class and in the superclass.
@@ -45,6 +48,12 @@ public abstract class PojoMessageHandlerPartialBase<T>
 
     @Override
     public final void onMessage(T message, boolean last) {
+        if (params != null && params.length == 1 &&
+                params[0] instanceof DecodeException) {
+            ((WsSession) session).getLocal().onError(session,
+                    (DecodeException) params[0]);
+            return;
+        }
         Object[] parameters = params.clone();
         if (indexBoolean != -1) {
             parameters[indexBoolean] = Boolean.valueOf(last);

==================================================
PojoMethodMapping.java
index 7229f22b23..4e6936381e 100644
--- a/java/org/apache/tomcat/websocket/pojo/PojoMessageHandlerWholeBase.java
+++ b/java/org/apache/tomcat/websocket/pojo/PojoMessageHandlerWholeBase.java
@@ -22,9 +22,7 @@ import java.lang.reflect.Method;
 import javax.websocket.DecodeException;
 import javax.websocket.MessageHandler;
 import javax.websocket.Session;
-import javax.websocket.SessionException;
 
-import org.apache.tomcat.util.res.StringManager;
 import org.apache.tomcat.websocket.WsSession;
 
 /**
@@ -36,9 +34,6 @@ import org.apache.tomcat.websocket.WsSession;
 public abstract class PojoMessageHandlerWholeBase<T>
         extends PojoMessageHandlerBase<T> implements MessageHandler.Whole<T> {
 
-    private static final StringManager sm =
-            StringManager.getManager(Constants.PACKAGE_NAME);
-
     public PojoMessageHandlerWholeBase(Object pojo, Method method,
             Session session, Object[] params, int indexPayload,
             boolean convert, int indexSession) {
@@ -50,14 +45,19 @@ public abstract class PojoMessageHandlerWholeBase<T>
     @Override
     public final void onMessage(T message) {
 
+        if (params != null && params.length == 1 &&
+                params[0] instanceof DecodeException) {
+            ((WsSession) session).getLocal().onError(session,
+                    (DecodeException) params[0]);
+            return;
+        }
+
         // Can this message be decoded?
         Object payload;
         try {
             payload = decode(message);
         } catch (DecodeException de) {
-            SessionException se = new SessionException(sm.getString(
-                    "pojoMessageHandlerWhole.decodeFail"), de, session);
-            ((WsSession) session).getLocal().onError(session, se);
+            ((WsSession) session).getLocal().onError(session, de);
             return;
         }
 

==================================================
