b891b869613ef8dd9248bbdfcaafb16597d666bf
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=59261
==================================================
Mark Thomas
==================================================
Thu Apr 7 16:19:55 2016 +0000
==================================================
ServletRequest.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=59261
ServletRequest.getAsyncContext() now throws an IllegalStateException as required by the Servlet specification if the request is not in asynchronous mode when called.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1738149 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CoyoteAdapter.java
index 20b186243d..1867d3dc08 100644
--- a/java/javax/servlet/ServletRequest.java
+++ b/java/javax/servlet/ServletRequest.java
@@ -481,9 +481,14 @@ public interface ServletRequest {
     public boolean isAsyncSupported();
 
     /**
-     * @return TODO
+     * Get the current AsyncContext.
+     *
+     * @return The current AsyncContext
+     *
      * @throws IllegalStateException if the request is not in asynchronous mode
-     * @since Servlet 3.0 TODO SERVLET3 - Add comments
+     *         (i.e. @link #isAsyncStarted() is {@code false})
+     *
+     * @since Servlet 3.0
      */
     public AsyncContext getAsyncContext();
 

==================================================
Request.java
index 9282e3ff9e..b0a2363b1d 100644
--- a/java/org/apache/catalina/connector/LocalStrings.properties
+++ b/java/org/apache/catalina/connector/LocalStrings.properties
@@ -71,6 +71,7 @@ outputBuffer.writeNull=The String argument to write(String,int,int) may not be n
 
 request.asyncNotSupported=A filter or servlet of the current chain does not support asynchronous operations.
 request.illegalWrap=The request wrapper must wrap the request obtained from getRequest()
+request.notAsync=It is illegal to call this method if the current request is not in asynchronous mode (i.e. isAsyncStarted() returns false)
 
 requestFacade.nullRequest=The request object has been recycled and is no longer associated with this facade
 

==================================================
ApplicationDispatcher.java
index 4fb071e100..bea4d1ca3e 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -412,7 +412,7 @@ public class Request implements HttpServletRequest {
     /**
      * AsyncContext
      */
-    protected volatile AsyncContextImpl asyncContext = null;
+    private volatile AsyncContextImpl asyncContext = null;
 
     protected Boolean asyncSupported = null;
 
@@ -1695,7 +1695,14 @@ public class Request implements HttpServletRequest {
 
     @Override
     public AsyncContext getAsyncContext() {
-        return this.asyncContext;
+        if (!isAsyncStarted()) {
+            throw new IllegalStateException(sm.getString("request.notAsync"));
+        }
+        return asyncContext;
+    }
+
+    public AsyncContextImpl getAsyncContextInternal() {
+        return asyncContext;
     }
 
     @Override

==================================================
StandardWrapperValve.java
index 1f679e5fc0..79ecf613a8 100644
--- a/java/org/apache/catalina/core/ApplicationDispatcher.java
+++ b/java/org/apache/catalina/core/ApplicationDispatcher.java
@@ -375,7 +375,7 @@ final class ApplicationDispatcher implements AsyncDispatcher, RequestDispatcher
             processRequest(request,response,state);
         }
 
-        if (request.getAsyncContext() != null) {
+        if (request.isAsyncStarted()) {
             // An async request was started during the forward, don't close the
             // response as it may be written to during the async handling
             return;

==================================================
