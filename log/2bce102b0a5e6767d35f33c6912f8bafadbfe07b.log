2bce102b0a5e6767d35f33c6912f8bafadbfe07b
==================================================
Improve handling of stack overflow errors when parsing SSI expressions.
==================================================
Mark Thomas
==================================================
Thu Aug 18 19:20:07 2022 +0100
==================================================
ExpressionParseTree.java
Improve handling of stack overflow errors when parsing SSI expressions.


==================================================
SSIStopProcessingException.java
index 0052d27c87..a6b7afc9e7 100644
--- a/java/org/apache/catalina/ssi/ExpressionParseTree.java
+++ b/java/org/apache/catalina/ssi/ExpressionParseTree.java
@@ -24,6 +24,7 @@ import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 import java.util.regex.PatternSyntaxException;
 
+import org.apache.tomcat.util.ExceptionUtils;
 import org.apache.tomcat.util.res.StringManager;
 /**
  * Represents a parsed expression.
@@ -68,10 +69,18 @@ public class ExpressionParseTree {
     /**
      * Evaluates the tree and returns true or false. The specified SSIMediator
      * is used to resolve variable references.
+     *
      * @return the evaluation result
+     *
+     * @throws SSIStopProcessingException If an error occurs evaluating the tree
      */
-    public boolean evaluateTree() {
-        return root.evaluate();
+    public boolean evaluateTree() throws SSIStopProcessingException {
+        try {
+            return root.evaluate();
+        } catch (Throwable t) {
+            ExceptionUtils.handleThrowable(t);
+            throw new SSIStopProcessingException(t);
+        }
     }
 
 

==================================================
