29fa038cff2fb67030f9afbb9d2832b1c5e4b26b
==================================================
Fix some TCK failures when using a security manager.
==================================================
Mark Emlyn
==================================================
Sat Nov 29 19:01:57 2008 +0000
==================================================
DefaultInstanceManager.java
Fix some TCK failures when using a security manager.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@721704 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SecurityClassLoad.java
index cc7a76fed9..254289f66f 100644
--- a/java/org/apache/catalina/core/DefaultInstanceManager.java
+++ b/java/org/apache/catalina/core/DefaultInstanceManager.java
@@ -205,14 +205,24 @@ public class DefaultInstanceManager implements InstanceManager {
      * @throws java.lang.reflect.InvocationTargetException
      *                                if call fails
      */
-    protected void preDestroy(Object instance, Class<?> clazz)
+    protected void preDestroy(Object instance, final Class<?> clazz)
             throws IllegalAccessException, InvocationTargetException {
         Class<?> superClass = clazz.getSuperclass();
         if (superClass != Object.class) {
             preDestroy(instance, superClass);
         }
 
-        Method[] methods = clazz.getDeclaredMethods();
+        Method[] methods;
+        if (Globals.IS_SECURITY_ENABLED) {
+            methods = AccessController.doPrivileged(
+                    new PrivilegedAction<Method[]>(){
+                public Method[] run(){
+                    return clazz.getDeclaredMethods();
+                }
+            });
+        } else {
+            methods = clazz.getDeclaredMethods();
+        }
         Method preDestroy = null;
         for (Method method : methods) {
             if (method.isAnnotationPresent(PreDestroy.class)) {

==================================================
JspApplicationContextImpl.java
index 23d45ca9c1..7cd230f5e0 100644
--- a/java/org/apache/catalina/security/SecurityClassLoad.java
+++ b/java/org/apache/catalina/security/SecurityClassLoad.java
@@ -62,6 +62,21 @@ public final class SecurityClassLoad {
         loader.loadClass
             (basePackage +
              "core.ContainerBase$PrivilegedAddChild");
+        loader.loadClass
+            (basePackage +
+             "core.DefaultInstanceManager$1");
+        loader.loadClass
+            (basePackage +
+             "core.DefaultInstanceManager$2");
+        loader.loadClass
+            (basePackage +
+             "core.DefaultInstanceManager$3");
+        loader.loadClass
+            (basePackage +
+             "core.DefaultInstanceManager$4");
+        loader.loadClass
+            (basePackage +
+             "core.DefaultInstanceManager$5");
         loader.loadClass
             (basePackage +
              "core.ApplicationHttpRequest$AttributeNamesEnumerator");

==================================================
