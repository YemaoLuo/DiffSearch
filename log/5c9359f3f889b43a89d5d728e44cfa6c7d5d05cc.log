5c9359f3f889b43a89d5d728e44cfa6c7d5d05cc
==================================================
Re-factoring
==================================================
Mark Emlyn
==================================================
Sat Nov 24 17:55:57 2012 +0000
==================================================
UpgradeAprServletInputStream.java
Re-factoring
- Make sure all read() methods work correctly when using non-blocking
- Pull up special handling of single byte read since it is required by
multiple protocols and by multiple overridden methods

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1413225 13f79535-47bb-0310-9956-ffa450edef68



==================================================
UpgradeBioServletInputStream.java
index b38816c7b5..6f2693ef83 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeAprServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeAprServletInputStream.java
@@ -65,7 +65,8 @@ public class UpgradeAprServletInputStream extends UpgradeServletInputStream {
 */
 
     @Override
-    protected int doRead(boolean block) throws IOException {
+    protected int doRead(boolean block, byte[] b, int off, int len)
+            throws IOException {
         // TODO Auto-generated method stub
         return 0;
     }

==================================================
UpgradeNioServletInputStream.java
index 021594becc..d3a9eba84d 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeBioServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeBioServletInputStream.java
@@ -32,8 +32,9 @@ public class UpgradeBioServletInputStream extends UpgradeServletInputStream {
     }
 
     @Override
-    protected int doRead(boolean block) throws IOException {
-        return inputStream.read();
+    protected int doRead(boolean block, byte[] b, int off, int len)
+            throws IOException {
+        return inputStream.read(b, off, len);
     }
 
     @Override

==================================================
UpgradeServletInputStream.java
index 8b8beb49fa..16c079c53b 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeNioServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeNioServletInputStream.java
@@ -37,19 +37,6 @@ public class UpgradeNioServletInputStream extends UpgradeServletInputStream {
         this.pool = pool;
     }
 
-    @Override
-    protected int doRead(boolean block) throws IOException {
-        byte[] bytes = new byte[1];
-        int result = readSocket(block, bytes, 0, 1);
-        if (result == 0) {
-            return NO_DATA;
-        } else if (result == -1) {
-            return EOF;
-        } else {
-            return bytes[0] & 0xFF;
-        }
-    }
-
     @Override
     protected boolean doIsReady() throws IOException {
         ByteBuffer readBuffer = channel.getBufHandler().getReadBuffer();
@@ -66,7 +53,8 @@ public class UpgradeNioServletInputStream extends UpgradeServletInputStream {
         return isReady;
     }
 
-    private int readSocket(boolean block, byte[] b, int off, int len)
+    @Override
+    protected int doRead(boolean block, byte[] b, int off, int len)
             throws IOException {
 
         ByteBuffer readBuffer = channel.getBufHandler().getReadBuffer();

==================================================
