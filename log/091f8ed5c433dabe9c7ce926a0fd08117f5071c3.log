091f8ed5c433dabe9c7ce926a0fd08117f5071c3
==================================================
use an InputSource in JspDocumentParser to provide a base URI for resolution
==================================================
Jeremy Boynes
==================================================
Tue Nov 26 06:30:07 2013 +0000
==================================================
JspDocumentParser.java
use an InputSource in JspDocumentParser to provide a base URI for resolution

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1545553 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JspUtil.java
index 869257af98..8ded835019 100644
--- a/java/org/apache/jasper/compiler/JspDocumentParser.java
+++ b/java/org/apache/jasper/compiler/JspDocumentParser.java
@@ -19,7 +19,6 @@ package org.apache.jasper.compiler;
 import java.io.CharArrayWriter;
 import java.io.FileNotFoundException;
 import java.io.IOException;
-import java.io.InputStream;
 import java.util.Collection;
 import java.util.Iterator;
 
@@ -171,27 +170,24 @@ class JspDocumentParser
 
             // Parse the input
             SAXParser saxParser = getSAXParser(validate, jspDocParser);
-            InputStream inStream = null;
+            InputSource source = JspUtil.getInputSource(path, jar, jspDocParser.ctxt);
             try {
-                inStream = JspUtil.getInputStream(path, jar, jspDocParser.ctxt);
-                saxParser.parse(new InputSource(inStream), jspDocParser);
+                saxParser.parse(source, jspDocParser);
             } catch (EnableDTDValidationException e) {
                 saxParser = getSAXParser(true, jspDocParser);
                 jspDocParser.isValidating = true;
-                if (inStream != null) {
-                    try {
-                        inStream.close();
-                    } catch (Exception any) {
-                    }
+                try {
+                    source.getByteStream().close();
+                } catch (IOException e2) {
+                    // ignore
                 }
-                inStream = JspUtil.getInputStream(path, jar, jspDocParser.ctxt);
-                saxParser.parse(new InputSource(inStream), jspDocParser);
+                source = JspUtil.getInputSource(path, jar, jspDocParser.ctxt);
+                saxParser.parse(source, jspDocParser);
             } finally {
-                if (inStream != null) {
-                    try {
-                        inStream.close();
-                    } catch (Exception any) {
-                    }
+                try {
+                    source.getByteStream().close();
+                } catch (IOException e) {
+                    // ignore
                 }
             }
 

==================================================
TestJspDocumentParser.java
index 066e90f997..4c3dd4e163 100644
--- a/java/org/apache/jasper/compiler/JspUtil.java
+++ b/java/org/apache/jasper/compiler/JspUtil.java
@@ -28,6 +28,7 @@ import org.apache.jasper.JasperException;
 import org.apache.jasper.JspCompilationContext;
 import org.apache.tomcat.util.scan.Jar;
 import org.xml.sax.Attributes;
+import org.xml.sax.InputSource;
 
 /**
  * This class has all the utility method(s). Ideally should move all the bean
@@ -664,6 +665,20 @@ public class JspUtil {
         return in;
     }
 
+    public static InputSource getInputSource(String fname, Jar jar, JspCompilationContext ctxt)
+        throws IOException {
+        InputSource source;
+        if (jar != null) {
+            String jarEntryName = fname.substring(1, fname.length());
+            source = new InputSource(jar.getInputStream(jarEntryName));
+            source.setSystemId(jar.getURL(jarEntryName));
+        } else {
+            source = new InputSource(ctxt.getResourceAsStream(fname));
+            source.setSystemId(ctxt.getResource(fname).toExternalForm());
+        }
+        return source;
+    }
+
     /**
      * Gets the fully-qualified class name of the tag handler corresponding to
      * the given tag file path.

==================================================
