ba6cd3f3976dcec8eb77f3a83f944bfbb6cd57e6
==================================================
Fix crash observed during pausing the connector when using APR.
==================================================
Rainer Jung
==================================================
Mon Jun 13 18:14:46 2011 +0000
==================================================
AjpAprProcessor.java
Fix crash observed during pausing the connector when using APR.

Only add socket to poller if we are sure we don't close it later.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1135208 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11AprProcessor.java
index 783d54a366..32270e8089 100644
--- a/java/org/apache/coyote/ajp/AjpAprProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpAprProcessor.java
@@ -319,13 +319,6 @@ public class AjpAprProcessor extends AbstractAjpProcessor {
             recycle();
         }
 
-        // Add the socket to the poller
-        if (!error && !endpoint.isPaused()) {
-            if (!isAsync()) {
-                ((AprEndpoint)endpoint).getPoller().add(socketRef);
-            }
-        }
-
         rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);
         
         if (error || endpoint.isPaused()) {
@@ -333,6 +326,8 @@ public class AjpAprProcessor extends AbstractAjpProcessor {
         } else if (isAsync()) {
             return SocketState.LONG;
         } else {
+            // Add the socket to the poller
+            ((AprEndpoint)endpoint).getPoller().add(socketRef);
             return SocketState.OPEN;
         }
     }

==================================================
