b26ad77f659de34d49dda5a248566a38383cec0e
==================================================
BZ 64265. Fix ETag comparison. Always use weak comparison.
==================================================
Mark Thomas
==================================================
Mon Mar 30 21:40:17 2020 +0100
==================================================
DefaultServlet.java
BZ 64265. Fix ETag comparison. Always use weak comparison.

https://bz.apache.org/bugzilla/show_bug.cgi?id=64265


==================================================
TestDefaultServletIfMatchRequests.java
index 396b91b31d..1cf343a6b4 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -2161,16 +2161,24 @@ public class DefaultServlet extends HttpServlet {
             throws IOException {
 
         String eTag = resource.getETag();
+        // Default servlet uses weak matching so we strip any leading "W/" and
+        // then compare using equals
+        if (eTag.startsWith("W/")) {
+            eTag = eTag.substring(2);
+        }
         String headerValue = request.getHeader("If-Match");
         if (headerValue != null) {
             if (headerValue.indexOf('*') == -1) {
 
-                StringTokenizer commaTokenizer = new StringTokenizer
-                    (headerValue, ",");
+                StringTokenizer commaTokenizer = new StringTokenizer(headerValue, ",");
                 boolean conditionSatisfied = false;
 
                 while (!conditionSatisfied && commaTokenizer.hasMoreTokens()) {
                     String currentToken = commaTokenizer.nextToken();
+                    currentToken = currentToken.trim();
+                    if (currentToken.startsWith("W/")) {
+                        currentToken = currentToken.substring(2);
+                    }
                     if (currentToken.trim().equals(eTag))
                         conditionSatisfied = true;
                 }

==================================================
