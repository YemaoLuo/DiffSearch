0fcfda8f062995ea9824fe915ead90d694b67856
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56461
==================================================
Sylvain Laurent
==================================================
Sun May 18 21:16:42 2014 +0000
==================================================
StandardContext.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56461
New option to make context startup fail if a load-on-startup servlet fails

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1595690 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardHost.java
index 4709366b41..f00b79bd28 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -810,6 +810,8 @@ public class StandardContext extends ContainerBase
 
     private String containerSciFilter;
 
+    private Boolean failCtxIfServletStartFails;
+
     protected static final ThreadBindingListener DEFAULT_NAMING_LISTENER = (new ThreadBindingListener() {
         @Override
         public void bind() {}
@@ -2627,8 +2629,32 @@ public class StandardContext extends ContainerBase
                 this.renewThreadsWhenStoppingContext);
     }
 
-    // -------------------------------------------------------- Context Methods
+    public Boolean getFailCtxIfServletStartFails() {
+        return failCtxIfServletStartFails;
+    }
+
+    public void setFailCtxIfServletStartFails(
+            Boolean failCtxIfServletStartFails) {
+        Boolean oldFailCtxIfServletStartFails = this.failCtxIfServletStartFails;
+        this.failCtxIfServletStartFails = failCtxIfServletStartFails;
+        support.firePropertyChange("failCtxIfServletStartFails",
+                oldFailCtxIfServletStartFails,
+                failCtxIfServletStartFails);
+    }
+
+    protected boolean getComputedFailCtxIfServletStartFails() {
+        if(failCtxIfServletStartFails != null) {
+            return failCtxIfServletStartFails.booleanValue();
+        }
+        //else look at Host config
+        if(getParent() instanceof StandardHost) {
+            return ((StandardHost)getParent()).isFailCtxIfServletStartFails();
+        }
+        //else
+        return false;
+    }
 
+    // -------------------------------------------------------- Context Methods
 
     /**
      * Add a new Listener class name to the set of Listeners
@@ -4897,7 +4923,7 @@ public class StandardContext extends ContainerBase
      * @param children Array of wrappers for all currently defined
      *  servlets (including those not declared load on startup)
      */
-    public void loadOnStartup(Container children[]) {
+    public boolean loadOnStartup(Container children[]) {
 
         // Collect "load on startup" servlets that need to be initialized
         TreeMap<Integer, ArrayList<Wrapper>> map = new TreeMap<>();
@@ -4925,10 +4951,14 @@ public class StandardContext extends ContainerBase
                                       getName()), StandardWrapper.getRootCause(e));
                     // NOTE: load errors (including a servlet that throws
                     // UnavailableException from tht init() method) are NOT
-                    // fatal to application startup
+                    // fatal to application startup, excepted if failDeploymentIfServletLoadedOnStartupFails is specified
+                    if(getComputedFailCtxIfServletStartFails()) {
+                        return false;
+                    }
                 }
             }
         }
+        return true;
 
     }
 
@@ -5201,7 +5231,10 @@ public class StandardContext extends ContainerBase
 
             // Load and initialize all "load on startup" servlets
             if (ok) {
-                loadOnStartup(findChildren());
+                if (!loadOnStartup(findChildren())){
+                    log.error("Error loadOnStartup");
+                    ok = false;
+                }
             }
 
             // Start ContainerBackgroundProcessor thread

==================================================
TestStandardContext.java
index 5b6b7466dd..c93220489f 100644
--- a/java/org/apache/catalina/core/StandardHost.java
+++ b/java/org/apache/catalina/core/StandardHost.java
@@ -182,6 +182,8 @@ public class StandardHost extends ContainerBase implements Host {
 
     private boolean undeployOldVersions = false;
 
+    private boolean failCtxIfServletStartFails = false;
+
 
     // ------------------------------------------------------------- Properties
 
@@ -648,6 +650,21 @@ public class StandardHost extends ContainerBase implements Host {
     }
 
 
+    public boolean isFailCtxIfServletStartFails() {
+        return failCtxIfServletStartFails;
+    }
+
+
+    public void setFailCtxIfServletStartFails(
+            boolean failCtxIfServletStartFails) {
+        boolean oldFailCtxIfServletStartFails = this.failCtxIfServletStartFails;
+        this.failCtxIfServletStartFails = failCtxIfServletStartFails;
+        support.firePropertyChange("failCtxIfServletStartFails",
+                oldFailCtxIfServletStartFails,
+                failCtxIfServletStartFails);
+    }
+
+
     // --------------------------------------------------------- Public Methods
 
 

==================================================
