4a466eb85a6b70d3c0aedd4520e2dc1fd746fdd5
==================================================
Implement support for running the tests when the build output directory has non-default value.
==================================================
Konstantin Kolinko
==================================================
Wed Apr 28 18:49:11 2010 +0000
==================================================
TestTomcat.java
index 80539f8357..2b7f455f51 100644
--- a/build.xml
+++ b/build.xml
@@ -73,6 +73,7 @@
   <property name="tomcat.release"        value="${tomcat.output}/release"/>
   <property name="tomcat.src.jars"       value="${tomcat.output}/src-jars"/>
   <property name="test.classes"          value="${tomcat.output}/testclasses"/>
+  <property name="test.temp"             value="${tomcat.output}/test-tmp"/>
 
   <!-- Servlet 3.0 spec requires 1.6+ -->
   <property name="compile.source" value="1.6"/>
@@ -915,6 +916,9 @@
     <junit printsummary="yes" fork="yes" dir="." showoutput="yes">
       <classpath refid="tomcat.test.classpath" />
 
+      <sysproperty key="tomcat.test.temp" value="${test.temp}" />
+      <sysproperty key="tomcat.test.tomcatbuild" value="${tomcat.build}" />
+
       <formatter type="plain" usefile="true" />
 
       <!-- If test.entry is defined, run a single test, otherwise run all valid tests -->

==================================================
TestTomcatSSL.java
index 612e08e906..12ef7ae178 100644
--- a/test/org/apache/catalina/startup/TestTomcat.java
+++ b/test/org/apache/catalina/startup/TestTomcat.java
@@ -185,8 +185,7 @@ public class TestTomcat extends TomcatBaseTest {
     public void testSingleWebapp() throws Exception {
         Tomcat tomcat = getTomcatInstance();
 
-        File appDir = 
-            new File("output/build/webapps/examples");
+        File appDir = new File(getBuildDirectory(), "webapps/examples");
         // app dir is relative to server home
         tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
         
@@ -200,8 +199,7 @@ public class TestTomcat extends TomcatBaseTest {
     public void testJsps() throws Exception {
         Tomcat tomcat = getTomcatInstance();
 
-        File appDir = 
-            new File("output/build/webapps/examples");
+        File appDir = new File(getBuildDirectory(), "webapps/examples");
         // app dir is relative to server home
         tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
         
@@ -296,7 +294,7 @@ public class TestTomcat extends TomcatBaseTest {
         
         String contextPath = "/examples";
         
-        File appDir = new File("output/build/webapps" + contextPath);
+        File appDir = new File(getBuildDirectory(), "webapps" + contextPath);
         // app dir is relative to server home
         org.apache.catalina.Context ctx =
             tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());

==================================================
TomcatBaseTest.java
index 637431eec3..9e17a3ca60 100644
--- a/test/org/apache/catalina/startup/TestTomcatSSL.java
+++ b/test/org/apache/catalina/startup/TestTomcatSSL.java
@@ -70,9 +70,11 @@ public class TestTomcatSSL extends TomcatBaseTest {
         tomcat.getConnector().setProperty("SSLEnabled", "true");
         tomcat.getConnector().setProperty("sslProtocol",
             "tls");
-        // test runs in output/tmp
-        tomcat.getConnector().setAttribute("keystoreFile", 
-            "../../test/org/apache/catalina/startup/test.keystore");
+
+        File keystoreFile = new File(
+                "test/org/apache/catalina/startup/test.keystore");
+        tomcat.getConnector().setAttribute("keystoreFile",
+                keystoreFile.getAbsolutePath());
     }
     
     public void testSimpleSsl() throws Exception {
@@ -98,8 +100,7 @@ public class TestTomcatSSL extends TomcatBaseTest {
         
         Tomcat tomcat = getTomcatInstance();
 
-        File appDir = 
-            new File("output/build/webapps/examples");
+        File appDir = new File(getBuildDirectory(), "webapps/examples");
         tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
         
         initSsl(tomcat, nio);
@@ -119,8 +120,7 @@ public class TestTomcatSSL extends TomcatBaseTest {
     public void renegotiateFail(boolean nio) throws Exception {
         Tomcat tomcat = getTomcatInstance();
 
-        File appDir = 
-            new File("output/build/webapps/examples");
+        File appDir = new File(getBuildDirectory(), "webapps/examples");
         // app dir is relative to server home
         tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
 
@@ -198,8 +198,7 @@ public class TestTomcatSSL extends TomcatBaseTest {
     public void renegotiateWorks(boolean nio) throws Exception {
         Tomcat tomcat = getTomcatInstance();
 
-        File appDir = 
-            new File("output/build/webapps/examples");
+        File appDir = new File(getBuildDirectory(), "webapps/examples");
         // app dir is relative to server home
         tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
 

==================================================
