496ea9096544f1ac2f073628eee591e93eafab53
==================================================
Correct regression caused by connector re-factoring that meant that sendfile data was not reset between pipe-lined HTTP requests.
==================================================
Mark Emlyn
==================================================
Wed Jul 6 15:05:45 2011 +0000
==================================================
AbstractHttp11Processor.java
Correct regression caused by connector re-factoring that meant that sendfile data was not reset between pipe-lined HTTP requests.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1143457 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11AprProcessor.java
index 78bfc74bf5..c1aa4b0e9a 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Processor.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Processor.java
@@ -776,6 +776,9 @@ public abstract class AbstractHttp11Processor extends AbstractProcessor {
         http09 = false;
         contentDelimitation = false;
         expectation = false;
+        
+        prepareRequestInternal();
+
         if (endpoint.isSSLEnabled()) {
             request.scheme().setString("https");
         }
@@ -970,6 +973,12 @@ public abstract class AbstractHttp11Processor extends AbstractProcessor {
     }
 
 
+    /**
+     * Connector implementation specific request preparation. Ideally, this will
+     * go away in the future.
+     */
+    protected abstract void prepareRequestInternal();
+    
     /**
      * When committing the response, we have to validate the set of headers, as
      * well as setup the response filters.

==================================================
Http11NioProcessor.java
index 0d4cb6b778..56f9ef3371 100644
--- a/java/org/apache/coyote/http11/Http11AprProcessor.java
+++ b/java/org/apache/coyote/http11/Http11AprProcessor.java
@@ -620,6 +620,11 @@ public class Http11AprProcessor extends AbstractHttp11Processor {
     // ------------------------------------------------------ Protected Methods
 
 
+    @Override
+    protected void prepareRequestInternal() {
+        sendfileData = null;
+    }
+
     @Override
     protected boolean prepareSendfile(OutputFilter[] outputFilters) {
         String fileName = (String) request.getAttribute(

==================================================
Http11Processor.java
index c277eab4ef..ecb041590b 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -675,6 +675,11 @@ public class Http11NioProcessor extends AbstractHttp11Processor {
     // ------------------------------------------------------ Protected Methods
 
 
+    @Override
+    protected void prepareRequestInternal() {
+        sendfileData = null;
+    }
+
     @Override
     protected boolean prepareSendfile(OutputFilter[] outputFilters) {
         String fileName = (String) request.getAttribute(

==================================================
