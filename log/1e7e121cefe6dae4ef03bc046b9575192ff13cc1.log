1e7e121cefe6dae4ef03bc046b9575192ff13cc1
==================================================
Fix dropped HTTP/2 responses.
==================================================
Mark Thomas
==================================================
Fri Dec 16 20:37:03 2022 +0000
==================================================
StreamProcessor.java
Fix dropped HTTP/2 responses.

When resetting an HTTP/2 stream because the final response has been
generated before the request has been fully read, use the HTTP/2 error
code NO_ERROR so that client does not discard the response.

Based on a suggestion by Lorenzo Dalla Vecchia.


==================================================
TestFlowControl.java
index 5572e070c9..3afda9037b 100644
--- a/java/org/apache/coyote/http2/StreamProcessor.java
+++ b/java/org/apache/coyote/http2/StreamProcessor.java
@@ -97,7 +97,7 @@ class StreamProcessor extends AbstractProcessor {
                             // send any more data on this stream (reset).
                             StreamException se = new StreamException(
                                     sm.getString("streamProcessor.cancel", stream.getConnectionId(),
-                                            stream.getIdAsString()), Http2Error.CANCEL, stream.getIdAsInt());
+                                            stream.getIdAsString()), Http2Error.NO_ERROR, stream.getIdAsInt());
                             stream.close(se);
                         } else if (!getErrorState().isConnectionIoAllowed()) {
                             ConnectionException ce = new ConnectionException(sm.getString(

==================================================
