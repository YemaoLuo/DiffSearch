a9aa71ec61aca7b5e750bde1042c1bbd5d10c7ac
==================================================
Ensure values are not duplicated when manipulating the vary header
==================================================
Mark Thomas
==================================================
Wed Dec 2 18:51:26 2020 +0000
==================================================
ResponseUtil.java
Ensure values are not duplicated when manipulating the vary header


==================================================
TestResponseUtil.java
index c0cee24d72..a39359e04a 100644
--- a/java/org/apache/tomcat/util/http/ResponseUtil.java
+++ b/java/org/apache/tomcat/util/http/ResponseUtil.java
@@ -21,9 +21,9 @@ import java.io.StringReader;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Enumeration;
-import java.util.HashSet;
+import java.util.Iterator;
+import java.util.LinkedHashSet;
 import java.util.List;
-import java.util.Set;
 
 import jakarta.servlet.http.HttpServletResponse;
 
@@ -76,7 +76,7 @@ public class ResponseUtil {
         // the existing values, check if the new value is already present and
         // then add it if not. The good news is field names are tokens which
         // makes parsing simpler.
-        Set<String> fieldNames = new HashSet<>();
+        LinkedHashSet<String> fieldNames = new LinkedHashSet<>();
 
         for (String varyHeader : varyHeaders) {
             StringReader input = new StringReader(varyHeader);
@@ -97,10 +97,12 @@ public class ResponseUtil {
         // Replace existing header(s) to ensure any invalid values are removed
         fieldNames.add(name);
         StringBuilder varyHeader = new StringBuilder();
-        varyHeader.append(name);
-        for (String fieldName : fieldNames) {
+        Iterator<String> iter = fieldNames.iterator();
+        // There must be at least one value as one is added just above
+        varyHeader.append(iter.next());
+        while (iter.hasNext()) {
             varyHeader.append(',');
-            varyHeader.append(fieldName);
+            varyHeader.append(iter.next());
         }
         adapter.setHeader(VARY_HEADER, varyHeader.toString());
     }

==================================================
