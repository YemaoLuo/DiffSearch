22c47be25fe7abd6f712b819e2f8416f873e07b1
==================================================
- Adjustments to error processing with Comet during the begin event (exceptions not causing error reports).
==================================================
Remy Maucherat
==================================================
Fri Mar 30 14:38:02 2007 +0000
==================================================
CoyoteAdapter.java
- Adjustments to error processing with Comet during the begin event (exceptions not causing error reports).
- Fix a probable bug when security was enabled (Comet would most likely not work).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@524103 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ApplicationFilterFactory.java
index 7054fc652f..810b7554bb 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -216,7 +216,7 @@ public class CoyoteAdapter
                 connector.getContainer().getPipeline().getFirst().invoke(request, response);
 
                 if (request.isComet()) {
-                    if (!response.isClosed()) {
+                    if (!response.isClosed() && !response.isError()) {
                         comet = true;
                         res.action(ActionCode.ACTION_COMET_BEGIN, null);
                     } else {

==================================================
StandardWrapperValve.java
index c3cdd4f555..212a173271 100644
--- a/java/org/apache/catalina/core/ApplicationFilterFactory.java
+++ b/java/org/apache/catalina/core/ApplicationFilterFactory.java
@@ -121,16 +121,21 @@ public final class ApplicationFilterFactory {
         
         // Create and initialize a filter chain object
         ApplicationFilterChain filterChain = null;
-        if (!Globals.IS_SECURITY_ENABLED && (request instanceof Request)) {
+        if (request instanceof Request) {
             Request req = (Request) request;
-            filterChain = (ApplicationFilterChain) req.getFilterChain();
-            if (filterChain == null) {
+            if (Globals.IS_SECURITY_ENABLED) {
+                // Security: Do not recycle
                 filterChain = new ApplicationFilterChain();
-                req.setFilterChain(filterChain);
+            } else {
+                filterChain = (ApplicationFilterChain) req.getFilterChain();
+                if (filterChain == null) {
+                    filterChain = new ApplicationFilterChain();
+                    req.setFilterChain(filterChain);
+                }
             }
             comet = req.isComet();
         } else {
-            // Security: Do not recycle
+            // Request dispatcher in use
             filterChain = new ApplicationFilterChain();
         }
 

==================================================
