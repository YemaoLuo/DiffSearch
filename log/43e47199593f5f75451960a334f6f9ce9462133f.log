43e47199593f5f75451960a334f6f9ce9462133f
==================================================
When AsyncContext.dispatch(...) is invoked do not cast request and response to HttpServletRequest/HttpServletResponse. AsyncContext.startAsync(ServletRequest,ServletResponse) can be invoked with custom ServletRequest/ServletResponse.
==================================================
Violeta Georgieva
==================================================
Wed Jun 26 05:00:22 2013 +0000
==================================================
AsyncContextImpl.java
When AsyncContext.dispatch(...) is invoked do not cast request and response to HttpServletRequest/HttpServletResponse. AsyncContext.startAsync(ServletRequest,ServletResponse) can be invoked with custom ServletRequest/ServletResponse.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1496732 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index 120745e256..cf3022d3a8 100644
--- a/java/org/apache/catalina/core/AsyncContextImpl.java
+++ b/java/org/apache/catalina/core/AsyncContextImpl.java
@@ -168,9 +168,17 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
     @Override
     public void dispatch() {
         check();
-        HttpServletRequest sr = (HttpServletRequest)getRequest();
-        String path = sr.getRequestURI();
-        String cpath = sr.getContextPath();
+        String path;
+        String cpath;
+        ServletRequest servletRequest = getRequest();
+        if (servletRequest instanceof HttpServletRequest) {
+            HttpServletRequest sr = (HttpServletRequest) servletRequest;
+            path = sr.getRequestURI();
+            cpath = sr.getContextPath();
+        } else {
+            path = request.getRequestURI();
+            cpath = request.getContextPath();
+        }
         if (cpath.length()>1) path = path.substring(cpath.length());
         dispatch(path);
     }
@@ -205,10 +213,8 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
         }
         final AsyncDispatcher applicationDispatcher =
                 (AsyncDispatcher) requestDispatcher;
-        final HttpServletRequest servletRequest =
-                (HttpServletRequest) getRequest();
-        final HttpServletResponse servletResponse =
-                (HttpServletResponse) getResponse();
+        final ServletRequest servletRequest = getRequest();
+        final ServletResponse servletResponse = getResponse();
         Runnable run = new Runnable() {
             @Override
             public void run() {

==================================================
