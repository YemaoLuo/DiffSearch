30d93b8a01ae4d31a24cb10c939014c05fda913e
==================================================
Switch B2CConverter to use Tomcat's Harmony based UTF-8 decoder
==================================================
Mark Emlyn
==================================================
Mon Mar 4 13:28:02 2013 +0000
==================================================
B2CConverter.java
Switch B2CConverter to use Tomcat's Harmony based UTF-8 decoder

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1452295 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestCoyoteAdapter.java
index 1441afc159..44b48288c2 100644
--- a/java/org/apache/tomcat/util/buf/B2CConverter.java
+++ b/java/org/apache/tomcat/util/buf/B2CConverter.java
@@ -117,7 +117,15 @@ public class B2CConverter {
         } else {
             action = CodingErrorAction.REPORT;
         }
-        decoder = getCharset(encoding).newDecoder();
+        Charset charset = getCharset(encoding);
+        // Special case. Use the Apache Harmony based UTF-8 decoder because it
+        // - a) rejects invalid sequences that the JVM decoder does not
+        // - b) fails faster for some invalid sequences
+        if (charset.equals(UTF_8)) {
+            decoder = new Utf8Decoder();
+        } else {
+            decoder = charset.newDecoder();
+        }
         decoder.onMalformedInput(action);
         decoder.onUnmappableCharacter(action);
     }

==================================================
