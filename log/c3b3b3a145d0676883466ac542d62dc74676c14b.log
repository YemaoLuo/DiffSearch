c3b3b3a145d0676883466ac542d62dc74676c14b
==================================================
Only register for write when using non-blocking and there is more data to write. This fixes various crashes in APR due to trying to add the same socket to the poller twice.
==================================================
Mark Emlyn
==================================================
Fri May 10 19:53:12 2013 +0000
==================================================
AbstractHttp11Processor.java
Only register for write when using non-blocking and there is more data to write. This fixes various crashes in APR due to trying to add the same socket to the poller twice.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1481165 13f79535-47bb-0310-9956-ffa450edef68



==================================================
InternalNioOutputBuffer.java
index 10ee31a82b..0cb805e155 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Processor.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Processor.java
@@ -1057,8 +1057,6 @@ public abstract class AbstractHttp11Processor<S> extends AbstractProcessor<S> {
 
         rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);
 
-        registerForWrite();
-
         if (error || endpoint.isPaused()) {
             return SocketState.CLOSED;
         } else if (isAsync() || comet) {
@@ -1612,7 +1610,6 @@ public abstract class AbstractHttp11Processor<S> extends AbstractProcessor<S> {
         if (error) {
             return SocketState.CLOSED;
         } else if (isAsync()) {
-            registerForWrite();
             return SocketState.LONG;
         } else {
             if (!keepAlive) {

==================================================
