c6a9bc2b54b2f04bf234774f36b472730bcdbe20
==================================================
When Context manager does not exist, 
==================================================
Keiichi Fujino
==================================================
Mon Oct 31 09:58:42 2011 +0000
==================================================
ClusterSessionListener.java
When Context manager does not exist, 
A no context manager message is replied in order to avoid timeout (default 60sec) of GET_ALL_SESSIONS sync phase. 

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1195384 13f79535-47bb-0310-9956-ffa450edef68



==================================================
DeltaManager.java
index 598f109790..f35c233b00 100644
--- a/java/org/apache/catalina/ha/session/ClusterSessionListener.java
+++ b/java/org/apache/catalina/ha/session/ClusterSessionListener.java
@@ -74,10 +74,22 @@ public class ClusterSessionListener extends ClusterListener {
                 }
             } else {
                 ClusterManager mgr = managers.get(ctxname);
-                if (mgr != null)
+                if (mgr != null) {
                     mgr.messageDataReceived(msg);
-                else if (log.isWarnEnabled())
-                    log.warn("Context manager doesn't exist:" + ctxname);
+                } else {
+                    if (log.isWarnEnabled())
+                        log.warn("Context manager doesn't exist:" + ctxname);
+
+                    // A no context manager message is replied in order to avoid 
+                    // timeout of GET_ALL_SESSIONS sync phase.  
+                    if (msg.getEventType() == SessionMessage.EVT_GET_ALL_SESSIONS) {
+                        SessionMessage replymsg = new SessionMessageImpl(ctxname,
+                                SessionMessage.EVT_ALL_SESSION_NOCONTEXTMANAGER, 
+                                null, "NO-CONTEXT-MANAGER","NO-CONTEXT-MANAGER-" + ctxname);
+                        cluster.send(replymsg, msg.getAddress());
+                    }
+                }
+                    
             }
         }
         return;

==================================================
SessionMessage.java
index c403999e5e..bb9b50264d 100644
--- a/java/org/apache/catalina/ha/session/LocalStrings.properties
+++ b/java/org/apache/catalina/ha/session/LocalStrings.properties
@@ -31,6 +31,7 @@ deltaManager.noCluster=Starting... no cluster associated with this context: [{0}
 deltaManager.noMasterMember=Starting... with no other member for context [{0}] at domain [{1}]
 deltaManager.noMembers=Manager [{0}]: skipping state transfer. No members active in cluster group.
 deltaManager.noSessionState=Manager [{0}]: No session state send at {1} received, timing out after {2} ms.
+deltaManager.noContextManager=Manager [{0}]: No context manager send at {1} received in {2} ms.
 deltaManager.sendMessage.newSession=Manager [{0}] send new session ({1})
 deltaManager.expireSessions=Manager [{0}] expiring sessions upon shutdown
 deltaManager.receiveMessage.accessed=Manager [{0}]: received session [{1}] accessed.
@@ -40,6 +41,7 @@ deltaManager.receiveMessage.error=Manager [{0}]: Unable to receive message throu
 deltaManager.receiveMessage.eventType=Manager [{0}]: Received SessionMessage of type=({1}) from [{2}]
 deltaManager.receiveMessage.expired=Manager [{0}]: received session [{1}] expired.
 deltaManager.receiveMessage.transfercomplete=Manager [{0}] received from node [{1}:{2}] session state transfered.
+deltaManager.receiveMessage.noContextManager=Manager [{0}] received from node [{1}:{2}] no context manager.
 deltaManager.receiveMessage.unloadingAfter=Manager [{0}]: unloading sessions complete
 deltaManager.receiveMessage.unloadingBegin=Manager [{0}]: start unloading sessions
 deltaManager.receiveMessage.allSessionDataAfter=Manager [{0}]: session state deserialized

==================================================
SessionMessageImpl.java
index 199772b03c..391cd1b1bb 100644
--- a/java/org/apache/catalina/ha/session/SessionMessage.java
+++ b/java/org/apache/catalina/ha/session/SessionMessage.java
@@ -33,6 +33,7 @@ import org.apache.catalina.ha.ClusterMessage;
  *   <li><pre>public static final int EVT_ALL_SESSION_DATA</pre><li>
  *   <li><pre>public static final int EVT_ALL_SESSION_TRANSFERCOMPLETE</pre><li>
  *   <li><pre>public static final int EVT_CHANGE_SESSION_ID</pre><li>
+ *   <li><pre>public static final int EVT_ALL_SESSION_NOCONTEXTMANAGER</pre><li>
  * </ul>
  *
  */
@@ -81,6 +82,11 @@ public interface SessionMessage extends ClusterMessage {
      */
     public static final int EVT_CHANGE_SESSION_ID = 15;
 
+    /**
+     * Event type used when context manager doesn't exist.
+     * This is used when the manager which send a session state does not exist. 
+     */
+    public static final int EVT_ALL_SESSION_NOCONTEXTMANAGER = 16;
 
     public String getContextName();
 

==================================================
