dafd07d0464d9b307b774995e520a746446879bc
==================================================
As per Remy's review comment, make sure we continue to reset the writer/stream flags before forwarding to a custom error page.
==================================================
Mark Emlyn
==================================================
Mon Nov 3 18:53:37 2008 +0000
==================================================
Response.java
As per Remy's review comment, make sure we continue to reset the writer/stream flags before forwarding to a custom error page.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@710125 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardHostValve.java
index fa42135290..e4cc50c783 100644
--- a/java/org/apache/catalina/connector/Response.java
+++ b/java/org/apache/catalina/connector/Response.java
@@ -670,16 +670,38 @@ public class Response
      *  been committed
      */
     public void resetBuffer() {
+        resetBuffer(false);
+    }
+
+    
+    /**
+     * Reset the data buffer and the using Writer/Stream flags but not any
+     * status or header information.
+     *
+     * @param resetWriterStreamFlags <code>true</code> if the internal
+     *        <code>usingWriter</code>, <code>usingOutputStream</code>,
+     *        <code>isCharacterEncodingSet</code> flags should also be reset
+     * 
+     * @exception IllegalStateException if the response has already
+     *  been committed
+     */
+    public void resetBuffer(boolean resetWriterStreamFlags) {
 
         if (isCommitted())
             throw new IllegalStateException
                 (sm.getString("coyoteResponse.resetBuffer.ise"));
 
         outputBuffer.reset();
+        
+        if(resetWriterStreamFlags) {
+            usingOutputStream = false;
+            usingWriter = false;
+            isCharacterEncodingSet = false;
+        }
 
     }
 
-
+    
     /**
      * Set the buffer size to be used for this Response.
      *

==================================================
