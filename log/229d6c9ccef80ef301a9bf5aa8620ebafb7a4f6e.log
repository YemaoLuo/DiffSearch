229d6c9ccef80ef301a9bf5aa8620ebafb7a4f6e
==================================================
Servlet 4.0
==================================================
Mark Thomas
==================================================
Fri Oct 16 06:33:09 2015 +0000
==================================================
ApplicationPushBuilder.java
Servlet 4.0
Use the correct character encoding (the one used for the original URI) to decode the push path.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1708910 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestApplicationPushBuilder.java
index 063812544b..63fa53aaa2 100644
--- a/java/org/apache/catalina/core/ApplicationPushBuilder.java
+++ b/java/org/apache/catalina/core/ApplicationPushBuilder.java
@@ -364,7 +364,8 @@ public class ApplicationPushBuilder implements PushBuilder {
 
         // Undecoded path - just %nn encoded
         pushTarget.requestURI().setString(pushPath);
-        pushTarget.decodedURI().setString(decode(pushPath, baseRequest.getCharacterEncoding()));
+        pushTarget.decodedURI().setString(decode(pushPath,
+                catalinaRequest.getConnector().getURIEncodingLower()));
 
         // Query string
         if (pushQueryString == null && queryString != null) {
@@ -398,7 +399,7 @@ public class ApplicationPushBuilder implements PushBuilder {
     }
 
 
-    // Package private so it can be tested
+    // Package private so it can be tested. charsetName must be in lower case.
     static String decode(String input, String charsetName) {
         int start = input.indexOf('%');
         int end = 0;
@@ -410,7 +411,7 @@ public class ApplicationPushBuilder implements PushBuilder {
 
         Charset charset;
         try {
-            charset = B2CConverter.getCharset(charsetName);
+            charset = B2CConverter.getCharsetLower(charsetName);
         } catch (UnsupportedEncodingException uee) {
             // Impossible since original request would have triggered an error
             // before reaching here

==================================================
