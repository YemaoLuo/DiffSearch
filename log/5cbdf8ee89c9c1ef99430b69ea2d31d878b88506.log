5cbdf8ee89c9c1ef99430b69ea2d31d878b88506
==================================================
minor optimizations
==================================================
Filip Hanik
==================================================
Thu May 17 15:43:49 2007 +0000
==================================================
ChannelData.java
minor optimizations


git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@538977 13f79535-47bb-0310-9956-ffa450edef68



==================================================
MemberImpl.java
index eff5d508b1..c8028d833a 100644
--- a/java/org/apache/catalina/tribes/io/ChannelData.java
+++ b/java/org/apache/catalina/tribes/io/ChannelData.java
@@ -229,11 +229,13 @@ public class ChannelData implements ChannelMessage {
         offset += 4; //uniqueId length
         System.arraycopy(xbuf.getBytesDirect(),offset,data.uniqueId,0,data.uniqueId.length);
         offset += data.uniqueId.length; //uniqueId data
-        byte[] addr = new byte[XByteBuffer.toInt(xbuf.getBytesDirect(),offset)];
+        //byte[] addr = new byte[XByteBuffer.toInt(xbuf.getBytesDirect(),offset)];
+        int addrlen = XByteBuffer.toInt(xbuf.getBytesDirect(),offset);
         offset += 4; //addr length
-        System.arraycopy(xbuf.getBytesDirect(),offset,addr,0,addr.length);
-        data.setAddress(MemberImpl.getMember(addr));
-        offset += addr.length; //addr data
+        //System.arraycopy(xbuf.getBytesDirect(),offset,addr,0,addr.length);
+        data.setAddress(MemberImpl.getMember(xbuf.getBytesDirect(),offset,addrlen));
+        //offset += addr.length; //addr data
+        offset += addrlen;
         int xsize = XByteBuffer.toInt(xbuf.getBytesDirect(),offset);
         offset += 4; //xsize length
         System.arraycopy(xbuf.getBytesDirect(),offset,xbuf.getBytesDirect(),0,xsize);

==================================================
NioReceiver.java
index fc40dad5ac..0e5479a67b 100644
--- a/java/org/apache/catalina/tribes/membership/MemberImpl.java
+++ b/java/org/apache/catalina/tribes/membership/MemberImpl.java
@@ -398,6 +398,10 @@ public class MemberImpl implements Member, java.io.Externalizable {
        return getMember(data,new MemberImpl());
     }
 
+    public static MemberImpl getMember(byte[] data, int offset, int length) {
+       return getMember(data,offset,length,new MemberImpl());
+    }
+
     /**
      * Return the name of this object
      * @return a unique name to the cluster

==================================================
TribesTestSuite.java
index 8abf4af1e9..a7ba368f9b 100644
--- a/java/org/apache/catalina/tribes/transport/nio/NioReceiver.java
+++ b/java/org/apache/catalina/tribes/transport/nio/NioReceiver.java
@@ -175,13 +175,14 @@ public class NioReceiver extends ReceiverBase implements Runnable, ChannelReceiv
         try { key.channel().close(); } catch (IOException e) { if (log.isDebugEnabled()) log.debug("", e); }
         
     }
-    
+    protected long lastCheck = System.currentTimeMillis();
     protected void socketTimeouts() {
+        long now = System.currentTimeMillis();
+        if ( (now-lastCheck) < getSelectorTimeout() ) return;
         //timeout
         Selector tmpsel = selector;
         Set keys =  (isListening()&&tmpsel!=null)?tmpsel.keys():null;
         if ( keys == null ) return;
-        long now = System.currentTimeMillis();
         for (Iterator iter = keys.iterator(); iter.hasNext(); ) {
             SelectionKey key = (SelectionKey) iter.next();
             try {
@@ -215,6 +216,7 @@ public class NioReceiver extends ReceiverBase implements Runnable, ChannelReceiv
                 cancelledKey(key);
             }
         }
+        lastCheck = System.currentTimeMillis();
     }
 
 

==================================================
SocketSend.java
index f88d5539d0..bb8ad58cbf 100644
--- a/test/org/apache/catalina/tribes/test/TribesTestSuite.java
+++ b/test/org/apache/catalina/tribes/test/TribesTestSuite.java
@@ -35,6 +35,7 @@ public class TribesTestSuite
         suite.addTestSuite(org.apache.catalina.tribes.test.membership.TestMemberArrival.class);
         suite.addTestSuite(org.apache.catalina.tribes.test.membership.TestTcpFailureDetector.class);
         suite.addTestSuite(org.apache.catalina.tribes.test.channel.TestDataIntegrity.class);
+        suite.addTestSuite(org.apache.catalina.tribes.test.interceptors.TestOrderInterceptor.class);
         return suite;
     }
 }

==================================================
