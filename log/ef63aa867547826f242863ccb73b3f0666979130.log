ef63aa867547826f242863ccb73b3f0666979130
==================================================
Handle close and pong control frames inside fragmented message.
==================================================
Mark Emlyn
==================================================
Thu Feb 23 11:30:55 2012 +0000
==================================================
StreamInbound.java
Handle close and pong control frames inside fragmented message.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1292742 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsInputStream.java
index a3e3c59aa9..48de65ef9f 100644
--- a/java/org/apache/catalina/websocket/StreamInbound.java
+++ b/java/org/apache/catalina/websocket/StreamInbound.java
@@ -80,7 +80,7 @@ public abstract class StreamInbound implements UpgradeInbound {
             }
 
             if (opCode == Constants.OPCODE_CLOSE){
-                doClose(frame);
+                getOutbound().close(frame);
                 return SocketState.CLOSED;
             } else if (opCode == Constants.OPCODE_PING) {
                 doPing(frame);
@@ -109,21 +109,6 @@ public abstract class StreamInbound implements UpgradeInbound {
         }
     }
 
-    private void doClose(WsFrame frame) throws IOException {
-        if (frame.getPayLoadLength() > 0) {
-            // Must be status (2 bytes) plus optional message
-            if (frame.getPayLoadLength() == 1) {
-                throw new IOException();
-            }
-            int status = (frame.getPayLoad().get() & 0xFF) << 8;
-            status += frame.getPayLoad().get() & 0xFF;
-            getOutbound().close(status, frame.getPayLoad());
-        } else {
-            // No status
-            getOutbound().close(0, null);
-        }
-    }
-
     private void doPing(WsFrame frame) throws IOException {
         getOutbound().pong(frame.getPayLoad());
     }

==================================================
WsOutbound.java
index c98e5ecabf..b74ff66ff8 100644
--- a/java/org/apache/catalina/websocket/WsInputStream.java
+++ b/java/org/apache/catalina/websocket/WsInputStream.java
@@ -68,7 +68,11 @@ public class WsInputStream extends java.io.InputStream {
             while (frame.isControl()) {
                 if (getFrame().getOpCode() == Constants.OPCODE_PING) {
                     outbound.pong(frame.getPayLoad());
-                } else {
+                } else if (getFrame().getOpCode() == Constants.OPCODE_PONG) {
+                    // NO-OP. Swallow it.
+                } else if (getFrame().getOpCode() == Constants.OPCODE_CLOSE) {
+                    outbound.close(frame);
+                } else{
                     // TODO
                     throw new IOException("TODO");
                 }

==================================================
