990da5f1b1438630b9859c41f618bce6ae317019
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=57326
==================================================
Mark Thomas
==================================================
Mon Dec 15 16:15:34 2014 +0000
==================================================
AsyncContextImpl.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=57326
Enable AsyncListeners to re-register themselves through AsyncListener.onStartAsync ()

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1645685 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index 221bd0614d..699cd5c226 100644
--- a/java/org/apache/catalina/core/AsyncContextImpl.java
+++ b/java/org/apache/catalina/core/AsyncContextImpl.java
@@ -339,6 +339,7 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
 
         List<AsyncListenerWrapper> listenersCopy = new ArrayList<>();
         listenersCopy.addAll(listeners);
+        listeners.clear();
         for (AsyncListenerWrapper listener : listenersCopy) {
             try {
                 listener.fireOnStartAsync(event);
@@ -348,7 +349,6 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
                         listener.getClass().getName() + "]", t);
             }
         }
-        listeners.clear();
     }
 
     @Override

==================================================
