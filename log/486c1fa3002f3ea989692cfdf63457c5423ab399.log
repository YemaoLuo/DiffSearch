486c1fa3002f3ea989692cfdf63457c5423ab399
==================================================
Followup to r1138573
==================================================
Konstantin Kolinko
==================================================
Wed Jun 22 23:39:58 2011 +0000
==================================================
Constants.java
Followup to r1138573
Improve support for embedding Tomcat 7.

Expose the string that was used to suppress loading default web.xml as a constant. Short-circuit the attempt to load the web.xml file when this magic value is used. Thus saving us from unneeded getResourceAsStream() call.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1138693 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ContextConfig.java
index c9c804173f..5a8067fd8d 100644
--- a/java/org/apache/catalina/startup/Constants.java
+++ b/java/org/apache/catalina/startup/Constants.java
@@ -38,6 +38,18 @@ public final class Constants {
     public static final String HostContextXml = "context.xml.default";
     public static final String HostWebXml = "web.xml.default";
 
+    /**
+     * A dummy value used to suppress loading the default web.xml file.
+     *
+     * <p>
+     * It is useful when embedding Tomcat, when the default configuration is
+     * done programmatically, e.g. by calling
+     * <code>Tomcat.initWebappDefaults(context)</code>.
+     *
+     * @see Tomcat
+     */
+    public static final String NoDefaultWebXml = "org/apache/catalina/startup/NO_DEFAULT_XML";
+
     // J2EE
     public static final String J2eeSchemaPublicId_14 =
         "j2ee_1_4.xsd";

==================================================
Tomcat.java
index bf8394994f..4bff0c20e0 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -1589,6 +1589,10 @@ public class ContextConfig
         // Set the default if we don't have any overrides
         if (defaultWebXml == null) getDefaultWebXml();
 
+        // Is it explicitly suppressed, e.g. in embedded environment?
+        if (Constants.NoDefaultWebXml.equals(defaultWebXml)) {
+            return null;
+        }
         return getWebXmlSource(defaultWebXml, getBaseDir());
     }
     

==================================================
TestStandardContextResources.java
index f5c63328c0..7004e3b732 100644
--- a/java/org/apache/catalina/startup/Tomcat.java
+++ b/java/org/apache/catalina/startup/Tomcat.java
@@ -531,8 +531,8 @@ public class Tomcat {
         ctx.addLifecycleListener(ctxCfg);
         
         // prevent it from looking ( if it finds one - it'll have dup error )
-        ctxCfg.setDefaultWebXml("org/apache/catalin/startup/NO_DEFAULT_XML");
-        
+        ctxCfg.setDefaultWebXml(noDefaultWebXmlPath());
+
         if (host == null) {
             getHost().addChild(ctx);
         } else {
@@ -560,7 +560,7 @@ public class Tomcat {
      * {@link #getDefaultWebXmlListener()}.
      */
     public String noDefaultWebXmlPath() {
-        return "org/apache/catalin/startup/NO_DEFAULT_XML";
+        return Constants.NoDefaultWebXml;
     }
     
     /**

==================================================
