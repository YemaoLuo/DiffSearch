6e73b63efc6ce1142f7bcbdfab68308c57ef3378
==================================================
Handle possible cause of false test failure
==================================================
Mark Thomas
==================================================
Wed Sep 27 11:14:24 2017 +0000
==================================================
Http2TestBase.java
Handle possible cause of false test failure
Use utility method to reduce code duplication

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1809830 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestHttp2Limits.java
index 4e4d9ff63e..239dff01a1 100644
--- a/test/org/apache/coyote/http2/Http2TestBase.java
+++ b/test/org/apache/coyote/http2/Http2TestBase.java
@@ -812,6 +812,14 @@ public abstract class Http2TestBase extends TomcatBaseTest {
     }
 
 
+    protected void skipWindowSizeFrames() throws Http2Exception, IOException {
+        do {
+            output.clearTrace();
+            parser.readFrame(true);
+        } while (output.getTrace().contains("WindowSize"));
+    }
+
+
     void handleGoAwayResponse(int lastStream, Http2Error expectedError)
             throws Http2Exception, IOException {
         try {

==================================================
TestHttp2Section_6_1.java
index 1d8c531f76..a39823e4f6 100644
--- a/test/org/apache/coyote/http2/TestHttp2Limits.java
+++ b/test/org/apache/coyote/http2/TestHttp2Limits.java
@@ -482,18 +482,15 @@ public class TestHttp2Limits extends Http2TestBase {
             break;
         }
         case STREAM_RESET: {
-            parser.readFrame(true);
+            // NIO2 can sometimes send window updates depending timing
+            skipWindowSizeFrames();
+
             Assert.assertEquals("3-RST-[11]\n", output.getTrace());
             break;
         }
         case CONNECTION_RESET: {
-            // Connection reset
-            do {
-                // NIO2 can sometimes send window updates depending on the
-                // timing of the connection close
-                output.clearTrace();
-                parser.readFrame(true);
-            } while (output.getTrace().contains("WindowSize"));
+            // NIO2 can sometimes send window updates depending timing
+            skipWindowSizeFrames();
 
             // Connection ID will vary so use a pattern
             Assert.assertThat(output.getTrace(), RegexMatcher.matchesRegex(

==================================================
