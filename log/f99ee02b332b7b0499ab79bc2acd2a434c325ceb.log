f99ee02b332b7b0499ab79bc2acd2a434c325ceb
==================================================
Comet didn't work at all under a security manger. Need to allow web apps access to the comet interfaces so move those interfaces to a separate package so we can grant access.
==================================================
Mark Emlyn
==================================================
Fri Nov 6 18:26:39 2009 +0000
==================================================
Valve.java
index 63e4b62fa9..8a8e51fa44 100644
--- a/conf/catalina.policy
+++ b/conf/catalina.policy
@@ -146,6 +146,9 @@ grant {
     // Precompiled JSPs need access to these system properties.
     permission java.util.PropertyPermission "org.apache.jasper.runtime.BodyContentImpl.LIMIT_BUFFER", "read";
     permission java.util.PropertyPermission "org.apache.el.parser.COERCE_TO_ZERO", "read";
+    
+    // Applications using Comet need to be able to access this package
+    permission java.lang.RuntimePermission "accessClassInPackage.org.apache.catalina.comet";
 };
 
 

==================================================
CometEvent.java
index 414317032c..e2a29fc4dc 100644
--- a/java/org/apache/catalina/Valve.java
+++ b/java/org/apache/catalina/Valve.java
@@ -22,6 +22,7 @@ package org.apache.catalina;
 import java.io.IOException;
 import javax.servlet.ServletException;
 
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;
 

==================================================
CometFilter.java
similarity index 99%
rename from java/org/apache/catalina/CometEvent.java
rename to java/org/apache/catalina/comet/CometEvent.java
index 341a57e614..29a884a49c 100644
--- a/java/org/apache/catalina/CometEvent.java
+++ b/java/org/apache/catalina/comet/CometEvent.java
@@ -16,7 +16,7 @@
  */
 
 
-package org.apache.catalina;
+package org.apache.catalina.comet;
 
 import java.io.IOException;
 

==================================================
CometFilterChain.java
similarity index 99%
rename from java/org/apache/catalina/CometFilter.java
rename to java/org/apache/catalina/comet/CometFilter.java
index 55cd327c4a..2b69bc4753 100644
--- a/java/org/apache/catalina/CometFilter.java
+++ b/java/org/apache/catalina/comet/CometFilter.java
@@ -16,7 +16,7 @@
  */
 
 
-package org.apache.catalina;
+package org.apache.catalina.comet;
 
 import java.io.IOException;
 

==================================================
CometProcessor.java
similarity index 97%
rename from java/org/apache/catalina/CometFilterChain.java
rename to java/org/apache/catalina/comet/CometFilterChain.java
index f0632fcd71..b4ca50e68c 100644
--- a/java/org/apache/catalina/CometFilterChain.java
+++ b/java/org/apache/catalina/comet/CometFilterChain.java
@@ -16,7 +16,7 @@
  */
 
 
-package org.apache.catalina;
+package org.apache.catalina.comet;
 
 import java.io.IOException;
 

==================================================
CometEventImpl.java
similarity index 97%
rename from java/org/apache/catalina/CometProcessor.java
rename to java/org/apache/catalina/comet/CometProcessor.java
index 38e9f3bc34..a652129a47 100644
--- a/java/org/apache/catalina/CometProcessor.java
+++ b/java/org/apache/catalina/comet/CometProcessor.java
@@ -16,7 +16,7 @@
  */
 
 
-package org.apache.catalina;
+package org.apache.catalina.comet;
 
 import java.io.IOException;
 

==================================================
CoyoteAdapter.java
index 0da2f561a1..051d566677 100644
--- a/java/org/apache/catalina/connector/CometEventImpl.java
+++ b/java/org/apache/catalina/connector/CometEventImpl.java
@@ -24,7 +24,7 @@ import javax.servlet.ServletException;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.util.res.StringManager;
 
 public class CometEventImpl implements CometEvent {

==================================================
ApplicationFilterChain.java
index 2aabdc7d6f..16c1d4235c 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -24,11 +24,11 @@ import java.util.EnumSet;
 
 import javax.servlet.SessionTrackingMode;
 
-import org.apache.catalina.CometEvent;
 import org.apache.catalina.Context;
 import org.apache.catalina.Globals;
 import org.apache.catalina.Wrapper;
 import org.apache.tomcat.util.res.StringManager;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.core.AsyncContextImpl;
 import org.apache.catalina.util.URLEncoder;
 import org.apache.coyote.ActionCode;

==================================================
ApplicationFilterFactory.java
index 2b577a96ff..49da22a026 100644
--- a/java/org/apache/catalina/core/ApplicationFilterChain.java
+++ b/java/org/apache/catalina/core/ApplicationFilterChain.java
@@ -32,12 +32,12 @@ import javax.servlet.ServletResponse;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometFilter;
-import org.apache.catalina.CometFilterChain;
-import org.apache.catalina.CometProcessor;
 import org.apache.catalina.Globals;
 import org.apache.catalina.InstanceEvent;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometFilter;
+import org.apache.catalina.comet.CometFilterChain;
+import org.apache.catalina.comet.CometProcessor;
 import org.apache.catalina.security.SecurityUtil;
 import org.apache.catalina.util.InstanceSupport;
 import org.apache.tomcat.util.res.StringManager;

==================================================
StandardContextValve.java
index b8b981cb6d..6a450e6998 100644
--- a/java/org/apache/catalina/core/ApplicationFilterFactory.java
+++ b/java/org/apache/catalina/core/ApplicationFilterFactory.java
@@ -23,9 +23,9 @@ import javax.servlet.DispatcherType;
 import javax.servlet.Servlet;
 import javax.servlet.ServletRequest;
 
-import org.apache.catalina.CometFilter;
 import org.apache.catalina.Globals;
 import org.apache.catalina.Wrapper;
+import org.apache.catalina.comet.CometFilter;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.deploy.FilterMap;
 

==================================================
StandardEngineValve.java
index 9e8a0089ed..5b91e3e2f9 100644
--- a/java/org/apache/catalina/core/StandardContextValve.java
+++ b/java/org/apache/catalina/core/StandardContextValve.java
@@ -27,10 +27,10 @@ import javax.servlet.ServletRequestEvent;
 import javax.servlet.ServletRequestListener;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
 import org.apache.catalina.Container;
 import org.apache.catalina.Globals;
 import org.apache.catalina.Wrapper;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;
 import org.apache.tomcat.util.res.StringManager;

==================================================
StandardHostValve.java
index b2df268eea..320720e62a 100644
--- a/java/org/apache/catalina/core/StandardEngineValve.java
+++ b/java/org/apache/catalina/core/StandardEngineValve.java
@@ -24,8 +24,8 @@ import java.io.IOException;
 import javax.servlet.ServletException;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
 import org.apache.catalina.Host;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;
 import org.apache.tomcat.util.res.StringManager;

==================================================
StandardWrapperValve.java
index 9dd2433664..f22b9486b2 100644
--- a/java/org/apache/catalina/core/StandardHostValve.java
+++ b/java/org/apache/catalina/core/StandardHostValve.java
@@ -27,10 +27,10 @@ import javax.servlet.ServletContext;
 import javax.servlet.ServletException;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
 import org.apache.catalina.Context;
 import org.apache.catalina.Globals;
 import org.apache.catalina.Wrapper;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.connector.ClientAbortException;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;

==================================================
RemoteAddrFilter.java
index 88c72f37f5..d4d377cb33 100644
--- a/java/org/apache/catalina/core/StandardWrapperValve.java
+++ b/java/org/apache/catalina/core/StandardWrapperValve.java
@@ -29,10 +29,10 @@ import javax.servlet.ServletException;
 import javax.servlet.UnavailableException;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometProcessor;
 import org.apache.catalina.Context;
 import org.apache.catalina.Globals;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometProcessor;
 import org.apache.catalina.connector.ClientAbortException;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;

==================================================
RemoteHostFilter.java
index cc3febcf18..ffb252d728 100644
--- a/java/org/apache/catalina/filters/RemoteAddrFilter.java
+++ b/java/org/apache/catalina/filters/RemoteAddrFilter.java
@@ -26,8 +26,8 @@ import javax.servlet.ServletException;
 import javax.servlet.ServletRequest;
 import javax.servlet.ServletResponse;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometFilterChain;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometFilterChain;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 

==================================================
RequestFilter.java
index 6778b58b8d..0b4c12d472 100644
--- a/java/org/apache/catalina/filters/RemoteHostFilter.java
+++ b/java/org/apache/catalina/filters/RemoteHostFilter.java
@@ -26,8 +26,8 @@ import javax.servlet.ServletException;
 import javax.servlet.ServletRequest;
 import javax.servlet.ServletResponse;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometFilterChain;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometFilterChain;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 

==================================================
CometConnectionManagerValve.java
index 97f9b95ca1..2499dc512f 100644
--- a/java/org/apache/catalina/filters/RequestFilter.java
+++ b/java/org/apache/catalina/filters/RequestFilter.java
@@ -30,9 +30,9 @@ import javax.servlet.ServletRequest;
 import javax.servlet.ServletResponse;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometFilter;
-import org.apache.catalina.CometFilterChain;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometFilter;
+import org.apache.catalina.comet.CometFilterChain;
 import org.apache.tomcat.util.res.StringManager;
 
 /**

==================================================
ValveBase.java
index a9281649f6..0800ed1a92 100644
--- a/java/org/apache/catalina/valves/CometConnectionManagerValve.java
+++ b/java/org/apache/catalina/valves/CometConnectionManagerValve.java
@@ -30,13 +30,13 @@ import javax.servlet.http.HttpSession;
 import javax.servlet.http.HttpSessionEvent;
 import javax.servlet.http.HttpSessionListener;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometProcessor;
 import org.apache.catalina.Context;
 import org.apache.catalina.Lifecycle;
 import org.apache.catalina.LifecycleEvent;
 import org.apache.catalina.LifecycleException;
 import org.apache.catalina.LifecycleListener;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometProcessor;
 import org.apache.catalina.connector.CometEventImpl;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;

==================================================
BayeuxServlet.java
index 524b53687b..a5f41fc252 100644
--- a/java/org/apache/catalina/valves/ValveBase.java
+++ b/java/org/apache/catalina/valves/ValveBase.java
@@ -27,7 +27,6 @@ import javax.management.MalformedObjectNameException;
 import javax.management.ObjectName;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
 import org.apache.catalina.Contained;
 import org.apache.catalina.Container;
 import org.apache.catalina.Context;
@@ -36,6 +35,7 @@ import org.apache.catalina.Host;
 import org.apache.catalina.Pipeline;
 import org.apache.catalina.Valve;
 import org.apache.catalina.Wrapper;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.connector.Request;
 import org.apache.catalina.connector.Response;
 import org.apache.catalina.core.ContainerBase;

==================================================
ClientImpl.java
index dfb81b372f..f0ce85b0f5 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/BayeuxServlet.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/BayeuxServlet.java
@@ -24,8 +24,8 @@ import javax.servlet.ServletRequest;
 import javax.servlet.ServletResponse;
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.catalina.CometEvent;
-import org.apache.catalina.CometProcessor;
+import org.apache.catalina.comet.CometEvent;
+import org.apache.catalina.comet.CometProcessor;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.json.JSONArray;

==================================================
RequestBase.java
index 3705e1f6d3..b03f7a8539 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/ClientImpl.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/ClientImpl.java
@@ -22,7 +22,7 @@ import java.util.Map;
 import java.util.Queue;
 import java.util.concurrent.ConcurrentLinkedQueue;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.json.JSONObject;
 import org.apache.cometd.bayeux.Bayeux;
 import org.apache.cometd.bayeux.Client;

==================================================
RequestFactory.java
index 9f6036eed1..a813abf21f 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/RequestBase.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/RequestBase.java
@@ -28,7 +28,7 @@ import java.util.Date;
 import java.text.SimpleDateFormat;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.bayeux.HttpError;
 
 import org.apache.juli.logging.Log;

==================================================
TomcatBayeux.java
index c617180326..203d94dc1a 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/RequestFactory.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/RequestFactory.java
@@ -18,7 +18,7 @@ package org.apache.tomcat.bayeux;
 
 import org.json.JSONObject;
 import org.apache.tomcat.bayeux.request.MetaHandshakeRequest;
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.json.JSONException;
 import org.apache.tomcat.bayeux.request.MetaConnectRequest;
 import org.apache.tomcat.bayeux.request.MetaDisconnectRequest;

==================================================
MetaConnectRequest.java
index e7d33c05c5..f8d68826ca 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/TomcatBayeux.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/TomcatBayeux.java
@@ -20,7 +20,7 @@ import java.util.HashMap;
 import java.util.LinkedHashMap;
 import java.util.List;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.catalina.tribes.util.Arrays;
 import org.apache.catalina.tribes.util.UUIDGenerator;
 import org.apache.cometd.bayeux.Bayeux;

==================================================
MetaDisconnectRequest.java
index 2eacdbc8b8..f2f509af0a 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaConnectRequest.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaConnectRequest.java
@@ -20,7 +20,7 @@ import java.io.IOException;
 import java.util.HashMap;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.bayeux.HttpError;
 import org.apache.tomcat.bayeux.BayeuxException;
 import org.apache.tomcat.bayeux.BayeuxRequest;

==================================================
MetaHandshakeRequest.java
index b3dde94002..78bf7b47dc 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaDisconnectRequest.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaDisconnectRequest.java
@@ -20,7 +20,7 @@ import java.io.IOException;
 import java.util.HashMap;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.bayeux.HttpError;
 import org.apache.tomcat.bayeux.BayeuxException;
 import org.apache.tomcat.bayeux.BayeuxRequest;

==================================================
MetaSubscribeRequest.java
index 0883ae9fc5..593cfef0ff 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaHandshakeRequest.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaHandshakeRequest.java
@@ -20,7 +20,7 @@ import java.io.IOException;
 import java.util.HashMap;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.bayeux.HttpError;
 import org.apache.tomcat.bayeux.BayeuxException;
 import org.apache.tomcat.bayeux.BayeuxRequest;

==================================================
MetaUnsubscribeRequest.java
index b6af0b2d6d..af42d097ce 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaSubscribeRequest.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaSubscribeRequest.java
@@ -22,7 +22,7 @@ import java.util.Iterator;
 import java.util.List;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.bayeux.HttpError;
 import org.apache.tomcat.bayeux.BayeuxException;
 import org.apache.tomcat.bayeux.BayeuxRequest;

==================================================
PublishRequest.java
index e8b3e163d2..62e4c8f4f1 100644
--- a/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaUnsubscribeRequest.java
+++ b/modules/bayeux/java/org/apache/tomcat/bayeux/request/MetaUnsubscribeRequest.java
@@ -22,7 +22,7 @@ import java.util.Iterator;
 import java.util.List;
 import javax.servlet.ServletException;
 
-import org.apache.catalina.CometEvent;
+import org.apache.catalina.comet.CometEvent;
 import org.apache.tomcat.bayeux.HttpError;
 import org.apache.tomcat.bayeux.BayeuxException;
 import org.apache.tomcat.bayeux.BayeuxRequest;

==================================================
ChatServlet.java
index 4cc4c53ce6..4cb28fe416 100644
--- a/webapps/docs/aio.xml
+++ b/webapps/docs/aio.xml
@@ -58,7 +58,7 @@
   <subsection name="CometEvent">
   
   <p>
-    Servlets which implement the <code>org.apache.catalina.CometProcessor</code>
+    Servlets which implement the <code>org.apache.catalina.comet.CometProcessor</code>
     interface will have their event method invoked rather than the usual service
     method, according to the event which occurred. The event object gives
     access to the usual request and response objects, which may be used in the

==================================================
