771298910a701f3b009e7aad8c03728525b4fb18
==================================================
Update to Commons Pool 2.3 release
==================================================
Mark Thomas
==================================================
Thu Jan 1 17:23:52 2015 +0000
==================================================
DefaultPooledObject.java
Update to Commons Pool 2.3 release

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1648907 13f79535-47bb-0310-9956-ffa450edef68



==================================================
LinkedBlockingDeque.java
index 22f74e9c45..054ca717ba 100644
--- a/java/org/apache/tomcat/dbcp/pool2/impl/DefaultPooledObject.java
+++ b/java/org/apache/tomcat/dbcp/pool2/impl/DefaultPooledObject.java
@@ -83,7 +83,11 @@ public class DefaultPooledObject<T> implements PooledObject<T> {
 
     @Override
     public long getIdleTimeMillis() {
-        return System.currentTimeMillis() - lastReturnTime;
+        final long elapsed = System.currentTimeMillis() - lastReturnTime;
+     // elapsed may be negative if:
+     // - another thread updates lastReturnTime during the calculation window
+     // - System.currentTimeMillis() is not monotonic (e.g. system time is set back)
+     return elapsed >= 0 ? elapsed : 0;
     }
 
     @Override
@@ -214,9 +218,7 @@ public class DefaultPooledObject<T> implements PooledObject<T> {
                 state == PooledObjectState.RETURNING) {
             state = PooledObjectState.IDLE;
             lastReturnTime = System.currentTimeMillis();
-            if (borrowedBy != null) {
-                borrowedBy = null;
-            }
+            borrowedBy = null;
             return true;
         }
 

==================================================
