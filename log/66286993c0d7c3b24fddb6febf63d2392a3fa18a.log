66286993c0d7c3b24fddb6febf63d2392a3fa18a
==================================================
Rename current cookie parser Cookies -> LegacyCookieProcessor
==================================================
Mark Emlyn
==================================================
Fri Sep 26 10:15:39 2014 +0000
==================================================
StandardContext.java
Rename current cookie parser Cookies -> LegacyCookieProcessor
Start to deprecated the use of system properties, moving towards per Context control of Cookie parsing.
Document the new CookieParser configuration options.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1627737 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ContextRuleSet.java
index 6eb50fdf7b..8b4aaea0df 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -129,7 +129,7 @@ import org.apache.tomcat.util.descriptor.web.MessageDestinationRef;
 import org.apache.tomcat.util.descriptor.web.SecurityCollection;
 import org.apache.tomcat.util.descriptor.web.SecurityConstraint;
 import org.apache.tomcat.util.http.CookieProcessor;
-import org.apache.tomcat.util.http.Cookies;
+import org.apache.tomcat.util.http.LegacyCookieProcessor;
 import org.apache.tomcat.util.scan.StandardJarScanner;
 import org.apache.tomcat.util.security.PrivilegedGetTccl;
 import org.apache.tomcat.util.security.PrivilegedSetTccl;
@@ -837,7 +837,7 @@ public class StandardContext extends ContainerBase
     @Override
     public CookieProcessor getCookieProcessor() {
         if (cookieProcessor == null) {
-            cookieProcessor = new Cookies();
+            cookieProcessor = new LegacyCookieProcessor();
         }
         return cookieProcessor;
     }

==================================================
CookieSupport.java
index ea5b7a9a24..0ca1045673 100644
--- a/java/org/apache/catalina/startup/ContextRuleSet.java
+++ b/java/org/apache/catalina/startup/ContextRuleSet.java
@@ -243,7 +243,7 @@ public class ContextRuleSet extends RuleSetBase {
                             "org.apache.tomcat.JarScanFilter");
 
         digester.addObjectCreate(prefix + "Context/CookieProcessor",
-                                 "org.apache.tomcat.util.http.Cookies",
+                                 "org.apache.tomcat.util.http.LegacyCookieProcessor",
                                  "className");
         digester.addSetProperties(prefix + "Context/CookieProcessor");
         digester.addSetNext(prefix + "Context/CookieProcessor",

==================================================
LegacyCookieProcessor.java
index 9d0a78b589..7acf3fc021 100644
--- a/java/org/apache/tomcat/util/http/CookieSupport.java
+++ b/java/org/apache/tomcat/util/http/CookieSupport.java
@@ -32,7 +32,10 @@ public final class CookieSupport {
     /**
      * If true, cookie values are allowed to contain an equals character without
      * being quoted.
+     *
+     * @deprecated  Will be removed in Tomcat 9.
      */
+    @Deprecated
     public static final boolean ALLOW_EQUALS_IN_VALUE;
 
     /**

==================================================
CookiesBaseTest.java
similarity index 94%
rename from java/org/apache/tomcat/util/http/Cookies.java
rename to java/org/apache/tomcat/util/http/LegacyCookieProcessor.java
index 3b058f23dd..bfa1bfb606 100644
--- a/java/org/apache/tomcat/util/http/Cookies.java
+++ b/java/org/apache/tomcat/util/http/LegacyCookieProcessor.java
@@ -27,17 +27,17 @@ import org.apache.tomcat.util.log.UserDataHelper;
 import org.apache.tomcat.util.res.StringManager;
 
 /**
- * A collection of cookies - reusable and tuned for server side performance.
- * Based on RFC6265 and RFC2109.
+ * The legacy (up to early Tomcat 8 releases) cookie parser based on RFC6265,
+ * RFC2109 and RFC2616.
  *
  * This class is not thread-safe.
  *
  * @author Costin Manolache
  * @author kevin seguin
  */
-public final class Cookies implements CookieProcessor {
+public final class LegacyCookieProcessor implements CookieProcessor {
 
-    private static final Log log = LogFactory.getLog(Cookies.class);
+    private static final Log log = LogFactory.getLog(LegacyCookieProcessor.class);
 
     private static final UserDataHelper userDataLog = new UserDataHelper(log);
 
@@ -45,6 +45,10 @@ public final class Cookies implements CookieProcessor {
             StringManager.getManager("org.apache.tomcat.util.http");
 
 
+    @SuppressWarnings("deprecation") // Default to false when deprecated code is removed
+    private boolean allowEqualsInValue = CookieSupport.ALLOW_EQUALS_IN_VALUE;
+
+
     @Override
     public Charset getCharset() {
         return StandardCharsets.ISO_8859_1;
@@ -98,7 +102,7 @@ public final class Cookies implements CookieProcessor {
      * RFC 2965 / RFC 2109
      * JVK
      */
-    private static final void processCookieHeader(byte bytes[], int off, int len,
+    private final void processCookieHeader(byte bytes[], int off, int len,
             ServerCookies serverCookies) {
 
         if (len <= 0 || bytes == null) {
@@ -191,7 +195,7 @@ public final class Cookies implements CookieProcessor {
                                 !CookieSupport.isV0Separator((char)bytes[pos]) &&
                                 CookieSupport.ALLOW_HTTP_SEPARATORS_IN_V0 ||
                             !CookieSupport.isHttpSeparator((char)bytes[pos]) ||
-                            bytes[pos] == '=' && CookieSupport.ALLOW_EQUALS_IN_VALUE) {
+                            bytes[pos] == '=' && allowEqualsInValue) {
                         // Token
                         valueStart = pos;
                         // getToken returns the position at the delimiter
@@ -346,7 +350,7 @@ public final class Cookies implements CookieProcessor {
      * token, with no separator characters in between.
      * JVK
      */
-    private static final int getTokenEndPosition(byte bytes[], int off, int end,
+    private final int getTokenEndPosition(byte bytes[], int off, int end,
             int version, boolean isName){
         int pos = off;
         while (pos < end &&
@@ -355,8 +359,7 @@ public final class Cookies implements CookieProcessor {
                         CookieSupport.ALLOW_HTTP_SEPARATORS_IN_V0 &&
                         bytes[pos] != '=' &&
                         !CookieSupport.isV0Separator((char)bytes[pos]) ||
-                 !isName && bytes[pos] == '=' &&
-                         CookieSupport.ALLOW_EQUALS_IN_VALUE)) {
+                 !isName && bytes[pos] == '=' && allowEqualsInValue)) {
             pos++;
         }
 
@@ -458,4 +461,14 @@ public final class Cookies implements CookieProcessor {
         }
         bc.setEnd(dest);
     }
+
+
+    public boolean getAllowEqualsInValue() {
+        return allowEqualsInValue;
+    }
+
+
+    public void setAllowEqualsInValue(boolean allowEqualsInValue) {
+        this.allowEqualsInValue = allowEqualsInValue;
+    }
 }

==================================================
TestBug49158.java
index f7f9d0f342..8f5a08bb4c 100644
--- a/test/org/apache/tomcat/util/http/CookiesBaseTest.java
+++ b/test/org/apache/tomcat/util/http/CookiesBaseTest.java
@@ -29,10 +29,11 @@ import org.apache.catalina.startup.Tomcat;
 import org.apache.catalina.startup.TomcatBaseTest;
 
 /**
- * Base Test case for {@link Cookies}. <b>Note</b> because of the use of
- * <code>static final</code> constants in {@link Cookies}, each of these tests
- * must be executed in a new JVM instance. The tests have been place in separate
- * classes to facilitate this when running the unit tests via Ant.
+ * Base Test case for {@link LegacyCookieProcessor}. <b>Note</b> because of the
+ * use of <code>static final</code> constants in {@link LegacyCookieProcessor},
+ * each of these tests  must be executed in a new JVM instance. The tests have
+ * been place in separate classes to facilitate this when running the unit tests
+ * via Ant.
  */
 public abstract class CookiesBaseTest extends TomcatBaseTest {
 

==================================================
TestCookies.java
index e7aeae798f..8ec18bed22 100644
--- a/test/org/apache/tomcat/util/http/TestBug49158.java
+++ b/test/org/apache/tomcat/util/http/TestBug49158.java
@@ -37,8 +37,8 @@ import org.apache.catalina.startup.Tomcat;
 import org.apache.tomcat.util.buf.ByteChunk;
 
 /**
- * Test case for {@link Cookies}. <b>Note</b> because of the use of <code>final
- * static</code> constants in {@link Cookies}, each of these tests must be
+ * Test case for {@link LegacyCookieProcessor}. <b>Note</b> because of the use of <code>final
+ * static</code> constants in {@link LegacyCookieProcessor}, each of these tests must be
  * executed in a new JVM instance. The tests have been place in separate classes
  * to facilitate this when running the unit tests via Ant.
  */

==================================================
TestCookiesDefaultSysProps.java
index ff663a29d4..0f47297d58 100644
--- a/test/org/apache/tomcat/util/http/TestCookies.java
+++ b/test/org/apache/tomcat/util/http/TestCookies.java
@@ -478,7 +478,7 @@ public class TestCookies {
         if (useRfc6265) {
             cookieProcessor = new Rfc6265CookieProcessor();
         } else {
-            cookieProcessor = new Cookies();
+            cookieProcessor = new LegacyCookieProcessor();
         }
         MessageBytes cookieHeaderValue = mimeHeaders.addValue("Cookie");
         byte[] bytes = header.getBytes(StandardCharsets.UTF_8);

==================================================
TestCookiesNoFwdStrictSysProps.java
index 826b8a96e6..a4525f90c4 100644
--- a/test/org/apache/tomcat/util/http/TestCookiesDefaultSysProps.java
+++ b/test/org/apache/tomcat/util/http/TestCookiesDefaultSysProps.java
@@ -29,8 +29,8 @@ import org.apache.catalina.startup.Tomcat;
 import org.apache.tomcat.util.buf.ByteChunk;
 
 /**
- * Test case for {@link Cookies}. <b>Note</b> because of the use of <code>final
- * static</code> constants in {@link Cookies}, each of these tests must be
+ * Test case for {@link LegacyCookieProcessor}. <b>Note</b> because of the use of <code>final
+ * static</code> constants in {@link LegacyCookieProcessor}, each of these tests must be
  * executed in a new JVM instance. The tests have been place in separate classes
  * to facilitate this when running the unit tests via Ant.
  */

==================================================
TestCookiesNoStrictNamingSysProps.java
index 00e152e074..5b9a09fc4f 100644
--- a/test/org/apache/tomcat/util/http/TestCookiesNoFwdStrictSysProps.java
+++ b/test/org/apache/tomcat/util/http/TestCookiesNoFwdStrictSysProps.java
@@ -25,8 +25,8 @@ import org.apache.catalina.startup.Tomcat;
 import org.apache.tomcat.util.buf.ByteChunk;
 
 /**
- * Test case for {@link Cookies}. <b>Note</b> because of the use of <code>final
- * static</code> constants in {@link Cookies}, each of these tests must be
+ * Test case for {@link LegacyCookieProcessor}. <b>Note</b> because of the use of <code>final
+ * static</code> constants in {@link LegacyCookieProcessor}, each of these tests must be
  * executed in a new JVM instance. The tests have been place in separate classes
  * to facilitate this when running the unit tests via Ant.
  */

==================================================
TestCookiesStrictSysProps.java
index 297743ac84..7e393561da 100644
--- a/test/org/apache/tomcat/util/http/TestCookiesNoStrictNamingSysProps.java
+++ b/test/org/apache/tomcat/util/http/TestCookiesNoStrictNamingSysProps.java
@@ -25,8 +25,8 @@ import org.apache.catalina.startup.Tomcat;
 import org.apache.tomcat.util.buf.ByteChunk;
 
 /**
- * Test case for {@link Cookies}. <b>Note</b> because of the use of <code>final
- * static</code> constants in {@link Cookies}, each of these tests must be
+ * Test case for {@link LegacyCookieProcessor}. <b>Note</b> because of the use of <code>final
+ * static</code> constants in {@link LegacyCookieProcessor}, each of these tests must be
  * executed in a new JVM instance. The tests have been place in separate classes
  * to facilitate this when running the unit tests via Ant.
  */

==================================================
TesterCookiesPerformance.java
index e96166d33f..161cac4280 100644
--- a/test/org/apache/tomcat/util/http/TestCookiesStrictSysProps.java
+++ b/test/org/apache/tomcat/util/http/TestCookiesStrictSysProps.java
@@ -29,8 +29,8 @@ import org.apache.catalina.startup.Tomcat;
 import org.apache.tomcat.util.buf.ByteChunk;
 
 /**
- * Test case for {@link Cookies}. <b>Note</b> because of the use of <code>final
- * static</code> constants in {@link Cookies}, each of these tests must be
+ * Test case for {@link LegacyCookieProcessor}. <b>Note</b> because of the use of <code>final
+ * static</code> constants in {@link LegacyCookieProcessor}, each of these tests must be
  * executed in a new JVM instance. The tests have been place in separate classes
  * to facilitate this when running the unit tests via Ant.
  */

==================================================
