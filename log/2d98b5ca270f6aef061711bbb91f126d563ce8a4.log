2d98b5ca270f6aef061711bbb91f126d563ce8a4
==================================================
Provide modifyHandshake() with a per session (i.e. per connection) view of the user properties rather than a per endpoint view (that would be shared will all connections to that endpoint).
==================================================
Mark Emlyn
==================================================
Mon Oct 28 12:48:03 2013 +0000
==================================================
UpgradeUtil.java
Provide modifyHandshake() with a per session (i.e. per connection) view of the user properties rather than a per endpoint view (that would be shared will all connections to that endpoint).
This allows for easier configuration of per connection properties from within modifyHandshake()

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1536337 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsPerSessionServerEndpointConfig.java
index 0b02fef071..b900cfc5a8 100644
--- a/java/org/apache/tomcat/websocket/server/UpgradeUtil.java
+++ b/java/org/apache/tomcat/websocket/server/UpgradeUtil.java
@@ -160,7 +160,10 @@ public class UpgradeUtil {
 
         WsHandshakeRequest wsRequest = new WsHandshakeRequest(req);
         WsHandshakeResponse wsResponse = new WsHandshakeResponse();
-        sec.getConfigurator().modifyHandshake(sec, wsRequest, wsResponse);
+        WsPerSessionServerEndpointConfig perSessionServerEndpointConfig =
+                new WsPerSessionServerEndpointConfig(sec);
+        sec.getConfigurator().modifyHandshake(perSessionServerEndpointConfig,
+                wsRequest, wsResponse);
         wsRequest.finished();
 
         // Add any additional headers
@@ -173,8 +176,8 @@ public class UpgradeUtil {
 
         WsHttpUpgradeHandler wsHandler =
                 req.upgrade(WsHttpUpgradeHandler.class);
-        wsHandler.preInit(ep, sec, sc, wsRequest, subProtocol,
-                pathParams, req.isSecure());
+        wsHandler.preInit(ep, perSessionServerEndpointConfig, sc, wsRequest,
+                subProtocol, pathParams, req.isSecure());
 
     }
 

==================================================
