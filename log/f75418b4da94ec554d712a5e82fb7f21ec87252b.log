f75418b4da94ec554d712a5e82fb7f21ec87252b
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51396
==================================================
Mark Emlyn
==================================================
Mon Jun 20 22:34:16 2011 +0000
==================================================
ContextConfig.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51396
Correctly handle jsp-file entries in web.xml when the JSP servlet has been configured via code when embedding Tomcat.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1137806 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestContextConfig.java
index 4e50dd02a4..bf8394994f 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -1381,15 +1381,29 @@ public class ContextConfig
     }
 
     private void convertJsps(WebXml webXml) {
+        Map<String,String> jspInitParams;
         ServletDef jspServlet = webXml.getServlets().get("jsp");
+        if (jspServlet == null) {
+            jspInitParams = new HashMap<String,String>();
+            Wrapper w = (Wrapper) context.findChild("jsp");
+            if (w != null) {
+                String[] params = w.findInitParameters();
+                for (String param : params) {
+                    jspInitParams.put(param, w.findInitParameter(param));
+                }
+            }
+        } else {
+            jspInitParams = jspServlet.getParameterMap();
+        }
         for (ServletDef servletDef: webXml.getServlets().values()) {
             if (servletDef.getJspFile() != null) {
-                convertJsp(servletDef, jspServlet);
+                convertJsp(servletDef, jspInitParams);
             }
         }
     }
 
-    private void convertJsp(ServletDef servletDef, ServletDef jspServletDef) {
+    private void convertJsp(ServletDef servletDef,
+            Map<String,String> jspInitParams) {
         servletDef.setServletClass(org.apache.catalina.core.Constants.JSP_SERVLET_CLASS);
         String jspFile = servletDef.getJspFile();
         if ((jspFile != null) && !jspFile.startsWith("/")) {
@@ -1405,7 +1419,7 @@ public class ContextConfig
         }
         servletDef.getParameterMap().put("jspFile", jspFile);
         servletDef.setJspFile(null);
-        for (Map.Entry<String, String> initParam: jspServletDef.getParameterMap().entrySet()) {
+        for (Map.Entry<String, String> initParam: jspInitParams.entrySet()) {
             servletDef.addInitParameter(initParam.getKey(), initParam.getValue());
         }
     }

==================================================
