a77cff9e528f3317db18b00ec390021ec02a9278
==================================================
Fix OpenSSL 3 exception on shutdown
==================================================
remm remm@apache.org
==================================================
Wed Oct 26 15:57:37 2022 +0200
==================================================
OpenSSLLifecycleListener.java
Fix OpenSSL 3 exception on shutdown

The version check was missing and the removed fips API was called,
causing a harmless (but ugly obviously) linker exception.


==================================================
OpenSSLLifecycleListener.java
index 98d6c527c4..57b427031c 100644
--- a/modules/openssl-foreign/src/main/java/org/apache/tomcat/util/net/openssl/panama/OpenSSLLifecycleListener.java
+++ b/modules/openssl-foreign/src/main/java/org/apache/tomcat/util/net/openssl/panama/OpenSSLLifecycleListener.java
@@ -395,7 +395,9 @@ public class OpenSSLLifecycleListener implements LifecycleListener {
                 if (!MemorySegment.NULL.equals(enginePointer)) {
                     ENGINE_free(enginePointer);
                 }
-                FIPS_mode_set(0);
+                if (OpenSSL_version_num() < 0x3000000fL) {
+                    FIPS_mode_set(0);
+                }
             } finally {
                 OpenSSLStatus.setInitialized(false);
                 fipsModeActive = false;

==================================================
