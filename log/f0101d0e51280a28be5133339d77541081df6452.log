f0101d0e51280a28be5133339d77541081df6452
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54095
==================================================
Mark Emlyn
==================================================
Thu Oct 10 21:24:59 2013 +0000
==================================================
DefaultServlet.java
index eefc6165d2..14d36e7166 100644
--- a/conf/web.xml
+++ b/conf/web.xml
@@ -104,6 +104,10 @@
             <param-name>listings</param-name>
             <param-value>false</param-value>
         </init-param>
+        <init-param>
+            <param-name>gzip</param-name>
+            <param-value>true</param-value>
+        </init-param>
         <load-on-startup>1</load-on-startup>
     </servlet>
 

==================================================
TestDefaultServlet.java
index 0533910b17..2c6f75933d 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -32,6 +32,7 @@ import java.io.Reader;
 import java.io.StringReader;
 import java.io.StringWriter;
 import java.util.ArrayList;
+import java.util.Enumeration;
 import java.util.Iterator;
 import java.util.StringTokenizer;
 
@@ -139,6 +140,12 @@ public class DefaultServlet
     protected boolean readOnly = true;
 
 
+    /**
+     * Should be serve gzip versions of files. By default, it's set to true.
+     */
+    protected boolean gzip = true;
+
+
     /**
      * The output buffer size to use when serving resources.
      */
@@ -277,6 +284,9 @@ public class DefaultServlet
         if (getServletConfig().getInitParameter("readonly") != null)
             readOnly = Boolean.parseBoolean(getServletConfig().getInitParameter("readonly"));
 
+        if (getServletConfig().getInitParameter("gzip") != null)
+            gzip = Boolean.parseBoolean(getServletConfig().getInitParameter("gzip"));
+
         if (getServletConfig().getInitParameter("sendfileSize") != null)
             sendfileSize =
                 Integer.parseInt(getServletConfig().getInitParameter("sendfileSize")) * 1024;
@@ -754,6 +764,19 @@ public class DefaultServlet
             resource.setMimeType(contentType);
         }
 
+        // Serve a gzipped version of the file if present
+        if (gzip
+                && checkIfGzip(request)
+                && resource.isFile()
+                && !path.endsWith(".gz")) {
+            WebResource gzipResource = resources.getResource(path + ".gz");
+            if (gzipResource.exists() && gzipResource.isFile()) {
+                gzipResource.setMimeType(contentType);
+                response.addHeader("Content-Encoding", "gzip");
+                resource = gzipResource;
+            }
+        }
+
         ArrayList<Range> ranges = null;
         long contentLength = -1L;
 
@@ -1681,6 +1704,24 @@ public class DefaultServlet
         return true;
     }
 
+    /**
+     * Check if the user agent supports gzip encoding.
+     *
+     * @param request   The servlet request we are processing
+     * @return boolean true if the user agent supports gzip encoding,
+     * and false if the user agent does not support gzip encoding
+     */
+    protected boolean checkIfGzip(HttpServletRequest request) {
+        Enumeration<String> headers = request.getHeaders("Accept-Encoding");
+        while (headers.hasMoreElements()) {
+            String header = headers.nextElement();
+            if (header.indexOf("gzip") != -1) {
+                return true;
+            }
+        }
+        return false;
+    }
+
 
     /**
      * Check if the if-unmodified-since condition is satisfied.

==================================================
