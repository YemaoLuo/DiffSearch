70d4e9ba0a81a1d782fa50695a18d23f2f1f179c
==================================================
Do not add a trailing / to a request URI during canonicalization.
==================================================
Mark Thomas
==================================================
Wed Oct 13 18:28:45 2021 +0100
==================================================
CoyoteAdapter.java
Do not add a trailing / to a request URI during canonicalization.

This is part of the clarification in Servet 6.0 of the expected
canonicalization Servlet containers are expected to apply to request
URIs.



==================================================
TestCoyoteAdapter.java
index 053874f8aa..046cc4c41c 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -1149,6 +1149,7 @@ public class CoyoteAdapter implements Adapter {
         final byte[] b = uriBC.getBytes();
         final int start = uriBC.getStart();
         int end = uriBC.getEnd();
+        boolean appendedSlash = false;
 
         // An empty URL is not acceptable
         if (start == end) {
@@ -1197,6 +1198,7 @@ public class CoyoteAdapter implements Adapter {
                     && (b[end - 3] == (byte) '/'))) {
                 b[end] = (byte) '/';
                 end++;
+                appendedSlash = true;
             }
         }
 
@@ -1241,8 +1243,13 @@ public class CoyoteAdapter implements Adapter {
             index = index2;
         }
 
-        return true;
+        // If a slash was appended to help normalize "/." or "/.." then remove
+        // any trailing "/" from the result unless the result is "/".
+        if (appendedSlash && end > 1 && b[end - 1]== '/') {
+            uriBC.setEnd(end -1);
+        }
 
+        return true;
     }
 
 

==================================================
