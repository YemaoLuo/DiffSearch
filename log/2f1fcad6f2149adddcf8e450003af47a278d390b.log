2f1fcad6f2149adddcf8e450003af47a278d390b
==================================================
Refactor: Make Http2Protocol available to Http2UpgradeHandler.
==================================================
Mark Thomas
==================================================
Tue Sep 5 09:43:44 2017 +0000
==================================================
Http2AsyncUpgradeHandler.java
Refactor: Make Http2Protocol available to Http2UpgradeHandler.
This will enable some duplicated properties to be removed.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1807325 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http2Protocol.java
index 3932884b59..10c708450e 100644
--- a/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
@@ -36,8 +36,9 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
     private Throwable error = null;
     private IOException applicationIOE = null;
 
-    public Http2AsyncUpgradeHandler(Adapter adapter, Request coyoteRequest) {
-        super (adapter, coyoteRequest);
+    public Http2AsyncUpgradeHandler(Http2Protocol protocol, Adapter adapter,
+            Request coyoteRequest) {
+        super (protocol, adapter, coyoteRequest);
     }
 
     private CompletionHandler<Long, Void> errorCompletion = new CompletionHandler<Long, Void>() {

==================================================
Http2UpgradeHandler.java
index c9a9cbd92c..cd578a9f43 100644
--- a/java/org/apache/coyote/http2/Http2Protocol.java
+++ b/java/org/apache/coyote/http2/Http2Protocol.java
@@ -102,8 +102,8 @@ public class Http2Protocol implements UpgradeProtocol {
     public InternalHttpUpgradeHandler getInternalUpgradeHandler(SocketWrapperBase<?> socketWrapper,
             Adapter adapter, Request coyoteRequest) {
         Http2UpgradeHandler result = (socketWrapper.hasAsyncIO())
-                ? new Http2AsyncUpgradeHandler(adapter, coyoteRequest)
-                : new Http2UpgradeHandler(adapter, coyoteRequest);
+                ? new Http2AsyncUpgradeHandler(this, adapter, coyoteRequest)
+                : new Http2UpgradeHandler(this, adapter, coyoteRequest);
 
         result.setReadTimeout(getReadTimeout());
         result.setKeepAliveTimeout(getKeepAliveTimeout());

==================================================
TestAbstractStream.java
index 5102286001..60537d243e 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -96,6 +96,7 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
 
     protected final String connectionId;
 
+    private final Http2Protocol protocol;
     private final Adapter adapter;
     protected volatile SocketWrapperBase<?> socketWrapper;
     private volatile SSLSupport sslSupport;
@@ -151,8 +152,9 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
     private int maxTrailerSize = Constants.DEFAULT_MAX_TRAILER_SIZE;
 
 
-    Http2UpgradeHandler(Adapter adapter, Request coyoteRequest) {
+    Http2UpgradeHandler(Http2Protocol protocol, Adapter adapter, Request coyoteRequest) {
         super (STREAM_ID_ZERO);
+        this.protocol = protocol;
         this.adapter = adapter;
         this.connectionId = Integer.toString(connectionIdGenerator.getAndIncrement());
 

==================================================
