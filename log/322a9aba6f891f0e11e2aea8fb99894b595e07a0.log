322a9aba6f891f0e11e2aea8fb99894b595e07a0
==================================================
Log warning if a listener is incorrectly placed
==================================================
Michael Osipov
==================================================
Mon Nov 8 20:39:09 2021 +0100
==================================================
AprLifecycleListener.java
Log warning if a listener is incorrectly placed

Some listeners are intented to be nested inside a Server element only.
If a listener is misplaced a warning message is logged.



==================================================
JreMemoryLeakPreventionListener.java
index d92ac141c7..285abf9b71 100644
--- a/java/org/apache/catalina/core/AprLifecycleListener.java
+++ b/java/org/apache/catalina/core/AprLifecycleListener.java
@@ -121,6 +121,10 @@ public class AprLifecycleListener implements LifecycleListener {
 
         if (Lifecycle.BEFORE_INIT_EVENT.equals(event.getType())) {
             synchronized (lock) {
+                if (!(event.getLifecycle() instanceof Server)) {
+                    log.warn(sm.getString("listener.notServer",
+                            event.getLifecycle().getClass().getSimpleName()));
+                }
                 init();
                 for (String msg : initInfoLogMessages) {
                     log.info(msg);

==================================================
GlobalResourcesLifecycleListener.java
index 345d197fdc..80dbc79847 100644
--- a/java/org/apache/catalina/core/LocalStrings.properties
+++ b/java/org/apache/catalina/core/LocalStrings.properties
@@ -142,6 +142,8 @@ jniLifecycleListener.missingPathOrName=One of libraryName or libraryPath must be
 
 jreLeakListener.classToInitializeFail=Failed to load class [{0}] during Tomcat start to prevent possible memory leaks.
 
+listener.notServer=This listener must only be nested within Server elements, but is in [{0}].
+
 naming.addEnvEntry=Adding environment entry [{0}]
 naming.addResourceEnvRef=Adding resource env ref [{0}]
 naming.bindFailed=Failed to bind object: [{0}]

==================================================
SecurityListener.java
index b97a0184d5..1c604fd388 100644
--- a/java/org/apache/catalina/security/LocalStrings.properties
+++ b/java/org/apache/catalina/security/LocalStrings.properties
@@ -13,6 +13,8 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+listener.notServer=This listener must only be nested within Server elements, but is in [{0}].
+
 SecurityListener.checkUmaskFail=Start attempted with umask setting of [{0}]. Running Tomcat without a umask at least as restrictive as [{1}] has been blocked by the Lifecycle listener org.apache.catalina.security.SecurityListener (usually configured in CATALINA_BASE/conf/server.xml)
 SecurityListener.checkUmaskNone=No umask setting was found in system property [{0}]. However, it appears Tomcat is running on a platform that supports umask. The system property is typically set in CATALINA_HOME/bin/catalina.sh. The Lifecycle listener org.apache.catalina.security.SecurityListener (usually configured in CATALINA_BASE/conf/server.xml) expects a umask at least as restrictive as [{1}]
 SecurityListener.checkUmaskParseFail=Failed to parse value [{0}] as a valid umask.

==================================================
VersionLoggerListener.java
index b8d0affb03..facc17c182 100644
--- a/java/org/apache/catalina/startup/LocalStrings.properties
+++ b/java/org/apache/catalina/startup/LocalStrings.properties
@@ -146,6 +146,7 @@ hostConfig.undeploy=Undeploying context [{0}]
 hostConfig.undeployVersion=Undeploying old version of context [{0}] which has no active session
 
 listener.createFailed=Optional listener [{0}] is not enabled
+listener.notServer=This listener must only be nested within Server elements, but is in [{0}].
 
 passwdUserDatabase.readFail=Failed to obtain a complete set of users from /etc/passwd
 

==================================================
StoreConfigLifecycleListener.java
index fdf160c461..4067b860b8 100644
--- a/java/org/apache/catalina/storeconfig/LocalStrings.properties
+++ b/java/org/apache/catalina/storeconfig/LocalStrings.properties
@@ -34,7 +34,7 @@ standardContextSF.storeContext=Store context [{0}] configuration separately at p
 standardContextSF.storeContextWithBackup=Store context [{0}] configuration separately with backup at path [{1}]
 
 storeConfigListener.loadError=Error loading StoreConfig
-storeConfigListener.notServer=The listener was added to component other than the Server and will therefore be ignored
+storeConfigListener.notServer=This listener must only be nested within Server elements, but is in [{0}], ignoring it.
 storeConfigListener.registerError=Error registering StoreConfig MBean
 
 storeFactory.noDescriptor=Descriptor for element [{0}].[{1}] not configured

==================================================
