e98409e3bb9ae1e29e607ca511eb99dfcf3014a0
==================================================
Add expanded unit tests for HEAD and fix bugs identified in buffering
==================================================
Mark Thomas
==================================================
Thu Jun 3 16:44:41 2021 +0100
==================================================
OutputBuffer.java
Add expanded unit tests for HEAD and fix bugs identified in buffering



==================================================
TestHttpServletDoHead.java
index 0ea4dbda6d..d7a6783ea3 100644
--- a/java/org/apache/catalina/connector/OutputBuffer.java
+++ b/java/org/apache/catalina/connector/OutputBuffer.java
@@ -527,7 +527,7 @@ public class OutputBuffer extends Writer {
         while (sOff < sEnd) {
             int n = transfer(s, sOff, sEnd - sOff, cb);
             sOff += n;
-            if (isFull(cb)) {
+            if (sOff < sEnd && isFull(cb)) {
                 flushCharBuffer();
             }
         }
@@ -684,7 +684,7 @@ public class OutputBuffer extends Writer {
             int n = transfer(src, off, len, bb);
             len = len - n;
             off = off + n;
-            if (isFull(bb)) {
+            if (len > 0 && isFull(bb)) {
                 flushByteBuffer();
                 appendByteArray(src, off, len);
             }
@@ -736,7 +736,7 @@ public class OutputBuffer extends Writer {
             appendByteBuffer(from);
         } else {
             transfer(from, bb);
-            if (isFull(bb)) {
+            if (from.hasRemaining() && isFull(bb)) {
                 flushByteBuffer();
                 appendByteBuffer(from);
             }
@@ -749,7 +749,7 @@ public class OutputBuffer extends Writer {
         }
 
         int limit = bb.capacity();
-        while (len >= limit) {
+        while (len > limit) {
             realWriteBytes(ByteBuffer.wrap(src, off, limit));
             len = len - limit;
             off = off + limit;
@@ -767,7 +767,7 @@ public class OutputBuffer extends Writer {
 
         int limit = bb.capacity();
         int fromLimit = from.limit();
-        while (from.remaining() >= limit) {
+        while (from.remaining() > limit) {
             from.limit(from.position() + limit);
             realWriteBytes(from.slice());
             from.position(from.limit());

==================================================
