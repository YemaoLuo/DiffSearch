1e95c5a414bba99d0f7693dea65b84af01e8fe26
==================================================
Ensure AsyncListener.onError() is triggered for a non-blocking IO error
==================================================
Mark Thomas
==================================================
Wed Feb 24 17:11:16 2021 +0000
==================================================
CoyoteAdapter.java
Ensure AsyncListener.onError() is triggered for a non-blocking IO error

If the non-blocking I/O error occurred in onWritePossible() or
onDataAvailable() (rather than when buffered data was being written in
the background) the error was not propogated to the AsyncListener.



==================================================
TestNonBlockingAPI.java
index e470ed93b3..e9100e125f 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -188,6 +188,7 @@ public class CoyoteAdapter implements Adapter {
                         // https://bz.apache.org/bugzilla/show_bug.cgi?id=65001
                         res.action(ActionCode.CLOSE_NOW, t);
                         writeListener.onError(t);
+                        asyncConImpl.setErrorState(t, true);
                     } finally {
                         request.getContext().unbind(false, oldCL);
                     }
@@ -215,6 +216,7 @@ public class CoyoteAdapter implements Adapter {
                         // https://bz.apache.org/bugzilla/show_bug.cgi?id=65001
                         res.action(ActionCode.CLOSE_NOW, t);
                         readListener.onError(t);
+                        asyncConImpl.setErrorState(t, true);
                     } finally {
                         request.getContext().unbind(false, oldCL);
                     }

==================================================
