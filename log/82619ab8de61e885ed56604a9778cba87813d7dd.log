82619ab8de61e885ed56604a9778cba87813d7dd
==================================================
Remove finally and leave the channel in sendfile mode until the sendfile is done. Also check for close first since sendfile is reset on closing.
==================================================
Remy Maucherat
==================================================
Thu Sep 17 14:52:39 2015 +0000
==================================================
NioEndpoint.java
Remove finally and leave the channel in sendfile mode until the sendfile is done. Also check for close first since sendfile is reset on closing.
Note: this could hide away 57265, so it's probably a good idea to not port it to 8.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1703640 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SecureNioChannel.java
index 1ec51a8883..9956087641 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -958,7 +958,9 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel> {
 
                 // Configure output channel
                 sc = socketWrapper.getSocket();
-                sc.setSendFile(true);
+                if (calledByProcessor) {
+                    sc.setSendFile(true);
+                }
                 // TLS/SSL channel is slightly different
                 WritableByteChannel wc = ((sc instanceof SecureNioChannel)?sc:sc.getIOChannel());
 
@@ -987,6 +989,7 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel> {
                         log.debug("Send file complete for: "+sd.fileName);
                     }
                     socketWrapper.setSendfileData(null);
+                    sc.setSendFile(false);
                     try {
                         sd.fchannel.close();
                     } catch (Exception ignore) {
@@ -1035,8 +1038,6 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel> {
                     cancelledKey(sk);
                 }
                 return SendfileState.ERROR;
-            } finally {
-                if (sc!=null) sc.setSendFile(false);
             }
         }
 

==================================================
