2439a4e81c24586c636e34cae89091d90a482548
==================================================
Create dependency to the TLD file rather than to the webappPath of the root of the search
==================================================
Mark Emlyn
==================================================
Wed Nov 27 19:58:05 2013 +0000
==================================================
TldScanner.java
Create dependency to the TLD file rather than to the webappPath of the root of the search
Add a test case for bug 55807 and the other issues fixed in TldScanner while investigating bug 55807

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1546172 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestTldScanner.java
index 956d01ff32..553dab973b 100644
--- a/java/org/apache/jasper/servlet/TldScanner.java
+++ b/java/org/apache/jasper/servlet/TldScanner.java
@@ -313,6 +313,7 @@ public class TldScanner {
             if (!metaInf.isDirectory()) {
                 return;
             }
+            final Path filePath = file.toPath();
             Files.walkFileTree(metaInf.toPath(), new SimpleFileVisitor<Path>() {
                 @Override
                 public FileVisitResult visitFile(Path file,
@@ -322,9 +323,11 @@ public class TldScanner {
                         return FileVisitResult.CONTINUE;
                     }
 
+                    String resourcePath = webappPath + "/" +
+                            file.subpath(filePath.getNameCount(), file.getNameCount());
                     try {
                         URL url = file.toUri().toURL();
-                        TldResourcePath path = new TldResourcePath(url, webappPath);
+                        TldResourcePath path = new TldResourcePath(url, resourcePath);
                         parseTld(path);
                         tldFound = true;
                     } catch (SAXException e) {

==================================================
