dd056b6b355893e5f20cbd987af53057d39bf14b
==================================================
Remove unnecessary privileged block from setAttribute.
==================================================
Mark Thomas
==================================================
Thu Apr 6 20:56:15 2017 +0000
==================================================
PageContextImpl.java
Remove unnecessary privileged block from setAttribute.
I can't see anything in doSetAttribute that would trigger a security check.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1790465 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SecurityClassLoad.java
index 0145866bcc..13f31f7a9a 100644
--- a/java/org/apache/jasper/runtime/PageContextImpl.java
+++ b/java/org/apache/jasper/runtime/PageContextImpl.java
@@ -19,8 +19,6 @@ package org.apache.jasper.runtime;
 
 import java.io.IOException;
 import java.io.Writer;
-import java.security.AccessController;
-import java.security.PrivilegedAction;
 import java.util.Collections;
 import java.util.Enumeration;
 import java.util.HashMap;
@@ -51,7 +49,6 @@ import org.apache.jasper.Constants;
 import org.apache.jasper.compiler.Localizer;
 import org.apache.jasper.el.ELContextImpl;
 import org.apache.jasper.runtime.JspContextWrapper.ELContextWrapper;
-import org.apache.jasper.security.SecurityUtil;
 
 /**
  * Implementation of the PageContext class from the JSP spec. Also doubles as a
@@ -245,26 +242,12 @@ public class PageContextImpl extends PageContext {
     public void setAttribute(final String name, final Object o, final int scope) {
 
         if (name == null) {
-            throw new NullPointerException(Localizer
-                    .getMessage("jsp.error.attribute.null_name"));
+            throw new NullPointerException(Localizer.getMessage("jsp.error.attribute.null_name"));
         }
 
-        if (SecurityUtil.isPackageProtectionEnabled()) {
-            AccessController.doPrivileged(new PrivilegedAction<Void>() {
-                @Override
-                public Void run() {
-                    doSetAttribute(name, o, scope);
-                    return null;
-                }
-            });
+        if (o == null) {
+            removeAttribute(name, scope);
         } else {
-            doSetAttribute(name, o, scope);
-        }
-
-    }
-
-    private void doSetAttribute(String name, Object o, int scope) {
-        if (o != null) {
             switch (scope) {
             case PAGE_SCOPE:
                 attributes.put(name, o);
@@ -289,8 +272,6 @@ public class PageContextImpl extends PageContext {
             default:
                 throw new IllegalArgumentException("Invalid scope");
             }
-        } else {
-            removeAttribute(name, scope);
         }
     }
 

==================================================
