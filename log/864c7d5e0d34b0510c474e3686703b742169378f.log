864c7d5e0d34b0510c474e3686703b742169378f
==================================================
- Add possibly missing notification.
==================================================
Remy Maucherat
==================================================
Wed Apr 9 21:21:16 2014 +0000
==================================================
InternalNio2InputBuffer.java
- Add possibly missing notification.
- Try again the SSL websocket test, will revert the commit if not fixed.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1586150 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AbstractServletOutputStream.java
index 2bde3103d3..b612ecd215 100644
--- a/java/org/apache/coyote/http11/InternalNio2InputBuffer.java
+++ b/java/org/apache/coyote/http11/InternalNio2InputBuffer.java
@@ -905,7 +905,7 @@ public class InternalNio2InputBuffer extends AbstractInputBuffer<Nio2Channel> {
             if (readPending) {
                 interest = true;
             } else {
-                // If no write is pending, notify
+                // If no read is pending, notify
                 endpoint.processSocket(socket, SocketStatus.OPEN_READ, true);
             }
         }

==================================================
Nio2ServletOutputStream.java
index f236a983cb..c8e207bb4f 100644
--- a/java/org/apache/coyote/http11/upgrade/AbstractServletOutputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/AbstractServletOutputStream.java
@@ -76,6 +76,9 @@ public abstract class AbstractServletOutputStream<S> extends ServletOutputStream
         synchronized (fireListenerLock) {
             boolean result = (buffer == null);
             fireListener = !result;
+            if (fireListener) {
+                registerWriteInterest();
+            }
             return result;
         }
     }
@@ -236,4 +239,8 @@ public abstract class AbstractServletOutputStream<S> extends ServletOutputStream
     protected abstract void doFlush() throws IOException;
 
     protected abstract void doClose() throws IOException;
+
+    protected void registerWriteInterest() {
+    }
+
 }

==================================================
TestWebSocketFrameClientSSL.java
index ba82ebed96..0a4e7d9f84 100644
--- a/java/org/apache/coyote/http11/upgrade/Nio2ServletOutputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/Nio2ServletOutputStream.java
@@ -175,4 +175,15 @@ public class Nio2ServletOutputStream extends AbstractServletOutputStream<Nio2Cha
     protected void doClose() throws IOException {
         channel.close(true);
     }
+
+    @Override
+    protected void registerWriteInterest() {
+        synchronized (completionHandler) {
+            if (writePending.availablePermits() > 0) {
+                // If no write is pending, notify
+                endpoint.processSocket(socketWrapper, SocketStatus.OPEN_WRITE, true);
+            }
+        }
+    }
+
 }

==================================================
