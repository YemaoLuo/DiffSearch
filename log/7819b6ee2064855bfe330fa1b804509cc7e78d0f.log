7819b6ee2064855bfe330fa1b804509cc7e78d0f
==================================================
Add MBean for Membership component.
==================================================
Keiichi Fujino
==================================================
Mon Apr 10 08:16:13 2017 +0000
==================================================
McastService.java
Add MBean for Membership component.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1790791 13f79535-47bb-0310-9956-ffa450edef68



==================================================
McastServiceMBean.java
index a34e3d21f6..dbdbd012fd 100644
--- a/java/org/apache/catalina/tribes/membership/McastService.java
+++ b/java/org/apache/catalina/tribes/membership/McastService.java
@@ -21,6 +21,8 @@ import java.io.IOException;
 import java.net.DatagramPacket;
 import java.util.Properties;
 
+import javax.management.ObjectName;
+
 import org.apache.catalina.tribes.Channel;
 import org.apache.catalina.tribes.ChannelException;
 import org.apache.catalina.tribes.ChannelMessage;
@@ -30,6 +32,7 @@ import org.apache.catalina.tribes.MembershipService;
 import org.apache.catalina.tribes.MessageListener;
 import org.apache.catalina.tribes.io.ChannelData;
 import org.apache.catalina.tribes.io.XByteBuffer;
+import org.apache.catalina.tribes.jmx.JmxRegistry;
 import org.apache.catalina.tribes.util.Arrays;
 import org.apache.catalina.tribes.util.StringManager;
 import org.apache.catalina.tribes.util.UUIDGenerator;
@@ -42,7 +45,8 @@ import org.apache.juli.logging.LogFactory;
  * This class is responsible for maintaining a list of active cluster nodes in the cluster.
  * If a node fails to send out a heartbeat, the node will be dismissed.
  */
-public class McastService implements MembershipService,MembershipListener,MessageListener {
+public class McastService
+        implements MembershipService,MembershipListener,MessageListener, McastServiceMBean {
 
     private static final Log log = LogFactory.getLog(McastService.class);
 
@@ -80,6 +84,11 @@ public class McastService implements MembershipService,MembershipListener,Messag
 
     private Channel channel;
 
+    /**
+     * the ObjectName of this McastService. 
+     */
+    private ObjectName oname = null;
+
     /**
      * Create a membership service.
      */
@@ -363,7 +372,11 @@ public class McastService implements MembershipService,MembershipListener,Messag
         impl.setChannel(channel);
 
         impl.start(level);
-
+        // register jmx
+        JmxRegistry jmxRegistry = JmxRegistry.getRegistry(channel);
+        if (jmxRegistry != null) {
+            this.oname = jmxRegistry.registerJmx(",component=Membership", this);
+        }
 
     }
 
@@ -375,6 +388,10 @@ public class McastService implements MembershipService,MembershipListener,Messag
     public void stop(int svc) {
         try  {
             if ( impl != null && impl.stop(svc) ) {
+                if (oname != null) {
+                    JmxRegistry.getRegistry(channel).unregisterJmx(oname);
+                    oname = null;
+                }
                 impl.setChannel(null);
                 impl = null;
                 channel = null;

==================================================
