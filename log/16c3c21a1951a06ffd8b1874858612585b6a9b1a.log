16c3c21a1951a06ffd8b1874858612585b6a9b1a
==================================================
Replicate Principal in ClusterSingleSignOn.
==================================================
Keiichi Fujino
==================================================
Thu Mar 8 08:39:02 2012 +0000
==================================================
ClusterSingleSignOn.java
Replicate Principal in ClusterSingleSignOn.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1298296 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ClusterSingleSignOnListener.java
index ad2158bbb3..044b349cdd 100644
--- a/java/org/apache/catalina/ha/authenticator/ClusterSingleSignOn.java
+++ b/java/org/apache/catalina/ha/authenticator/ClusterSingleSignOn.java
@@ -31,6 +31,8 @@ import org.apache.catalina.Session;
 import org.apache.catalina.authenticator.SingleSignOn;
 import org.apache.catalina.ha.CatalinaCluster;
 import org.apache.catalina.ha.ClusterManager;
+import org.apache.catalina.ha.session.SerializablePrincipal;
+import org.apache.catalina.realm.GenericPrincipal;
 import org.apache.tomcat.util.ExceptionUtils;
 
 
@@ -293,6 +295,12 @@ public class ClusterSingleSignOn extends SingleSignOn {
             msg.setUsername(username);
             msg.setPassword(password);
 
+            SerializablePrincipal sp = null;
+            if (principal instanceof GenericPrincipal) {
+                sp = SerializablePrincipal.createPrincipal((GenericPrincipal) principal);
+                msg.setPrincipal(sp);
+            }
+
             cluster.send(msg);
             if (containerLog.isDebugEnabled()) {
                 containerLog.debug("SingleSignOnMessage Send with action "
@@ -352,6 +360,12 @@ public class ClusterSingleSignOn extends SingleSignOn {
             msg.setUsername(username);
             msg.setPassword(password);
 
+            SerializablePrincipal sp = null;
+            if (principal instanceof GenericPrincipal) {
+                sp = SerializablePrincipal.createPrincipal((GenericPrincipal) principal);
+                msg.setPrincipal(sp);
+            }
+
             cluster.send(msg);
             if (containerLog.isDebugEnabled()) {
                 containerLog.debug("SingleSignOnMessage Send with action "

==================================================
SingleSignOnMessage.java
index 53315094d5..62104b6c4e 100644
--- a/java/org/apache/catalina/ha/authenticator/ClusterSingleSignOnListener.java
+++ b/java/org/apache/catalina/ha/authenticator/ClusterSingleSignOnListener.java
@@ -18,6 +18,7 @@
 package org.apache.catalina.ha.authenticator;
 
 import java.io.IOException;
+import java.security.Principal;
 import java.util.Map;
 
 import org.apache.catalina.Session;
@@ -76,6 +77,7 @@ public class ClusterSingleSignOnListener extends ClusterListener {
             SingleSignOnMessage msg = (SingleSignOnMessage) myobj;
             int action = msg.getAction();
             Session session = null;
+            Principal principal = null;
 
             if (log.isDebugEnabled())
                 log.debug("SingleSignOnMessage Received with action "
@@ -98,11 +100,17 @@ public class ClusterSingleSignOnListener extends ClusterListener {
                 clusterSSO.deregisterLocal(msg.getSsoId());
                 break;
             case SingleSignOnMessage.REGISTER_SESSION:
-                clusterSSO.registerLocal(msg.getSsoId(), null, msg.getAuthType(),
+                if (msg.getPrincipal() != null) {
+                    principal = msg.getPrincipal().getPrincipal();
+                }
+                clusterSSO.registerLocal(msg.getSsoId(), principal, msg.getAuthType(),
                                          msg.getUsername(), msg.getPassword());
                 break;
             case SingleSignOnMessage.UPDATE_SESSION:
-                clusterSSO.updateLocal(msg.getSsoId(), null, msg.getAuthType(),
+                if (msg.getPrincipal() != null) {
+                    principal = msg.getPrincipal().getPrincipal();
+                }
+                clusterSSO.updateLocal(msg.getSsoId(), principal, msg.getAuthType(),
                                        msg.getUsername(), msg.getPassword());
                 break;
             case SingleSignOnMessage.REMOVE_SESSION:

==================================================
