d754fec74ad84f090f893b9e6d05231d0b6cfaf5
==================================================
Fix failing unit test and Gump with BIO
==================================================
Mark Emlyn
==================================================
Tue Sep 3 19:04:00 2013 +0000
==================================================
CoyoteInputStream.java
Fix failing unit test and Gump with BIO
Make the test for having to call isReady() before any non-blocking read or write stricter. Previously, an app would get away with this if isReady() would have returned true if it had been called.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1519798 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CoyoteOutputStream.java
index 02aad199c1..2a2780cf3d 100644
--- a/java/org/apache/catalina/connector/CoyoteInputStream.java
+++ b/java/org/apache/catalina/connector/CoyoteInputStream.java
@@ -40,6 +40,7 @@ public class CoyoteInputStream extends ServletInputStream {
 
 
     protected InputBuffer ib;
+    private volatile Boolean ready = null;
 
 
     protected CoyoteInputStream(InputBuffer ib) {
@@ -240,7 +241,8 @@ public class CoyoteInputStream extends ServletInputStream {
 
     @Override
     public boolean isReady() {
-        return ib.isReady();
+        ready = Boolean.valueOf(ib.isReady());
+        return ready.booleanValue();
     }
 
 
@@ -251,9 +253,10 @@ public class CoyoteInputStream extends ServletInputStream {
 
 
     private void checkNonBlockingRead() {
-        if (ib.isBlocking() && !ib.isReady()) {
+        if (ib.isBlocking() && (ready == null || !ready.booleanValue())) {
             throw new IllegalStateException(
                     sm.getString("coyoteInputStream.nbNotready"));
         }
+        ready = null;
     }
 }

==================================================
