ea1438235a266f36413b322743f53d7ac9bc6800
==================================================
Retain thread safety for ContainerBase.realm but don't try and
==================================================
Mark Emlyn
==================================================
Tue Nov 29 21:57:04 2011 +0000
==================================================
ContainerBase.java
Retain thread safety for ContainerBase.realm but don't try and
start/stop it multiple times

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1208096 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardContext.java
index 03cc7cb78d..102f92d0fe 100644
--- a/java/org/apache/catalina/core/ContainerBase.java
+++ b/java/org/apache/catalina/core/ContainerBase.java
@@ -710,14 +710,23 @@ public abstract class ContainerBase extends LifecycleMBeanBase
                 return (realm);
             if (parent != null)
                 return (parent.getRealm());
-            return (null);
+            return null;
         } finally {
             l.unlock();
         }
-
     }
 
 
+    protected Realm getRealmInternal() {
+        Lock l = realmLock.readLock();
+        try {
+            l.lock();
+            return realm;
+        } finally {
+            l.unlock();
+        }
+    }
+
     /**
      * Set the Realm with which this Container is associated.
      *
@@ -1082,7 +1091,7 @@ public abstract class ContainerBase extends LifecycleMBeanBase
             ((Lifecycle) manager).start();
         if ((cluster != null) && (cluster instanceof Lifecycle))
             ((Lifecycle) cluster).start();
-        Realm realm = getRealm();
+        Realm realm = getRealmInternal();
         if ((realm != null) && (realm instanceof Lifecycle))
             ((Lifecycle) realm).start();
         if ((resources != null) && (resources instanceof Lifecycle))
@@ -1169,7 +1178,7 @@ public abstract class ContainerBase extends LifecycleMBeanBase
         if ((resources != null) && (resources instanceof Lifecycle)) {
             ((Lifecycle) resources).stop();
         }
-        Realm realm = getRealm();
+        Realm realm = getRealmInternal();
         if ((realm != null) && (realm instanceof Lifecycle)) {
             ((Lifecycle) realm).stop();
         }
@@ -1321,7 +1330,7 @@ public abstract class ContainerBase extends LifecycleMBeanBase
                 log.warn(sm.getString("containerBase.backgroundProcess.manager", manager), e);
             }
         }
-        Realm realm = getRealm();
+        Realm realm = getRealmInternal();
         if (realm != null) {
             try {
                 realm.backgroundProcess();

==================================================
