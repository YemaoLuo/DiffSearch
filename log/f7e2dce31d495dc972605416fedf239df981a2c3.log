f7e2dce31d495dc972605416fedf239df981a2c3
==================================================
Move count down connections to the shared close
==================================================
remm remm@apache.org
==================================================
Wed Nov 6 18:11:39 2019 +0100
==================================================
AprEndpoint.java
Move count down connections to the shared close


==================================================
Nio2Endpoint.java
index 6361756054..0315075f0f 100644
--- a/java/org/apache/tomcat/util/net/AprEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AprEndpoint.java
@@ -791,7 +791,6 @@ public class AprEndpoint extends AbstractEndpoint<Long,Long> implements SNICallB
         // are closed when calling stop() followed by start().
         if (socket != 0) {
             Socket.destroy(socket);
-            countDownConnection();
         }
     }
 

==================================================
NioEndpoint.java
index afb875706d..6ecba6a6df 100644
--- a/java/org/apache/tomcat/util/net/Nio2Endpoint.java
+++ b/java/org/apache/tomcat/util/net/Nio2Endpoint.java
@@ -917,7 +917,6 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel,AsynchronousS
             }
             try {
                 synchronized (getSocket()) {
-                    getEndpoint().countDownConnection();
                     if (getSocket().isOpen()) {
                         getSocket().close(true);
                     }

==================================================
SocketWrapperBase.java
index 0cb33f6857..d059a70c73 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -1165,7 +1165,6 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel,SocketChannel>
             }
             try {
                 synchronized (getSocket()) {
-                    getEndpoint().countDownConnection();
                     if (getSocket().isOpen()) {
                         getSocket().close(true);
                     }

==================================================
