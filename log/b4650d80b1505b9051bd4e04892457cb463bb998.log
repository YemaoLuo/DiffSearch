b4650d80b1505b9051bd4e04892457cb463bb998
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53257
==================================================
Mark Emlyn
==================================================
Thu May 31 20:18:49 2012 +0000
==================================================
ApplicationContext.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53257
BZ 53257 is partially a regression caused by r1152593 (the fix for BZ 51584) and partially an existing issue that had always been present.
This patch:
- reverts r1152593
- extends the test cases to cover BZ 53257 & BZ 51584
- correctly fixes BZ 53257 & BZ 51584
- fixes the additional issues the unit tests uncovered

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1344890 13f79535-47bb-0310-9956-ffa450edef68



==================================================
DirContextURLConnection.java
index b6c01f0975..9c28cf5e7d 100644
--- a/java/org/apache/catalina/core/ApplicationContext.java
+++ b/java/org/apache/catalina/core/ApplicationContext.java
@@ -14,14 +14,12 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
-
 package org.apache.catalina.core;
 
-
 import java.io.InputStream;
 import java.lang.reflect.InvocationTargetException;
 import java.net.MalformedURLException;
+import java.net.URI;
 import java.net.URL;
 import java.util.ArrayList;
 import java.util.Collections;
@@ -69,7 +67,6 @@ import org.apache.catalina.connector.Connector;
 import org.apache.catalina.deploy.FilterDef;
 import org.apache.catalina.util.ResourceSet;
 import org.apache.catalina.util.ServerInfo;
-import org.apache.naming.resources.DirContextURLStreamHandler;
 import org.apache.naming.resources.Resource;
 import org.apache.tomcat.util.ExceptionUtils;
 import org.apache.tomcat.util.buf.CharChunk;
@@ -520,9 +517,8 @@ public class ApplicationContext
             String hostName = context.getParent().getName();
             try {
                 resources.lookup(normPath);
-                return new URL
-                    ("jndi", "", 0, getJNDIUri(hostName, fullPath),
-                     new DirContextURLStreamHandler(resources));
+                return new URI("jndi",
+                        getJNDIUri(hostName, fullPath), null).toURL();
             } catch (NamingException e) {
                 // Ignore
             } catch (Exception e) {

==================================================
TestCompiler.java
index e42a8cad8e..711384f6d1 100644
--- a/res/checkstyle/org-import-control.xml
+++ b/res/checkstyle/org-import-control.xml
@@ -106,6 +106,7 @@
     <allow pkg="javax.mail"/>
     <allow pkg="javax.wsdl"/>
     <allow pkg="org.apache.naming"/>
+    <allow class="org.apache.tomcat.util.buf.UDecoder"/>
     <allow class="org.apache.tomcat.util.http.FastHttpDateFormat"/>
     <allow class="org.apache.tomcat.util.http.RequestUtil"/>
     <subpackage name="factory.webservices">

==================================================
