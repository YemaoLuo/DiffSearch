ff687b5524b2b78c449fe32e8c520da86068cd1a
==================================================
Improve CSRF prevention filter by exposing the request's current nonce to the request.
==================================================
Christopher Schultz
==================================================
0500
==================================================
Constants.java
Improve CSRF prevention filter by exposing the request's current nonce to the request.



==================================================
CsrfPreventionFilter.java
index 4fe41cd0e8..87dd6c4ab3 100644
--- a/java/org/apache/catalina/filters/Constants.java
+++ b/java/org/apache/catalina/filters/Constants.java
@@ -25,12 +25,34 @@ package org.apache.catalina.filters;
  */
 public final class Constants {
 
+    /**
+     * The session attribute key under which the CSRF nonce
+     * cache will be stored.
+     */
     public static final String CSRF_NONCE_SESSION_ATTR_NAME =
         "org.apache.catalina.filters.CSRF_NONCE";
 
+    /**
+     * The request attribute key under which the current
+     * requests's CSRF nonce can be found.
+     */
+    public static final String CSRF_NONCE_REQUEST_ATTR_NAME =
+        "org.apache.catalina.filters.CSRF_REQUEST_NONCE";
+
+    /**
+     * The name of the request parameter which carries CSRF nonces
+     * from the client to the server for validation.
+     */
     public static final String CSRF_NONCE_REQUEST_PARAM =
         "org.apache.catalina.filters.CSRF_NONCE";
 
+    /**
+     * The servlet context attribute key under which the
+     * CSRF request parameter name can be found.
+     */
+    public static final String CSRF_NONCE_REQUEST_PARAM_NAME_KEY =
+        "org.apache.catalina.filters.CSRF_NONCE_PARAM_NAME";
+
     public static final String METHOD_GET = "GET";
 
     public static final String CSRF_REST_NONCE_HEADER_NAME = "X-CSRF-Token";
@@ -39,6 +61,17 @@ public final class Constants {
 
     public static final String CSRF_REST_NONCE_HEADER_REQUIRED_VALUE = "Required";
 
+    /**
+     * The session attribute key under which the CSRF REST nonce
+     * cache will be stored.
+     */
     public static final String CSRF_REST_NONCE_SESSION_ATTR_NAME =
         "org.apache.catalina.filters.CSRF_REST_NONCE";
+
+    /**
+     * The servlet context attribute key under which the
+     * CSRF REST header name can be found.
+     */
+    public static final String CSRF_REST_NONCE_HEDAER_NAME_KEY =
+        "org.apache.catalina.filters.CSRF_REST_NONCE_HEADER_NAME";
 }

==================================================
CsrfPreventionFilterBase.java
index fff5c2fedb..d94cdec43d 100644
--- a/java/org/apache/catalina/filters/CsrfPreventionFilter.java
+++ b/java/org/apache/catalina/filters/CsrfPreventionFilter.java
@@ -128,6 +128,11 @@ public class CsrfPreventionFilter extends CsrfPreventionFilterBase {
 
             nonceCache.add(newNonce);
 
+            // Take this request's nonce and put it into the request
+            // attributes so pages can make direct use of it, rather than
+            // requiring the use of response.encodeURL.
+            request.setAttribute(Constants.CSRF_NONCE_REQUEST_ATTR_NAME, newNonce);
+
             wResponse = new CsrfResponseWrapper(res, newNonce);
         } else {
             wResponse = response;

==================================================
