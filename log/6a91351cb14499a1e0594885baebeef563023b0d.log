6a91351cb14499a1e0594885baebeef563023b0d
==================================================
Separate validation of *.jspx and *.tagx files into a new option.
==================================================
Mark Emlyn
==================================================
Fri Nov 22 10:05:31 2013 +0000
==================================================
Context.java
Separate validation of *.jspx and *.tagx files into a new option.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1544460 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Globals.java
index b7d25501f8..46a822fe81 100644
--- a/java/org/apache/catalina/Context.java
+++ b/java/org/apache/catalina/Context.java
@@ -591,7 +591,7 @@ public interface Context extends Container {
 
     /**
      * Controls whether the parsing of web.xml and web-fragment.xml files for
-     * this Context be performed by a namespace aware parser.
+     * this Context will be performed by a namespace aware parser.
      *
      * @param xmlNamespaceAware true to enable namespace awareness
      */
@@ -609,13 +609,31 @@ public interface Context extends Container {
 
     /**
      * Controls whether the parsing of web.xml, web-fragment.xml and *.tld files
-     * for this Context be performed by a validating parser.
+     * for this Context will be performed by a validating parser.
      *
      * @param xmlValidation true to enable xml validation
      */
     public void setXmlValidation(boolean xmlValidation);
 
 
+    /**
+     * Will the parsing of *.jspx and *.tagx files for this Context be performed
+     * by a validating parser?
+     *
+     * @return true if validation is enabled.
+     */
+    public boolean getXmlValidationJspDoc();
+
+
+    /**
+     * Controls whether the parsing of *.jspx and *.tagx files for this Context
+     * will be performed by a validating parser.
+     *
+     * @param xmlValidationJspDoc true to enable xml validation
+     */
+    public void setXmlValidationJspDoc(boolean xmlValidationJspDoc);
+
+
     /**
      * Get the Jar Scanner to be used to scan for JAR resources for this
      * context.

==================================================
StandardContext.java
index afa3ac32f3..e9fb78eae3 100644
--- a/java/org/apache/catalina/Globals.java
+++ b/java/org/apache/catalina/Globals.java
@@ -273,10 +273,20 @@ public final class Globals {
 
     /**
      * Name of the ServletContext attribute that determines if the JSP engine
-     * should validate *.tld, *.jspx and *.tagx files when parsing them.
+     * should validate *.tld files when parsing them.
      * <p>
      * This must be kept in sync with org.apache.japser.Constants
      */
     public static final String JASPER_XML_VALIDATION_ATTR =
             "org.apache.jasper.XML_VALIDATE";
+
+
+    /**
+     * Name of the ServletContext attribute that determines if the JSP engine
+     * should validate *.jspx and *.tagx files when parsing them.
+     * <p>
+     * This must be kept in sync with org.apache.japser.Constants
+     */
+    public static final String JASPER_XML_VALIDATION_DOC_ATTR =
+            "org.apache.jasper.XML_VALIDATE_DOC";
 }

==================================================
FailedContext.java
index efe6a6a56b..8454a046aa 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -694,6 +694,13 @@ public class StandardContext extends ContainerBase
     private boolean xmlValidation = Globals.STRICT_SERVLET_COMPLIANCE;
 
 
+    /**
+     * Attribute value used to turn on/off XML validation for *.jspx and *.tagx
+     * files.
+     */
+    private boolean xmlValidationJspDoc = false;
+
+
     /**
      * Attribute value used to turn on/off XML namespace validation
      */
@@ -6376,6 +6383,18 @@ public class StandardContext extends ContainerBase
     }
 
 
+    @Override
+    public void setXmlValidationJspDoc(boolean webXmlValidationJspDoc){
+        this.xmlValidationJspDoc = webXmlValidationJspDoc;
+    }
+
+
+    @Override
+    public boolean getXmlValidationJspDoc(){
+        return xmlValidationJspDoc;
+    }
+
+
     @Override
     public boolean getXmlNamespaceAware(){
         return xmlNamespaceAware;

==================================================
Constants.java
index 81174c293b..fc5aecc27e 100644
--- a/java/org/apache/catalina/startup/FailedContext.java
+++ b/java/org/apache/catalina/startup/FailedContext.java
@@ -455,6 +455,11 @@ public class FailedContext extends LifecycleMBeanBase implements Context {
     @Override
     public void setXmlValidation(boolean xmlValidation) { /* NO-OP */ }
 
+    @Override
+    public boolean getXmlValidationJspDoc() { return false; }
+    @Override
+    public void setXmlValidationJspDoc(boolean xmlValidationJspDoc) { /* NO-OP */ }
+
     @Override
     public JarScanner getJarScanner() { return null; }
     @Override

==================================================
JspDocumentParser.java
index 5f54238a34..17e6ab7e59 100644
--- a/java/org/apache/jasper/Constants.java
+++ b/java/org/apache/jasper/Constants.java
@@ -154,9 +154,18 @@ public class Constants {
 
     /**
      * Name of the ServletContext attribute that determines if the XML parsers
-     * used for *.tld, *.jspx and *.tagx files will be validating or not.
+     * used for *.tld files will be validating or not.
      * <p>
      * This must be kept in sync with org.apache.catalina.Globals
      */
     public static final String XML_VALIDATION_ATTR = "org.apache.jasper.XML_VALIDATE";
+
+
+    /**
+     * Name of the ServletContext attribute that determines if the XML parsers
+     * used for *.jspx and *.tagx files will be validating or not.
+     * <p>
+     * This must be kept in sync with org.apache.catalina.Globals
+     */
+    public static final String XML_VALIDATION_DOC_ATTR = "org.apache.jasper.XML_VALIDATE_DOC";
 }

==================================================
TesterContext.java
index 57bbca663b..36ef56d81d 100644
--- a/java/org/apache/jasper/compiler/JspDocumentParser.java
+++ b/java/org/apache/jasper/compiler/JspDocumentParser.java
@@ -166,7 +166,7 @@ class JspDocumentParser
 
             boolean validate = Boolean.parseBoolean(
                     pc.getJspCompilationContext().getServletContext().getInitParameter(
-                            Constants.XML_VALIDATION_ATTR));
+                            Constants.XML_VALIDATION_DOC_ATTR));
             jspDocParser.isValidating = validate;
 
             // Parse the input

==================================================
