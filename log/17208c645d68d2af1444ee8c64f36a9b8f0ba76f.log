17208c645d68d2af1444ee8c64f36a9b8f0ba76f
==================================================
Expand tests and fix escaping issue in userRoleAttribute filter
==================================================
Mark Thomas
==================================================
Tue Apr 13 12:20:06 2021 +0100
==================================================
JNDIRealm.java
Expand tests and fix escaping issue in userRoleAttribute filter



==================================================
TestJNDIRealmIntegration.java
index cdb9f9e387..59a56d8b70 100644
--- a/java/org/apache/catalina/realm/JNDIRealm.java
+++ b/java/org/apache/catalina/realm/JNDIRealm.java
@@ -1883,11 +1883,13 @@ public class JNDIRealm extends RealmBase {
             return list;
         }
 
-        // Set up parameters for an appropriate search
+        // Set up parameters for an appropriate search filter
+        // The dn is already attribute value escaped but the others are not
+        // This is a filter so all input will require filter escaping
         String filter = connection.roleFormat.format(new String[] {
                 doFilterEscaping(dn),
                 doFilterEscaping(doAttributeValueEscaping(username)),
-                userRoleId });
+                doFilterEscaping(doAttributeValueEscaping(userRoleId)) });
         SearchControls controls = new SearchControls();
         if (roleSubtree) {
             controls.setSearchScope(SearchControls.SUBTREE_SCOPE);

==================================================
