0339feceaa7268fde35fa10f1dddec4abc1106c7
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54807
==================================================
Mark Emlyn
==================================================
Fri Apr 19 19:25:49 2013 +0000
==================================================
WsServerContainer.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54807
Forgot to create TreeSet with correct Comparator. Add a test case that checks the context starts correctly.

Also, TemplatePathMatchComparator is thread-safe so use a single instance rather than creating multiple instances.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1469997 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestWebSocketServerContainer.java
index a5153661cf..bce3c19ffe 100644
--- a/java/org/apache/tomcat/websocket/server/WsServerContainer.java
+++ b/java/org/apache/tomcat/websocket/server/WsServerContainer.java
@@ -138,7 +138,8 @@ public class WsServerContainer extends WsWebSocketContainer
             SortedSet<TemplatePathMatch> templateMatches =
                     configTemplateMatchMap.get(key);
             if (templateMatches == null) {
-                templateMatches = new TreeSet<>();
+                templateMatches = new TreeSet<>(
+                        TemplatePathMatchComparator.getInstance());
                 configTemplateMatchMap.put(key, templateMatches);
             }
             templateMatches.add(new TemplatePathMatch(sec, uriTemplate));
@@ -204,8 +205,8 @@ public class WsServerContainer extends WsWebSocketContainer
             SortedSet<TemplatePathMatch> templateMatches =
                     configTemplateMatchMap.get(key);
             if (templateMatches == null) {
-                templateMatches =
-                        new TreeSet<>(new TemplatePathMatchComparator());
+                templateMatches = new TreeSet<>(
+                        TemplatePathMatchComparator.getInstance());
                 configTemplateMatchMap.put(key, templateMatches);
             }
             templateMatches.add(new TemplatePathMatch(sec, uriTemplate));
@@ -308,9 +309,24 @@ public class WsServerContainer extends WsWebSocketContainer
     }
 
 
+    /**
+     * This Comparator implementation is thread-safe so only create a single
+     * instance.
+     */
     private static class TemplatePathMatchComparator
             implements Comparator<TemplatePathMatch> {
 
+        private static final TemplatePathMatchComparator INSTANCE =
+                new TemplatePathMatchComparator();
+
+        public static TemplatePathMatchComparator getInstance() {
+            return INSTANCE;
+        }
+
+        private TemplatePathMatchComparator() {
+            // Hide default constructor
+        }
+
         @Override
         public int compare(TemplatePathMatch tpm1, TemplatePathMatch tpm2) {
             return tpm1.getUriTemplate().getNormalizedPath().compareTo(

==================================================
