7fefc08b68348f0b545e695ba0e91e643e3ea53b
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53047
==================================================
Mark Emlyn
==================================================
Sat Jun 9 20:30:44 2012 +0000
==================================================
DataSourceRealm.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53047
If the Realm is configured for an authentication only all roles mode and no role table or column is defined, don't populate the Principal's roles

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1348498 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JDBCRealm.java
index 962b9edf5c..10767c059d 100644
--- a/java/org/apache/catalina/realm/DataSourceRealm.java
+++ b/java/org/apache/catalina/realm/DataSourceRealm.java
@@ -500,6 +500,12 @@ public class DataSourceRealm extends RealmBase {
     protected ArrayList<String> getRoles(Connection dbConnection,
                                      String username) {
 
+        if (allRolesMode != AllRolesMode.STRICT_MODE && !isRoleStoreDefined()) {
+            // Using an authentication only configuration and no role store has
+            // been defined so don't spend cycles looking
+            return null;
+        }
+
         ResultSet rs = null;
         PreparedStatement stmt = null;
         ArrayList<String> list = null;
@@ -579,8 +585,13 @@ public class DataSourceRealm extends RealmBase {
 
     }
 
-    // ------------------------------------------------------ Lifecycle Methods
 
+    private boolean isRoleStoreDefined() {
+        return userRoleTable != null || roleNameCol != null;
+    }
+
+
+    // ------------------------------------------------------ Lifecycle Methods
 
     /**
      * Prepare for the beginning of active use of the public methods of this

==================================================
