b730f9f1f12910de3d38e3fc7415db16ad7c5a1a
==================================================
Revert fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=56555 which, after further discussion, was classed as INVALID.
==================================================
Mark Emlyn
==================================================
Mon Jun 2 12:23:24 2014 +0000
==================================================
AbstractHttp11Processor.java
Revert fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=56555 which, after further discussion, was classed as INVALID.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1599183 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAbstractHttp11Processor.java
index 8c6a51f7d6..f5af6dc63c 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Processor.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Processor.java
@@ -1478,8 +1478,11 @@ public abstract class AbstractHttp11Processor<S> extends AbstractProcessor<S> {
         // Connection: close header.
         keepAlive = keepAlive && !statusDropsConnection(statusCode);
         if (!keepAlive) {
-            headers.setValue(Constants.CONNECTION).setString(
-                    Constants.CLOSE);
+            // Avoid adding the close header twice
+            if (!connectionClosePresent) {
+                headers.addValue(Constants.CONNECTION).setString(
+                        Constants.CLOSE);
+            }
         } else if (!http11 && !error) {
             headers.addValue(Constants.CONNECTION).setString(Constants.KEEPALIVE);
         }

==================================================
