d554f6f1f4624646076aceb197b2e59e21bc2547
==================================================
Improvements to connection handling
==================================================
Filip Hanik
==================================================
Mon Oct 27 22:24:26 2008 +0000
==================================================
ConnectionPool.java
Improvements to connection handling


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@708354 13f79535-47bb-0310-9956-ffa450edef68



==================================================
PooledConnection.java
index 1b594f32c9..f2b94504ea 100644
--- a/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
+++ b/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
@@ -409,13 +409,15 @@ public class ConnectionPool {
     protected PooledConnection createConnection(long now, PooledConnection con) {
         //no connections where available we'll create one
         boolean error = false;
+        boolean inbusy = true;
         try {
             //connect and validate the connection
             con = create();
             con.lock();
             if (!busy.offer(con)) {
+                inbusy = false;
                 log.debug("Connection doesn't fit into busy array, connection will not be traceable.");
-            }
+            } 
             con.connect();
             if (con.validate(PooledConnection.VALIDATE_INIT)) {
                 //no need to lock a new one, its not contented
@@ -424,6 +426,10 @@ public class ConnectionPool {
                     con.setStackTrace(getThreadDump());
                 }
                 return con;
+            } else {
+                //validation failed, make sure we disconnect
+                //and clean up
+                error =true;
             } //end if
         } catch (Exception e) {
             error = true;
@@ -431,7 +437,7 @@ public class ConnectionPool {
         } finally {
             if (error ) {
                 release(con);
-                busy.remove(con);
+                if (inbusy) busy.remove(con);
             }
             con.unlock();
         }//catch

==================================================
