bd4a02f62440f7a2a02bd5e726a341eb84d10ad2
==================================================
Correctly handle two stage close process.
==================================================
Mark Emlyn
==================================================
Fri Mar 15 20:40:53 2013 +0000
==================================================
WsFrameBase.java
index bea2a56742..f4479ccb0c 100644
--- a/java/org/apache/tomcat/websocket/LocalStrings.properties
+++ b/java/org/apache/tomcat/websocket/LocalStrings.properties
@@ -51,6 +51,7 @@ wsSession.duplicateHandlerBinary=A binary message handler has already been confi
 wsSession.duplicateHandlerPong=A pong message handler has already been configured
 wsSession.duplicateHandlerText=A text message handler has already been configured
 wsSession.expireFailed=Unable to close expired session cleanly
+wsSession.sendCloseFail=Failed to send close message to remote endpoint
 wsSession.invalidHandlerTypePong=A pong message handler must implement MessageHandler.Basic
 wsSession.removeHandlerFailed=Unable to remove the handler [{0}] as it was not registered with this session
 wsSession.unknownHandler=Unable to add the message handler [{0}] as it was for the unrecognised type [{1}]

==================================================
WsRemoteEndpointImplBase.java
index e20c0ba8e5..6970209b82 100644
--- a/java/org/apache/tomcat/websocket/WsFrameBase.java
+++ b/java/org/apache/tomcat/websocket/WsFrameBase.java
@@ -283,7 +283,7 @@ public abstract class WsFrameBase {
                     reason = controlBufferText.toString();
                 }
             }
-            wsSession.close(new CloseReason(Util.getCloseCode(code), reason));
+            wsSession.onClose(new CloseReason(Util.getCloseCode(code), reason));
         } else if (opCode == Constants.OPCODE_PING) {
             if (wsSession.isOpen()) {
                 wsSession.getBasicRemote().sendPong(controlBufferBinary);

==================================================
WsSession.java
index 82ef05ad23..116a21bbf1 100644
--- a/java/org/apache/tomcat/websocket/WsRemoteEndpointImplBase.java
+++ b/java/org/apache/tomcat/websocket/WsRemoteEndpointImplBase.java
@@ -243,12 +243,8 @@ public abstract class WsRemoteEndpointImplBase implements RemoteEndpoint {
             boolean dataMessage) {
         synchronized (messagePartLock) {
 
-            if (closed) {
-                close();
-            } else {
-                fragmented = nextFragmented;
-                text = nextText;
-            }
+            fragmented = nextFragmented;
+            text = nextText;
 
             if (dataMessage) {
                 dataMessageInProgress = false;

==================================================
