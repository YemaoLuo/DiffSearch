7d8f1d52ffff3def5c18ed7ac71b0f4ec73b801d
==================================================
Improve logging behaviour when shutdown occurs via a shutdownhook. If present, use Catalina's shutdown hook to shutdown Tomcat and JULI. This enables them to be shutdown in the correct order.
==================================================
Mark Emlyn
==================================================
Wed Feb 17 13:51:37 2010 +0000
==================================================
Catalina.java
Improve logging behaviour when shutdown occurs via a shutdownhook. If present, use Catalina's shutdown hook to shutdown Tomcat and JULI. This enables them to be shutdown in the correct order.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@910974 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ClassLoaderLogManager.java
index a7c722a8cb..4fd68491e0 100644
--- a/java/org/apache/catalina/startup/Catalina.java
+++ b/java/org/apache/catalina/startup/Catalina.java
@@ -28,11 +28,13 @@ import java.net.Socket;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.List;
+import java.util.logging.LogManager;
 
 import org.apache.catalina.Container;
 import org.apache.catalina.Lifecycle;
 import org.apache.catalina.LifecycleException;
 import org.apache.catalina.core.StandardServer;
+import org.apache.juli.ClassLoaderLogManager;
 import org.apache.tomcat.util.digester.Digester;
 import org.apache.tomcat.util.digester.Rule;
 import org.xml.sax.Attributes;
@@ -572,6 +574,15 @@ public class Catalina extends Embedded {
                     shutdownHook = new CatalinaShutdownHook();
                 }
                 Runtime.getRuntime().addShutdownHook(shutdownHook);
+                
+                // If JULI is being used, disable JULI's shutdown hook since
+                // shutdown hooks run in parallel and log messages may be lost
+                // if JULI's hook completes before the CatalinaShutdownHook()
+                LogManager logManager = LogManager.getLogManager();
+                if (logManager instanceof ClassLoaderLogManager) {
+                    ((ClassLoaderLogManager) logManager).setUseShutdownHook(
+                            false);
+                }
             }
         } catch (Throwable t) {
             // This will fail on JDK 1.2. Ignoring, as Tomcat can run
@@ -652,6 +663,13 @@ public class Catalina extends Embedded {
                 Catalina.this.stop();
             }
             
+            // If JULI is used, shut JULI down *after* the server shuts down
+            // so log messages aren't lost
+            LogManager logManager = LogManager.getLogManager();
+            if (logManager instanceof ClassLoaderLogManager) {
+                ((ClassLoaderLogManager) logManager).shutdown();
+            }
+
         }
 
     }

==================================================
