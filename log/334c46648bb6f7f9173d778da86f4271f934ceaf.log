334c46648bb6f7f9173d778da86f4271f934ceaf
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54387
==================================================
Mark Emlyn
==================================================
Thu Jan 10 12:06:50 2013 +0000
==================================================
WebXml.java
index 9067ddb1e1..8629b9e20c 100644
--- a/java/org/apache/catalina/deploy/LocalStrings.properties
+++ b/java/org/apache/catalina/deploy/LocalStrings.properties
@@ -22,6 +22,7 @@ webXml.duplicateMessageDestination=Duplicate message-destination name [{0}]
 webXml.duplicateMessageDestinationRef=Duplicate message-destination-ref name [{0}]
 webXml.duplicateResourceEnvRef=Duplicate resource-env-ref name [{0}]
 webXml.duplicateResourceRef=Duplicate resource-ref name [{0}]
+webXml.duplicateServletMapping=The servlets named [{0}] and [{1}] are both mapped to the url-pattern [{2}] which is not permitted
 webXml.duplicateTaglibUri=Duplicate tag library URI [{0}]
 webXml.reservedName=A web.xml file was detected using a reserved name [{0}]. The name element will be ignored for this fragment.
 webXml.mergeConflictDisplayName=The display name was defined in multiple fragments with different values including fragment with name [{0}] located at [{1}]

==================================================
TestWebXml.java
index 1248deb216..081b512543 100644
--- a/java/org/apache/catalina/deploy/WebXml.java
+++ b/java/org/apache/catalina/deploy/WebXml.java
@@ -327,7 +327,14 @@ public class WebXml {
     private final Map<String,String> servletMappings = new HashMap<>();
     private final Set<String> servletMappingNames = new HashSet<>();
     public void addServletMapping(String urlPattern, String servletName) {
-        servletMappings.put(urlPattern, servletName);
+        String oldServletName = servletMappings.put(urlPattern, servletName);
+        if (oldServletName != null) {
+            // Duplicate mapping. As per clarification from the Servlet EG,
+            // deployment should fail.
+            throw new IllegalArgumentException(sm.getString(
+                    "webXml.duplicateServletMapping", oldServletName,
+                    servletName, urlPattern));
+        }
         servletMappingNames.add(servletName);
     }
     public Map<String,String> getServletMappings() { return servletMappings; }

==================================================
