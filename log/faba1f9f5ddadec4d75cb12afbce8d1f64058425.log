faba1f9f5ddadec4d75cb12afbce8d1f64058425
==================================================
Ported test to validate JASPIC DIGEST implementation 
==================================================
Mark Thomas
==================================================
Fri Jun 26 08:07:37 2015 +0000
==================================================
DigestAuthModule.java
Ported test to validate JASPIC DIGEST implementation 
Patch by fjodorver

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1687710 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestJaspicDigestAuthenticator.java
index 85002b727f..202dbf7cc4 100644
--- a/java/org/apache/catalina/authenticator/jaspic/provider/modules/DigestAuthModule.java
+++ b/java/org/apache/catalina/authenticator/jaspic/provider/modules/DigestAuthModule.java
@@ -238,18 +238,13 @@ public class DigestAuthModule extends TomcatAuthModule {
 
         DigestInfo digestInfo = new DigestInfo(getOpaque(), getNonceValidity(), getKey(), nonces,
                 isValidateUri(), getRealmName());
-        if (authorization == null) {
 
+        if (authorization == null || !digestInfo.parse(request, authorization)) {
             String nonce = generateNonce(request);
-
             String authenticateHeader = getAuthenticateHeader(nonce, false);
             return sendUnauthorizedError(response, authenticateHeader);
         }
 
-        if (!digestInfo.parse(request, authorization)) {
-            return AuthStatus.SEND_FAILURE;
-        }
-
         if (digestInfo.validate(request)) {
             principal = digestInfo.authenticate(realm);
         }

==================================================
