cb69c4a027e3a25636eddd830750835a483e2009
==================================================
Fix various NIO2 sendfile issues discovered while testing ciphers, and refactor to optimize its behavior.
==================================================
Remy Maucherat
==================================================
Thu Jul 10 20:21:55 2014 +0000
==================================================
Http11Nio2Processor.java
Fix various NIO2 sendfile issues discovered while testing ciphers, and refactor to optimize its behavior.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1609564 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Nio2Endpoint.java
index c57c87e3e2..6abd2004b8 100644
--- a/java/org/apache/coyote/http11/Http11Nio2Processor.java
+++ b/java/org/apache/coyote/http11/Http11Nio2Processor.java
@@ -280,17 +280,21 @@ public class Http11Nio2Processor extends AbstractHttp11Processor<Nio2Channel> {
         if (sendfileData != null && !getErrorState().isError()) {
             ((Nio2Endpoint.Nio2SocketWrapper) socketWrapper).setSendfileData(sendfileData);
             sendfileData.keepAlive = keepAlive;
-            if (((Nio2Endpoint) endpoint).processSendfile(
-                    (Nio2Endpoint.Nio2SocketWrapper) socketWrapper)) {
-                sendfileInProgress = true;
-            } else {
+            switch (((Nio2Endpoint) endpoint)
+                    .processSendfile((Nio2Endpoint.Nio2SocketWrapper) socketWrapper)) {
+            case DONE:
+                return false;
+            case ERROR:
                 // Write failed
                 if (log.isDebugEnabled()) {
                     log.debug(sm.getString("http11processor.sendfile.error"));
                 }
                 setErrorState(ErrorState.CLOSE_NOW, null);
+                return true;
+            case PENDING:
+                sendfileInProgress = true;
+                return true;
             }
-            return true;
         }
         return false;
     }

==================================================
