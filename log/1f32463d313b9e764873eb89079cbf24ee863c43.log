1f32463d313b9e764873eb89079cbf24ee863c43
==================================================
Fix 66530 - Regression in fix for BZ 66442. Ensure count is decremented
==================================================
Mark Thomas
==================================================
Fri Mar 17 09:23:05 2023 +0000
==================================================
Http2AsyncUpgradeHandler.java
Fix 66530 - Regression in fix for BZ 66442. Ensure count is decremented

https://bz.apache.org/bugzilla/show_bug.cgi?id=66530


==================================================
Http2UpgradeHandler.java
index 629924e02e..5eee67451c 100644
--- a/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
@@ -203,7 +203,7 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
             }
         }
         if (endOfStream) {
-            stream.sentEndOfStream();
+            sentEndOfStream(stream);
         }
     }
 
@@ -227,10 +227,7 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
         header[3] = FrameType.DATA.getIdByte();
         if (finished) {
             header[4] = FLAG_END_OF_STREAM;
-            stream.sentEndOfStream();
-            if (!stream.isActive()) {
-                setConnectionTimeoutForStreamCount(activeRemoteStreamCount.decrementAndGet());
-            }
+            sentEndOfStream(stream);
         }
         if (writable) {
             ByteUtil.set31Bits(header, 5, stream.getIdAsInt());
@@ -350,10 +347,7 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
             header[3] = FrameType.DATA.getIdByte();
             if (finished) {
                 header[4] = FLAG_END_OF_STREAM;
-                sendfile.stream.sentEndOfStream();
-                if (!sendfile.stream.isActive()) {
-                    setConnectionTimeoutForStreamCount(activeRemoteStreamCount.decrementAndGet());
-                }
+                sentEndOfStream(sendfile.stream);
             }
             if (writable) {
                 if (log.isDebugEnabled()) {
@@ -434,10 +428,7 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
                 header[3] = FrameType.DATA.getIdByte();
                 if (finished) {
                     header[4] = FLAG_END_OF_STREAM;
-                    sendfile.stream.sentEndOfStream();
-                    if (!sendfile.stream.isActive()) {
-                        setConnectionTimeoutForStreamCount(activeRemoteStreamCount.decrementAndGet());
-                    }
+                    sentEndOfStream(sendfile.stream);
                 }
                 if (writable) {
                     if (log.isDebugEnabled()) {

==================================================
