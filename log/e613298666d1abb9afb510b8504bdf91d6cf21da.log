e613298666d1abb9afb510b8504bdf91d6cf21da
==================================================
Implement equals/hashCode so that they survive connection closure
==================================================
Filip Hanik
==================================================
Tue Aug 7 00:14:50 2012 +0000
==================================================
DisposableConnectionFacade.java
Implement equals/hashCode so that they survive connection closure



git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1370074 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JdbcInterceptor.java
index e93f4b67a3..5d88b930e5 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/DisposableConnectionFacade.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/DisposableConnectionFacade.java
@@ -17,6 +17,7 @@
 package org.apache.tomcat.jdbc.pool;
 
 import java.lang.reflect.Method;
+import java.lang.reflect.Proxy;
 import java.sql.SQLException;
 
 /**
@@ -44,10 +45,26 @@ public class DisposableConnectionFacade extends JdbcInterceptor {
     public void reset(ConnectionPool parent, PooledConnection con) {
     }
 
+
+
+    @Override
+    public int hashCode() {
+        return System.identityHashCode(this);
+    }
+
+    @Override
+    public boolean equals(Object obj) {
+        return this==obj;
+    }
+
     @Override
     public Object invoke(Object proxy, Method method, Object[] args)
             throws Throwable {
-        if (getNext()==null) {
+        if (compare(EQUALS_VAL, method)) {
+            return this.equals(Proxy.getInvocationHandler(args[0]));
+        } else if (compare(HASHCODE_VAL, method)) {
+            return this.hashCode();
+        } else if (getNext()==null) {
             if (compare(ISCLOSED_VAL, method)) {
                 return Boolean.TRUE;
             }

==================================================
EqualsHashCodeTest.java
index 3ed85441ee..00b8056e9d 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/JdbcInterceptor.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/JdbcInterceptor.java
@@ -66,6 +66,16 @@ public abstract class JdbcInterceptor implements InvocationHandler {
      */
     public static final String ISVALID_VAL = "isValid";
 
+    /**
+     * {@link java.lang.Object#equals(Object)}
+     */
+    public static final String EQUALS_VAL = "equals";
+
+    /**
+     * {@link java.lang.Object#hashCode()}
+     */
+    public static final String HASHCODE_VAL = "hashCode";
+
     /**
      * Properties for this interceptor.
      */

==================================================
