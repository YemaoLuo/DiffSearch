4e963c982eaa33024b97935a4d235d186f1b923b
==================================================
Fix getPrincipal logic
==================================================
remm remm@apache.org
==================================================
Fri Jun 4 16:28:59 2021 +0200
==================================================
UserDatabaseRealm.java
Fix getPrincipal logic

Also improve tests.


==================================================
TestGenericPrincipal.java
index bb27099b07..6c5f474939 100644
--- a/java/org/apache/catalina/realm/UserDatabaseRealm.java
+++ b/java/org/apache/catalina/realm/UserDatabaseRealm.java
@@ -148,7 +148,16 @@ public class UserDatabaseRealm extends RealmBase {
      */
     @Override
     protected Principal getPrincipal(String username) {
-        return new UserDatabasePrincipal(username);
+        UserDatabase database = getUserDatabase();
+        if (database == null) {
+            return null;
+        }
+        User user = database.findUser(username);
+        if (user == null) {
+            return null;
+        } else {
+            return new UserDatabasePrincipal(user);
+        }
     }
 
 
@@ -225,21 +234,13 @@ public class UserDatabaseRealm extends RealmBase {
         private static final long serialVersionUID = 1L;
         private final User user;
 
-        public UserDatabasePrincipal(String username) {
-            super(username);
-            UserDatabase database = getUserDatabase();
-            if (database == null) {
-                user = null;
-            } else {
-                user = database.findUser(username);
-            }
+        public UserDatabasePrincipal(User user) {
+            super(user.getName());
+            this.user = user;
         }
 
         @Override
         public String[] getRoles() {
-            if (user == null) {
-                return super.getRoles();
-            }
             Set<String> roles = new HashSet<>();
             Iterator<Role> uroles = user.getRoles();
             while (uroles.hasNext()) {
@@ -266,7 +267,7 @@ public class UserDatabaseRealm extends RealmBase {
                 return false;
             }
             UserDatabase database = getUserDatabase();
-            if (user == null || database == null) {
+            if (database == null) {
                 return super.hasRole(role);
             }
             Role dbrole = database.findRole(role);

==================================================
MemoryUserDatabaseTests.java
index b2ac92fedd..5a994156e6 100644
--- a/test/org/apache/catalina/realm/TestGenericPrincipal.java
+++ b/test/org/apache/catalina/realm/TestGenericPrincipal.java
@@ -56,13 +56,6 @@ public class TestGenericPrincipal {
         doTest(gpIn);
     }
 
-    @Test
-    public void testSerialize04() throws ClassNotFoundException, IOException {
-        UserDatabaseRealm realm = new UserDatabaseRealm();
-        GenericPrincipal gpIn = realm.new UserDatabasePrincipal(USER);
-        doTest(gpIn);
-    }
-
     private void doTest(GenericPrincipal gpIn)
             throws ClassNotFoundException, IOException {
         GenericPrincipal gpOut = serializeAndDeserialize(gpIn);

==================================================
