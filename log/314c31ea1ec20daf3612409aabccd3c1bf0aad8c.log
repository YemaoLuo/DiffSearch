314c31ea1ec20daf3612409aabccd3c1bf0aad8c
==================================================
Fix regression that broke support for unencrypted PKCS#1 keys
==================================================
Mark Thomas
==================================================
Thu May 26 08:18:01 2022 +0100
==================================================
PEMFile.java
Fix regression that broke support for unencrypted PKCS#1 keys


==================================================
TestPEMFile.java
index 80c585d3b8..03abf596d7 100644
--- a/java/org/apache/tomcat/util/net/jsse/PEMFile.java
+++ b/java/org/apache/tomcat/util/net/jsse/PEMFile.java
@@ -143,7 +143,13 @@ public class PEMFile {
                     privateKey = part.toPrivateKey(password, keyAlgorithm, Format.PKCS8);
                     break;
                 case Part.RSA_PRIVATE_KEY:
-                    privateKey = part.toPrivateKey(password, keyAlgorithm, Format.PKCS1);
+                    if (part.algorithm == null) {
+                        // If no encryption algorithm was detected, ignore any
+                        // (probably default) key password provided.
+                        privateKey = part.toPrivateKey(null, keyAlgorithm, Format.PKCS1);
+                    } else {
+                        privateKey = part.toPrivateKey(password, keyAlgorithm, Format.PKCS1);
+                    }
                     break;
                 case Part.CERTIFICATE:
                 case Part.X509_CERTIFICATE:

==================================================
