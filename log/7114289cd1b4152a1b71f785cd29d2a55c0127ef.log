7114289cd1b4152a1b71f785cd29d2a55c0127ef
==================================================
Add debug for TestFlowControl as it appears to un unstable
==================================================
Mark Thomas
==================================================
Tue Mar 16 20:49:49 2021 +0000
==================================================
Http2UpgradeHandler.java
Add debug for TestFlowControl as it appears to un unstable


==================================================
Stream.java
index a8e0a85e3e..7e7fe631cc 100644
--- a/java/org/apache/coyote/http2/LocalStrings.properties
+++ b/java/org/apache/coyote/http2/LocalStrings.properties
@@ -96,6 +96,7 @@ stream.inputBuffer.empty=The Stream input buffer is empty. Waiting for more data
 stream.inputBuffer.readTimeout=Timeout waiting to read data from client
 stream.inputBuffer.reset=Stream reset
 stream.inputBuffer.signal=Data added to inBuffer when read thread is waiting. Signalling that thread to continue
+stream.inputBuffer.swallowUnread=Swallowing [{0}] bytes previous read into input stream buffer
 stream.notWritable=Connection [{0}], Stream [{1}], This stream is not writable
 stream.outputBuffer.flush.debug=Connection [{0}], Stream [{1}], flushing output with buffer at position [{2}], writeInProgress [{3}] and closed [{4}]
 stream.recycle=Connection [{0}], Stream [{1}] has been recycled
@@ -138,6 +139,7 @@ upgradeHandler.reset.receive=Connection [{0}], Stream [{1}], Reset received due
 upgradeHandler.rst.debug=Connection [{0}], Stream [{1}], Error [{2}], Message [{3}],  RST (closing stream)
 upgradeHandler.sendPrefaceFail=Connection [{0}], Failed to send preface to client
 upgradeHandler.socketCloseFailed=Error closing socket
+upgradeHandler.startRequestBodyFrame.result=Connection [{0}], Stream [{1}] startRequestBodyFrame returned [{2}]
 upgradeHandler.stream.closed=Stream [{0}] has been closed for some time
 upgradeHandler.stream.even=A new remote stream ID of [{0}] was requested but all remote streams must use odd identifiers
 upgradeHandler.stream.notWritable=Connection [{0}], Stream [{1}], This stream is not writable

==================================================
TestFlowControl.java
index 5929cda1dd..37b15335d1 100644
--- a/java/org/apache/coyote/http2/Stream.java
+++ b/java/org/apache/coyote/http2/Stream.java
@@ -1194,6 +1194,9 @@ class Stream extends AbstractNonZeroStream implements HeaderEmitter {
                 synchronized (inputBuffer) {
                     closed = true;
                     int unreadByteCount = inBuffer.position();
+                    if (log.isDebugEnabled()) {
+                        log.debug(sm.getString("stream.inputBuffer.swallowUnread", Integer.valueOf(unreadByteCount)));
+                    }
                     if (unreadByteCount > 0) {
                         inBuffer.position(0);
                         inBuffer.limit(inBuffer.limit() - unreadByteCount);

==================================================
