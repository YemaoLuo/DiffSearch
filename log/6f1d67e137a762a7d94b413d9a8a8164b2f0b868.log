6f1d67e137a762a7d94b413d9a8a8164b2f0b868
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=59189
==================================================
Mark Thomas
==================================================
Fri Mar 18 11:22:30 2016 +0000
==================================================
PerMessageDeflate.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=59189
Explicitly release the native memory held by the Inflater and Deflater when using PerMessageDeflate and the WebSocket session ends.
Based on a patch by Henrik Olsson.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1735577 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Transformation.java
index 9d275794de..513cf08bfa 100644
--- a/java/org/apache/tomcat/websocket/PerMessageDeflate.java
+++ b/java/org/apache/tomcat/websocket/PerMessageDeflate.java
@@ -460,4 +460,13 @@ public class PerMessageDeflate implements Transformation {
         }
         return result;
     }
+
+
+    @Override
+    public void close() {
+        // There will always be a next transformation
+        next.close();
+        inflater.end();
+        deflater.end();
+    }
 }

==================================================
WsFrameBase.java
index 1d094035ad..5186181b65 100644
--- a/java/org/apache/tomcat/websocket/Transformation.java
+++ b/java/org/apache/tomcat/websocket/Transformation.java
@@ -103,4 +103,9 @@ public interface Transformation {
      *          may be bigger or smaller than the size of the input list
      */
     List<MessagePart> sendMessagePart(List<MessagePart> messageParts);
+
+    /**
+     * Clean-up any resources that were used by the transformation.
+     */
+    void close();
 }

==================================================
WsRemoteEndpointImplBase.java
index f4f58b2420..12b53f51f7 100644
--- a/java/org/apache/tomcat/websocket/WsFrameBase.java
+++ b/java/org/apache/tomcat/websocket/WsFrameBase.java
@@ -737,6 +737,11 @@ public abstract class WsFrameBase {
         public boolean validateRsv(int rsv, byte opCode) {
             return rsv == 0;
         }
+
+        @Override
+        public void close() {
+            // NO-OP for the terminal transformations
+        }
     }
 
 

==================================================
