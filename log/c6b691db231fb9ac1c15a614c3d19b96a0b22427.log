c6b691db231fb9ac1c15a614c3d19b96a0b22427
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53337
==================================================
Mark Emlyn
==================================================
Sun Jun 3 15:50:50 2012 +0000
==================================================
ApplicationDispatcher.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53337
Fix RequestDispatcher.forward() to an async servlet

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1345688 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index aced5a1c80..11eda0fbc1 100644
--- a/java/org/apache/catalina/core/ApplicationDispatcher.java
+++ b/java/org/apache/catalina/core/ApplicationDispatcher.java
@@ -382,6 +382,12 @@ final class ApplicationDispatcher
             processRequest(request,response,state);
         }
 
+        if (request.getAsyncContext() != null) {
+            // An async request was started during the forward, don't close the
+            // response as it may be written to during the async handling
+            return;
+        }
+
         // This is not a real close in order to support error processing
         if (wrapper.getLogger().isDebugEnabled() )
             wrapper.getLogger().debug(" Disabling the response for futher output");

==================================================
