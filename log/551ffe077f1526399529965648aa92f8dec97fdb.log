551ffe077f1526399529965648aa92f8dec97fdb
==================================================
Fix for bug 43741. Correctly handle dependencies for tag files in JARs.
==================================================
Mark Emlyn
==================================================
Mon Feb 4 22:58:21 2008 +0000
==================================================
JspCompilationContext.java
Fix for bug 43741. Correctly handle dependencies for tag files in JARs.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@618481 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Compiler.java
index 0fe40f3db0..fe667c876c 100644
--- a/java/org/apache/jasper/JspCompilationContext.java
+++ b/java/org/apache/jasper/JspCompilationContext.java
@@ -279,9 +279,29 @@ public class JspCompilationContext {
 
 
     public URL getResource(String res) throws MalformedURLException {
-        return context.getResource(canonicalURI(res));
+        URL result = null;
+
+        if (res.startsWith("/META-INF/")) {
+            // This is a tag file packaged in a jar that is being compiled
+            URL jarUrl = tagFileJarUrls.get(res);
+            if (jarUrl == null) {
+                jarUrl = tagFileJarUrl;
+            }
+            if (jarUrl != null) {
+                result = new URL(jarUrl.toExternalForm() + res.substring(1));
+            }
+        } else if (res.startsWith("jar:file:")) {
+                // This is a tag file packaged in a jar that is being checked
+                // for a dependency
+                result = new URL(res);
+
+        } else {
+            result = context.getResource(canonicalURI(res));
+        }
+        return result;
     }
 
+
     public Set getResourcePaths(String path) {
         return context.getResourcePaths(canonicalURI(path));
     }
@@ -554,7 +574,7 @@ public class JspCompilationContext {
     
     public void compile() throws JasperException, FileNotFoundException {
         createCompiler();
-        if (isPackagedTagFile || jspCompiler.isOutDated()) {
+        if (jspCompiler.isOutDated()) {
             try {
                 jspCompiler.removeGeneratedFiles();
                 jspLoader = null;

==================================================
TagFileProcessor.java
index 8b4e32fdc0..353750faac 100644
--- a/java/org/apache/jasper/compiler/Compiler.java
+++ b/java/org/apache/jasper/compiler/Compiler.java
@@ -23,6 +23,7 @@ import java.io.FileOutputStream;
 import java.io.OutputStreamWriter;
 import java.io.PrintWriter;
 import java.io.UnsupportedEncodingException;
+import java.net.JarURLConnection;
 import java.net.URL;
 import java.net.URLConnection;
 import java.util.Iterator;
@@ -384,7 +385,12 @@ public abstract class Compiler {
                 return false;
             }
             URLConnection uc = jspUrl.openConnection();
-            jspRealLastModified = uc.getLastModified();
+            if (uc instanceof JarURLConnection) {
+                jspRealLastModified =
+                    ((JarURLConnection) uc).getJarEntry().getTime();
+            } else {
+                jspRealLastModified = uc.getLastModified();
+            }
             uc.getInputStream().close();
         } catch (Exception e) {
             return true;
@@ -435,9 +441,15 @@ public abstract class Compiler {
                     return true;
                 }
 
-                URLConnection includeUconn = includeUrl.openConnection();
-                long includeLastModified = includeUconn.getLastModified();
-                includeUconn.getInputStream().close();
+                URLConnection iuc = includeUrl.openConnection();
+                long includeLastModified = 0;
+                if (iuc instanceof JarURLConnection) {
+                    includeLastModified =
+                        ((JarURLConnection) iuc).getJarEntry().getTime();
+                } else {
+                    includeLastModified = iuc.getLastModified();
+                }
+                iuc.getInputStream().close();
 
                 if (includeLastModified > targetLastModified) {
                     return true;

==================================================
