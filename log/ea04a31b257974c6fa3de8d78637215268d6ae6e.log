ea04a31b257974c6fa3de8d78637215268d6ae6e
==================================================
If an error status is set during async processing, don't drop the connection and let the async processing handle it
==================================================
Mark Emlyn
==================================================
Wed May 18 17:16:26 2011 +0000
==================================================
Http11AprProcessor.java
If an error status is set during async processing, don't drop the connection and let the async processing handle it

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1124340 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11NioProcessor.java
index 98d15d0e5a..a6cb615056 100644
--- a/java/org/apache/coyote/http11/Http11AprProcessor.java
+++ b/java/org/apache/coyote/http11/Http11AprProcessor.java
@@ -311,7 +311,8 @@ public class Http11AprProcessor extends AbstractHttp11Processor {
                     // committed, so we can't try and set headers.
                     if(keepAlive && !error) { // Avoid checking twice.
                         error = response.getErrorException() != null ||
-                                statusDropsConnection(response.getStatus());
+                                (!isAsync() &&
+                                statusDropsConnection(response.getStatus()));
                     }
                 } catch (InterruptedIOException e) {
                     error = true;

==================================================
Http11Processor.java
index e774b7f1d7..609d33722c 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -401,7 +401,8 @@ public class Http11NioProcessor extends AbstractHttp11Processor {
                     // committed, so we can't try and set headers.
                     if(keepAlive && !error) { // Avoid checking twice.
                         error = response.getErrorException() != null ||
-                                statusDropsConnection(response.getStatus());
+                                (!isAsync() &&
+                                statusDropsConnection(response.getStatus()));
                     }
                     // Comet support
                     SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());

==================================================
