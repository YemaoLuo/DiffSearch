f4c39506d8b0d5e37ea9f404d16b236cd1f7de70
==================================================
Process HTTP/0.9 requests with extra request line data as HTTP/1.1
==================================================
Mark Thomas
==================================================
Tue Mar 24 09:50:02 2020 +0000
==================================================
Http11InputBuffer.java
Process HTTP/0.9 requests with extra request line data as HTTP/1.1

https://bz.apache.org/bugzilla/show_bug.cgi?id=64240


==================================================
TestHttp11InputBufferCRLF.java
index 7be3e01e60..289a0bcf3d 100644
--- a/java/org/apache/coyote/http11/Http11InputBuffer.java
+++ b/java/org/apache/coyote/http11/Http11InputBuffer.java
@@ -462,6 +462,9 @@ public class Http11InputBuffer implements InputBuffer, ApplicationBufferHandler
                     request.protocol().setString(Constants.HTTP_11);
                     throw new IllegalArgumentException(sm.getString("iib.invalidRequestTarget"));
                 }
+                if (chr == '<') {
+                    System.out.println("debug");
+                }
                 if (chr == Constants.SP || chr == Constants.HT) {
                     space = true;
                     end = pos;
@@ -471,9 +474,10 @@ public class Http11InputBuffer implements InputBuffer, ApplicationBufferHandler
                     // HTTP/0.9 style request
                     // Stop this processing loop
                     space = true;
+                    // Set blank protocol (indicates HTTP/0.9)
+                    request.protocol().setString("");
                     // Skip the protocol processing
-                    parsingRequestLinePhase = 6;
-                    parsingRequestLineEol = true;
+                    parsingRequestLinePhase = 7;
                     if (prevChr == Constants.CR) {
                         end = pos - 1;
                     } else {
@@ -504,7 +508,9 @@ public class Http11InputBuffer implements InputBuffer, ApplicationBufferHandler
                 request.requestURI().setBytes(byteBuffer.array(), parsingRequestLineStart,
                         end - parsingRequestLineStart);
             }
-            if (!parsingRequestLineEol) {
+            // HTTP/0.9 processing jumps to stage 7.
+            // Don't want to overwrite that here.
+            if (parsingRequestLinePhase == 4) {
                 parsingRequestLinePhase = 5;
             }
         }
@@ -557,9 +563,12 @@ public class Http11InputBuffer implements InputBuffer, ApplicationBufferHandler
             if ((end - parsingRequestLineStart) > 0) {
                 request.protocol().setBytes(byteBuffer.array(), parsingRequestLineStart,
                         end - parsingRequestLineStart);
-            } else {
-                request.protocol().setString("");
+                parsingRequestLinePhase = 7;
             }
+            // If no protocol is found, the ISE below will be triggered.
+        }
+        if (parsingRequestLinePhase == 7) {
+            // Parsing is complete. Return and clean-up.
             parsingRequestLine = false;
             parsingRequestLinePhase = 0;
             parsingRequestLineEol = false;

==================================================
