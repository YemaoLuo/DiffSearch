4a760b9a34a953c4c8389855f29ab7e4b9b6204b
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=45282
==================================================
Mark Emlyn
==================================================
Mon Oct 6 22:14:09 2014 +0000
==================================================
NioReceiver.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=45282
Improve shutdown of NIO receiver so that sockets are closed cleanly.
This is essentially the patch that Filip suggested in the bug report with some additional refactoring by me.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1629776 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ExceptionUtils.java
index fd90b5dc32..a6f6a54070 100644
--- a/java/org/apache/catalina/tribes/transport/nio/NioReceiver.java
+++ b/java/org/apache/catalina/tribes/transport/nio/NioReceiver.java
@@ -37,6 +37,7 @@ import org.apache.catalina.tribes.transport.AbstractRxTask;
 import org.apache.catalina.tribes.transport.Constants;
 import org.apache.catalina.tribes.transport.ReceiverBase;
 import org.apache.catalina.tribes.transport.RxTaskPool;
+import org.apache.catalina.tribes.util.ExceptionUtils;
 import org.apache.catalina.tribes.util.StringManager;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
@@ -315,12 +316,7 @@ public class NioReceiver extends ReceiverBase implements Runnable {
             } catch (java.nio.channels.CancelledKeyException nx) {
                 log.warn(sm.getString("NioReceiver.clientDisconnect"));
             } catch (Throwable t) {
-                if (t instanceof ThreadDeath) {
-                    throw (ThreadDeath) t;
-                }
-                if (t instanceof VirtualMachineError) {
-                    throw (VirtualMachineError) t;
-                }
+                ExceptionUtils.handleThrowable(t);
                 log.error(sm.getString("NioReceiver.requestError"), t);
             }
 
@@ -388,6 +384,12 @@ public class NioReceiver extends ReceiverBase implements Runnable {
         } catch (ClosedSelectorException ignore){
             // Ignore
         }
+        try {
+            selector.selectNow();
+        } catch (Throwable t){
+            ExceptionUtils.handleThrowable(t);
+            // Ignore everything else
+        }
         selector.close();
     }
 

==================================================
