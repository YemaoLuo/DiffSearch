1160149ea11f837f05648202fe0ada1f5d705351
==================================================
Ensure that clear the channel instance from channel services when stopping channel.
==================================================
Keiichi Fujino
==================================================
Thu Apr 21 06:21:43 2016 +0000
==================================================
ChannelCoordinator.java
Ensure that clear the channel instance from channel services when stopping channel.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1740236 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ChannelInterceptorBase.java
index 930962de81..67461720d6 100644
--- a/java/org/apache/catalina/tribes/group/ChannelCoordinator.java
+++ b/java/org/apache/catalina/tribes/group/ChannelCoordinator.java
@@ -247,7 +247,7 @@ public class ChannelCoordinator extends ChannelInterceptorBase implements Messag
             }
 
             startLevel = (startLevel & (~svc));
-
+            channel = null;
         } catch (Exception x) {
             throw new ChannelException(x);
         }

==================================================
McastService.java
index 67aed3f180..acf367b116 100644
--- a/java/org/apache/catalina/tribes/group/ChannelInterceptorBase.java
+++ b/java/org/apache/catalina/tribes/group/ChannelInterceptorBase.java
@@ -171,6 +171,7 @@ public abstract class ChannelInterceptorBase implements ChannelInterceptor {
     @Override
     public void stop(int svc) throws ChannelException {
         if (getNext() != null) getNext().stop(svc);
+        channel = null;
     }
 
     @Override

==================================================
ReceiverBase.java
index 181de95dbb..590421b05b 100644
--- a/java/org/apache/catalina/tribes/membership/McastService.java
+++ b/java/org/apache/catalina/tribes/membership/McastService.java
@@ -374,7 +374,11 @@ public class McastService implements MembershipService,MembershipListener,Messag
     @Override
     public void stop(int svc) {
         try  {
-            if ( impl != null && impl.stop(svc) ) impl = null;
+            if ( impl != null && impl.stop(svc) ) {
+                impl.setChannel(null);
+                impl = null;
+                channel = null;
+            }
         } catch ( Exception x)  {
             log.error(sm.getString(
                     "McastService.stopFail", Integer.valueOf(svc)), x);

==================================================
ReplicationTransmitter.java
index 7ef1389788..568c298725 100644
--- a/java/org/apache/catalina/tribes/transport/ReceiverBase.java
+++ b/java/org/apache/catalina/tribes/transport/ReceiverBase.java
@@ -100,6 +100,7 @@ public abstract class ReceiverBase implements ChannelReceiver, ListenCallback, R
     public void stop() {
         if ( executor != null ) executor.shutdownNow();//ignore left overs
         executor = null;
+        channel = null;
     }
 
     /**

==================================================
