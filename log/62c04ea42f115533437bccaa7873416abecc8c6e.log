62c04ea42f115533437bccaa7873416abecc8c6e
==================================================
Fixed test cases that errored due to path case sentsitivity on Windows
==================================================
Igal Sapir
==================================================
Tue Oct 2 21:39:57 2018 +0000
==================================================
TomcatBaseTest.java
Fixed test cases that errored due to path case sentsitivity on Windows

e.g. Testcase: testNestedJarGetURL took 2.628 sec
 FAILED
expected:<jar:war:file:/[e]:/Workspace/git/tomc...> but was:<jar:war:file:/[E]:/Workspace/git/tomc...>
junit.framework.AssertionFailedError: expected:<jar:war:file:/[e]:/Workspace/git/tomc...> but was:<jar:war:file:/[E]:/Workspace/git/tomc...>
 at org.apache.catalina.webresources.TestAbstractArchiveResource.testNestedJarGetURL(TestAbstractArchiveResource.java:51)

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1842657 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAbstractArchiveResource.java
index 0fd2286277..4a4afebd02 100644
--- a/test/org/apache/catalina/startup/TomcatBaseTest.java
+++ b/test/org/apache/catalina/startup/TomcatBaseTest.java
@@ -88,6 +88,7 @@ public abstract class TomcatBaseTest extends LoggingBaseTest {
     protected static final int DEFAULT_CLIENT_TIMEOUT_MS = 300_000;
 
     public static final String TEMP_DIR = System.getProperty("java.io.tmpdir");
+    public static final String OS_NAME = System.getProperty("os.name");
 
     /**
      * Make the Tomcat instance available to sub-classes.
@@ -148,6 +149,13 @@ public abstract class TomcatBaseTest extends LoggingBaseTest {
         return accessLogEnabled;
     }
 
+    /*
+     * Sub-classes may need to test differently on Windows, e.g. case-insensitive file paths
+     */
+    public boolean isWindows() {
+        return OS_NAME.startsWith("Windows");
+    }
+
     @Before
     @Override
     public void setUp() throws Exception {

==================================================
TestFileResource.java
index a24f06cd59..c4fcb4c0b5 100644
--- a/test/org/apache/catalina/webresources/TestAbstractArchiveResource.java
+++ b/test/org/apache/catalina/webresources/TestAbstractArchiveResource.java
@@ -48,7 +48,15 @@ public class TestAbstractArchiveResource extends TomcatBaseTest {
         expectedURL.append(docBase.getAbsoluteFile().toURI().toURL().toString());
         expectedURL.append("*/WEB-INF/lib/test.jar!/META-INF/resources/index.html");
 
-        Assert.assertEquals(expectedURL.toString(), webResource.getURL().toString());
+        String expected = expectedURL.toString();
+        String actual = webResource.getURL().toString();
+
+        if (isWindows()){
+            expected = expected.toLowerCase();
+            actual = actual.toLowerCase();
+        }
+
+        Assert.assertEquals(expected, actual);
     }
 
 
@@ -71,7 +79,15 @@ public class TestAbstractArchiveResource extends TomcatBaseTest {
         expectedURL.append(docBase.getAbsoluteFile().toURI().toURL().toString());
         expectedURL.append("WEB-INF/lib/test-lib.jar!/META-INF/tags/echo.tag");
 
-        Assert.assertEquals(expectedURL.toString(), webResource.getURL().toString());
+        String expected = expectedURL.toString();
+        String actual = webResource.getURL().toString();
+
+        if (isWindows()){
+            expected = expected.toLowerCase();
+            actual = actual.toLowerCase();
+        }
+
+        Assert.assertEquals(expected, actual);
     }
 
 }

==================================================
Http2TestBase.java
index 160359ce96..aa90339198 100644
--- a/test/org/apache/catalina/webresources/TestFileResource.java
+++ b/test/org/apache/catalina/webresources/TestFileResource.java
@@ -40,6 +40,15 @@ public class TestFileResource extends TomcatBaseTest {
 
         // Build the expected location the same way the webapp base dir is built
         File f = new File("test/webapp/WEB-INF/classes");
-        Assert.assertEquals(f.toURI().toURL().toString(), out.toString().trim());
+
+        String expected = f.toURI().toURL().toString();
+        String actual = out.toString().trim();
+
+        if (isWindows()){
+            expected = expected.toLowerCase();
+            actual = actual.toLowerCase();
+        }
+
+        Assert.assertEquals(expected, actual);
     }
 }

==================================================
