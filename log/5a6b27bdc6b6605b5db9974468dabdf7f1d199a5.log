5a6b27bdc6b6605b5db9974468dabdf7f1d199a5
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53545
==================================================
Mark Emlyn
==================================================
Sat Aug 11 09:43:19 2012 +0000
==================================================
PageContextImpl.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53545
Ensure buffered data is cleared when using a jsp:forward action to a static resource inside classic a custom tag

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1371896 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestPageContextImpl.java
index 5f2b6a1562..1fb25d9931 100644
--- a/java/org/apache/jasper/runtime/PageContextImpl.java
+++ b/java/org/apache/jasper/runtime/PageContextImpl.java
@@ -715,6 +715,7 @@ public class PageContextImpl extends PageContext {
         // JSP.4.5 If the buffer was flushed, throw IllegalStateException
         try {
             out.clear();
+            baseOut.clear();
         } catch (IOException ex) {
             IllegalStateException ise = new IllegalStateException(Localizer
                     .getMessage("jsp.error.attempt_to_clear_flushed_buffer"));

==================================================
Bug53545.java
new file mode 100644
index 0000000000..444d195146
--- /dev/null
+++ b/test/org/apache/jasper/runtime/TestPageContextImpl.java
@@ -0,0 +1,53 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.jasper.runtime;
+
+import java.io.File;
+
+import javax.servlet.http.HttpServletResponse;
+
+import junit.framework.Assert;
+
+import org.junit.Test;
+
+import org.apache.catalina.startup.Tomcat;
+import org.apache.catalina.startup.TomcatBaseTest;
+import org.apache.tomcat.util.buf.ByteChunk;
+
+public class TestPageContextImpl extends TomcatBaseTest {
+
+    @Test
+    public void testDoForward() throws Exception {
+        Tomcat tomcat = getTomcatInstance();
+
+        File appDir = new File("test/webapp-3.0");
+        tomcat.addWebapp(null, "/test", appDir.getAbsolutePath());
+
+        tomcat.start();
+
+        ByteChunk res = new ByteChunk();
+
+        int rc = getUrl("http://localhost:" + getPort() +
+                "/test/bug53545.jsp", res, null);
+
+        Assert.assertEquals(HttpServletResponse.SC_OK, rc);
+
+        String body = res.toString();
+        Assert.assertTrue(body.contains("OK"));
+        Assert.assertFalse(body.contains("FAIL"));
+    }
+}

==================================================
