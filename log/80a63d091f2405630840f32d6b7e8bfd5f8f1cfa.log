80a63d091f2405630840f32d6b7e8bfd5f8f1cfa
==================================================
As per RFC2616, an unknown expect header should result in a 417 response.
==================================================
Mark Emlyn
==================================================
Tue Jun 3 12:14:17 2014 +0000
==================================================
AbstractHttp11Processor.java
As per RFC2616, an unknown expect header should result in a 417 response.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1599500 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SimpleHttpClient.java
index 36d5203893..4b14386898 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Processor.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Processor.java
@@ -1250,10 +1250,14 @@ public abstract class AbstractHttp11Processor<S> extends AbstractProcessor<S> {
         if (http11) {
             expectMB = headers.getValue("expect");
         }
-        if ((expectMB != null)
-            && (expectMB.indexOfIgnoreCase("100-continue", 0) != -1)) {
-            getInputBuffer().setSwallowInput(false);
-            expectation = true;
+        if (expectMB != null) {
+            if (expectMB.indexOfIgnoreCase("100-continue", 0) != -1) {
+                getInputBuffer().setSwallowInput(false);
+                expectation = true;
+            } else {
+                error = true;
+                response.setStatus(HttpServletResponse.SC_EXPECTATION_FAILED);
+            }
         }
 
         // Check user-agent header

==================================================
TestAbstractHttp11Processor.java
index 15b32ad4b6..abeb029b14 100644
--- a/test/org/apache/catalina/startup/SimpleHttpClient.java
+++ b/test/org/apache/catalina/startup/SimpleHttpClient.java
@@ -54,6 +54,7 @@ public abstract class SimpleHttpClient {
     public static final String FAIL_404 = "HTTP/1.1 404";
     public static final String TIMEOUT_408 = "HTTP/1.1 408";
     public static final String FAIL_413 = "HTTP/1.1 413";
+    public static final String FAIL_417 = "HTTP/1.1 417";
     public static final String FAIL_50X = "HTTP/1.1 50";
     public static final String FAIL_500 = "HTTP/1.1 500";
     public static final String FAIL_501 = "HTTP/1.1 501";
@@ -421,6 +422,10 @@ public abstract class SimpleHttpClient {
         return getResponseLine().startsWith(FAIL_413);
     }
 
+    public boolean isResponse417() {
+        return getResponseLine().startsWith(FAIL_417);
+    }
+
     public boolean isResponse50x() {
         return getResponseLine().startsWith(FAIL_50X);
     }

==================================================
