1320ca875854c49ff5a876c67b6d971f415fddd9
==================================================
Do not mark threads from the container thread pool as container threads when being used to process AsyncContext.start(Runnable)</code> so processing is correctly transferred back to a genuine container thread when necessary.
==================================================
Mark Emlyn
==================================================
Thu Aug 7 10:28:18 2014 +0000
==================================================
AbstractProtocol.java
Do not mark threads from the container thread pool as container threads when being used to process AsyncContext.start(Runnable)</code> so processing is correctly transferred back to a genuine container thread when necessary.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1616464 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ContainerThreadMarker.java
index ab912bb576..9886cef35c 100644
--- a/java/org/apache/coyote/AbstractProtocol.java
+++ b/java/org/apache/coyote/AbstractProtocol.java
@@ -609,7 +609,7 @@ public abstract class AbstractProtocol<S> implements ProtocolHandler,
             }
 
             wrapper.setAsync(false);
-            ContainerThreadMarker.markAsContainerThread();
+            ContainerThreadMarker.set();
 
             try {
                 if (processor == null) {
@@ -753,7 +753,10 @@ public abstract class AbstractProtocol<S> implements ProtocolHandler,
                 // less-than-verbose logs.
                 getLog().error(
                         sm.getString("abstractConnectionHandler.error"), e);
+            } finally {
+                ContainerThreadMarker.clear();
             }
+
             // Make sure socket/processor is removed from the list of current
             // connections
             connections.remove(socket);

==================================================
