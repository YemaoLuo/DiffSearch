d0cfd667d3cf5943b91dec6e4eb7c445030d9c88
==================================================
Refactor to aid re-use
==================================================
Mark Thomas
==================================================
Mon Jul 29 18:08:09 2019 +0100
==================================================
WebSocketBaseTest.java
Refactor to aid re-use


==================================================
TestClose.java
index 56c27ef476..3d55c9d161 100644
--- a/test/org/apache/tomcat/websocket/WebSocketBaseTest.java
+++ b/test/org/apache/tomcat/websocket/WebSocketBaseTest.java
@@ -19,10 +19,31 @@ package org.apache.tomcat.websocket;
 import org.junit.After;
 import org.junit.Assert;
 
+import org.apache.catalina.Context;
+import org.apache.catalina.LifecycleException;
+import org.apache.catalina.servlets.DefaultServlet;
+import org.apache.catalina.startup.Tomcat;
 import org.apache.catalina.startup.TomcatBaseTest;
+import org.apache.tomcat.websocket.server.WsContextListener;
 
 public abstract class WebSocketBaseTest extends TomcatBaseTest {
 
+    protected Tomcat startServer(
+            final Class<? extends WsContextListener> configClass)
+            throws LifecycleException {
+
+        Tomcat tomcat = getTomcatInstance();
+        // No file system docBase required
+        Context ctx = tomcat.addContext("", null);
+        ctx.addApplicationListener(configClass.getName());
+        Tomcat.addServlet(ctx, "default", new DefaultServlet());
+        ctx.addServletMappingDecoded("/", "default");
+
+        tomcat.start();
+        return tomcat;
+    }
+
+
     @After
     public void checkBackgroundProcessHasStopped() throws Exception {
         // Need to stop Tomcat to ensure background processed have been stopped.

==================================================
TesterWsClient.java
index cc6360a6af..30c18bb1c3 100644
--- a/test/org/apache/tomcat/websocket/server/TestClose.java
+++ b/test/org/apache/tomcat/websocket/server/TestClose.java
@@ -37,10 +37,6 @@ import org.junit.Assume;
 import org.junit.Before;
 import org.junit.Test;
 
-import org.apache.catalina.Context;
-import org.apache.catalina.LifecycleException;
-import org.apache.catalina.servlets.DefaultServlet;
-import org.apache.catalina.startup.Tomcat;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.apache.tomcat.websocket.WebSocketBaseTest;
@@ -127,7 +123,7 @@ public class TestClose extends WebSocketBaseTest {
 
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
         client.closeSocket();
 
@@ -139,7 +135,7 @@ public class TestClose extends WebSocketBaseTest {
     public void testTcpReset() throws Exception {
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
         client.forceCloseSocket();
 
@@ -153,7 +149,7 @@ public class TestClose extends WebSocketBaseTest {
     public void testWsCloseThenTcpClose() throws Exception {
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
         client.sendCloseFrame(CloseCodes.GOING_AWAY);
         client.closeSocket();
@@ -166,7 +162,7 @@ public class TestClose extends WebSocketBaseTest {
     public void testWsCloseThenTcpReset() throws Exception {
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
         client.sendCloseFrame(CloseCodes.GOING_AWAY);
         client.forceCloseSocket();
@@ -190,9 +186,9 @@ public class TestClose extends WebSocketBaseTest {
 
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
-        client.sendMessage("Test");
+        client.sendTextMessage("Test");
         awaitLatch(events.onMessageCalled, "onMessage not called");
 
         client.closeSocket();
@@ -206,9 +202,9 @@ public class TestClose extends WebSocketBaseTest {
     public void testTcpResetInOnMessage() throws Exception {
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
-        client.sendMessage("Test");
+        client.sendTextMessage("Test");
         awaitLatch(events.onMessageCalled, "onMessage not called");
 
         client.forceCloseSocket();
@@ -239,9 +235,9 @@ public class TestClose extends WebSocketBaseTest {
 
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
-        client.sendMessage("Test");
+        client.sendTextMessage("Test");
         awaitLatch(events.onMessageCalled, "onMessage not called");
 
         client.sendCloseFrame(CloseCodes.NORMAL_CLOSURE);
@@ -258,9 +254,9 @@ public class TestClose extends WebSocketBaseTest {
 
         startServer(TestEndpointConfig.class);
 
-        TesterWsCloseClient client = new TesterWsCloseClient("localhost", getPort());
+        TesterWsClient client = new TesterWsClient("localhost", getPort());
         client.httpUpgrade(BaseEndpointConfig.PATH);
-        client.sendMessage("Test");
+        client.sendTextMessage("Test");
         awaitLatch(events.onMessageCalled, "onMessage not called");
 
         client.sendCloseFrame(CloseCodes.NORMAL_CLOSURE);
@@ -331,22 +327,6 @@ public class TestClose extends WebSocketBaseTest {
     }
 
 
-    private Tomcat startServer(
-            final Class<? extends WsContextListener> configClass)
-            throws LifecycleException {
-
-        Tomcat tomcat = getTomcatInstance();
-        // No file system docBase required
-        Context ctx = tomcat.addContext("", null);
-        ctx.addApplicationListener(configClass.getName());
-        Tomcat.addServlet(ctx, "default", new DefaultServlet());
-        ctx.addServletMappingDecoded("/", "default");
-
-        tomcat.start();
-        return tomcat;
-    }
-
-
     public abstract static class BaseEndpointConfig extends TesterEndpointConfig {
 
         public static final String PATH = "/test";

==================================================
