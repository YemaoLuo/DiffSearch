5db68f3ef313508c67b7446e838a79e53798e3c0
==================================================
More debug logging to help with intermittent CI failures
==================================================
Mark Thomas
==================================================
Thu Sep 10 09:51:23 2020 +0100
==================================================
AsyncChannelWrapper.java
More debug logging to help with intermittent CI failures


==================================================
AsyncChannelWrapperNonSecure.java
index d970d75708..cd6fc78af4 100644
--- a/java/org/apache/tomcat/websocket/AsyncChannelWrapper.java
+++ b/java/org/apache/tomcat/websocket/AsyncChannelWrapper.java
@@ -16,6 +16,8 @@
  */
 package org.apache.tomcat.websocket;
 
+import java.io.IOException;
+import java.net.SocketAddress;
 import java.nio.ByteBuffer;
 import java.nio.channels.CompletionHandler;
 import java.util.concurrent.Future;
@@ -44,4 +46,6 @@ public interface AsyncChannelWrapper {
     void close();
 
     Future<Void> handshake() throws SSLException;
+
+    SocketAddress getLocalAddress() throws IOException;
 }

==================================================
AsyncChannelWrapperSecure.java
index d86c22c14c..f28ef87284 100644
--- a/java/org/apache/tomcat/websocket/AsyncChannelWrapperNonSecure.java
+++ b/java/org/apache/tomcat/websocket/AsyncChannelWrapperNonSecure.java
@@ -17,6 +17,7 @@
 package org.apache.tomcat.websocket;
 
 import java.io.IOException;
+import java.net.SocketAddress;
 import java.nio.ByteBuffer;
 import java.nio.channels.AsynchronousSocketChannel;
 import java.nio.channels.CompletionHandler;
@@ -80,6 +81,12 @@ public class AsyncChannelWrapperNonSecure implements AsyncChannelWrapper {
     }
 
 
+    @Override
+    public SocketAddress getLocalAddress() throws IOException {
+        return socketChannel.getLocalAddress();
+    }
+
+
     private static final class NoOpFuture implements Future<Void> {
 
         @Override

==================================================
WsWebSocketContainer.java
index 03b7923c78..7a3489d082 100644
--- a/java/org/apache/tomcat/websocket/LocalStrings.properties
+++ b/java/org/apache/tomcat/websocket/LocalStrings.properties
@@ -129,7 +129,7 @@ wsWebSocketContainer.shutdown=The web application is stopping
 
 wsWebSocketContainer.asynchronousSocketChannelFail=Unable to open a connection to the server
 wsWebSocketContainer.connect.entry=Connecting endpoint instance of type [{0}] to [{1}]
-wsWebSocketContainer.connect.write=Writing the HTTP upgrade request from buffer starting at [{0}] with a limit of [{1}]
+wsWebSocketContainer.connect.write=Writing the HTTP upgrade request from buffer starting at [{0}] with a limit of [{1}] from local address [{2}]
 wsWebSocketContainer.defaultConfiguratorFail=Failed to create the default configurator
 wsWebSocketContainer.endpointCreateFail=Failed to create a local endpoint of type [{0}]
 wsWebSocketContainer.failedAuthentication=Failed to handle HTTP response code [{0}]. Authentication header was not accepted by server.

==================================================
