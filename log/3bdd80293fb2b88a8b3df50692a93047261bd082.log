3bdd80293fb2b88a8b3df50692a93047261bd082
==================================================
Fix BZ 65505. HTTP header removal must not change order of other headers
==================================================
Mark Thomas
==================================================
Tue Aug 24 13:06:59 2021 +0100
==================================================
MimeHeaders.java
Fix BZ 65505. HTTP header removal must not change order of other headers

If there are headers with multiple values, we must retain relative order
of those values. It is easier to retain order for all header values.

https://bz.apache.org/bugzilla/show_bug.cgi?id=65505
https://datatracker.ietf.org/doc/html/rfc7230#section-3.2.2


==================================================
TestResponseUtil.java
index 113412c523..2396c455a3 100644
--- a/java/org/apache/tomcat/util/http/MimeHeaders.java
+++ b/java/org/apache/tomcat/util/http/MimeHeaders.java
@@ -392,15 +392,27 @@ public class MimeHeaders {
     }
 
     /**
-     * reset and swap with last header
+     * Reset, move to the end and then reduce count by 1.
      * @param idx the index of the header to remove.
      */
     public void removeHeader(int idx) {
-        MimeHeaderField mh = headers[idx];
+        // Implementation note. This method must not change the order of the
+        // remaining headers because, if there are multiple header values for
+        // the same name, the order of those headers is significant. It is
+        // simpler to retain order for all values than try to determine if there
+        // are multiple header values for the same name.
 
+        // Clear the header to remove
+        MimeHeaderField mh = headers[idx];
         mh.recycle();
-        headers[idx] = headers[count - 1];
+
+        // Move the remaining headers
+        System.arraycopy(headers, idx + 1, headers, idx, count - idx -1);
+
+        // Place the removed header at the end
         headers[count - 1] = mh;
+
+        // Reduce the count
         count--;
     }
 

==================================================
