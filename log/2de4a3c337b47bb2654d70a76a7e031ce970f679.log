2de4a3c337b47bb2654d70a76a7e031ce970f679
==================================================
Revert "Clear SocketWrapper reference to help GC"
==================================================
lihan lihan@apache.org
==================================================
Sun May 21 09:27:51 2023 +0800
==================================================
AbstractProcessor.java
Revert "Clear SocketWrapper reference to help GC"

This reverts commit 10492dd22bd64ff63cf77786fa67d45cdc2a54b3.



==================================================
Http11Processor.java
index 8965dab62b..3ee6898fbd 100644
--- a/java/org/apache/coyote/AbstractProcessor.java
+++ b/java/org/apache/coyote/AbstractProcessor.java
@@ -721,9 +721,6 @@ public abstract class AbstractProcessor extends AbstractProcessorLight implement
     public void recycle() {
         errorState = ErrorState.NONE;
         asyncStateMachine.recycle();
-        // Clear fields that can be cleared to aid GC and trigger NPEs if this
-        // is reused
-        socketWrapper = null;
     }
 
 

==================================================
StreamProcessor.java
index 85dfd34f3c..9e2e74914c 100644
--- a/java/org/apache/coyote/http11/Http11Processor.java
+++ b/java/org/apache/coyote/http11/Http11Processor.java
@@ -1418,6 +1418,7 @@ public class Http11Processor extends AbstractProcessor {
         inputBuffer.recycle();
         outputBuffer.recycle();
         upgradeToken = null;
+        socketWrapper = null;
         sendfileData = null;
         sslSupport = null;
     }

==================================================
Nio2Channel.java
index 3b1c03ac38..78cb770649 100644
--- a/java/org/apache/coyote/http2/StreamProcessor.java
+++ b/java/org/apache/coyote/http2/StreamProcessor.java
@@ -392,8 +392,8 @@ class StreamProcessor extends AbstractProcessor {
 
     @Override
     public final void recycle() {
-        super.recycle();
         // StreamProcessor instances are not re-used.
+
         // Calling removeRequestProcessor even though the RequestProcesser was
         // never added will add the values from the RequestProcessor to the
         // running total for the GlobalRequestProcessor
@@ -401,6 +401,10 @@ class StreamProcessor extends AbstractProcessor {
         if (global != null) {
             global.removeRequestProcessor(request.getRequestProcessor());
         }
+
+        // Clear fields that can be cleared to aid GC and trigger NPEs if this
+        // is reused
+        setSocketWrapper(null);
     }
 
 

==================================================
NioChannel.java
index 9d65266374..603c43f416 100644
--- a/java/org/apache/tomcat/util/net/Nio2Channel.java
+++ b/java/org/apache/tomcat/util/net/Nio2Channel.java
@@ -79,7 +79,6 @@ public class Nio2Channel implements AsynchronousByteChannel {
     @Override
     public void close() throws IOException {
         sc.close();
-        reset(this.sc, null);
     }
 
 

==================================================
