a63bf3a4b62dec78e71a6354e0a33770d4f87dc7
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55837
==================================================
Mark Emlyn
==================================================
Wed Dec 4 17:18:57 2013 +0000
==================================================
DirResourceSet.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55837
getRealPath() should return a result for resources that don't exist where possible
Add some unit tests to check this.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1547848 13f79535-47bb-0310-9956-ffa450edef68



==================================================
EmptyResource.java
index a9d2f5c2e8..5d4ab86873 100644
--- a/java/org/apache/catalina/webresources/DirResourceSet.java
+++ b/java/org/apache/catalina/webresources/DirResourceSet.java
@@ -92,10 +92,13 @@ public class DirResourceSet extends AbstractFileResourceSet {
         String webAppMount = getWebAppMount();
         WebResourceRoot root = getRoot();
         if (path.startsWith(webAppMount)) {
-            File f = file(path.substring(webAppMount.length()), true);
+            File f = file(path.substring(webAppMount.length()), false);
             if (f == null) {
                 return new EmptyResource(root, path);
             }
+            if (!f.exists()) {
+                return new EmptyResource(root, path, f);
+            }
             if (f.isDirectory() && path.charAt(path.length() - 1) != '/') {
                 path = path += '/';
             }

==================================================
StandardRoot.java
index fba3d86571..5c67a94ebe 100644
--- a/java/org/apache/catalina/webresources/EmptyResource.java
+++ b/java/org/apache/catalina/webresources/EmptyResource.java
@@ -16,6 +16,8 @@
  */
 package org.apache.catalina.webresources;
 
+import java.io.File;
+import java.io.IOException;
 import java.io.InputStream;
 import java.net.URL;
 import java.security.cert.Certificate;
@@ -28,10 +30,16 @@ public class EmptyResource implements WebResource {
 
     private final WebResourceRoot root;
     private final String webAppPath;
+    private final File file;
 
     public EmptyResource(WebResourceRoot root, String webAppPath) {
+        this(root, webAppPath, null);
+    }
+
+    public EmptyResource(WebResourceRoot root, String webAppPath, File file) {
         this.root = root;
         this.webAppPath = webAppPath;
+        this.file = file;
     }
 
     @Override
@@ -86,7 +94,15 @@ public class EmptyResource implements WebResource {
 
     @Override
     public String getCanonicalPath() {
-        return null;
+        if (file == null) {
+            return null;
+        } else {
+            try {
+                return file.getCanonicalPath();
+            } catch (IOException e) {
+                return null;
+            }
+        }
     }
 
     @Override

==================================================
AbstractTestResourceSet.java
index d2d48315f2..c2a1b84a71 100644
--- a/java/org/apache/catalina/webresources/StandardRoot.java
+++ b/java/org/apache/catalina/webresources/StandardRoot.java
@@ -239,6 +239,7 @@ public class StandardRoot extends LifecycleMBeanBase
             boolean useClassLoaderResources) {
         WebResource result = null;
         WebResource virtual = null;
+        WebResource mainEmpty = null;
         for (ArrayList<WebResourceSet> list : allResources) {
             for (WebResourceSet webResourceSet : list) {
                 if (useClassLoaderResources || !webResourceSet.getClassLoaderOnly()) {
@@ -246,8 +247,12 @@ public class StandardRoot extends LifecycleMBeanBase
                     if (result.exists()) {
                         return result;
                     }
-                    if (virtual == null && result.isVirtual()) {
-                        virtual = result;
+                    if (virtual == null) {
+                        if (result.isVirtual()) {
+                            virtual = result;
+                        } else if (main.equals(webResourceSet)) {
+                            mainEmpty = result;
+                        }
                     }
                 }
             }
@@ -259,7 +264,7 @@ public class StandardRoot extends LifecycleMBeanBase
         }
 
         // Default is empty resource in main resources
-        return new EmptyResource(this, path);
+        return mainEmpty;
     }
 
     @Override

==================================================
