09129f99c0b0ff743c49d71ed6b3f507be6f9027
==================================================
Fix possible race condition when using an upgraded connection and setting the IO listeners, it now uses the same processing as non upgraded connections.
==================================================
Remy Maucherat
==================================================
Fri Aug 11 16:01:41 2017 +0000
==================================================
UpgradeServletInputStream.java
Fix possible race condition when using an upgraded connection and setting the IO listeners, it now uses the same processing as non upgraded connections.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1804813 13f79535-47bb-0310-9956-ffa450edef68



==================================================
UpgradeServletOutputStream.java
index 25b808e60b..df5c615d35 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeServletInputStream.java
@@ -101,6 +101,8 @@ public class UpgradeServletInputStream extends ServletInputStream {
             throw new IllegalStateException(sm.getString("upgrade.sis.read.closed"));
         }
 
+        this.listener = listener;
+
         // Container is responsible for first call to onDataAvailable().
         if (ContainerThreadMarker.isContainerThread()) {
             processor.addDispatch(DispatchType.NON_BLOCKING_READ);
@@ -108,7 +110,6 @@ public class UpgradeServletInputStream extends ServletInputStream {
             socketWrapper.registerReadInterest();
         }
 
-        this.listener = listener;
         // Switching to non-blocking. Don't know if data is available.
         ready = null;
     }

==================================================
