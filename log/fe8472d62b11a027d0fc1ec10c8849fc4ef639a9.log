fe8472d62b11a027d0fc1ec10c8849fc4ef639a9
==================================================
Fix BZ 64921. LoadBalancerDrainingValve sets correct cookie secure attr
==================================================
Mark Thomas
==================================================
Thu Nov 19 14:49:05 2020 +0000
==================================================
LoadBalancerDrainingValve.java
Fix BZ 64921. LoadBalancerDrainingValve sets correct cookie secure attr

https://bz.apache.org/bugzilla/show_bug.cgi?id=64921
Based on a pull request by Andreas Kurth


==================================================
TestLoadBalancerDrainingValve.java
index 1d6b8be069..7ef9386387 100644
--- a/java/org/apache/catalina/valves/LoadBalancerDrainingValve.java
+++ b/java/org/apache/catalina/valves/LoadBalancerDrainingValve.java
@@ -19,6 +19,7 @@ package org.apache.catalina.valves;
 import java.io.IOException;
 
 import jakarta.servlet.ServletException;
+import jakarta.servlet.SessionCookieConfig;
 import jakarta.servlet.http.Cookie;
 import jakarta.servlet.http.HttpServletResponse;
 
@@ -222,6 +223,9 @@ public class LoadBalancerDrainingValve extends ValveBase {
                 sessionCookie.setPath(SessionConfig.getSessionCookiePath(request.getContext()));
                 sessionCookie.setMaxAge(0); // Delete
                 sessionCookie.setValue(""); // Purge the cookie's value
+                // Replicate logic used to set secure attribute for session cookies
+                SessionCookieConfig sessionCookieConfig = request.getContext().getServletContext().getSessionCookieConfig();
+                sessionCookie.setSecure(request.isSecure() || sessionCookieConfig.isSecure());
                 response.addCookie(sessionCookie);
             }
 

==================================================
