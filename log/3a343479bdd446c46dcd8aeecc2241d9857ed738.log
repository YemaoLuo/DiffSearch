3a343479bdd446c46dcd8aeecc2241d9857ed738
==================================================
Add ALPN support to NIO by passing the socket wrapper to the channel.
==================================================
Remy Maucherat
==================================================
Wed Jul 15 16:20:38 2015 +0000
==================================================
NioChannel.java
Add ALPN support to NIO by passing the socket wrapper to the channel.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1691244 13f79535-47bb-0310-9956-ffa450edef68



==================================================
NioEndpoint.java
index 9bdbbd29ed..8b5a3e9b1a 100644
--- a/java/org/apache/tomcat/util/net/NioChannel.java
+++ b/java/org/apache/tomcat/util/net/NioChannel.java
@@ -42,6 +42,7 @@ public class NioChannel implements ByteChannel {
     protected static ByteBuffer emptyBuf = ByteBuffer.allocate(0);
 
     protected SocketChannel sc = null;
+    protected SocketWrapperBase<NioChannel> socket = null;
 
     protected final SocketBufferHandler bufHandler;
 
@@ -65,6 +66,10 @@ public class NioChannel implements ByteChannel {
     }
 
 
+    void setSocketWrapper(SocketWrapperBase<NioChannel> socket) {
+        this.socket = socket;
+    }
+
     /**
      * Free the channel memory
      */

==================================================
SecureNioChannel.java
index ac2aa8dc21..ca67f3c2b1 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -731,6 +731,7 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel> {
         public void register(final NioChannel socket) {
             socket.setPoller(this);
             NioSocketWrapper ka = new NioSocketWrapper(socket, NioEndpoint.this);
+            socket.setSocketWrapper(ka);
             ka.setPoller(this);
             ka.setReadTimeout(getSocketProperties().getSoTimeout());
             ka.setWriteTimeout(getSocketProperties().getSoTimeout());

==================================================
