243fb55851bea3600f3ce9a591f249c04d0acd6d
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58867
==================================================
Mark Thomas
==================================================
Wed Jan 20 21:21:35 2016 +0000
==================================================
ContextConfig.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58867
Improve WAR modification checking on Host start

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1725816 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestHostConfigAutomaticDeployment.java
index 8b3bd225aa..72ebb0f0bf 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -605,8 +605,7 @@ public class ContextConfig implements LifecycleListener {
         file = new File(docBase);
         String origDocBase = docBase;
 
-        ContextName cn = new ContextName(context.getPath(),
-                context.getWebappVersion());
+        ContextName cn = new ContextName(context.getPath(), context.getWebappVersion());
         String pathName = cn.getBaseName();
 
         boolean unpackWARs = true;
@@ -631,10 +630,21 @@ public class ContextConfig implements LifecycleListener {
             }
         } else {
             File docDir = new File(docBase);
-            if (!docDir.exists()) {
-                File warFile = new File(docBase + ".war");
-                if (warFile.exists()) {
-                    URL war = new URL("jar:" + warFile.toURI().toURL() + "!/");
+            File warFile = new File(docBase + ".war");
+            URL war = null;
+            if (warFile.exists()) {
+                war = new URL("jar:" + warFile.toURI().toURL() + "!/");
+            }
+            if (docDir.exists()) {
+                if (war != null && unpackWARs) {
+                    // Check if WAR needs to be re-expanded (e.g. if it has
+                    // changed). Note: HostConfig.deployWar() takes care of
+                    // ensuring that the correct XML file is used.
+                    // This will be a NO-OP if the WAR is unchanged.
+                    ExpandWar.expand(host, war, pathName);
+                }
+            } else {
+                if (war != null) {
                     if (unpackWARs) {
                         docBase = ExpandWar.expand(host, war, pathName);
                         file = new File(docBase);

==================================================
