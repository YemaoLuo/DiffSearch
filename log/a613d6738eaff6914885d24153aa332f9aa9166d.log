a613d6738eaff6914885d24153aa332f9aa9166d
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=62177
==================================================
Mark Thomas
==================================================
Thu Mar 15 14:10:17 2018 +0000
==================================================
Http2UpgradeHandler.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=62177
Correct two protocol errors with HTTP/2 PUSH_PROMISE frames.
Firstly, the HTTP/2 protocol only permits pushes to be sent on peer initiated requests.
Secondly, pushes must be sent in order of increasing stream ID.
These restriction were not being enforced leading to protocol errors at the client.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1826817 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Stream.java
index 170361cb29..45be053abc 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -1122,11 +1122,18 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
 
 
     void push(Request request, Stream associatedStream) throws IOException {
-        Stream pushStream  = createLocalStream(request);
+        Stream pushStream;
 
-        // TODO: Is 1k the optimal value?
-        writeHeaders(associatedStream, pushStream.getIdentifier().intValue(),
-                request.getMimeHeaders(), false, 1024);
+        // Synchronized since PUSH_PROMISE frames have to be sent in order. Once
+        // the stream has been created we need to ensure that the PUSH_PROMISE
+        // is sent before the next stream is created for a PUSH_PROMISE.
+        synchronized (socketWrapper) {
+            pushStream = createLocalStream(request);
+
+            // TODO: Is 1k the optimal value?
+            writeHeaders(associatedStream, pushStream.getIdentifier().intValue(),
+                    request.getMimeHeaders(), false, 1024);
+        }
 
         pushStream.sentPushPromise();
 

==================================================
