77534eb9ed1ac005966f7f17f393aa69cb976244
==================================================
More chunked encoding improvements
==================================================
Mark Emlyn
==================================================
Thu Aug 30 13:08:35 2012 +0000
==================================================
ChunkedInputFilter.java
More chunked encoding improvements
- Expand unit tests for chunked encoding
- Fix a parsing error at eol when multiple headers are present (regression in r1378699)
- Make parsing of terminating CRLF non-tolerant (RFC2616 only suggests to be tolerant of LF at the end of headers)
- Revert previous unnecessary change to SimpleHttpClient

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1378918 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SimpleHttpClient.java
index ab00ecb38a..2609ca857f 100644
--- a/java/org/apache/coyote/http11/filters/ChunkedInputFilter.java
+++ b/java/org/apache/coyote/http11/filters/ChunkedInputFilter.java
@@ -411,7 +411,7 @@ public class ChunkedInputFilter implements InputFilter {
 
         // CRLF terminates the request
         if (chr == Constants.CR || chr == Constants.LF) {
-            parseCRLF(true);
+            parseCRLF(false);
             return false;
         }
 
@@ -502,8 +502,9 @@ public class ChunkedInputFilter implements InputFilter {
                     lastSignificantChar = trailingHeaders.getEnd();
                 }
 
-                pos++;
-
+                if (!eol) {
+                    pos++;
+                }
             }
 
             // Checking the first character of the new line. If the character

==================================================
TestChunkedInputFilter.java
index b3190ebfe9..0c96f0889b 100644
--- a/test/org/apache/catalina/startup/SimpleHttpClient.java
+++ b/test/org/apache/catalina/startup/SimpleHttpClient.java
@@ -201,13 +201,7 @@ public abstract class SimpleHttpClient {
                 line = readLine();
                 while (line != null) {
                     builder.append(line);
-                    try {
-                        line = readLine();
-                    } catch (IOException ioe) {
-                        // The server probably closed the connection due to an
-                        // error
-                        line = null;
-                    }
+                    line = readLine();
                 }
             }
         }

==================================================
