d85c35f9679c7d7a78678a411ed8585798b0afd9
==================================================
Reduce the contention in the default InstanceManager implementation when multiple threads are managing objects and need to reference the annotation cache.
==================================================
Mark Thomas
==================================================
Wed Jan 25 14:26:53 2017 +0000
==================================================
DefaultInstanceManager.java
Reduce the contention in the default InstanceManager implementation when multiple threads are managing objects and need to reference the annotation cache.
Prior to this patch, TestDefaultInstanceManager#testConcurrency() showed a roughly linear increase in execution time as the thread count increased. With this patch applied, the test shows broadly no change in execution time as the thread count is increased from 1 to 8 on a machine with 8 cores available.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1780189 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardContext.java
index 926d7226a2..2fe43de58f 100644
--- a/java/org/apache/catalina/core/LocalStrings.properties
+++ b/java/org/apache/catalina/core/LocalStrings.properties
@@ -112,6 +112,7 @@ pushBuilder.noPath=It is illegal to call push() before setting a path
 standardContext.invalidWrapperClass={0} is not a subclass of StandardWrapper
 standardContext.applicationListener=Error configuring application listener of class {0}
 standardContext.applicationSkipped=Skipped installing application listeners due to previous error(s)
+standardContext.backgroundProcess.instanceManager=Exception processing instance manager {0} background process
 standardContext.backgroundProcess.loader=Exception processing loader {0} background process
 standardContext.backgroundProcess.manager=Exception processing manager {0} background process
 standardContext.backgroundProcess.resources=Exception processing resources {0} background process

==================================================
InstanceManager.java
index 4079c9ddd5..79691028de 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -5558,6 +5558,16 @@ public class StandardContext extends ContainerBase
                         resources), e);
             }
         }
+        InstanceManager instanceManager = getInstanceManager();
+        if (instanceManager != null) {
+            try {
+                instanceManager.backgroundProcess();
+            } catch (Exception e) {
+                log.warn(sm.getString(
+                        "standardContext.backgroundProcess.instanceManager",
+                        resources), e);
+            }
+        }
         super.backgroundProcess();
     }
 

==================================================
