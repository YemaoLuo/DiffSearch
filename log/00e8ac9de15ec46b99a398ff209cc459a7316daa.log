00e8ac9de15ec46b99a398ff209cc459a7316daa
==================================================
Some Lifecycle clean-up
==================================================
Mark Emlyn
==================================================
Tue Aug 31 17:52:45 2010 +0000
==================================================
ContainerBase.java
Some Lifecycle clean-up

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@991274 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ContextConfig.java
index e08e525579..404bc9b2aa 100644
--- a/java/org/apache/catalina/core/ContainerBase.java
+++ b/java/org/apache/catalina/core/ContainerBase.java
@@ -956,7 +956,13 @@ public abstract class ContainerBase extends LifecycleMBeanBase
         
         fireContainerEvent(REMOVE_CHILD_EVENT, child);
         
-        // child.setParent(null);
+        // Set child's parent to null to prevent a loop
+        child.setParent(null);
+        try {
+            child.destroy();
+        } catch (LifecycleException e) {
+            log.error("ContainerBase.removeChild: destroy: ", e);
+        }
 
     }
 
@@ -1091,9 +1097,10 @@ public abstract class ContainerBase extends LifecycleMBeanBase
 
         // Remove children now this container is being destroyed
         for (Container child : findChildren()) {
-            child.destroy();
+            removeChild(child);
         }
 
+        // Required if the child is destroyed directly.
         if (parent != null) {
             parent.removeChild(this);
         }

==================================================
