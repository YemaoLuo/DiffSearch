a9dac4ce97116c62ee124afd913cdaea805a4a8e
==================================================
Findbugs fixes to o.a.catalina
==================================================
Mark Emlyn
==================================================
Wed Sep 12 17:11:04 2012 +0000
==================================================
StandardContext.java
Findbugs fixes to o.a.catalina

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1384040 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AbstractReplicatedMap.java
index 91016e0378..e3d2933fb8 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -2514,7 +2514,7 @@ public class StandardContext extends ContainerBase
 
 
     @Override
-    public synchronized void setResources(DirContext resources) {
+    public void setResources(DirContext resources) {
 
         Lock writeLock = resourcesLock.writeLock();
         writeLock.lock();
@@ -2546,13 +2546,12 @@ public class StandardContext extends ContainerBase
 
             // The proxied resources will be refreshed on start
             this.resources = null;
+
+            support.firePropertyChange("resources", oldResources,
+                    resources);
         } finally {
             writeLock.unlock();
         }
-
-        support.firePropertyChange("resources", oldResources,
-                                   resources);
-
     }
 
 
@@ -4966,12 +4965,13 @@ public class StandardContext extends ContainerBase
                         .unregisterComponent(resourcesName);
                 }
             }
+            this.resources = null;
         } catch (Throwable t) {
             ExceptionUtils.handleThrowable(t);
             log.error(sm.getString("standardContext.resourcesStop"), t);
             ok = false;
-        } finally {
             this.resources = null;
+        } finally {
             writeLock.unlock();
         }
 

==================================================
