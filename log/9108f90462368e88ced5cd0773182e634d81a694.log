9108f90462368e88ced5cd0773182e634d81a694
==================================================
Move Mapper from Connector to Service removing potential duplication.
==================================================
Mark Emlyn
==================================================
Mon Jul 30 21:53:56 2012 +0000
==================================================
Service.java
index 98b34b5138..cfeef8deaf 100644
--- a/TOMCAT-NEXT.txt
+++ b/TOMCAT-NEXT.txt
@@ -43,7 +43,7 @@ but possibly 7.1.x).
  7. Rip out all the JNDI code in resource handling and replace it with straight
     URLs (File or WAR).
     Supporting re-factoring to consider arising from the above
-    - Move Mapper from Connector to Service/Engine (saves duplication)
+    - Move Mapper from Connector to Service (saves duplication)
     - Remove Mapper from Context - use Mapper from Service
 
  8. Review the connector shutdown code for timing and threading issues

==================================================
Connector.java
index d1af177c5d..ce4ab60e41 100644
--- a/java/org/apache/catalina/Service.java
+++ b/java/org/apache/catalina/Service.java
@@ -19,6 +19,7 @@
 package org.apache.catalina;
 
 import org.apache.catalina.connector.Connector;
+import org.apache.catalina.mapper.Mapper;
 
 /**
  * A <strong>Service</strong> is a group of one or more
@@ -147,4 +148,8 @@ public interface Service extends Lifecycle {
      */
     public void removeExecutor(Executor ex);
 
+    /**
+     * The mapper associated with this Service.
+     */
+    Mapper getMapper();
 }

==================================================
CoyoteAdapter.java
index e2c608e015..3f35808af4 100644
--- a/java/org/apache/catalina/connector/Connector.java
+++ b/java/org/apache/catalina/connector/Connector.java
@@ -27,7 +27,6 @@ import org.apache.catalina.LifecycleException;
 import org.apache.catalina.LifecycleState;
 import org.apache.catalina.Service;
 import org.apache.catalina.core.AprLifecycleListener;
-import org.apache.catalina.mapper.Mapper;
 import org.apache.catalina.util.LifecycleMBeanBase;
 import org.apache.coyote.Adapter;
 import org.apache.coyote.ProtocolHandler;
@@ -222,19 +221,6 @@ public class Connector extends LifecycleMBeanBase  {
     protected Adapter adapter = null;
 
 
-     /**
-      * Mapper.
-      */
-     protected final Mapper mapper = new Mapper();
-
-
-     /**
-      * Mapper listener.
-      */
-     protected final MapperListener mapperListener =
-             new MapperListener(mapper, this);
-
-
      /**
       * URI encoding.
       */
@@ -389,14 +375,6 @@ public class Connector extends LifecycleMBeanBase  {
     }
 
 
-    /**
-     * Return the mapper.
-     */
-    public Mapper getMapper() {
-        return (mapper);
-    }
-
-
     /**
      * Return the maximum number of headers that are allowed by the container. A
      * value of less than 0 means no limit.
@@ -970,9 +948,6 @@ public class Connector extends LifecycleMBeanBase  {
                 (sm.getString
                  ("coyoteConnector.protocolHandlerInitializationFailed"), e);
         }
-
-        // Initialize mapper listener
-        mapperListener.init();
     }
 
 
@@ -1004,8 +979,6 @@ public class Connector extends LifecycleMBeanBase  {
                 (errPrefix + " " + sm.getString
                  ("coyoteConnector.protocolHandlerStartFailed"), e);
         }
-
-        mapperListener.start();
     }
 
 
@@ -1026,15 +999,11 @@ public class Connector extends LifecycleMBeanBase  {
                 (sm.getString
                  ("coyoteConnector.protocolHandlerStopFailed"), e);
         }
-
-        mapperListener.stop();
     }
 
 
     @Override
     protected void destroyInternal() throws LifecycleException {
-        mapperListener.destroy();
-
         try {
             protocolHandler.destroy();
         } catch (Exception e) {

==================================================
StandardService.java
index 9ddb1b2e65..132853c73f 100644
--- a/java/org/apache/catalina/connector/LocalStrings_ja.properties
+++ b/java/org/apache/catalina/connector/LocalStrings_ja.properties
@@ -46,15 +46,3 @@ coyoteRequest.sessionCreateCommitted=\u30ec\u30b9\u30dd\u30f3\u30b9\u3092\u30b3\
 coyoteRequest.setAttribute.namenull=setAttribute\u3092\u540d\u524d\u3092\u6307\u5b9a\u305b\u305a\u306b\u547c\u3073\u51fa\u3059\u3053\u3068\u306f\u3067\u304d\u307e\u305b\u3093
 coyoteRequest.attributeEvent=\u5c5e\u6027\u30a4\u30d9\u30f3\u30c8\u30ea\u30b9\u30ca\u306b\u3088\u3063\u3066\u4f8b\u5916\u304c\u6295\u3052\u3089\u308c\u307e\u3057\u305f
 coyoteRequest.postTooLarge=POST\u3055\u308c\u305f\u30c7\u30fc\u30bf\u304c\u5927\u304d\u3059\u304e\u305f\u306e\u3067\u3001\u30d1\u30e9\u30e1\u30fc\u30bf\u304c\u69cb\u6587\u89e3\u6790\u3067\u304d\u307e\u305b\u3093\u3067\u3057\u305f\u3002\u305d\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u5de8\u5927\u306aPOST\u3092\u53d7\u3051\u4ed8\u3051\u306d\u3070\u306a\u3089\u306a\u3044\u5834\u5408\u306b\u306f\u3001\u3053\u308c\u3092\u89e3\u6c7a\u3059\u308b\u305f\u3081\u306b\u30b3\u30cd\u30af\u30bf\u306emaxPostSize\u5c5e\u6027\u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002
-
-
-#
-# MapperListener
-#
-
-mapperListener.registerContext=\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8 {0}\u3000\u3092\u767b\u9332\u3057\u307e\u3059
-mapperListener.unregisterContext=\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8 {0} \u306e\u767b\u9332\u3092\u62b9\u6d88\u3057\u307e\u3059
-mapperListener.registerWrapper=\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8 {1} \u306b\u30e9\u30c3\u30d1 {0} \u3092\u767b\u9332\u3057\u307e\u3059
-
-
-

==================================================
Constants.java
index 047d6393ec..27531bdd7f 100644
--- a/java/org/apache/catalina/core/StandardService.java
+++ b/java/org/apache/catalina/core/StandardService.java
@@ -32,6 +32,8 @@ import org.apache.catalina.LifecycleState;
 import org.apache.catalina.Server;
 import org.apache.catalina.Service;
 import org.apache.catalina.connector.Connector;
+import org.apache.catalina.mapper.Mapper;
+import org.apache.catalina.mapper.MapperListener;
 import org.apache.catalina.util.LifecycleMBeanBase;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
@@ -94,8 +96,26 @@ public class StandardService extends LifecycleMBeanBase implements Service {
 
     private ClassLoader parentClassLoader = null;
 
+    /**
+     * Mapper.
+     */
+    protected final Mapper mapper = new Mapper();
+
+
+    /**
+     * Mapper listener.
+     */
+    protected final MapperListener mapperListener =
+            new MapperListener(mapper, this);
+
+
     // ------------------------------------------------------------- Properties
 
+    @Override
+    public Mapper getMapper() {
+        return mapper;
+    }
+
 
     /**
      * Return the <code>Container</code> that handles requests for all
@@ -426,6 +446,9 @@ public class StandardService extends LifecycleMBeanBase implements Service {
             }
         }
 
+
+        mapperListener.start();
+
         // Start our defined Connectors second
         synchronized (connectorsLock) {
             for (Connector connector: connectors) {
@@ -499,6 +522,8 @@ public class StandardService extends LifecycleMBeanBase implements Service {
             }
         }
 
+        mapperListener.stop();
+
         synchronized (executors) {
             for (Executor executor: executors) {
                 executor.stop();
@@ -528,6 +553,9 @@ public class StandardService extends LifecycleMBeanBase implements Service {
             executor.init();
         }
 
+        // Initialize mapper listener
+        mapperListener.init();
+
         // Initialize our defined Connectors
         synchronized (connectorsLock) {
             for (Connector connector : connectors) {
@@ -547,6 +575,8 @@ public class StandardService extends LifecycleMBeanBase implements Service {
 
     @Override
     protected void destroyInternal() throws LifecycleException {
+        mapperListener.destroy();
+
         // Destroy our defined Connectors
         synchronized (connectorsLock) {
             for (Connector connector : connectors) {

==================================================
MapperListener.java
index 953aaeb0f6..e63e070aed 100644
--- a/java/org/apache/catalina/mapper/LocalStrings.properties
+++ b/java/org/apache/catalina/mapper/LocalStrings.properties
@@ -13,4 +13,12 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
-mapper.removeWrapper=Removing wrapper from Context [{0}] with path [{1}]
\ No newline at end of file
+mapper.removeWrapper=Removing wrapper from Context [{0}] with path [{1}]
+
+mapperListener.unknownDefaultHost=Unknown default host [{0}] for service [{1}]
+mapperListener.registerHost=Register host [{0}] at domain [{1}] for service [{2}]
+mapperListener.unregisterHost=Unregister host [{0}] at domain [{1}] for service [{2}]
+mapperListener.registerContext=Register Context [{0}] for service [{1}]
+mapperListener.unregisterContext=Unregister Context [{0}] for service [{1}]
+mapperListener.registerWrapper=Register Wrapper [{0}] in Context [{1}] for service [{2}]
+mapperListener.unregisterWrapper=Unregister Wrapper [{0}] in Context [{1}] for service [{2}]

==================================================
