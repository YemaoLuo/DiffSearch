c8168e12edb845947ab1af1bdebddeddb569bbec
==================================================
 When calling AuthConfigFactory.removeRegistration() and the registration is persistent, it should be removed from the persistent store.
==================================================
Mark Thomas
==================================================
Mon Nov 20 18:51:07 2017 +0000
==================================================
AuthConfigFactoryImpl.java
index cdebf87253..f01badcab8 100644
--- a/conf/jaspic-providers.xml
+++ b/conf/jaspic-providers.xml
@@ -1,23 +1,9 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<!--
-  Licensed to the Apache Software Foundation (ASF) under one or more
-  contributor license agreements.  See the NOTICE file distributed with
-  this work for additional information regarding copyright ownership.
-  The ASF licenses this file to You under the Apache License, Version 2.0
-  (the "License"); you may not use this file except in compliance with
-  the License.  You may obtain a copy of the License at
-
-      http://www.apache.org/licenses/LICENSE-2.0
-
-  Unless required by applicable law or agreed to in writing, software
-  distributed under the License is distributed on an "AS IS" BASIS,
-  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-  See the License for the specific language governing permissions and
-  limitations under the License.
--->
-<jaspic-providers xmlns="http://tomcat.apache.org/xml"
-                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-                  xsi:schemaLocation="http://tomcat.apache.org/xml jaspic-providers.xsd"
-                  version="1.0">
-  <!-- No JASPIC providers configured by default -->
+<?xml version='1.0' encoding='utf-8'?>
+<jaspic-providers
+    xmlns="http://tomcat.apache.org/xml"
+    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xsi:schemaLocation="http://tomcat.apache.org/xml jaspic-providers.xsd"
+    version="1.0">
+  <provider className="org.apache.catalina.authenticator.jaspic.SimpleAuthConfigProvider" layer="L_1" appContext="AC_1">
+  </provider>
 </jaspic-providers>

==================================================
TestAuthConfigFactoryImpl.java
index fda38feee5..153acad25b 100644
--- a/java/org/apache/catalina/authenticator/jaspic/AuthConfigFactoryImpl.java
+++ b/java/org/apache/catalina/authenticator/jaspic/AuthConfigFactoryImpl.java
@@ -238,6 +238,9 @@ public class AuthConfigFactoryImpl extends AuthConfigFactory {
             for (RegistrationListenerWrapper wrapper : registration.listeners) {
                 wrapper.getListener().notify(wrapper.getMessageLayer(), wrapper.getAppContext());
             }
+            if (registration.isPersistent()) {
+                savePersistentRegistrations();
+            }
             return true;
         }
     }

==================================================
