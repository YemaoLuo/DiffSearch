c91d98fcc8a465bbb0378c1686465203f7468c4c
==================================================
Ensure that onAllDataRead() event is always fired once (and once only) after the request body has been read
==================================================
Mark Emlyn
==================================================
Tue Nov 26 11:06:03 2013 +0000
==================================================
CoyoteAdapter.java
Ensure that onAllDataRead() event is always fired once (and once only) after the request body has been read

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1545613 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Request.java
index 8055d5bff4..6332cfafcb 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -364,6 +364,9 @@ public class CoyoteAdapter implements Adapter {
                     try {
                         Thread.currentThread().setContextClassLoader(newCL);
                         res.onWritePossible();
+                        if (request.isFinished() && req.sendAllDataReadEvent()) {
+                            req.getReadListener().onAllDataRead();
+                        }
                     } catch (Throwable t) {
                         ExceptionUtils.handleThrowable(t);
                         res.getWriteListener().onError(t);
@@ -381,7 +384,7 @@ public class CoyoteAdapter implements Adapter {
                     try {
                         Thread.currentThread().setContextClassLoader(newCL);
                         req.getReadListener().onDataAvailable();
-                        if (request.isFinished()) {
+                        if (request.isFinished() && req.sendAllDataReadEvent()) {
                             req.getReadListener().onAllDataRead();
                         }
                     } catch (Throwable t) {
@@ -548,7 +551,9 @@ public class CoyoteAdapter implements Adapter {
                             request.getContext().getLoader().getClassLoader();
                     try {
                         Thread.currentThread().setContextClassLoader(newCL);
-                        req.getReadListener().onAllDataRead();
+                        if (req.sendAllDataReadEvent()) {
+                            req.getReadListener().onAllDataRead();
+                        }
                     } finally {
                         Thread.currentThread().setContextClassLoader(oldCL);
                     }

==================================================
