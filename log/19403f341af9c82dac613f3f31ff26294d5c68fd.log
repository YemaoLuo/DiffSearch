19403f341af9c82dac613f3f31ff26294d5c68fd
==================================================
Add support to HTTP/2 test parser for push promise frames.
==================================================
Mark Thomas
==================================================
Fri Jan 14 19:24:42 2022 +0000
==================================================
Http2TestBase.java
Add support to HTTP/2 test parser for push promise frames.


==================================================
TesterHttp2Parser.java
index 6e97e5a8c6..76da7e0103 100644
--- a/test/org/apache/coyote/http2/Http2TestBase.java
+++ b/test/org/apache/coyote/http2/Http2TestBase.java
@@ -202,7 +202,7 @@ public abstract class Http2TestBase extends TomcatBaseTest {
 
     protected void buildGetRequest(byte[] frameHeader, ByteBuffer headersPayload, byte[] padding,
             int streamId, String url) {
-        List<Header> headers = new ArrayList<>(3);
+        List<Header> headers = new ArrayList<>(4);
         headers.add(new Header(":method", "GET"));
         headers.add(new Header(":scheme", "http"));
         headers.add(new Header(":path", url));
@@ -1033,6 +1033,7 @@ public abstract class Http2TestBase extends TomcatBaseTest {
         private boolean traceBody = false;
         private ByteBuffer bodyBuffer = null;
         private long bytesRead;
+        private volatile HpackDecoder hpackDecoder = null;
 
         public void setTraceBody(boolean traceBody) {
             this.traceBody = traceBody;
@@ -1041,7 +1042,14 @@ public abstract class Http2TestBase extends TomcatBaseTest {
 
         @Override
         public HpackDecoder getHpackDecoder() {
-            return new HpackDecoder(remoteSettings.getHeaderTableSize());
+            if (hpackDecoder == null) {
+                synchronized (this) {
+                    if (hpackDecoder == null) {
+                        hpackDecoder = new HpackDecoder(remoteSettings.getHeaderTableSize());
+                    }
+                }
+            }
+            return hpackDecoder;
         }
 
 
@@ -1221,6 +1229,14 @@ public abstract class Http2TestBase extends TomcatBaseTest {
         }
 
 
+        public void pushPromise(int streamId, int pushedStreamId) {
+            trace.append(streamId);
+            trace.append("-PushPromise-");
+            trace.append(pushedStreamId);
+            trace.append("\n");
+        }
+
+
         public void clearTrace() {
             trace = new StringBuffer();
             bytesRead = 0;

==================================================
