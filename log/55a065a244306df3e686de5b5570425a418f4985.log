55a065a244306df3e686de5b5570425a418f4985
==================================================
Switch to using lastAsyncStart to calculate the async timeouts
==================================================
Mark Emlyn
==================================================
Wed Nov 12 10:48:41 2014 +0000
==================================================
AbstractEndpoint.java
Switch to using lastAsyncStart to calculate the async timeouts

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1638744 13f79535-47bb-0310-9956-ffa450edef68



==================================================
NioEndpoint.java
index dc58c02ad4..4bf24cda87 100644
--- a/java/org/apache/tomcat/util/net/AbstractEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AbstractEndpoint.java
@@ -129,7 +129,7 @@ public abstract class AbstractEndpoint<S> {
                 }
                 long now = System.currentTimeMillis();
                 for (SocketWrapperBase<S> socket : waitingRequests) {
-                    long access = socket.getLastAccess();
+                    long access = socket.getLastAsyncStart();
                     if (socket.getTimeout() > 0 && (now - access) > socket.getTimeout()) {
                         processSocket(socket, SocketStatus.TIMEOUT, true);
                     }

==================================================
SocketWrapperBase.java
index c890cb3219..74b6747b52 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -1292,7 +1292,7 @@ public class NioEndpoint extends AbstractEndpoint<NioChannel> {
                             processKey(key,ka);
                         } else if (!ka.isAsync() || ka.getTimeout() > 0) {
                             // Async requests with a timeout of 0 or less never timeout
-                            long delta = now - ka.getLastAccess();
+                            long delta = now - ka.getLastAsyncStart();
                             long timeout = (ka.getTimeout()==-1)?((long) socketProperties.getSoTimeout()):(ka.getTimeout());
                             boolean isTimedout = delta > timeout;
                             if (isTimedout) {

==================================================
