e6407ae3379c6478acafb7fcb9d7078731f1db3f
==================================================
Fix regression in filtering. byte is signed, not unsigned.
==================================================
Mark Emlyn
==================================================
Sun Oct 12 10:01:51 2014 +0000
==================================================
AjpMessage.java
Fix regression in filtering. byte is signed, not unsigned.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1631156 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AbstractOutputBuffer.java
index a3b94f177e..e4a5ee7f91 100644
--- a/java/org/apache/coyote/ajp/AjpMessage.java
+++ b/java/org/apache/coyote/ajp/AjpMessage.java
@@ -166,8 +166,13 @@ public class AjpMessage {
             // corrupted.
             byte[] buffer = bc.getBuffer();
             for (int i = bc.getOffset(); i < bc.getLength(); i++) {
-                if (((buffer[i] <= 31) && (buffer[i] != 9)) ||
-                        buffer[i] == 127 || buffer[i] > 255) {
+                // byte values are signed i.e. -128 to 127
+                // The values are used unsigned. 0 to 31 are CTLs so they are
+                // filtered (apart from TAB which is 9). 127 is a control (DEL).
+                // The values 128 to 255 are all OK. Converting those to signed
+                // gives -128 to -1.
+                if ((buffer[i] > -1 && buffer[i] <= 31 && buffer[i] != 9) ||
+                        buffer[i] == 127) {
                     buffer[i] = ' ';
                 }
             }

==================================================
