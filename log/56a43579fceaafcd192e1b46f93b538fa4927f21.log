56a43579fceaafcd192e1b46f93b538fa4927f21
==================================================
Rework fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=56568
==================================================
Mark Emlyn
==================================================
Wed Aug 27 14:28:14 2014 +0000
==================================================
Compiler.java
Rework fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=56568

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1620903 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Generator.java
index 6d2182273e..b146ce7ed0 100644
--- a/java/org/apache/jasper/compiler/Compiler.java
+++ b/java/org/apache/jasper/compiler/Compiler.java
@@ -255,13 +255,6 @@ public abstract class Compiler {
             // to be GC'd and save memory.
             ctxt.setWriter(null);
 
-            if (jsw != null) {
-                // Need to know if the JSP is an error page at runtime to determine
-                // which HTTP methods are permitted. Error pages permit any. Normal
-                // pages only permit GET, POST or HEAD.
-                jsw.setErrorPage(pageInfo.isErrorPage());
-            }
-
             if (log.isDebugEnabled()) {
                 t4 = System.currentTimeMillis();
                 log.debug("Generated " + javaFileName + " total=" + (t4 - t1)

==================================================
JspServletWrapper.java
index 80ae85e2fc..8a4c88c58f 100644
--- a/java/org/apache/jasper/compiler/Generator.java
+++ b/java/org/apache/jasper/compiler/Generator.java
@@ -643,6 +643,20 @@ class Generator {
         out.pushIndent();
         out.println();
 
+        // Method check
+        if (!pageInfo.isErrorPage()) {
+            out.println("final java.lang.String _jspx_method = request.getMethod();");
+            out.print("if (!\"GET\".equals(_jspx_method) && !\"POST\".equals(_jspx_method) && !\"HEAD\".equals(_jspx_method) && ");
+            out.println("!javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {");
+            out.pushIndent();
+            out.print("response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, ");
+            out.println("\"" + Localizer.getMessage("jsp.error.servlet.invalid.method") + "\");");
+            out.println("return;");
+            out.popIndent();
+            out.println("}");
+            out.println();
+        }
+
         // Local variable declarations
         out.printil("final javax.servlet.jsp.PageContext pageContext;");
 

==================================================
TestJspServlet.java
index e67d30e2e1..d336cf9b2d 100644
--- a/java/org/apache/jasper/servlet/JspServletWrapper.java
+++ b/java/org/apache/jasper/servlet/JspServletWrapper.java
@@ -22,7 +22,6 @@ import java.io.IOException;
 import java.util.HashMap;
 import java.util.Map;
 
-import javax.servlet.DispatcherType;
 import javax.servlet.RequestDispatcher;
 import javax.servlet.Servlet;
 import javax.servlet.ServletConfig;
@@ -104,7 +103,6 @@ public class JspServletWrapper {
     private final boolean unloadAllowed;
     private final boolean unloadByCount;
     private final boolean unloadByIdle;
-    private boolean errorPage;
 
     /*
      * JspServletWrapper for JSP pages.
@@ -421,20 +419,6 @@ public class JspServletWrapper {
                 }
             }
 
-            String method = request.getMethod();
-
-            if (!"GET".equals(method) && !"POST".equals(method) && !"HEAD".equals(method) &&
-                    !DispatcherType.ERROR.equals(request.getDispatcherType()) &&
-                    !isErrorPage()) {
-                // Specification states behaviour is undefined
-                // Jasper opts to reject any other verbs, partly as they are
-                // unlikely to make sense in a JSP context and partly to protect
-                // against verb tampering
-                response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED,
-                        Localizer.getMessage("jsp.error.servlet.invalid.method"));
-                return;
-            }
-
             /*
              * (4) Service request
              */
@@ -601,14 +585,4 @@ public class JspServletWrapper {
             return new JasperException(ex);
         }
     }
-
-
-    public void setErrorPage(boolean errorPage) {
-        this.errorPage = errorPage;
-    }
-
-
-    public boolean isErrorPage() {
-        return errorPage;
-    }
 }

==================================================
