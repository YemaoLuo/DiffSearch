ee21e34216ddd77bcbe10fa170bce0b58abb4cd0
==================================================
Remove the option to use schema validation for *.jspx and *.tagx files
==================================================
Mark Emlyn
==================================================
Tue Nov 26 14:07:45 2013 +0000
==================================================
Context.java
Remove the option to use schema validation for *.jspx and *.tagx files

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1545665 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Globals.java
index 9b6bd7a951..dab578fbe0 100644
--- a/java/org/apache/catalina/Context.java
+++ b/java/org/apache/catalina/Context.java
@@ -634,24 +634,6 @@ public interface Context extends Container {
     public void setTldValidation(boolean tldValidation);
 
 
-    /**
-     * Will the parsing of *.jspx and *.tagx files for this Context be performed
-     * by a validating parser?
-     *
-     * @return true if validation is enabled.
-     */
-    public boolean getXmlValidationJspDoc();
-
-
-    /**
-     * Controls whether the parsing of *.jspx and *.tagx files for this Context
-     * will be performed by a validating parser.
-     *
-     * @param xmlValidationJspDoc true to enable xml validation
-     */
-    public void setXmlValidationJspDoc(boolean xmlValidationJspDoc);
-
-
     /**
      * Get the Jar Scanner to be used to scan for JAR resources for this
      * context.

==================================================
ApplicationContext.java
index 74d7a41e87..9cda32b22e 100644
--- a/java/org/apache/catalina/Globals.java
+++ b/java/org/apache/catalina/Globals.java
@@ -279,14 +279,4 @@ public final class Globals {
      */
     public static final String JASPER_XML_VALIDATION_TLD_INIT_PARAM =
             "org.apache.jasper.XML_VALIDATE_TLD";
-
-
-    /**
-     * Name of the ServletContext init-param that determines if the JSP engine
-     * should validate *.jspx and *.tagx files when parsing them.
-     * <p>
-     * This must be kept in sync with org.apache.jasper.Constants
-     */
-    public static final String JASPER_XML_VALIDATION_DOC_INIT_PARAM =
-            "org.apache.jasper.XML_VALIDATE_DOC";
 }

==================================================
StandardContext.java
index 55e638b150..1a32ff8c51 100644
--- a/java/org/apache/catalina/core/ApplicationContext.java
+++ b/java/org/apache/catalina/core/ApplicationContext.java
@@ -309,9 +309,6 @@ public class ApplicationContext
         if (Globals.JASPER_XML_VALIDATION_TLD_INIT_PARAM.equals(name) &&
                 context.getTldValidation()) {
             return "true";
-        } else if (Globals.JASPER_XML_VALIDATION_DOC_INIT_PARAM.equals(name) &&
-                context.getXmlValidationJspDoc()) {
-            return "true";
         }
         return parameters.get(name);
     }
@@ -330,9 +327,6 @@ public class ApplicationContext
         if (context.getTldValidation()) {
             names.add(Globals.JASPER_XML_VALIDATION_TLD_INIT_PARAM);
         }
-        if (context.getXmlValidationJspDoc()) {
-            names.add(Globals.JASPER_XML_VALIDATION_DOC_INIT_PARAM);
-        }
         return Collections.enumeration(names);
     }
 

==================================================
FailedContext.java
index a618d4f3a6..1eee6b2616 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -694,13 +694,6 @@ public class StandardContext extends ContainerBase
     private boolean webXmlValidation = Globals.STRICT_SERVLET_COMPLIANCE;
 
 
-    /**
-     * Attribute value used to turn on/off XML validation for *.jspx and *.tagx
-     * files.
-     */
-    private boolean xmlValidationJspDoc = false;
-
-
     /**
      * Attribute value used to turn on/off XML namespace validation
      */
@@ -6405,18 +6398,6 @@ public class StandardContext extends ContainerBase
     }
 
 
-    @Override
-    public void setXmlValidationJspDoc(boolean webXmlValidationJspDoc) {
-        this.xmlValidationJspDoc = webXmlValidationJspDoc;
-    }
-
-
-    @Override
-    public boolean getXmlValidationJspDoc() {
-        return xmlValidationJspDoc;
-    }
-
-
     /**
      * Support for "stateManageable" JSR77
      */

==================================================
Constants.java
index 2e8c87637b..c995c43a8e 100644
--- a/java/org/apache/catalina/startup/FailedContext.java
+++ b/java/org/apache/catalina/startup/FailedContext.java
@@ -460,11 +460,6 @@ public class FailedContext extends LifecycleMBeanBase implements Context {
     @Override
     public void setTldValidation(boolean tldValidation){ /* NO-OP */ }
 
-    @Override
-    public boolean getXmlValidationJspDoc() { return false; }
-    @Override
-    public void setXmlValidationJspDoc(boolean xmlValidationJspDoc) { /* NO-OP */ }
-
     @Override
     public JarScanner getJarScanner() { return null; }
     @Override

==================================================
JspC.java
index ee72fcfbba..aa39683de4 100644
--- a/java/org/apache/jasper/Constants.java
+++ b/java/org/apache/jasper/Constants.java
@@ -160,14 +160,4 @@ public class Constants {
      */
     public static final String XML_VALIDATION_TLD_INIT_PARAM =
             "org.apache.jasper.XML_VALIDATE_TLD";
-
-
-    /**
-     * Name of the ServletContext init-param that determines if the XML parsers
-     * used for *.jspx and *.tagx files will be validating or not.
-     * <p>
-     * This must be kept in sync with org.apache.catalina.Globals
-     */
-    public static final String XML_VALIDATION_DOC_INIT_PARAM =
-            "org.apache.jasper.XML_VALIDATE_DOC";
 }

==================================================
JspDocumentParser.java
index 83b28733a7..f53a27b165 100644
--- a/java/org/apache/jasper/JspC.java
+++ b/java/org/apache/jasper/JspC.java
@@ -134,7 +134,6 @@ public class JspC extends Task implements Options {
     protected static final String SWITCH_SMAP = "-smap";
     protected static final String SWITCH_DUMP_SMAP = "-dumpsmap";
     protected static final String SWITCH_VALIDATE_TLD = "-validateTld";
-    protected static final String SWITCH_VALIDATE_DOC = "-validateDoc";
     protected static final String SHOW_SUCCESS ="-s";
     protected static final String LIST_ERRORS = "-l";
     protected static final int INC_WEBXML = 10;
@@ -166,7 +165,6 @@ public class JspC extends Task implements Options {
     protected boolean trimSpaces = false;
     protected boolean genStringAsCharArray = false;
     protected boolean validateTld;
-    protected boolean validateJspDoc;
     protected boolean xpoweredBy;
     protected boolean mappedFile = false;
     protected boolean poolingEnabled = true;
@@ -375,8 +373,6 @@ public class JspC extends Task implements Options {
                 smapDumped = true;
             } else if (tok.equals(SWITCH_VALIDATE_TLD)) {
                 setValidateTld(true);
-            } else if (tok.equals(SWITCH_VALIDATE_DOC)) {
-                setValidateJspDoc(true);
             } else {
                 if (tok.startsWith("-")) {
                     throw new JasperException("Unrecognized option: " + tok +
@@ -864,14 +860,6 @@ public class JspC extends Task implements Options {
         return validateTld;
     }
 
-    public void setValidateJspDoc( boolean b ) {
-        this.validateJspDoc = b;
-    }
-
-    public boolean isValidateJspDoc() {
-        return validateJspDoc;
-    }
-
     public void setListErrors( boolean b ) {
         listErrors = b;
     }
@@ -1449,9 +1437,6 @@ public class JspC extends Task implements Options {
         URL resourceBase = new File(uriRoot).getCanonicalFile().toURI().toURL();
 
         context = new JspCServletContext(log, resourceBase, classLoader);
-        if (isValidateJspDoc()) {
-            context.setInitParameter(Constants.XML_VALIDATION_DOC_INIT_PARAM, "true");
-        }
         if (isValidateTld()) {
             context.setInitParameter(Constants.XML_VALIDATION_TLD_INIT_PARAM, "true");
         }

==================================================
TesterContext.java
index 74c09960de..286749d33c 100644
--- a/java/org/apache/jasper/compiler/JspDocumentParser.java
+++ b/java/org/apache/jasper/compiler/JspDocumentParser.java
@@ -28,7 +28,6 @@ import javax.servlet.jsp.tagext.TagLibraryInfo;
 import javax.xml.parsers.SAXParser;
 import javax.xml.parsers.SAXParserFactory;
 
-import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.JspCompilationContext;
 import org.apache.tomcat.util.descriptor.tld.TldResourcePath;
@@ -162,13 +161,10 @@ class JspDocumentParser
                 jspDocParser.isTop = false;
             }
 
-            boolean validate = Boolean.parseBoolean(
-                    pc.getJspCompilationContext().getServletContext().getInitParameter(
-                            Constants.XML_VALIDATION_DOC_INIT_PARAM));
-            jspDocParser.isValidating = validate;
+            jspDocParser.isValidating = false;
 
             // Parse the input
-            SAXParser saxParser = getSAXParser(validate, jspDocParser);
+            SAXParser saxParser = getSAXParser(false, jspDocParser);
             InputSource source = JspUtil.getInputSource(path, jar, jspDocParser.ctxt);
             try {
                 saxParser.parse(source, jspDocParser);

==================================================
TestJspDocumentParser.java
index d65ede4439..7ee1e0ba7f 100644
--- a/test/org/apache/catalina/core/TesterContext.java
+++ b/test/org/apache/catalina/core/TesterContext.java
@@ -634,16 +634,6 @@ public class TesterContext implements Context {
         return false;
     }
 
-    @Override
-    public boolean getXmlValidationJspDoc() {
-        return false;
-    }
-
-    @Override
-    public void setXmlValidationJspDoc(boolean xmlValidationJspDoc) {
-       // NO-OP
-    }
-
     @Override
     public void setXmlValidation(boolean xmlValidation) {
         // NO-OP

==================================================
