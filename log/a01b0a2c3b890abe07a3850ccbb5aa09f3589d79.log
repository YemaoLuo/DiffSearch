a01b0a2c3b890abe07a3850ccbb5aa09f3589d79
==================================================
Fix change fragment absolute-ordering at web.xml with manager redeploy!
==================================================
Peter Rossbach
==================================================
Fri May 14 15:00:06 2010 +0000
==================================================
ContextConfig.java
Fix change fragment absolute-ordering at web.xml with manager redeploy!

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@944304 13f79535-47bb-0310-9956-ffa450edef68



==================================================
BaseDirContext.java
index 1c6c6af81f..2e2b9cae4c 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -1171,7 +1171,7 @@ public class ContextConfig
      * web.xml file.
      */
     protected void webConfig() {
-        WebXml webXml = new WebXml();
+        WebXml webXml = createWebXml();
 
         // Parse global web.xml if present
         InputSource globalWebXml = getGlobalWebXmlSource();
@@ -1281,7 +1281,10 @@ public class ContextConfig
         }
     }
 
-    
+    protected WebXml createWebXml() {
+        return new WebXml();
+    }
+
     /**
      * Scan JARs for ServletContainerInitializer implementations.
      * Implementations will be added in web-fragment.xml priority order.

==================================================
TestStandardContextResources.java
index 5e72fa6696..e8fe554d10 100644
--- a/java/org/apache/naming/resources/BaseDirContext.java
+++ b/java/org/apache/naming/resources/BaseDirContext.java
@@ -375,7 +375,16 @@ public abstract class BaseDirContext implements DirContext {
      * Release any resources allocated for this directory context.
      */
     public void release() {
-        // No action taken by the default implementation
+        for(BaseDirContext bcontext: this.aliases.values()) {
+            bcontext.release();
+        }
+        this.aliases.clear();
+        for(DirContext dcontext: this.altDirContexts) {
+            if(dcontext instanceof BaseDirContext) {
+                ((BaseDirContext)dcontext).release();
+            }
+        }
+        this.altDirContexts.clear();        
     }
 
     

==================================================
