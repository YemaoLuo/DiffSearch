514f7ca22550007598bf376a675c392e14c912e3
==================================================
Ensure that the HEAD response is consistent with the GET response when HttpServlet is relied upon to generate the HEAD response and the GET response uses chunking.
==================================================
Mark Thomas
==================================================
Wed Dec 12 23:25:39 2018 +0000
==================================================
HttpServlet.java
Ensure that the HEAD response is consistent with the GET response when HttpServlet is relied upon to generate the HEAD response and the GET response uses chunking.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1848810 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestHttpServlet.java
index 92794c2be1..f28eac3d6e 100644
--- a/java/javax/servlet/http/HttpServlet.java
+++ b/java/javax/servlet/http/HttpServlet.java
@@ -758,7 +758,7 @@ class NoBodyResponse extends HttpServletResponseWrapper {
     // file private
     NoBodyResponse(HttpServletResponse r) {
         super(r);
-        noBody = new NoBodyOutputStream();
+        noBody = new NoBodyOutputStream(this);
     }
 
     // file private
@@ -847,11 +847,13 @@ class NoBodyOutputStream extends ServletOutputStream {
     private static final ResourceBundle lStrings =
         ResourceBundle.getBundle(LSTRING_FILE);
 
+    private final HttpServletResponse response;
+    private boolean flushed = false;
     private int contentLength = 0;
 
     // file private
-    NoBodyOutputStream() {
-        // NOOP
+    NoBodyOutputStream(HttpServletResponse response) {
+        this.response = response;
     }
 
     // file private
@@ -860,8 +862,9 @@ class NoBodyOutputStream extends ServletOutputStream {
     }
 
     @Override
-    public void write(int b) {
+    public void write(int b) throws IOException {
         contentLength++;
+        checkCommit();
     }
 
     @Override
@@ -882,6 +885,7 @@ class NoBodyOutputStream extends ServletOutputStream {
         }
 
         contentLength += len;
+        checkCommit();
     }
 
     @Override
@@ -894,4 +898,11 @@ class NoBodyOutputStream extends ServletOutputStream {
     public void setWriteListener(javax.servlet.WriteListener listener) {
         // TODO SERVLET 3.1
     }
+
+    private void checkCommit() throws IOException {
+        if (!flushed && contentLength > response.getBufferSize()) {
+            response.flushBuffer();
+            flushed = true;
+        }
+    }
 }

==================================================
