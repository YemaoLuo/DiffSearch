553eb18995b5f8d005699293fcc06a88ee19fbf6
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58624
==================================================
Mark Thomas
==================================================
Tue Nov 24 22:20:22 2015 +0000
==================================================
WsRemoteEndpointImplBase.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58624
Correct a potential deadlock if the WebSocket connection is closed when a message write is in progress.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1716269 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestWsRemoteEndpointImplServer.java
index 0cc7891669..1983310747 100644
--- a/java/org/apache/tomcat/websocket/WsRemoteEndpointImplBase.java
+++ b/java/org/apache/tomcat/websocket/WsRemoteEndpointImplBase.java
@@ -289,15 +289,13 @@ public abstract class WsRemoteEndpointImplBase implements RemoteEndpoint {
         }
 
         long timeout = timeoutExpiry - System.currentTimeMillis();
-        synchronized (messagePartLock) {
-            try {
-                if (!messagePartInProgress.tryAcquire(timeout, TimeUnit.MILLISECONDS)) {
-                    throw new SocketTimeoutException();
-                }
-            } catch (InterruptedException e) {
-                // TODO i18n
-                throw new IOException(e);
+        try {
+            if (!messagePartInProgress.tryAcquire(timeout, TimeUnit.MILLISECONDS)) {
+                throw new SocketTimeoutException();
             }
+        } catch (InterruptedException e) {
+            // TODO i18n
+            throw new IOException(e);
         }
 
         for (MessagePart mp : messageParts) {

==================================================
