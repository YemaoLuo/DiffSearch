0b80308a371658f4e9bce8f3347ce5330487c290
==================================================
Need to add an additional test.
==================================================
Mark Emlyn
==================================================
Wed Dec 26 00:41:13 2012 +0000
==================================================
Utf8Decoder.java
Need to add an additional test.
Also add extra tests when buffers not backed by arrays.
Expand the test cases to cover the Autobahn failures

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1425801 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestUtf8.java
index c86e5e33cc..fd5b845af4 100644
--- a/java/org/apache/tomcat/websocket/Utf8Decoder.java
+++ b/java/org/apache/tomcat/websocket/Utf8Decoder.java
@@ -114,6 +114,10 @@ public class Utf8Decoder extends CharsetDecoder {
                     }
                     pos += tail;
                 }
+                // Note: This is the additional test added
+                if ((jchar >= 0xD800 && jchar <= 0xDFFF) || jchar > 0x10FFFF) {
+                    return CoderResult.unmappableForLength(3);
+                }
                 if (jchar <= 0xffff) {
                     out.put((char) jchar);
                     outRemaining--;
@@ -177,7 +181,7 @@ public class Utf8Decoder extends CharsetDecoder {
                 inIndex += tail;
             }
             // Note: This is the additional test added
-            if (jchar >= 0xD800 && jchar <= 0xDFFF) {
+            if ((jchar >= 0xD800 && jchar <= 0xDFFF) || jchar > 0x10FFFF) {
                 return CoderResult.unmappableForLength(3);
             }
             if (jchar <= 0xffff) {

==================================================
