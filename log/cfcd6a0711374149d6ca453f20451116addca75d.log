cfcd6a0711374149d6ca453f20451116addca75d
==================================================
Yet another attempt to fix Comet test failures for Connector stop.
==================================================
Mark Emlyn
==================================================
Fri Aug 31 20:19:12 2012 +0000
==================================================
Http11AprProtocol.java
Yet another attempt to fix Comet test failures for Connector stop.
If the endpoint is stopped - don't add sockets to the poller (it may have been stopped already) and process the STOP event directly.
If the connector stop has completed then the executor may be null so protect against NPEs and log when a socket couldn't be processed.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1379580 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AprEndpoint.java
index 5b8060c81a..ca430954d9 100644
--- a/java/org/apache/coyote/http11/Http11AprProtocol.java
+++ b/java/org/apache/coyote/http11/Http11AprProtocol.java
@@ -293,9 +293,16 @@ public class Http11AprProtocol extends AbstractHttp11Protocol<Long> {
                 socket.setAsync(true);
             } else if (processor.isComet()) {
                 // Comet
-                ((AprEndpoint) proto.endpoint).getCometPoller().add(
-                        socket.getSocket().longValue(),
-                        proto.endpoint.getSoTimeout());
+                if (proto.endpoint.isRunning()) {
+                    ((AprEndpoint) proto.endpoint).getCometPoller().add(
+                            socket.getSocket().longValue(),
+                            proto.endpoint.getSoTimeout());
+                } else {
+                    // Process a STOP directly
+                    ((AprEndpoint) proto.endpoint).processSocket(
+                            socket.getSocket().longValue(),
+                            SocketStatus.STOP);
+                }
             } else {
                 // Upgraded
                 ((AprEndpoint) proto.endpoint).getPoller().add(

==================================================
