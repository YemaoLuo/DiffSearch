0f69c9b27578e8379aaa43a87f7b0bd3b33e8914
==================================================
Make unescaping the exact reverse of escaping.
==================================================
Mark Emlyn
==================================================
Sat Oct 20 22:52:47 2007 +0000
==================================================
Cookies.java
index c887bf77ea..f05dca2c92 100644
--- a/STATUS
+++ b/STATUS
@@ -57,15 +57,6 @@ Index: /home/remm/Work/eclipse/jbossweb-2.1.x/apache-tomcat-6.0.x/bin/setclasspa
    Comment by rjung: Maybe switching "then" and "else" cases by using "-x" instead of "! -x".
                      This way the error exit stays the last case which seems more natural.
 
-    
-* Final fixes to the Cookie handling. This makes sure that we unescape any value
-  that has been quoted and ensures the unescaping is the exact reverse of the
-  escaping. This patch also tidies up ServerCookie to make it clearer what
-  applies to which particular cookie spec.
-  http://people.apache.org/~markt/patches/2007-10-18-cookies.patch
-  +1: markt, fhanik,funkman
-  -1:
-
 * Fix MD5 files for distribution
   http://issues.apache.org/bugzilla/attachment.cgi?id=21009&action=view
   +1: fhanik,funkman

==================================================
ServerCookie.java
index 7221071d79..d3de33a294 100644
--- a/java/org/apache/tomcat/util/http/Cookies.java
+++ b/java/org/apache/tomcat/util/http/Cookies.java
@@ -345,9 +345,11 @@ public final class Cookies { // extends MultiMap {
         int version = 0;
         ServerCookie sc=null;
         boolean isSpecial;
+        boolean isQuoted;
 
         while (pos < end) {
             isSpecial = false;
+            isQuoted = false;
 
             // Skip whitespace and non-token characters (separators)
             while (pos < end && 
@@ -389,6 +391,7 @@ public final class Cookies { // extends MultiMap {
                 // token, name-only with an '=', or other (bad)
                 switch (bytes[pos]) {
                 case '"':; // Quoted Value
+                    isQuoted = true;
                     valueStart=pos + 1; // strip "
                     // getQuotedValue returns the position before 
                     // at the last qoute. This must be dealt with
@@ -532,7 +535,12 @@ public final class Cookies { // extends MultiMap {
                 
                 if (valueStart != -1) { // Normal AVPair
                     sc.getValue().setBytes( bytes, valueStart,
-                                            valueEnd-valueStart);
+                            valueEnd-valueStart);
+                    if (isQuoted) {
+                        // We know this is a byte value so this is safe
+                        ServerCookie.unescapeDoubleQuotes(
+                                sc.getValue().getByteChunk());
+                    }
                 } else {
                     // Name Only
                     sc.getValue().setString(""); 

==================================================
