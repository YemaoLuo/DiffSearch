fc943093e9b8e4a9b6207317cf8a55b8c307b7c0
==================================================
Fix a file descriptor leak when reading the global web.xml.
==================================================
Mark Thomas
==================================================
Wed Aug 24 14:02:16 2016 +0000
==================================================
ContextConfig.java
Fix a file descriptor leak when reading the global web.xml.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1757527 13f79535-47bb-0310-9956-ffa450edef68



==================================================
InputSourceUtil.java
index 8708453a37..0b0ab9209a 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -80,6 +80,7 @@ import org.apache.tomcat.util.bcel.classfile.ElementValue;
 import org.apache.tomcat.util.bcel.classfile.ElementValuePair;
 import org.apache.tomcat.util.bcel.classfile.JavaClass;
 import org.apache.tomcat.util.buf.UriUtil;
+import org.apache.tomcat.util.descriptor.InputSourceUtil;
 import org.apache.tomcat.util.descriptor.XmlErrorHandler;
 import org.apache.tomcat.util.descriptor.web.ContextEjb;
 import org.apache.tomcat.util.descriptor.web.ContextEnvironment;
@@ -1504,6 +1505,8 @@ public class ContextConfig implements LifecycleListener {
 
         if (entry != null && entry.getGlobalTimeStamp() == globalTimeStamp &&
                 entry.getHostTimeStamp() == hostTimeStamp) {
+            InputSourceUtil.close(globalWebXml);
+            InputSourceUtil.close(hostWebXml);
             return entry.getWebXml();
         }
 

==================================================
WebXmlParser.java
new file mode 100644
index 0000000000..ea70a68c3d
--- /dev/null
+++ b/java/org/apache/tomcat/util/descriptor/InputSourceUtil.java
@@ -0,0 +1,47 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.descriptor;
+
+import java.io.InputStream;
+
+import org.apache.tomcat.util.ExceptionUtils;
+import org.xml.sax.InputSource;
+
+public final class InputSourceUtil {
+
+    private InputSourceUtil() {
+        // Utility class. Hide default constructor.
+    }
+
+
+    public static void close(InputSource inputSource) {
+        if (inputSource == null) {
+            // Nothing to do
+            return;
+        }
+
+        InputStream is = inputSource.getByteStream();
+        if (is != null) {
+            try {
+                is.close();
+            } catch (Throwable t) {
+                ExceptionUtils.handleThrowable(t);
+            }
+        }
+
+    }
+}

==================================================
