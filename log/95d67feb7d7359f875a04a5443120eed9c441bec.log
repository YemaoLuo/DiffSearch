95d67feb7d7359f875a04a5443120eed9c441bec
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51555
==================================================
Mark Emlyn
==================================================
Tue Jul 26 08:25:46 2011 +0000
==================================================
Lifecycle.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51555
Permit an additional lifecycle transition. Allow destroy() to be called on components that are initialized. This can occur in some start failure scenarios.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1151016 13f79535-47bb-0310-9956-ffa450edef68



==================================================
LifecycleBase.java
index d1e3cde2cb..eb2551fc9a 100644
--- a/java/org/apache/catalina/Lifecycle.java
+++ b/java/org/apache/catalina/Lifecycle.java
@@ -14,8 +14,6 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-
-
 package org.apache.catalina;
 
 
@@ -28,35 +26,38 @@ package org.apache.catalina;
  * The valid state transitions for components that support {@link Lifecycle}
  * are:
  * <pre>
- *    init()
- * NEW ->-- INITIALIZING
- * |||           |                  --------------------<-----------------------
- * |||           |auto              |                                          |
- * |||          \|/    start()     \|/       auto          auto         stop() |
- * |||      INITIALIZED -->-- STARTING_PREP -->- STARTING -->- STARTED -->---  |
- * |||                              ^                             |         |  |
- * |||        start()               |                             |         |  |
- * ||----------->--------------------                             |         |  |
- * ||                                                             |         |  |
- * |---                auto                    auto               |         |  |
- * |  |          ---------<----- MUST_STOP ---------------------<--         |  |
- * |  |          |                                                          |  |
- * |  |          ---------------------------<--------------------------------  ^
- * |  |          |                                                             |
- * |  |         \|/            auto                 auto              start()  |
- * |  |     STOPPING_PREP ------>----- STOPPING ------>----- STOPPED ---->------
- * |  |                                   ^                  |  |  ^
- * |  |                  stop()           |                  |  |  |
- * |  |          --------------------------                  |  |  |
- * |  |          |                                  auto     |  |  |
- * |  |          |                  MUST_DESTROY------<-------  |  |
- * |  |          |                    |                         |  |
- * |  |          |                    |auto                     |  |
- * |  |          |    destroy()      \|/              destroy() |  |
- * |  |       FAILED ---->------ DESTROYING ---<-----------------  |
- * |  |                           ^     |                          |
- * |  |        destroy()          |     |auto                      |
- * |  -----------------------------    \|/                         |
+ *            start()
+ *  -----------------------------
+ *  |                           |
+ *  | init()                    |
+ * NEW ->-- INITIALIZING        |
+ * | |           |              |     ------------------<-----------------------
+ * | |           |auto          |     |                                        |
+ * | |          \|/    start() \|/   \|/     auto          auto         stop() |
+ * | |      INITIALIZED -->-- STARTING_PREP -->- STARTING -->- STARTED -->---  |
+ * | |         |                                                  |         |  |
+ * | |         |                                                  |         |  |
+ * | |         |                                                  |         |  |
+ * | |destroy()|                                                  |         |  |
+ * | -->-----<--       auto                    auto               |         |  |
+ * |     |       ---------<----- MUST_STOP ---------------------<--         |  |
+ * |     |       |                                                          |  |
+ * |    \|/      ---------------------------<--------------------------------  ^
+ * |     |       |                                                             |
+ * |     |      \|/            auto                 auto              start()  |
+ * |     |  STOPPING_PREP ------>----- STOPPING ------>----- STOPPED ---->------
+ * |     |                                ^                  |  |  ^
+ * |     |               stop()           |                  |  |  |
+ * |     |       --------------------------                  |  |  |
+ * |     |       |                                  auto     |  |  |
+ * |     |       |                  MUST_DESTROY------<-------  |  |
+ * |     |       |                    |                         |  |
+ * |     |       |                    |auto                     |  |
+ * |     |       |    destroy()      \|/              destroy() |  |
+ * |     |    FAILED ---->------ DESTROYING ---<-----------------  |
+ * |     |                        ^     |                          |
+ * |     |     destroy()          |     |auto                      |
+ * |     -------->-----------------    \|/                         |
  * |                                 DESTROYED                     |
  * |                                                               |
  * |                            stop()                             |
@@ -93,7 +94,8 @@ package org.apache.catalina;
  * methods that trigger the changed. No {@link LifecycleEvent}s are fired if the
  * attempted transition is not valid.
  * 
- * TODO: Not all components may transition from STOPPED to STARTING_PREP
+ * TODO: Not all components may transition from STOPPED to STARTING_PREP. These
+ *       components should use MUST_DESTROY to signal this.
  *
  * @author Craig R. McClanahan
  * @version $Id$

==================================================
