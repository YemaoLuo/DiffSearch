bc161f3204b41f5f580d4ff4466b25aaea073c4e
==================================================
Fix BZ 66609. Correctly escape XML directory listings
==================================================
Mark Thomas
==================================================
Wed May 24 14:11:32 2023 +0100
==================================================
DefaultServlet.java
index ab0021e3e2..f189b100f6 100644
--- a/build.xml
+++ b/build.xml
@@ -864,6 +864,7 @@
         <exclude name="test/webapp-fragments/WEB-INF/classes/*.txt"/>
         <exclude name="test/webapp/bug49nnn/*.txt"/>
         <exclude name="test/webapp/bug53257/**/*.txt"/>
+        <exclude name="test/webapp/bug66609/*.txt"/>
         <exclude name="test/webresources/**/*.txt"/>
         <exclude name="**/*.mdl"/>
         <exclude name="**/*.pem"/>
@@ -912,8 +913,9 @@
         <exclude name=".*/**"/>
         <exclude name="**/*.pem"/>
         <!-- Exclude simple test files -->
-        <exclude name="webapp/bug53257/**/*.txt"/>
         <exclude name="webapp/bug49nnn/bug49464*"/>
+        <exclude name="webapp/bug53257/**/*.txt"/>
+        <exclude name="webapp/bug66609/*.txt"/>
         <exclude name="webapp-fragments/WEB-INF/classes/*.txt"/>
         <exclude name="webresources/**"/>
         <!-- Exclude test files with unusual encodings -->

==================================================
TestDefaultServlet.java
index 83e0aa142c..5c86b21170 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -1650,7 +1650,7 @@ public class DefaultServlet extends HttpServlet {
               .append('\'');
             sb.append(" urlPath='")
               .append(rewrittenContextPath)
-              .append(rewriteUrl(directoryWebappPath + entry))
+              .append(Escape.xml(rewriteUrl(directoryWebappPath + entry)))
               .append(childResource.isDirectory()?"/":"")
               .append('\'');
             if (childResource.isFile()) {

==================================================
