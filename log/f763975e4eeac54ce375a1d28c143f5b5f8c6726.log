f763975e4eeac54ce375a1d28c143f5b5f8c6726
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54947
==================================================
Mark Emlyn
==================================================
Tue May 28 11:26:20 2013 +0000
==================================================
InternalNioInputBuffer.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54947
NIO connector incorrectly rejects a request if the CRLF terminating the request line is split across multiple packets.
Patch for the fix by Konstantin Prei√üer.
I added a test case.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1486875 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SimpleHttpClient.java
index 00d5953bae..c5b1eb7ed3 100644
--- a/java/org/apache/coyote/http11/InternalNioInputBuffer.java
+++ b/java/org/apache/coyote/http11/InternalNioInputBuffer.java
@@ -372,11 +372,11 @@ public class InternalNioInputBuffer extends AbstractInputBuffer<NioChannel> {
             }
             parsingRequestLineStart = pos;
             parsingRequestLinePhase = 6;
-        }
-        if (parsingRequestLinePhase == 6) {
-            // Mark the current buffer position
 
+            // Mark the current buffer position
             end = 0;
+        }
+        if (parsingRequestLinePhase == 6) {
             //
             // Reading the protocol
             // Protocol is always US-ASCII

==================================================
TestInternalInputBuffer.java
index 284dec1f7a..2b72c23eca 100644
--- a/test/org/apache/catalina/startup/SimpleHttpClient.java
+++ b/test/org/apache/catalina/startup/SimpleHttpClient.java
@@ -42,7 +42,9 @@ public abstract class SimpleHttpClient {
     public static final String TEMP_DIR =
             System.getProperty("java.io.tmpdir");
 
-    public static final String CRLF = "\r\n";
+    public static final String CR = "\r";
+    public static final String LF = "\n";
+    public static final String CRLF = CR + LF;
 
     public static final String INFO_100 = "HTTP/1.1 100";
     public static final String OK_200 = "HTTP/1.1 200";

==================================================
