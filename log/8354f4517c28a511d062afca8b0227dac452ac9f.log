8354f4517c28a511d062afca8b0227dac452ac9f
==================================================
Remove static references to ExpressionFactory. These should be per web application.
==================================================
Mark Emlyn
==================================================
Fri Mar 30 19:32:01 2012 +0000
==================================================
Validator.java
Remove static references to ExpressionFactory. These should be per web application.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1307579 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JspApplicationContextImpl.java
index e5c289f6da..4873fe219c 100644
--- a/java/org/apache/jasper/compiler/Validator.java
+++ b/java/org/apache/jasper/compiler/Validator.java
@@ -27,6 +27,7 @@ import java.util.Locale;
 import javax.el.ELException;
 import javax.el.ExpressionFactory;
 import javax.el.FunctionMapper;
+import javax.servlet.jsp.JspFactory;
 import javax.servlet.jsp.tagext.FunctionInfo;
 import javax.servlet.jsp.tagext.PageData;
 import javax.servlet.jsp.tagext.TagAttributeInfo;
@@ -500,8 +501,7 @@ class Validator {
                 new JspUtil.ValidAttribute("doctype-public"),
                 new JspUtil.ValidAttribute("doctype-system") };
 
-        private static final ExpressionFactory EXPRESSION_FACTORY =
-            ExpressionFactory.newInstance();
+        private final ExpressionFactory expressionFactory;
 
         /*
          * Constructor
@@ -510,6 +510,11 @@ class Validator {
             this.pageInfo = compiler.getPageInfo();
             this.err = compiler.getErrorDispatcher();
             this.loader = compiler.getCompilationContext().getClassLoader();
+            // Get the cached EL expression factory for this context
+            expressionFactory =
+                    JspFactory.getDefaultFactory().getJspApplicationContext(
+                    compiler.getCompilationContext().getServletContext()).
+                    getExpressionFactory();
         }
 
         @Override
@@ -1177,7 +1182,7 @@ class Validator {
                                             Boolean.TYPE == expectedClass ||
                                             expectedClass.isEnum()) {
                                         try {
-                                            EXPRESSION_FACTORY.coerceToType(attrs.getValue(i), expectedClass);
+                                            expressionFactory.coerceToType(attrs.getValue(i), expectedClass);
                                         } catch (Exception e) {
                                             err.jspError
                                                 (n, "jsp.error.coerce_to_type",

==================================================
