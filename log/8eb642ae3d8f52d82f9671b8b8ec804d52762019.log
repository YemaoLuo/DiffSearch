8eb642ae3d8f52d82f9671b8b8ec804d52762019
==================================================
Strengthen WebSocket extension parameter validation
==================================================
Mark Emlyn
==================================================
Mon Jun 23 12:55:25 2014 +0000
==================================================
Util.java
index 4c5c982131..a237a85c57 100644
--- a/java/org/apache/tomcat/websocket/LocalStrings.properties
+++ b/java/org/apache/tomcat/websocket/LocalStrings.properties
@@ -28,6 +28,7 @@ asyncChannelWrapperSecure.wrongStateWrite=Flag that indicates a write is in prog
 
 backgroundProcessManager.processFailed=A background process failed
 
+util.notToken=An illegal extension parameter was specified with name [{0}] and value [{1}]
 util.invalidMessageHandler=The message handler provided does not have an onMessage(Object) method
 util.invalidType=Unable to coerce value [{0}] to type [{1}]. That type is not supported.
 util.unknownDecoderType=The Decoder type [{0}] is not recognized

==================================================
TestUtil.java
index a45a22ee16..c7797edeeb 100644
--- a/java/org/apache/tomcat/websocket/Util.java
+++ b/java/org/apache/tomcat/websocket/Util.java
@@ -478,10 +478,24 @@ public class Util {
                 } else {
                     name = unparsedParameters[i].substring(0, equalsPos).trim();
                     value = unparsedParameters[i].substring(equalsPos + 1).trim();
-                    if (value.length() > 2 && value.charAt(0) == '\"') {
-                        value = value.substring(1, value.length() - 1);
+                    int len = value.length();
+                    if (len > 1) {
+                        if (value.charAt(0) == '\"' && value.charAt(len - 1) == '\"') {
+                            value = value.substring(1, value.length() - 1);
+                        }
                     }
                 }
+                // Make sure value doesn't contain any of the delimiters since
+                // that would indicate something went wrong
+                if (containsDelims(name) || containsDelims(value)) {
+                    throw new IllegalArgumentException(sm.getString(
+                            "util.notToken", name, value));
+                }
+                if (value != null &&
+                        (value.indexOf(',') > -1 || value.indexOf(';') > -1 ||
+                        value.indexOf('\"') > -1 || value.indexOf('=') > -1)) {
+                    throw new IllegalArgumentException(sm.getString("", value));
+                }
                 extension.addParameter(new WsExtensionParameter(name, value));
             }
             extensions.add(extension);
@@ -489,6 +503,25 @@ public class Util {
     }
 
 
+    private static boolean containsDelims(String input) {
+        if (input == null || input.length() == 0) {
+            return false;
+        }
+        for (char c : input.toCharArray()) {
+            switch (c) {
+                case ',':
+                case ';':
+                case '\"':
+                case '=':
+                    return true;
+                default:
+                    // NO_OP
+            }
+
+        }
+        return false;
+    }
+
     private static Method getOnMessageMethod(MessageHandler listener) {
         try {
             return listener.getClass().getMethod("onMessage", Object.class);

==================================================
