7682a4f48a62b007af3a709c9ee5b91a5aab1872
==================================================
Expand test cases for servlet security annotations to include deny uncovered http methods.
==================================================
Mark Emlyn
==================================================
Fri Jun 21 12:41:13 2013 +0000
==================================================
StandardContext.java
Expand test cases for servlet security annotations to include deny uncovered http methods.
Fix the failure identified by violetagg

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1495414 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestStandardWrapper.java
index ff8a21c721..195b3dd586 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -5291,7 +5291,7 @@ public class StandardContext extends ContainerBase
             // Needs to be after SCIs and listeners as they may programatically
             // change constraints
             if (ok) {
-                checkConstraintsForUncoveredMethods();
+                checkConstraintsForUncoveredMethods(findConstraints());
             }
 
             try {
@@ -5358,9 +5358,10 @@ public class StandardContext extends ContainerBase
     }
 
 
-    private void checkConstraintsForUncoveredMethods() {
+    private void checkConstraintsForUncoveredMethods(
+            SecurityConstraint[] constraints) {
         SecurityConstraint[] newConstraints =
-                SecurityConstraint.findUncoveredHttpMethods(findConstraints(),
+                SecurityConstraint.findUncoveredHttpMethods(constraints,
                         getDenyUncoveredHttpMethods(), getLogger());
         for (SecurityConstraint constraint : newConstraints) {
             addConstraint(constraint);
@@ -5838,6 +5839,8 @@ public class StandardContext extends ContainerBase
                         newSecurityConstraints) {
                     addConstraint(securityConstraint);
                 }
+
+                checkConstraintsForUncoveredMethods(newSecurityConstraints);
             }
         }
 

==================================================
