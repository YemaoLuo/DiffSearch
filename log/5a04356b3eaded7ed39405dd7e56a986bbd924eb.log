5a04356b3eaded7ed39405dd7e56a986bbd924eb
==================================================
Generate a valid root element for all possible versions of web.xml
==================================================
Mark Emlyn
==================================================
Tue Feb 11 14:12:06 2014 +0000
==================================================
XmlIdentifiers.java
Generate a valid root element for all possible versions of web.xml

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1567144 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WebXml.java
index d09eaa62ef..c69ad9aa50 100644
--- a/java/org/apache/tomcat/util/descriptor/XmlIdentifiers.java
+++ b/java/org/apache/tomcat/util/descriptor/XmlIdentifiers.java
@@ -49,36 +49,29 @@ public final class XmlIdentifiers {
             "http://java.sun.com/dtd/web-jsptaglibrary_1_2.dtd";
 
     // from J2EE 1.4
-    public static final String WEB_24_XSD =
-            "http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd";
-    public static final String TLD_20_XSD =
-            "http://java.sun.com/xml/ns/j2ee/web-jsptaglibrary_2_0.xsd";
+    public static final String JAVAEE_1_4_NS = "http://java.sun.com/xml/ns/j2ee";
+    public static final String WEB_24_XSD = JAVAEE_1_4_NS + "/web-app_2_4.xsd";
+    public static final String TLD_20_XSD = JAVAEE_1_4_NS + "/web-jsptaglibrary_2_0.xsd";
     public static final String WEBSERVICES_11_XSD =
             "http://www.ibm.com/webservices/xsd/j2ee_web_services_1_1.xsd";
 
     // from JavaEE 5
-    public static final String WEB_25_XSD =
-            "http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd";
-    public static final String TLD_21_XSD =
-            "http://java.sun.com/xml/ns/javaee/web-jsptaglibrary_2_1.xsd";
-    public static final String WEBSERVICES_12_XSD =
-            "http://java.sun.com/xml/ns/javaee/javaee_web_services_1_2.xsd";
+    public static final String JAVAEE_5_NS = "http://java.sun.com/xml/ns/javaee";
+    public static final String WEB_25_XSD = JAVAEE_5_NS + "/web-app_2_5.xsd";
+    public static final String TLD_21_XSD = JAVAEE_5_NS + "/web-jsptaglibrary_2_1.xsd";
+    public static final String WEBSERVICES_12_XSD = JAVAEE_5_NS + "javaee_web_services_1_2.xsd";
 
     // from JavaEE 6
-    public static final String WEB_30_XSD =
-            "http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd";
-    public static final String WEB_FRAGMENT_30_XSD =
-            "http://java.sun.com/xml/ns/javaee/web-fragment_3_0.xsd";
-    public static final String WEBSERVICES_13_XSD =
-            "http://java.sun.com/xml/ns/javaee/javaee_web_services_1_3.xsd";
+    public static final String JAVAEE_6_NS = JAVAEE_5_NS;
+    public static final String WEB_30_XSD = JAVAEE_6_NS + "/web-app_3_0.xsd";
+    public static final String WEB_FRAGMENT_30_XSD = JAVAEE_6_NS + "/web-fragment_3_0.xsd";
+    public static final String WEBSERVICES_13_XSD = JAVAEE_6_NS + "/javaee_web_services_1_3.xsd";
 
     // from JavaEE 7
-    public static final String WEB_31_XSD =
-            "http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd";
-    public static final String WEB_FRAGMENT_31_XSD =
-            "http://xmlns.jcp.org/xml/ns/javaee/web-fragment_3_1.xsd";
-    public static final String WEBSERVICES_14_XSD =
-            "http://xmlns.jcp.org/xml/ns/javaee/javaee_web_services_1_4.xsd";
+    public static final String JAVAEE_7_NS = "http://xmlns.jcp.org/xml/ns/javaee";
+    public static final String WEB_31_XSD = JAVAEE_7_NS + "/web-app_3_1.xsd";
+    public static final String WEB_FRAGMENT_31_XSD = JAVAEE_7_NS + "/web-fragment_3_1.xsd";
+    public static final String WEBSERVICES_14_XSD = JAVAEE_7_NS + "/javaee_web_services_1_4.xsd";
 
     private XmlIdentifiers() {
     }

==================================================
TestWebXml.java
index 7c59ee6978..ec990fabb5 100644
--- a/java/org/apache/tomcat/util/descriptor/web/WebXml.java
+++ b/java/org/apache/tomcat/util/descriptor/web/WebXml.java
@@ -637,16 +637,55 @@ public class WebXml {
         sb.append("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n");
 
         // Root element
-        sb.append("<web-app xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\"\n");
-        sb.append("         xmlns:xsi=");
-        sb.append("\"http://www.w3.org/2001/XMLSchema-instance\"\n");
-        sb.append("         xsi:schemaLocation=");
-        sb.append("\"http://xmlns.jcp.org/xml/ns/javaee" +
-                  " http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd\"\n");
-        sb.append("         version=\"");
-        sb.append(getVersion());
-        sb.append("\"\n");
-        sb.append("         metadata-complete=\"true\">\n\n");
+        if (publicId != null) {
+            sb.append("<!DOCTYPE web-app PUBLIC\n");
+            sb.append("  \"");
+            sb.append(publicId);
+            sb.append("\"\n");
+            sb.append("  \"");
+            if (XmlIdentifiers.WEB_22_PUBLIC.equals(publicId)) {
+                sb.append(XmlIdentifiers.WEB_22_SYSTEM);
+            } else {
+                sb.append(XmlIdentifiers.WEB_23_SYSTEM);
+            }
+            sb.append("\">\n");
+            sb.append("<web-app>");
+        } else {
+            String javaeeNamespace = null;
+            String webXmlSchemaLocation = null;
+            String version = getVersion();
+            if ("2.4".equals(version)) {
+                javaeeNamespace = XmlIdentifiers.JAVAEE_1_4_NS;
+                webXmlSchemaLocation = XmlIdentifiers.WEB_24_XSD;
+            } else if ("2.5".equals(version)) {
+                javaeeNamespace = XmlIdentifiers.JAVAEE_5_NS;
+                webXmlSchemaLocation = XmlIdentifiers.WEB_25_XSD;
+            } else if ("3.0".equals(version)) {
+                javaeeNamespace = XmlIdentifiers.JAVAEE_6_NS;
+                webXmlSchemaLocation = XmlIdentifiers.WEB_30_XSD;
+            } else if ("3.1".equals(version)) {
+                javaeeNamespace = XmlIdentifiers.JAVAEE_7_NS;
+                webXmlSchemaLocation = XmlIdentifiers.WEB_31_XSD;
+            }
+            sb.append("<web-app xmlns=\"");
+            sb.append(javaeeNamespace);
+            sb.append("\"\n");
+            sb.append("         xmlns:xsi=");
+            sb.append("\"http://www.w3.org/2001/XMLSchema-instance\"\n");
+            sb.append("         xsi:schemaLocation=\"");
+            sb.append(javaeeNamespace);
+            sb.append(" ");
+            sb.append(webXmlSchemaLocation);
+            sb.append("\"\n");
+            sb.append("         version=\"");
+            sb.append(getVersion());
+            sb.append("\"");
+            if ("2.4".equals(version)) {
+                sb.append(">\n\n");
+            } else {
+                sb.append("\n         metadata-complete=\"true\">\n\n");
+            }
+        }
 
         appendElement(sb, INDENT2, "display-name", displayName);
 
@@ -781,23 +820,25 @@ public class WebXml {
             sb.append("  <session-config>\n");
             appendElement(sb, INDENT4, "session-timeout",
                     sessionConfig.getSessionTimeout());
-            sb.append("    <cookie-config>\n");
-            appendElement(sb, INDENT6, "name", sessionConfig.getCookieName());
-            appendElement(sb, INDENT6, "domain",
-                    sessionConfig.getCookieDomain());
-            appendElement(sb, INDENT6, "path", sessionConfig.getCookiePath());
-            appendElement(sb, INDENT6, "comment",
-                    sessionConfig.getCookieComment());
-            appendElement(sb, INDENT6, "http-only",
-                    sessionConfig.getCookieHttpOnly());
-            appendElement(sb, INDENT6, "secure",
-                    sessionConfig.getCookieSecure());
-            appendElement(sb, INDENT6, "max-age",
-                    sessionConfig.getCookieMaxAge());
-            sb.append("    </cookie-config>\n");
-            for (SessionTrackingMode stm :
-                    sessionConfig.getSessionTrackingModes()) {
-                appendElement(sb, INDENT4, "tracking-mode", stm.name());
+            if (majorVersion >= 3) {
+                sb.append("    <cookie-config>\n");
+                appendElement(sb, INDENT6, "name", sessionConfig.getCookieName());
+                appendElement(sb, INDENT6, "domain",
+                        sessionConfig.getCookieDomain());
+                appendElement(sb, INDENT6, "path", sessionConfig.getCookiePath());
+                appendElement(sb, INDENT6, "comment",
+                        sessionConfig.getCookieComment());
+                appendElement(sb, INDENT6, "http-only",
+                        sessionConfig.getCookieHttpOnly());
+                appendElement(sb, INDENT6, "secure",
+                        sessionConfig.getCookieSecure());
+                appendElement(sb, INDENT6, "max-age",
+                        sessionConfig.getCookieMaxAge());
+                sb.append("    </cookie-config>\n");
+                for (SessionTrackingMode stm :
+                        sessionConfig.getSessionTrackingModes()) {
+                    appendElement(sb, INDENT4, "tracking-mode", stm.name());
+                }
             }
             sb.append("  </session-config>\n\n");
         }

==================================================
