7ac69f888046435308357b9717688c910d1f0981
==================================================
Implemented a one time parachute for java heap oom. Should give the system enough room to properly report the error and clear the caches. everything else will be up to the developer at that time
==================================================
Filip Hanik
==================================================
Sun Mar 25 17:19:39 2007 +0000
==================================================
Http11NioProtocol.java
Implemented a one time parachute for java heap oom. Should give the system enough room to properly report the error and clear the caches. everything else will be up to the developer at that time


git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@522303 13f79535-47bb-0310-9956-ffa450edef68



==================================================
NioEndpoint.java
index 5bf03a88ca..ca4089c4d0 100644
--- a/java/org/apache/coyote/http11/Http11NioProtocol.java
+++ b/java/org/apache/coyote/http11/Http11NioProtocol.java
@@ -34,13 +34,13 @@ import org.apache.coyote.ProtocolHandler;
 import org.apache.coyote.RequestGroupInfo;
 import org.apache.coyote.RequestInfo;
 import org.apache.tomcat.util.modeler.Registry;
+import org.apache.tomcat.util.net.NioChannel;
 import org.apache.tomcat.util.net.NioEndpoint;
 import org.apache.tomcat.util.net.NioEndpoint.Handler;
-import org.apache.tomcat.util.res.StringManager;
-import org.apache.tomcat.util.net.NioChannel;
 import org.apache.tomcat.util.net.SSLImplementation;
 import org.apache.tomcat.util.net.SecureNioChannel;
 import org.apache.tomcat.util.net.SocketStatus;
+import org.apache.tomcat.util.res.StringManager;
 
 
 /**
@@ -534,6 +534,11 @@ public class Http11NioProtocol implements ProtocolHandler, MBeanRegistration
         setAttribute("timeout", "" + timeouts);
     }
 
+    public void setOomParachute(int oomParachute) {
+        ep.setOomParachute(oomParachute);
+        setAttribute("oomParachute",oomParachute);
+    }
+
     // --------------------  SSL related properties --------------------
 
     public String getKeystoreFile() { return ep.getKeystoreFile();}
@@ -585,6 +590,10 @@ public class Http11NioProtocol implements ProtocolHandler, MBeanRegistration
         Http11ConnectionHandler(Http11NioProtocol proto) {
             this.proto = proto;
         }
+        
+        public void releaseCaches() {
+            recycledProcessors.clear();
+        }
 
         public SocketState event(NioChannel socket, SocketStatus status) {
             Http11NioProcessor result = connections.get(socket);
@@ -744,6 +753,10 @@ public class Http11NioProtocol implements ProtocolHandler, MBeanRegistration
         return domain;
     }
 
+    public int getOomParachute() {
+        return ep.getOomParachute();
+    }
+
     public ObjectName preRegister(MBeanServer server,
                                   ObjectName name) throws Exception {
         oname=name;

==================================================
