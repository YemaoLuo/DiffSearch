50e96de3bb633428b376355b29ee912dc4305999
==================================================
Use ip rather than name to match the local member.
==================================================
Remy Maucherat
==================================================
Mon Dec 17 17:26:52 2018 +0000
==================================================
CloudMembershipProvider.java
Use ip rather than name to match the local member.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1849113 13f79535-47bb-0310-9956-ffa450edef68



==================================================
DNSMembershipProvider.java
index 07061ce98f..70f5fa11d9 100644
--- a/java/org/apache/catalina/tribes/membership/cloud/CloudMembershipProvider.java
+++ b/java/org/apache/catalina/tribes/membership/cloud/CloudMembershipProvider.java
@@ -52,8 +52,8 @@ public abstract class CloudMembershipProvider extends MembershipProviderBase imp
 
     protected Map<String, String> headers = new HashMap<>();
 
+    protected String localIp;
     protected int port;
-    protected String hostName;
 
     protected long expirationTime = 5000;
 
@@ -87,7 +87,7 @@ public abstract class CloudMembershipProvider extends MembershipProviderBase imp
         connectionTimeout = Integer.parseInt(properties.getProperty("connectionTimeout", "1000"));
         readTimeout = Integer.parseInt(properties.getProperty("readTimeout", "1000"));
 
-        hostName = InetAddress.getLocalHost().getHostName();
+        localIp = InetAddress.getLocalHost().getHostAddress();
         port = Integer.parseInt(properties.getProperty("tcpListenPort"));
 
         expirationTime = Long.parseLong(properties.getProperty("expirationTime", "5000"));

==================================================
KubernetesMembershipProvider.java
index 2b7efec2b6..ab454cf9b8 100644
--- a/java/org/apache/catalina/tribes/membership/cloud/DNSMembershipProvider.java
+++ b/java/org/apache/catalina/tribes/membership/cloud/DNSMembershipProvider.java
@@ -80,7 +80,7 @@ public class DNSMembershipProvider extends CloudMembershipProvider {
                 String ip = inetAddress.getHostAddress();
                 byte[] id = md5.digest(ip.getBytes());
                 // We found ourselves, ignore
-                if (inetAddress.getHostName().equals(hostName)) {
+                if (localIp.equals(ip)) {
                     // Update the UID on initial lookup
                     Member localMember = service.getLocalMember(false);
                     if (localMember.getUniqueId() == CloudMembershipService.INITIAL_ID && localMember instanceof MemberImpl) {

==================================================
