228bf71b95022d5979ff104f6b86ee67cb492ba7
==================================================
Resolve some TODOs for "swallowAbortedUploads"
==================================================
Mark Emlyn
==================================================
Thu Mar 24 13:24:28 2011 +0000
==================================================
CometEventImpl.java
Resolve some TODOs for "swallowAbortedUploads"

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1084949 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CoyoteAdapter.java
index f5e4fdcf0f..34e9f20cba 100644
--- a/java/org/apache/catalina/connector/CometEventImpl.java
+++ b/java/org/apache/catalina/connector/CometEventImpl.java
@@ -95,6 +95,7 @@ public class CometEventImpl implements CometEvent {
         }
         boolean iscomet = request.isComet();
         request.setComet(false);
+        request.finishRequest();
         response.finishResponse();
         if (iscomet) request.cometClose();
     }

==================================================
Request.java
index 9d2e2b0c98..6a17264c7c 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -314,6 +314,7 @@ public class CoyoteAdapter implements Adapter {
                 }
             }
             if (!request.isAsync() && !comet) {
+                request.finishRequest();
                 response.finishResponse();
                 req.action(ActionCode.POST_REQUEST , null);
             }
@@ -417,6 +418,7 @@ public class CoyoteAdapter implements Adapter {
             if (asyncConImpl != null) {
                 async = true;
             } else if (!comet) {
+                request.finishRequest();
                 response.finishResponse();
                 if (postParseSuccess) {
                     // Log only if processing was invoked.

==================================================
Response.java
index f88a774d7e..e90055be25 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -792,10 +792,13 @@ public class Request
      * @exception IOException if an input/output error occurs
      */
     public void finishRequest() throws IOException {
-        // The reader and input stream don't need to be closed
-        // TODO: Is this ever called?
-        // If so, move input swallow disabling from 
-        // Response.finishResponse() to here
+        // Optionally disable swallowing of additional request data.
+        Context context = getContext();
+        if (context != null &&
+                response.getStatus() == HttpServletResponse.SC_REQUEST_ENTITY_TOO_LARGE &&
+                !context.getSwallowAbortedUploads()) {
+            coyoteRequest.action(ActionCode.DISABLE_SWALLOW_INPUT, null);
+        }
     }
 
 

==================================================
