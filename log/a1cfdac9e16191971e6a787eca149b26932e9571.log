a1cfdac9e16191971e6a787eca149b26932e9571
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56555
==================================================
Mark Emlyn
==================================================
Wed May 28 12:15:51 2014 +0000
==================================================
AbstractHttp11Processor.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56555
When Tomcat closes the connection based on the HTTP status code of the response, ensure that only one connection header is sent to the client.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1597987 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAbstractHttp11Processor.java
index 2f62873cec..f496222fc7 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Processor.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Processor.java
@@ -1485,11 +1485,8 @@ public abstract class AbstractHttp11Processor<S> extends AbstractProcessor<S> {
         // Connection: close header.
         keepAlive = keepAlive && !statusDropsConnection(statusCode);
         if (!keepAlive) {
-            // Avoid adding the close header twice
-            if (!connectionClosePresent) {
-                headers.addValue(Constants.CONNECTION).setString(
-                        Constants.CLOSE);
-            }
+            headers.setValue(Constants.CONNECTION).setString(
+                    Constants.CLOSE);
         } else if (!http11 && !error) {
             headers.addValue(Constants.CONNECTION).setString(Constants.KEEPALIVE);
         }

==================================================
