207c9ce9b90904d2be0b778b5afb94203d5cef72
==================================================
If an I/O error occurs during async processing on a non-container thread, ensure that the onError() event is triggered.
==================================================
Mark Thomas
==================================================
Tue Nov 1 10:21:20 2016 +0000
==================================================
AbstractProcessor.java
If an I/O error occurs during async processing on a non-container thread, ensure that the onError() event is triggered.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1767471 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AsyncStateMachine.java
index 92b224e7d7..8598ca4d7f 100644
--- a/java/org/apache/coyote/AbstractProcessor.java
+++ b/java/org/apache/coyote/AbstractProcessor.java
@@ -103,6 +103,9 @@ public abstract class AbstractProcessor extends AbstractProcessorLight implement
                 response.setStatus(500);
             }
             getLog().info(sm.getString("abstractProcessor.nonContainerThreadError"), t);
+            // Set the request attribute so that the async onError() event is
+            // fired when the error event is processed
+            request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);
             socketWrapper.processSocket(SocketEvent.ERROR, true);
         }
     }

==================================================
