eb70ce5cb0d7d689d2ce3d3e0d72eb28a72a4fa6
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51445
==================================================
Mark Emlyn
==================================================
Thu Jun 30 12:16:37 2011 +0000
==================================================
StandardWrapper.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51445
Correctly initialise all instances of Servlets that implement SingleThreadModel.
Based on a patch by Felix Schumacher.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1141502 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestStandardWrapper.java
index e30149fd5f..ba2b2feb20 100644
--- a/java/org/apache/catalina/core/StandardWrapper.java
+++ b/java/org/apache/catalina/core/StandardWrapper.java
@@ -1115,14 +1115,14 @@ public class StandardWrapper extends ContainerBase
 
             classLoadTime=(int) (System.currentTimeMillis() -t1);
 
-            initServlet(servlet);
-
-            // Register our newly initialized instance
             singleThreadModel = servlet instanceof SingleThreadModel;
             if (singleThreadModel) {
                 if (instancePool == null)
                     instancePool = new Stack<Servlet>();
             }
+
+            initServlet(servlet);
+
             fireContainerEvent("load", this);
 
             loadTime=System.currentTimeMillis() -t1;
@@ -1186,7 +1186,7 @@ public class StandardWrapper extends ContainerBase
     private synchronized void initServlet(Servlet servlet)
             throws ServletException {
         
-        if (instanceInitialized) return;
+        if (instanceInitialized && !singleThreadModel) return;
 
         // Call the initialization method of this servlet
         try {

==================================================
