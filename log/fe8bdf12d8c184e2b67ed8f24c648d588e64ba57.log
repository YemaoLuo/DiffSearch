fe8bdf12d8c184e2b67ed8f24c648d588e64ba57
==================================================
Separate out the gc process from the background process so gc() can be called independently.
==================================================
Mark Thomas
==================================================
Thu Jan 29 09:28:07 2015 +0000
==================================================
WebResourceRoot.java
Separate out the gc process from the background process so gc() can be called independently.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1655558 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WebResourceSet.java
index 61130f504c..25e6cd2cd3 100644
--- a/java/org/apache/catalina/WebResourceRoot.java
+++ b/java/org/apache/catalina/WebResourceRoot.java
@@ -407,6 +407,12 @@ public interface WebResourceRoot extends Lifecycle {
      */
     List<URL> getBaseUrls();
 
+    /**
+     * Implementations may cache some information to improve performance. This
+     * method triggers the clean-up of those resources.
+     */
+    void gc();
+
     static enum ResourceSetType {
         PRE,
         RESOURCE_JAR,

==================================================
StandardContext.java
index dd0af18b57..9d71cd0719 100644
--- a/java/org/apache/catalina/WebResourceSet.java
+++ b/java/org/apache/catalina/WebResourceSet.java
@@ -149,8 +149,8 @@ public interface WebResourceSet extends Lifecycle {
     boolean isReadOnly();
 
     /**
-     * Hook to allow the WebResourceRoot to trigger regular tasks on this set of
-     * resources.
+     * Implementations may cache some information to improve performance. This
+     * method triggers the clean-up of those resources.
      */
-    void backgroundProcess();
+    void gc();
 }

==================================================
AbstractArchiveResourceSet.java
index 3b4b75d74e..855de61494 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -5217,11 +5217,10 @@ public class StandardContext extends ContainerBase
         }
 
         // The WebResources implementation caches references to JAR files. On
-        // some platforms these references may lock the JAR files. The
-        // WebResources implementaion cleans-up unused JAR file references every
-        // run of background processing but since web application start is
-        // likely to have read from lots of JARs, trigger a clean-up now.
-        getResources().backgroundProcess();
+        // some platforms these references may lock the JAR files. Since web
+        // application start is likely to have read from lots of JARs, trigger
+        // a clean-up now.
+        getResources().gc();
 
         // Reinitializing if something went wrong
         if (!ok) {

==================================================
AbstractFileResourceSet.java
index 61022eaeb5..faf51808b5 100644
--- a/java/org/apache/catalina/webresources/AbstractArchiveResourceSet.java
+++ b/java/org/apache/catalina/webresources/AbstractArchiveResourceSet.java
@@ -294,7 +294,7 @@ public abstract class AbstractArchiveResourceSet extends AbstractResourceSet {
     }
 
     @Override
-    public void backgroundProcess() {
+    public void gc() {
         synchronized (archiveLock) {
             if (archive != null && archiveUseCount == 0) {
                 try {

==================================================
EmptyResourceSet.java
index b6e7f580d2..e3e485a285 100644
--- a/java/org/apache/catalina/webresources/AbstractFileResourceSet.java
+++ b/java/org/apache/catalina/webresources/AbstractFileResourceSet.java
@@ -132,7 +132,7 @@ public abstract class AbstractFileResourceSet extends AbstractResourceSet {
      * This is a NO-OP by default for File based resource sets.
      */
     @Override
-    public void backgroundProcess() {
+    public void gc() {
         // NO-OP
     }
 

==================================================
StandardRoot.java
index cd6580c6a7..69f05e2ec5 100644
--- a/java/org/apache/catalina/webresources/EmptyResourceSet.java
+++ b/java/org/apache/catalina/webresources/EmptyResourceSet.java
@@ -153,7 +153,7 @@ public class EmptyResourceSet extends LifecycleBase implements WebResourceSet {
     }
 
     @Override
-    public void backgroundProcess() {
+    public void gc() {
         // NO-OP
     }
 

==================================================
