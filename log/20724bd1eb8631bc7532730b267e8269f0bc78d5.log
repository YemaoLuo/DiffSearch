20724bd1eb8631bc7532730b267e8269f0bc78d5
==================================================
"-1" should not be a valid port number
==================================================
Mark Thomas
==================================================
Mon Aug 8 16:28:26 2022 +0100
==================================================
HttpParser.java
"-1" should not be a valid port number


==================================================
TestHttpParserHost.java
index 76d79cae5e..2d21f02e68 100644
--- a/java/org/apache/tomcat/util/http/parser/HttpParser.java
+++ b/java/org/apache/tomcat/util/http/parser/HttpParser.java
@@ -785,7 +785,11 @@ public class HttpParser {
             return readHostDomainName(reader);
         }
 
-        return pos;
+        if (inIPv6) {
+            return pos;
+        } else {
+            return validatePort(reader, pos);
+        }
     }
 
 
@@ -877,7 +881,7 @@ public class HttpParser {
 
         c = reader.read();
         if (c == ':') {
-            return pos;
+            return validatePort(reader, pos);
         } else {
             if(c == -1) {
                 return -1;
@@ -902,14 +906,27 @@ public class HttpParser {
 
         if (DomainParseState.COLON == state) {
             // State identifies the state of the previous character
-            return pos - 1;
+            return validatePort(reader, pos - 1);
         } else {
             return -1;
         }
     }
 
 
-    /**
+    static int validatePort(Reader reader, int colonPosition) throws IOException {
+        // Remaining characters should be numeric ...
+        readLong(reader);
+        // ... followed by EOS
+        if (reader.read() == -1) {
+            return colonPosition;
+        } else {
+            // Invalid port
+            throw new IllegalArgumentException();
+        }
+    }
+
+
+     /**
      * Skips all characters until EOF or the specified target is found. Normally
      * used to skip invalid input until the next separator.
      */

==================================================
