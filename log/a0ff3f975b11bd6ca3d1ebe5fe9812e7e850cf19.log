a0ff3f975b11bd6ca3d1ebe5fe9812e7e850cf19
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54012
==================================================
Mark Emlyn
==================================================
Thu Oct 25 11:57:13 2012 +0000
==================================================
Compiler.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54012
Enable the tag plug-in for c:set to work in tag files.
Based on a patch by Sheldon Shao.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1402113 13f79535-47bb-0310-9956-ffa450edef68



==================================================
PageInfo.java
index 86810a9d84..70fdc9cc3c 100644
--- a/java/org/apache/jasper/compiler/Compiler.java
+++ b/java/org/apache/jasper/compiler/Compiler.java
@@ -108,7 +108,7 @@ public abstract class Compiler {
 
         // Setup page info area
         pageInfo = new PageInfo(new BeanRepository(ctxt.getClassLoader(),
-                errDispatcher), ctxt.getJspFile());
+                errDispatcher), ctxt.getJspFile(), ctxt.isTagFile());
 
         JspConfig jspConfig = options.getJspConfig();
         JspConfig.JspProperty jspProperty = jspConfig.findJspProperty(ctxt

==================================================
TagPluginManager.java
index 2f99c32f8b..e2199a08da 100644
--- a/java/org/apache/jasper/compiler/PageInfo.java
+++ b/java/org/apache/jasper/compiler/PageInfo.java
@@ -99,8 +99,10 @@ class PageInfo {
     // JSP 2.2
     private boolean errorOnUndeclaredNamepsace = false;
 
-    PageInfo(BeanRepository beanRepository, String jspFile) {
+    private boolean isTagFile = false;
 
+    PageInfo(BeanRepository beanRepository, String jspFile, boolean isTagFile) {
+        this.isTagFile = isTagFile;
         this.jspFile = jspFile;
         this.beanRepository = beanRepository;
         this.varInfoNames = new HashSet<>();
@@ -119,6 +121,10 @@ class PageInfo {
         imports.addAll(Constants.STANDARD_IMPORTS);
     }
 
+    public boolean isTagFile() {
+        return isTagFile;
+    }
+
     /**
      * Check if the plugin ID has been previously declared.  Make a not
      * that this Id is now declared.

==================================================
TagPluginContext.java
index cd169442d9..e13d079d74 100644
--- a/java/org/apache/jasper/compiler/TagPluginManager.java
+++ b/java/org/apache/jasper/compiler/TagPluginManager.java
@@ -243,6 +243,11 @@ public class TagPluginManager {
             curNodes = node.getAtETag();
         }
 
+        @Override
+        public boolean isTagFile() {
+            return pageInfo.isTagFile();
+        }
+
         private Node.JspAttribute getNodeAttribute(String attribute) {
             Node.JspAttribute[] attrs = node.getJspAttributes();
             for (int i=0; attrs != null && i < attrs.length; i++) {

==================================================
Set.java
index cf7a8f0501..460a9f6d36 100644
--- a/java/org/apache/jasper/compiler/tagplugin/TagPluginContext.java
+++ b/java/org/apache/jasper/compiler/tagplugin/TagPluginContext.java
@@ -120,5 +120,10 @@ public interface TagPluginContext {
      * Get the value of an attribute in the current tagplugin context.
      */
     Object getPluginAttribute(String attr);
+
+    /**
+     * Is the tag being used inside a tag file?
+     */
+    boolean isTagFile();
 }
 

==================================================
