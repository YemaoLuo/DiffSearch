81a9f2e36a3a49f7a431b505a64475bd6a214718
==================================================
Correctly generate URLs for resources located inside JARs that are themselves located inside a packed WAR file.
==================================================
Mark Thomas
==================================================
Thu Nov 10 20:52:09 2016 +0000
==================================================
AbstractArchiveResource.java
Correctly generate URLs for resources located inside JARs that are themselves located inside a packed WAR file.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1769191 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JarResource.java
index fd7011e5f1..46fd641320 100644
--- a/java/org/apache/catalina/webresources/AbstractArchiveResource.java
+++ b/java/org/apache/catalina/webresources/AbstractArchiveResource.java
@@ -136,7 +136,7 @@ public abstract class AbstractArchiveResource extends AbstractResource {
 
     @Override
     public URL getURL() {
-        String url = baseUrl + "!/" + resource.getName();
+        String url = baseUrl + resource.getName();
         try {
             return new URL(url);
         } catch (MalformedURLException e) {

==================================================
WarResource.java
index fb59522e0e..23eb6d8d52 100644
--- a/java/org/apache/catalina/webresources/JarResource.java
+++ b/java/org/apache/catalina/webresources/JarResource.java
@@ -32,7 +32,7 @@ public class JarResource extends AbstractSingleArchiveResource {
 
     public JarResource(AbstractArchiveResourceSet archiveResourceSet, String webAppPath,
             String baseUrl, JarEntry jarEntry) {
-        super(archiveResourceSet, webAppPath, "jar:" + baseUrl, jarEntry, baseUrl);
+        super(archiveResourceSet, webAppPath, "jar:" + baseUrl + "!/", jarEntry, baseUrl);
     }
 
 

==================================================
TestAbstractArchiveResource.java
index 76ff38cae0..2d8ba8a4a4 100644
--- a/java/org/apache/catalina/webresources/WarResource.java
+++ b/java/org/apache/catalina/webresources/WarResource.java
@@ -16,8 +16,6 @@
  */
 package org.apache.catalina.webresources;
 
-import java.net.MalformedURLException;
-import java.net.URL;
 import java.util.jar.JarEntry;
 
 import org.apache.juli.logging.Log;
@@ -34,21 +32,7 @@ public class WarResource extends AbstractSingleArchiveResource {
 
     public WarResource(AbstractArchiveResourceSet archiveResourceSet, String webAppPath,
             String baseUrl, JarEntry jarEntry) {
-        super(archiveResourceSet, webAppPath, "war:" + baseUrl, jarEntry, baseUrl);
-    }
-
-
-    @Override
-    public URL getURL() {
-        String url = getBaseUrl() + "*/" + getResource().getName();
-        try {
-            return new URL(url);
-        } catch (MalformedURLException e) {
-            if (getLog().isDebugEnabled()) {
-                getLog().debug(sm.getString("fileResource.getUrlFail", url), e);
-            }
-            return null;
-        }
+        super(archiveResourceSet, webAppPath, "war:" + baseUrl + "*/", jarEntry, baseUrl);
     }
 
 

==================================================
