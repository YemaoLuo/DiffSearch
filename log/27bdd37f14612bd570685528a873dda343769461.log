27bdd37f14612bd570685528a873dda343769461
==================================================
Align HTTP InputBuffer implementations
==================================================
Mark Thomas
==================================================
Thu Jan 15 09:21:52 2015 +0000
==================================================
InternalAprInputBuffer.java
Align HTTP InputBuffer implementations

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1652009 13f79535-47bb-0310-9956-ffa450edef68



==================================================
InternalNio2InputBuffer.java
index fdab740281..c8be8d3d67 100644
--- a/java/org/apache/coyote/http11/InternalAprInputBuffer.java
+++ b/java/org/apache/coyote/http11/InternalAprInputBuffer.java
@@ -78,7 +78,8 @@ public class InternalAprInputBuffer extends AbstractInputBuffer<Long> {
 
         wrapper = socketWrapper;
 
-        int bufLength = Math.max(headerBufferSize * 2, 8192);
+        int bufLength = headerBufferSize +
+                wrapper.getSocketBufferHandler().getReadBuffer().capacity();
         if (buf == null || buf.length < bufLength) {
             buf = new byte[bufLength];
         }

==================================================
InternalNioInputBuffer.java
index 7ebccd678d..e772bca4f2 100644
--- a/java/org/apache/coyote/http11/InternalNio2InputBuffer.java
+++ b/java/org/apache/coyote/http11/InternalNio2InputBuffer.java
@@ -78,7 +78,7 @@ public class InternalNio2InputBuffer extends AbstractInputBuffer<Nio2Channel> {
         wrapper = socketWrapper;
 
         int bufLength = headerBufferSize +
-                wrapper.getSocket().getBufHandler().getReadBuffer().capacity();
+                wrapper.getSocketBufferHandler().getReadBuffer().capacity();
         if (buf == null || buf.length < bufLength) {
             buf = new byte[bufLength];
         }

==================================================
SocketWrapperBase.java
index bea4f601d3..9107fca503 100644
--- a/java/org/apache/coyote/http11/InternalNioInputBuffer.java
+++ b/java/org/apache/coyote/http11/InternalNioInputBuffer.java
@@ -79,7 +79,7 @@ public class InternalNioInputBuffer extends AbstractInputBuffer<NioChannel> {
         wrapper = socketWrapper;
 
         int bufLength = headerBufferSize +
-                wrapper.getSocket().getBufHandler().getReadBuffer().capacity();
+                wrapper.getSocketBufferHandler().getReadBuffer().capacity();
         if (buf == null || buf.length < bufLength) {
             buf = new byte[bufLength];
         }

==================================================
