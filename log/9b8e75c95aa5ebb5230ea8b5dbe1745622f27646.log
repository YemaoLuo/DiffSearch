9b8e75c95aa5ebb5230ea8b5dbe1745622f27646
==================================================
Refactoring in preparation for a fix for BZ 33453
==================================================
Mark Emlyn
==================================================
Thu May 19 16:25:45 2011 +0000
==================================================
JspCompilationContext.java
Refactoring in preparation for a fix for BZ 33453

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1124986 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Compiler.java
index 274db1059e..ec05e0b29c 100644
--- a/java/org/apache/jasper/JspCompilationContext.java
+++ b/java/org/apache/jasper/JspCompilationContext.java
@@ -19,9 +19,12 @@ package org.apache.jasper;
 
 import java.io.File;
 import java.io.FileNotFoundException;
+import java.io.IOException;
+import java.net.JarURLConnection;
 import java.net.MalformedURLException;
 import java.net.URL;
 import java.net.URLClassLoader;
+import java.net.URLConnection;
 import java.util.HashMap;
 import java.util.Map;
 import java.util.Set;
@@ -382,6 +385,43 @@ public class JspCompilationContext {
         return jspUri;
     }
 
+    public long getJspLastModified() {
+        long result = -1;
+        URLConnection uc = null;
+        try {
+            URL jspUrl = getResource(getJspFile());
+            if (jspUrl == null) {
+                incrementRemoved();
+                return result;
+            }
+            uc = jspUrl.openConnection();
+            if (uc instanceof JarURLConnection) {
+                result = ((JarURLConnection) uc).getJarEntry().getTime();
+            } else {
+                result = uc.getLastModified();
+            }
+        } catch (IOException e) {
+            if (log.isDebugEnabled()) {
+                log.debug(Localizer.getMessage(
+                        "jsp.error.lastModified", getJspFile()), e);
+            }
+            result = -1;
+        } finally {
+            if (uc != null) {
+                try {
+                    uc.getInputStream().close();
+                } catch (IOException e) {
+                    if (log.isDebugEnabled()) {
+                        log.debug(Localizer.getMessage(
+                                "jsp.error.lastModified", getJspFile()), e);
+                    }
+                    result = -1;
+                }
+            }
+        }
+        return result;
+    }
+
     public boolean isTagFile() {
         return isTagFile;
     }

==================================================
