8f43f9ede2f69d01b6ed9dd5b34b8a00e2badd18
==================================================
Align AJP and HTTP behaviour when no host information is present
==================================================
Mark Thomas
==================================================
Mon Jan 29 20:25:28 2018 +0000
==================================================
AjpProcessor.java
Align AJP and HTTP behaviour when no host information is present
- no functional change for AJP
- for HTTP use the actual server port rather than the configured value which may be zero

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1822582 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11Processor.java
index ce134cb01e..7a3ddc0140 100644
--- a/java/org/apache/coyote/ajp/AjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpProcessor.java
@@ -871,7 +871,9 @@ public class AjpProcessor extends AbstractProcessor {
     private void parseHost(MessageBytes valueMB) {
 
         if (valueMB == null || valueMB.isNull()) {
-            // HTTP/1.0
+            // No host information (HTTP/1.0)
+            // Ensure the local port field is populated and then use it.
+            request.action(ActionCode.REQ_LOCALPORT_ATTRIBUTE, request);
             request.setServerPort(request.getLocalPort());
             try {
                 request.serverName().duplicate(request.localName());

==================================================
