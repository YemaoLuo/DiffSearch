48ef5a540d8581ad8e2c477363191a7a5f2364b1
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=53387
==================================================
Mark Thomas
==================================================
Wed Jun 27 10:16:33 2018 +0000
==================================================
ExpressionParseTree.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=53387
Add support for regular expression capture groups to the SSI servlet and filter.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1834490 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SSIMediator.java
index 8d0c7a17fd..b8450566d4 100644
--- a/java/org/apache/catalina/ssi/ExpressionParseTree.java
+++ b/java/org/apache/catalina/ssi/ExpressionParseTree.java
@@ -20,6 +20,7 @@ package org.apache.catalina.ssi;
 import java.text.ParseException;
 import java.util.LinkedList;
 import java.util.List;
+import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 import java.util.regex.PatternSyntaxException;
 /**
@@ -368,11 +369,14 @@ public class ExpressionParseTree {
                     val2.charAt(val2Len - 1) == '/') {
                 // Treat as a regular expression
                 String expr = val2.substring(1, val2Len - 1);
+                ssiMediator.clearMatchGroups();
                 try {
                     Pattern pattern = Pattern.compile(expr);
                     // Regular expressions will only ever be used with EqualNode
                     // so return zero for equal and non-zero for not equal
-                    if (pattern.matcher(val1).find()) {
+                    Matcher matcher = pattern.matcher(val1);
+                    if (matcher.find()) {
+                        ssiMediator.populateMatchGroups(matcher);
                         return 0;
                     } else {
                         return -1;

==================================================
TestRegExpCapture.java
index 7f5069739c..3e65ee6457 100644
--- a/java/org/apache/catalina/ssi/SSIMediator.java
+++ b/java/org/apache/catalina/ssi/SSIMediator.java
@@ -25,6 +25,7 @@ import java.util.Iterator;
 import java.util.Locale;
 import java.util.Set;
 import java.util.TimeZone;
+import java.util.regex.Matcher;
 
 import org.apache.catalina.util.Strftime;
 import org.apache.catalina.util.URLEncoder;
@@ -52,6 +53,7 @@ public class SSIMediator {
     protected final long lastModifiedDate;
     protected Strftime strftime;
     protected final SSIConditionalState conditionalState = new SSIConditionalState();
+    protected  int lastMatchCount = 0;
 
 
     public SSIMediator(SSIExternalResolver ssiExternalResolver,
@@ -332,4 +334,24 @@ public class SSIMediator {
                     retVal);
         }
     }
+
+
+    protected void clearMatchGroups() {
+        for (int i = 1; i <= lastMatchCount; i++) {
+            setVariableValue(Integer.toString(i), "");
+        }
+        lastMatchCount = 0;
+    }
+
+
+    protected void populateMatchGroups(Matcher matcher) {
+        lastMatchCount = matcher.groupCount();
+        // $0 is not used
+        if (lastMatchCount == 0) {
+            return;
+        }
+        for (int i = 1; i <= lastMatchCount; i++) {
+            setVariableValue(Integer.toString(i), matcher.group(i));
+        }
+    }
 }
\ No newline at end of file

==================================================
