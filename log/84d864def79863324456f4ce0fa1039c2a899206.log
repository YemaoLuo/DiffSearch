84d864def79863324456f4ce0fa1039c2a899206
==================================================
Always use DeploymentException for invalid paths and add more checks
==================================================
Mark Thomas
==================================================
Fri May 15 17:36:29 2020 +0100
==================================================
UriTemplate.java
index 005c2f1f21..16fdaf2ef0 100644
--- a/java/org/apache/tomcat/websocket/server/LocalStrings.properties
+++ b/java/org/apache/tomcat/websocket/server/LocalStrings.properties
@@ -24,7 +24,7 @@ serverContainer.servletContextMissing=No ServletContext was specified
 upgradeUtil.incompatibleRsv=Extensions were specified that have incompatible RSV bit usage
 
 uriTemplate.duplicateParameter=The parameter [{0}] appears more than once in the path which is not permitted
-uriTemplate.emptySegment=The path [{0}] contains one or more empty segments which are is not permitted
+uriTemplate.emptySegment=The path [{0}] contains one or more empty segments which is not permitted
 uriTemplate.invalidPath=The path [{0}] is not valid.
 uriTemplate.invalidSegment=The segment [{0}] is not valid in the provided path [{1}]
 

==================================================
TestUriTemplate.java
index 6419ed07ae..ab5339550e 100644
--- a/java/org/apache/tomcat/websocket/server/UriTemplate.java
+++ b/java/org/apache/tomcat/websocket/server/UriTemplate.java
@@ -43,7 +43,8 @@ public class UriTemplate {
 
     public UriTemplate(String path) throws DeploymentException {
 
-        if (path == null || path.length() ==0 || !path.startsWith("/")) {
+        if (path == null || path.length() == 0 || !path.startsWith("/") || path.contains("/../") ||
+                path.contains("/./") || path.contains("//")) {
             throw new DeploymentException(
                     sm.getString("uriTemplate.invalidPath", path));
         }
@@ -68,7 +69,7 @@ public class UriTemplate {
                 } else {
                     // As per EG discussion, all other empty segments are
                     // invalid
-                    throw new IllegalArgumentException(sm.getString(
+                    throw new DeploymentException(sm.getString(
                             "uriTemplate.emptySegment", path));
                 }
             }
@@ -81,12 +82,12 @@ public class UriTemplate {
                 normalized.append(paramCount++);
                 normalized.append('}');
                 if (!paramNames.add(segment)) {
-                    throw new IllegalArgumentException(sm.getString(
+                    throw new DeploymentException(sm.getString(
                             "uriTemplate.duplicateParameter", segment));
                 }
             } else {
                 if (segment.contains("{") || segment.contains("}")) {
-                    throw new IllegalArgumentException(sm.getString(
+                    throw new DeploymentException(sm.getString(
                             "uriTemplate.invalidSegment", segment, path));
                 }
                 normalized.append(segment);

==================================================
