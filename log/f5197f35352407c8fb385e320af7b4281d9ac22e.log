f5197f35352407c8fb385e320af7b4281d9ac22e
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56399
==================================================
Konstantin Kolinko
==================================================
Wed May 14 00:44:33 2014 +0000
==================================================
CoyoteAdapter.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56399
When recycling a Coyote request, ensure that Catalina request have been recycled.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1594436 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Adapter.java
index 4a9d38afe7..df108bda87 100644
--- a/java/org/apache/catalina/connector/LocalStrings.properties
+++ b/java/org/apache/catalina/connector/LocalStrings.properties
@@ -17,6 +17,7 @@ cometEvent.nullRequest=The event object has been recycled and is no longer assoc
 
 coyoteAdapter.accesslogFail=Exception while attempting to add an entry to the access log
 coyoteAdapter.asyncDispatch=Exception while processing an asynchronous request
+coyoteAdapter.checkRecycled=A non-recycled request encountered. It will be recycled forcedly.
 coyoteAdapter.debug=The variable [{0}] has value [{1}]
 coyoteAdapter.parsePathParam=Unable to parse the path parameters using encoding [{0}]. The path parameters in the URL will be ignored.
 

==================================================
AbstractAjpProcessor.java
index 8992816a58..5fb3bf522e 100644
--- a/java/org/apache/coyote/Adapter.java
+++ b/java/org/apache/coyote/Adapter.java
@@ -55,6 +55,19 @@ public interface Adapter {
 
     public void log(Request req, Response res, long time);
 
+    /**
+     * Assert that request and response have been recycled. If they have not
+     * then log a warning and force a recycle. This method is called as a safety
+     * check when a processor is being recycled and may be returned to a pool
+     * for reuse.
+     *
+     * @param req
+     *            Request
+     * @param res
+     *            Response
+     */
+    public void checkRecycled(Request req, Response res);
+
     /**
      * Provide the name of the domain to use to register MBeans for conponents
      * associated with the connector.

==================================================
AbstractHttp11Processor.java
index efb2eda793..0620661c67 100644
--- a/java/org/apache/coyote/ajp/AbstractAjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AbstractAjpProcessor.java
@@ -890,6 +890,8 @@ public abstract class AbstractAjpProcessor<S> extends AbstractProcessor<S> {
      */
     @Override
     public void recycle(boolean socketClosing) {
+        getAdapter().checkRecycled(request, response);
+
         asyncStateMachine.recycle();
 
         // Recycle Request object

==================================================
