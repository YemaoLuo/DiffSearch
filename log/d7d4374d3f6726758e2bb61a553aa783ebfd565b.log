d7d4374d3f6726758e2bb61a553aa783ebfd565b
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63710
==================================================
Mark Thomas
==================================================
Thu Sep 12 21:05:11 2019 +0100
==================================================
StreamProcessor.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63710

No content-length on 304 responses (and other status codes)


==================================================
TestStreamProcessor.java
index 1e8f6a7307..c550f19e58 100644
--- a/java/org/apache/coyote/http2/StreamProcessor.java
+++ b/java/org/apache/coyote/http2/StreamProcessor.java
@@ -145,7 +145,7 @@ class StreamProcessor extends AbstractProcessor {
         headers.addValue(":status").setString(Integer.toString(statusCode));
 
         // Check to see if a response body is present
-        if (!(statusCode < 200 || statusCode == 205 || statusCode == 304)) {
+        if (!(statusCode < 200 || statusCode == 204 || statusCode == 205 || statusCode == 304)) {
             String contentType = coyoteResponse.getContentType();
             if (contentType != null) {
                 headers.setValue("content-type").setString(contentType);
@@ -154,13 +154,20 @@ class StreamProcessor extends AbstractProcessor {
             if (contentLanguage != null) {
                 headers.setValue("content-language").setString(contentLanguage);
             }
-        }
-
-        // Add a content-length header if a content length has been set unless
-        // the application has already added one
-        long contentLength = coyoteResponse.getContentLengthLong();
-        if (contentLength != -1 && headers.getValue("content-length") == null) {
-            headers.addValue("content-length").setLong(contentLength);
+            // Add a content-length header if a content length has been set unless
+            // the application has already added one
+            long contentLength = coyoteResponse.getContentLengthLong();
+            if (contentLength != -1 && headers.getValue("content-length") == null) {
+                headers.addValue("content-length").setLong(contentLength);
+            }
+        } else {
+            if (statusCode == 205) {
+                // RFC 7231 requires the server to explicitly signal an empty
+                // response in this case
+                coyoteResponse.setContentLength(0);
+            } else {
+                coyoteResponse.setContentLength(-1);
+            }
         }
 
         // Add date header unless it is an informational response or the

==================================================
