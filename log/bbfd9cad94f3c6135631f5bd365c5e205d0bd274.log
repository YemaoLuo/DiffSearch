bbfd9cad94f3c6135631f5bd365c5e205d0bd274
==================================================
Expand checks for proper WebSocket shutdown
==================================================
Mark Thomas
==================================================
Fri Apr 22 13:21:43 2016 +0000
==================================================
BackgroundProcessManager.java
Expand checks for proper WebSocket shutdown

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1740520 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WebSocketBaseTest.java
index 387245ac12..14c27b5973 100644
--- a/java/org/apache/tomcat/websocket/BackgroundProcessManager.java
+++ b/java/org/apache/tomcat/websocket/BackgroundProcessManager.java
@@ -108,6 +108,17 @@ public class BackgroundProcessManager {
     }
 
 
+    void shutdown() {
+        synchronized (processesLock) {
+            processes.clear();
+            if (wsBackgroundThread != null) {
+                wsBackgroundThread.halt();
+                wsBackgroundThread = null;
+            }
+        }
+    }
+
+
     private static class WsBackgroundThread extends Thread {
 
         private final BackgroundProcessManager manager;

==================================================
TestClassLoader.java
index 6cff5783ed..aeb52faa18 100644
--- a/test/org/apache/tomcat/websocket/WebSocketBaseTest.java
+++ b/test/org/apache/tomcat/websocket/WebSocketBaseTest.java
@@ -41,5 +41,8 @@ public abstract class WebSocketBaseTest extends TomcatBaseTest {
         }
 
         Assert.assertEquals(0, BackgroundProcessManager.getInstance().getProcessCount());
+
+        // Ensure the next test is not affected
+        BackgroundProcessManager.getInstance().shutdown();
     }
 }

==================================================
TestClose.java
index 95363a85fe..c9b24c3a41 100644
--- a/test/org/apache/tomcat/websocket/server/TestClassLoader.java
+++ b/test/org/apache/tomcat/websocket/server/TestClassLoader.java
@@ -35,12 +35,12 @@ import org.apache.catalina.Context;
 import org.apache.catalina.loader.WebappClassLoaderBase;
 import org.apache.catalina.servlets.DefaultServlet;
 import org.apache.catalina.startup.Tomcat;
-import org.apache.catalina.startup.TomcatBaseTest;
+import org.apache.tomcat.websocket.WebSocketBaseTest;
 
 /**
  * Tests endpoint methods are called with the correct class loader.
  */
-public class TestClassLoader extends TomcatBaseTest {
+public class TestClassLoader extends WebSocketBaseTest {
 
     private static final String PASS = "PASS";
     private static final String FAIL = "FAIL";

==================================================
TestCloseBug58264.java
index fd35ceff30..cadf16cbf6 100644
--- a/test/org/apache/tomcat/websocket/server/TestClose.java
+++ b/test/org/apache/tomcat/websocket/server/TestClose.java
@@ -42,14 +42,14 @@ import org.apache.catalina.Context;
 import org.apache.catalina.LifecycleException;
 import org.apache.catalina.servlets.DefaultServlet;
 import org.apache.catalina.startup.Tomcat;
-import org.apache.catalina.startup.TomcatBaseTest;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
+import org.apache.tomcat.websocket.WebSocketBaseTest;
 
 /**
  * Test the behavior of closing websockets under various conditions.
  */
-public class TestClose extends TomcatBaseTest {
+public class TestClose extends WebSocketBaseTest {
 
     private static Log log = LogFactory.getLog(TestClose.class);
 

==================================================
TestShutdown.java
index bc706eb8dc..c4d0c9a623 100644
--- a/test/org/apache/tomcat/websocket/server/TestCloseBug58264.java
+++ b/test/org/apache/tomcat/websocket/server/TestCloseBug58264.java
@@ -37,9 +37,9 @@ import org.junit.Test;
 import org.apache.catalina.Context;
 import org.apache.catalina.servlets.DefaultServlet;
 import org.apache.catalina.startup.Tomcat;
-import org.apache.catalina.startup.TomcatBaseTest;
+import org.apache.tomcat.websocket.WebSocketBaseTest;
 
-public class TestCloseBug58264 extends TomcatBaseTest {
+public class TestCloseBug58264 extends WebSocketBaseTest {
 
     @Test
     public void testOnErrorNotCalledWhenClosingConnection() throws Throwable {

==================================================
TestWsRemoteEndpointImplServer.java
index ad1a6f7369..e628121e49 100644
--- a/test/org/apache/tomcat/websocket/server/TestShutdown.java
+++ b/test/org/apache/tomcat/websocket/server/TestShutdown.java
@@ -37,15 +37,15 @@ import org.junit.Test;
 import org.apache.catalina.Context;
 import org.apache.catalina.servlets.DefaultServlet;
 import org.apache.catalina.startup.Tomcat;
-import org.apache.catalina.startup.TomcatBaseTest;
 import org.apache.tomcat.websocket.TesterMessageCountClient.BasicText;
 import org.apache.tomcat.websocket.TesterMessageCountClient.TesterProgrammaticEndpoint;
+import org.apache.tomcat.websocket.WebSocketBaseTest;
 
 /**
  * Tests inspired by https://bz.apache.org/bugzilla/show_bug.cgi?id=58835 to
  * check that WebSocket connections are closed gracefully on Tomcat shutdown.
  */
-public class TestShutdown extends TomcatBaseTest {
+public class TestShutdown extends WebSocketBaseTest {
 
     @Test
     public void testShutdownBufferedMessages() throws Exception {

==================================================
TestWsServerContainer.java
index 366f61e363..ff2c44e80f 100644
--- a/test/org/apache/tomcat/websocket/server/TestWsRemoteEndpointImplServer.java
+++ b/test/org/apache/tomcat/websocket/server/TestWsRemoteEndpointImplServer.java
@@ -42,11 +42,11 @@ import org.junit.Test;
 import org.apache.catalina.Context;
 import org.apache.catalina.servlets.DefaultServlet;
 import org.apache.catalina.startup.Tomcat;
-import org.apache.catalina.startup.TomcatBaseTest;
+import org.apache.tomcat.websocket.WebSocketBaseTest;
 import org.apache.tomcat.websocket.pojo.TesterUtil.SimpleClient;
 
 @Ignore // This test requires manual intervention to create breakpoints etc.
-public class TestWsRemoteEndpointImplServer extends TomcatBaseTest {
+public class TestWsRemoteEndpointImplServer extends WebSocketBaseTest {
 
     /*
      * https://bz.apache.org/bugzilla/show_bug.cgi?id=58624

==================================================
