3e03ceefd549684ba26b4af0e6cf738b2a1dd42e
==================================================
Fix HTTP/2 window updates with zero padding. Found via CI tests
==================================================
Mark Thomas
==================================================
Thu Oct 8 14:20:53 2020 +0100
==================================================
Http2AsyncUpgradeHandler.java
Fix HTTP/2 window updates with zero padding. Found via CI tests


==================================================
Http2UpgradeHandler.java
index defbb1c7a5..b77fee6c19 100644
--- a/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
@@ -229,14 +229,15 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
 
 
     @Override
-    void writeWindowUpdate(Stream stream, int increment, boolean applicationInitiated)
+    void writeWindowUpdate(AbstractNonZeroStream stream, int increment, boolean applicationInitiated)
             throws IOException {
         // Build window update frame for stream 0
         byte[] frame = new byte[13];
         ByteUtil.setThreeBytes(frame, 0,  4);
         frame[3] = FrameType.WINDOW_UPDATE.getIdByte();
         ByteUtil.set31Bits(frame, 9, increment);
-        if (stream.canWrite()) {
+        // No need to send update from closed stream
+        if  (stream instanceof Stream && ((Stream) stream).canWrite()) {
             // Change stream Id
             byte[] frame2 = new byte[13];
             ByteUtil.setThreeBytes(frame2, 0,  4);

==================================================
