fd381e94f222831fd2bee697deb6246d417b8f33
==================================================
Harden the FORM authentication process
==================================================
Mark Thomas
==================================================
Thu Dec 5 23:01:42 2019 +0000
==================================================
AuthenticatorBase.java
Harden the FORM authentication process

When the session ID is configured to change on authentication, track the
expected session ID through the authentication process and ensure that
the expected value is seen at each stage.



==================================================
Constants.java
index 0b63fd9575..d63d652a04 100644
--- a/java/org/apache/catalina/authenticator/AuthenticatorBase.java
+++ b/java/org/apache/catalina/authenticator/AuthenticatorBase.java
@@ -1126,7 +1126,11 @@ public abstract class AuthenticatorBase extends ValveBase
             // If the principal is null then this is a logout. No need to change
             // the session ID. See BZ 59043.
             if (getChangeSessionIdOnAuthentication() && principal != null) {
-                changeSessionID(request, session);
+                String newSessionId = changeSessionID(request, session);
+                // If the current session ID is being tracked, update it.
+                if (session.getNote(Constants.SESSION_ID_NOTE) != null) {
+                    session.setNote(Constants.SESSION_ID_NOTE, newSessionId);
+                }
             }
         } else if (alwaysUseSession) {
             session = request.getSessionInternal(true);

==================================================
FormAuthenticator.java
index 9857c0975c..a8e9a4747f 100644
--- a/java/org/apache/catalina/authenticator/Constants.java
+++ b/java/org/apache/catalina/authenticator/Constants.java
@@ -52,6 +52,12 @@ public class Constants {
 
     // ---------------------------------------------------------- Session Notes
 
+    /**
+     * The session id used as a CSRF marker when redirecting a user's request.
+     */
+    public static final String SESSION_ID_NOTE = "org.apache.catalina.authenticator.SESSION_ID";
+
+
     /**
      * If the <code>cache</code> property of our authenticator is set, and
      * the current request is part of a session, authentication information

==================================================
