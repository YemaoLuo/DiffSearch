8d7a5e75a6f297e5ad72fef17619966f113461a0
==================================================
BZ 55143
==================================================
Mark Emlyn
==================================================
Wed Jun 26 12:45:47 2013 +0000
==================================================
WsSession.java
BZ 55143
Handle removal of listeners that might have been wrapped

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1496907 13f79535-47bb-0310-9956-ffa450edef68



==================================================
PojoMessageHandlerBase.java
index 17d7e0033f..d70b01698c 100644
--- a/java/org/apache/tomcat/websocket/WsSession.java
+++ b/java/org/apache/tomcat/websocket/WsSession.java
@@ -44,6 +44,7 @@ import javax.websocket.WebSocketContainer;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.apache.tomcat.util.res.StringManager;
+import org.apache.tomcat.websocket.pojo.PojoMessageHandlerBase;
 
 public class WsSession implements Session {
 
@@ -236,23 +237,42 @@ public class WsSession implements Session {
             return;
         }
 
-        // TODO Handle wrapped listeners
+        MessageHandler wrapped = null;
 
-        if (listener.equals(textMessageHandler)) {
+        if (listener instanceof PojoMessageHandlerBase) {
+            wrapped =
+                    ((PojoMessageHandlerBase<?>) listener).getWrappedHandler();
+        }
+
+        if (wrapped == null) {
+            wrapped = listener;
+        }
+
+        boolean removed = false;
+        if (wrapped.equals(textMessageHandler) ||
+                listener.equals(textMessageHandler)) {
             textMessageHandler = null;
-            return;
-        } else if (listener.equals(binaryMessageHandler)) {
+            removed = true;
+        }
+
+        if (listener.equals(binaryMessageHandler) ||
+                listener.equals(binaryMessageHandler)) {
             binaryMessageHandler = null;
-            return;
-        } else if (listener.equals(pongMessageHandler)) {
+            removed = true;
+        }
+
+        if (listener.equals(pongMessageHandler) ||
+                listener.equals(pongMessageHandler)) {
             pongMessageHandler = null;
-            return;
+            removed = true;
         }
 
-        // ISE for now. Could swallow this silently / log this if the ISE
-        // becomes a problem
-        throw new IllegalStateException(
-                sm.getString("wsSession.removeHandlerFailed", listener));
+        if (!removed) {
+            // ISE for now. Could swallow this silently / log this if the ISE
+            // becomes a problem
+            throw new IllegalStateException(
+                    sm.getString("wsSession.removeHandlerFailed", listener));
+        }
     }
 
 

==================================================
