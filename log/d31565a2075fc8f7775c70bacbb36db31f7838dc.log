d31565a2075fc8f7775c70bacbb36db31f7838dc
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57601
==================================================
Mark Thomas
==================================================
Mon Mar 2 11:32:36 2015 +0000
==================================================
DefaultServlet.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57601
Ensure HEAD requests return the correct content length (i.e. the same as for a GET) when the requested resource includes a resource served by the Default servlet.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1663264 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestDefaultServlet.java
index be0dfc5432..9c10098b2a 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -39,6 +39,7 @@ import java.util.Iterator;
 import java.util.Locale;
 import java.util.StringTokenizer;
 
+import javax.servlet.DispatcherType;
 import javax.servlet.RequestDispatcher;
 import javax.servlet.ServletContext;
 import javax.servlet.ServletException;
@@ -411,13 +412,13 @@ public class DefaultServlet extends HttpServlet {
      * @exception ServletException if a servlet-specified error occurs
      */
     @Override
-    protected void doHead(HttpServletRequest request,
-                          HttpServletResponse response)
-        throws IOException, ServletException {
-
-        // Serve the requested resource, without the data content
-        serveResource(request, response, false, fileEncoding);
-
+    protected void doHead(HttpServletRequest request, HttpServletResponse response)
+            throws IOException, ServletException {
+        // Serve the requested resource, without the data content unless we are
+        // being included since in that case the content needs to be provided so
+        // the correct content length is reported for the including resource
+        boolean serveContent = DispatcherType.INCLUDE.equals(request.getDispatcherType());
+        serveResource(request, response, serveContent, fileEncoding);
     }
 
 

==================================================
