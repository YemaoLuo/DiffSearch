46e7d1e58a034debcd23ba74db06719de6ce5efd
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50207
==================================================
Mark Emlyn
==================================================
Tue Nov 23 16:57:47 2010 +0000
==================================================
Http11NioProtocol.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50207

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1038202 13f79535-47bb-0310-9956-ffa450edef68



==================================================
NioEndpoint.java
index c10e0e9726..2d36591fe0 100644
--- a/java/org/apache/coyote/http11/Http11NioProtocol.java
+++ b/java/org/apache/coyote/http11/Http11NioProtocol.java
@@ -329,19 +329,23 @@ public class Http11NioProtocol extends AbstractHttp11JsseProtocol {
                     if (processor.isAsync()) {
                         state = processor.asyncPostProcess();
                     }
-                    if (state != SocketState.LONG && state != SocketState.ASYNC_END) {
+                    if (state == SocketState.OPEN || state == SocketState.CLOSED) {
                         release(socket);
                         if (state == SocketState.OPEN) {
                             socket.getPoller().add(socket);
                         }
-                    } else if (state == SocketState.ASYNC_END) {
-                        // No further work required
                     } else if (state == SocketState.LONG) {
-                        att.setAsync(true); // Re-enable timeouts
+                        if (processor.isAsync()) {
+                            att.setAsync(true); // Re-enable timeouts
+                        } else {
+                            // Comet
+                            if (log.isDebugEnabled()) log.debug("Keeping processor["+processor);
+                            //add correct poller events here based on Comet stuff
+                            socket.getPoller().add(socket,att.getCometOps());
+                        }
                     } else {
-                        if (log.isDebugEnabled()) log.debug("Keeping processor["+processor);
-                        //add correct poller events here based on Comet stuff
-                        socket.getPoller().add(socket,att.getCometOps());
+                        // state == SocketState.ASYNC_END
+                        // No further work required
                     }
                 }
             }

==================================================
