2b1dfe5bc4befdc53d74a0333ac8931d78ec39f6
==================================================
Drop NPN calls
==================================================
remm remm@apache.org
==================================================
Tue May 31 11:17:10 2022 +0200
==================================================
OpenSSLContext.java
index 5273538daf..f6765453b4 100644
--- a/modules/openssl-java17/openssl-tomcat.conf
+++ b/modules/openssl-java17/openssl-tomcat.conf
@@ -214,7 +214,6 @@
 --include-function SSL_get_shutdown                              # header: /usr/include/openssl/ssl.h
 --include-function SSL_get_version                               # header: /usr/include/openssl/ssl.h
 --include-function SSL_get0_alpn_selected                        # header: /usr/include/openssl/ssl.h
---include-function SSL_get0_next_proto_negotiated                # header: /usr/include/openssl/ssl.h
 --include-function SSL_in_init                                   # header: /usr/include/openssl/ssl.h
 --include-function SSL_load_client_CA_file                       # header: /usr/include/openssl/ssl.h
 --include-function SSL_new                                       # header: /usr/include/openssl/ssl.h

==================================================
OpenSSLEngine.java
index ee2ab2f9d1..516f4c68ef 100644
--- a/modules/openssl-java17/src/main/java/org/apache/tomcat/util/net/openssl/panama/OpenSSLContext.java
+++ b/modules/openssl-java17/src/main/java/org/apache/tomcat/util/net/openssl/panama/OpenSSLContext.java
@@ -678,8 +678,6 @@ public class OpenSSLContext implements org.apache.tomcat.util.net.SSLContext {
                         CLinker.getInstance().upcallStub(openSSLCallbackAlpnSelectProtoHandle,
                         openSSLCallbackAlpnSelectProtoFunctionDescriptor, state.contextScope);
                 SSL_CTX_set_alpn_select_cb(state.sslCtx, openSSLCallbackAlpnSelectProto, state.sslCtx);
-                // Skip NPN (annoying and likely not useful anymore)
-                //SSLContext.setNpnProtos(state.ctx, protocolsArray, SSL.SSL_SELECTOR_FAILURE_NO_ADVERTISE);
             }
 
             // Apply OpenSSLConfCmd if used

==================================================
constants$11.java
index 52e0677144..f3cc027298 100644
--- a/modules/openssl-java17/src/main/java/org/apache/tomcat/util/net/openssl/panama/OpenSSLEngine.java
+++ b/modules/openssl-java17/src/main/java/org/apache/tomcat/util/net/openssl/panama/OpenSSLEngine.java
@@ -1008,9 +1008,6 @@ public final class OpenSSLEngine extends SSLEngine implements SSLUtil.ProtocolIn
         MemorySegment lenAddress = allocator.allocate(CLinker.C_INT, 0);
         MemorySegment protocolPointer = allocator.allocate(CLinker.C_POINTER, MemoryAddress.NULL);
         SSL_get0_alpn_selected(state.ssl, protocolPointer, lenAddress);
-        if (MemoryAddress.NULL.equals(protocolPointer.address())) {
-            SSL_get0_next_proto_negotiated(state.ssl, protocolPointer, lenAddress);
-        }
         if (MemoryAddress.NULL.equals(protocolPointer.address())) {
             return null;
         }
@@ -1808,14 +1805,7 @@ public final class OpenSSLEngine extends SSLEngine implements SSLUtil.ProtocolIn
         public String getProtocol() {
             String applicationProtocol = OpenSSLEngine.this.applicationProtocol;
             if (applicationProtocol == null) {
-                synchronized (OpenSSLEngine.this) {
-                    if (!destroyed) {
-                        applicationProtocol = getProtocolNegotiated();
-                    }
-                }
-                if (applicationProtocol == null) {
-                    applicationProtocol = fallbackApplicationProtocol;
-                }
+                applicationProtocol = fallbackApplicationProtocol;
                 if (applicationProtocol != null) {
                     OpenSSLEngine.this.applicationProtocol = applicationProtocol.replace(':', '_');
                 } else {

==================================================
openssl_h.java
index 051943ca6c..92b679eff7 100644
--- a/modules/openssl-java17/src/main/java/org/apache/tomcat/util/openssl/constants$11.java
+++ b/modules/openssl-java17/src/main/java/org/apache/tomcat/util/openssl/constants$11.java
@@ -35,16 +35,6 @@ class constants$11 {
         "(Ljdk/incubator/foreign/MemoryAddress;J)J",
         constants$11.SSL_set_options$FUNC, false
     );
-    static final FunctionDescriptor SSL_get0_next_proto_negotiated$FUNC = FunctionDescriptor.ofVoid(
-        C_POINTER,
-        C_POINTER,
-        C_POINTER
-    );
-    static final MethodHandle SSL_get0_next_proto_negotiated$MH = RuntimeHelper.downcallHandle(
-        openssl_h.LIBRARIES, "SSL_get0_next_proto_negotiated",
-        "(Ljdk/incubator/foreign/MemoryAddress;Ljdk/incubator/foreign/MemoryAddress;Ljdk/incubator/foreign/MemoryAddress;)V",
-        constants$11.SSL_get0_next_proto_negotiated$FUNC, false
-    );
     static final FunctionDescriptor SSL_CTX_set_alpn_select_cb$FUNC = FunctionDescriptor.ofVoid(
         C_POINTER,
         C_POINTER,

==================================================
