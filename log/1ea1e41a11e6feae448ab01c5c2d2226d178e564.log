1ea1e41a11e6feae448ab01c5c2d2226d178e564
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=62757
==================================================
Mark Thomas
==================================================
Wed Oct 3 14:03:51 2018 +0000
==================================================
JspRuntimeContext.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=62757
Correct a regression in the fix for bug 62603 that caused NullPointerExceptions when compiling tag files on first access when development mode was disabled and background compilation was enabled.
Based on a patch by Jordi Llach.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1842725 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TagFileProcessor.java
index 359ab80fe8..92c8661bce 100644
--- a/java/org/apache/jasper/compiler/JspRuntimeContext.java
+++ b/java/org/apache/jasper/compiler/JspRuntimeContext.java
@@ -378,8 +378,7 @@ public final class JspRuntimeContext {
         for (int i = 0; i < wrappers.length; i++ ) {
             JspServletWrapper jsw = (JspServletWrapper)wrappers[i];
             JspCompilationContext ctxt = jsw.getJspEngineContext();
-            // JspServletWrapper also synchronizes on this when
-            // it detects it has to do a reload
+            // Sync on JspServletWrapper when calling ctxt.compile()
             synchronized(jsw) {
                 try {
                     ctxt.compile();

==================================================
JspServletWrapper.java
index d543de0028..3b3300d366 100644
--- a/java/org/apache/jasper/compiler/TagFileProcessor.java
+++ b/java/org/apache/jasper/compiler/TagFileProcessor.java
@@ -543,12 +543,11 @@ class TagFileProcessor {
                         wrapper = new JspServletWrapper(ctxt.getServletContext(), ctxt
                                 .getOptions(), tagFilePath, tagInfo, ctxt
                                 .getRuntimeContext(), tagJar);
-                        rctxt.addWrapper(wrapperUri, wrapper);
-
                         // Use same classloader and classpath for compiling tag files
                         wrapper.getJspEngineContext().setClassLoader(
                                 ctxt.getClassLoader());
                         wrapper.getJspEngineContext().setClassPath(ctxt.getClassPath());
+                        rctxt.addWrapper(wrapperUri, wrapper);
                     } else {
                         // Make sure that JspCompilationContext gets the latest TagInfo
                         // for the tag file. TagInfo instance was created the last

==================================================
