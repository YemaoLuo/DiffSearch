d10b38913e1edaab05436a34ff8df0f5d7c02dd5
==================================================
Add a setDomain() method to LifecycleMBeanRegistration since not all components (eg Exectutor) retain a reference to their parent.
==================================================
Mark Emlyn
==================================================
Sun May 2 19:10:40 2010 +0000
==================================================
LifecycleMBeanRegistration.java
Add a setDomain() method to LifecycleMBeanRegistration since not all components (eg Exectutor) retain a reference to their parent.
Implement this new method where required.
Implement MBean (de)registration for Executors using the new interface.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@940305 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardEngine.java
index 644060e490..f744775775 100644
--- a/java/org/apache/catalina/core/LocalStrings.properties
+++ b/java/org/apache/catalina/core/LocalStrings.properties
@@ -197,6 +197,7 @@ standardService.onameFail=MBean name specified for Service [{0}] is not valid
 standardService.register.failed=Error registering Service at domain {0}
 standardService.start.name=Starting service {0}
 standardService.stop.name=Stopping service {0}
+standardThreadExecutor.onameFail=MBean name specified for Thread Executor [{0}] is not valid
 standardWrapper.allocate=Error allocating a servlet instance
 standardWrapper.allocateException=Allocate exception for servlet {0}
 standardWrapper.containerServlet=Loading container servlet {0}

==================================================
StandardServer.java
index 9361d9c133..66a1e260c0 100644
--- a/java/org/apache/catalina/core/StandardEngine.java
+++ b/java/org/apache/catalina/core/StandardEngine.java
@@ -367,10 +367,6 @@ public class StandardEngine
     @Override
     protected void destroyInternal() throws LifecycleException {
         
-        // if we created it, make sure it's also destroyed
-        // this call implizit this.stop()
-        ((StandardService)service).destroy();
-
         if( mbeans != null ) {
             try {
                 Registry.getRegistry(null, null)

==================================================
StandardService.java
index 4b83623f1a..f928ff7015 100644
--- a/java/org/apache/catalina/core/StandardServer.java
+++ b/java/org/apache/catalina/core/StandardServer.java
@@ -768,6 +768,11 @@ public final class StandardServer extends LifecycleBase
     }
 
     
+    public void setDomain(String domain) {
+        this.domain = domain;
+    }
+    
+    
     public ObjectName getObjectName() {
         if (oname == null) {
             StringBuilder name = new StringBuilder(getDomain());

==================================================
StandardThreadExecutor.java
index b8a730817d..b9362f74c3 100644
--- a/java/org/apache/catalina/core/StandardService.java
+++ b/java/org/apache/catalina/core/StandardService.java
@@ -521,6 +521,9 @@ public class StandardService extends LifecycleBase
 
         // Initialize any Executors
         for (Executor executor : findExecutors()) {
+            if (executor instanceof LifecycleMBeanRegistration) {
+                ((LifecycleMBeanRegistration) executor).setDomain(getDomain());
+            }
             executor.init();
         }
 
@@ -593,6 +596,10 @@ public class StandardService extends LifecycleBase
         return domain;
     }
 
+    public void setDomain(String domain) {
+        this.domain = domain;
+    }
+    
     public ObjectName getObjectName() {
         if (oname == null) {
             StringBuilder name = new StringBuilder(getDomain());

==================================================
