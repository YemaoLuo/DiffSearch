2f77f7cf6f40cc5cebd708eb99e842543dcb3b7b
==================================================
Fix possible memory leak with NIO when executor needs to create a new
==================================================
Mark Emlyn
==================================================
Wed Sep 4 12:14:02 2013 +0000
==================================================
AbstractEndpoint.java
Fix possible memory leak with NIO when executor needs to create a new
thread.
Pull up common code.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1519991 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AprEndpoint.java
index 6c8db0b336..69af7aa56f 100644
--- a/java/org/apache/tomcat/util/net/AbstractEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AbstractEndpoint.java
@@ -20,6 +20,7 @@ import java.io.File;
 import java.io.OutputStreamWriter;
 import java.net.InetAddress;
 import java.net.InetSocketAddress;
+import java.security.PrivilegedAction;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.StringTokenizer;
@@ -94,6 +95,23 @@ public abstract class AbstractEndpoint<S> {
         }
     }
 
+
+    protected static class PrivilegedSetTccl implements PrivilegedAction<Void> {
+
+        private ClassLoader cl;
+
+        PrivilegedSetTccl(ClassLoader cl) {
+            this.cl = cl;
+        }
+
+        @Override
+        public Void run() {
+            Thread.currentThread().setContextClassLoader(cl);
+            return null;
+        }
+    }
+
+
     private static final int INITIAL_ERROR_DELAY = 50;
     private static final int MAX_ERROR_DELAY = 1600;
 

==================================================
JIoEndpoint.java
index e5d929bf1b..c7214f8374 100644
--- a/java/org/apache/tomcat/util/net/AprEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AprEndpoint.java
@@ -2300,20 +2300,4 @@ public class AprEndpoint extends AbstractEndpoint<Long> {
             super(socket);
         }
     }
-
-
-    private static class PrivilegedSetTccl implements PrivilegedAction<Void> {
-
-        private ClassLoader cl;
-
-        PrivilegedSetTccl(ClassLoader cl) {
-            this.cl = cl;
-        }
-
-        @Override
-        public Void run() {
-            Thread.currentThread().setContextClassLoader(cl);
-            return null;
-        }
-    }
 }

==================================================
NioEndpoint.java
index 696a84b17e..cd518cfc9d 100644
--- a/java/org/apache/tomcat/util/net/JIoEndpoint.java
+++ b/java/org/apache/tomcat/util/net/JIoEndpoint.java
@@ -607,20 +607,4 @@ public class JIoEndpoint extends AbstractEndpoint<Socket> {
     protected Log getLog() {
         return log;
     }
-
-    private static class PrivilegedSetTccl implements PrivilegedAction<Void> {
-
-        private ClassLoader cl;
-
-        PrivilegedSetTccl(ClassLoader cl) {
-            this.cl = cl;
-        }
-
-        @Override
-        public Void run() {
-            Thread.currentThread().setContextClassLoader(cl);
-            return null;
-        }
-    }
-
 }

==================================================
