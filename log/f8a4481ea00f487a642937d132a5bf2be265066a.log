f8a4481ea00f487a642937d132a5bf2be265066a
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56334
==================================================
Mark Emlyn
==================================================
Sat Apr 12 20:07:54 2014 +0000
==================================================
ELParser.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56334
Correct double backslash escaping in attributes

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1586890 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestELParser.java
index c407165a31..e1fab19a18 100644
--- a/java/org/apache/jasper/compiler/ELParser.java
+++ b/java/org/apache/jasper/compiler/ELParser.java
@@ -209,7 +209,7 @@ public class ELParser {
                 prev = 0;
                 if (ch == '\\') {
                     buf.append('\\');
-                    prev = '\\';
+                    continue;
                 } else if (ch == '$'
                         || (!isDeferredSyntaxAllowedAsLiteral && ch == '#')) {
                     buf.append(ch);
@@ -468,18 +468,18 @@ public class ELParser {
 
         @Override
         public void visit(Function n) throws JasperException {
-            output.append(n.getOriginalText());
+            output.append(Generator.escape(n.getOriginalText()));
             output.append('(');
         }
 
         @Override
         public void visit(Text n) throws JasperException {
-            output.append(n.getText());
+            output.append(Generator.escape(n.getText()));
         }
 
         @Override
         public void visit(ELText n) throws JasperException {
-            output.append(n.getText());
+            output.append(Generator.escape(n.getText()));
         }
     }
 }

==================================================
TestParser.java
index ac2cbcb994..19dc89c372 100644
--- a/test/org/apache/jasper/compiler/TestELParser.java
+++ b/test/org/apache/jasper/compiler/TestELParser.java
@@ -170,6 +170,18 @@ public class TestELParser {
     }
 
 
+    @Test
+    public void testEscape01() throws JasperException {
+        doTestParser("${'\\\\'}");
+    }
+
+
+    @Test
+    public void testEscape02() throws JasperException {
+        doTestParser("\\\\x${'\\\\'}");
+    }
+
+
     private void doTestParser(String input) throws JasperException {
         Nodes nodes = ELParser.parse(input, false);
 

==================================================
