a9dc726f11524f658e3d51d89db18b0ee3b79ad2
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=55988
==================================================
Christopher Schultz
==================================================
Fri Feb 27 01:37:19 2015 +0000
==================================================
AbstractEndpoint.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=55988

Respect TLS server cipher ordering in JSSE-based connectors.
Patch provided by Ognjen Blagojevic.



git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1662614 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Nio2Endpoint.java
index 22c17a86b1..bc408a487c 100644
--- a/java/org/apache/tomcat/util/net/AbstractEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AbstractEndpoint.java
@@ -31,6 +31,8 @@ import java.util.concurrent.Executor;
 import java.util.concurrent.TimeUnit;
 
 import javax.net.ssl.KeyManagerFactory;
+import javax.net.ssl.SSLEngine;
+import javax.net.ssl.SSLParameters;
 
 import org.apache.juli.logging.Log;
 import org.apache.tomcat.util.IntrospectionUtils;
@@ -964,6 +966,10 @@ public abstract class AbstractEndpoint<S> {
      */
     public abstract String[] getCiphersUsed();
 
+    private String useServerCipherSuitesOrder = "false";
+    public String getUseServerCipherSuitesOrder() { return useServerCipherSuitesOrder;}
+    public void setUseServerCipherSuitesOrder(String s) { this.useServerCipherSuitesOrder = s;}
+
     private String keyAlias = null;
     public String getKeyAlias() { return keyAlias;}
     public void setKeyAlias(String s ) { keyAlias = s;}
@@ -1065,6 +1071,22 @@ public abstract class AbstractEndpoint<S> {
     protected final Set<SocketWrapperBase<S>> waitingRequests = Collections
             .newSetFromMap(new ConcurrentHashMap<SocketWrapperBase<S>, Boolean>());
 
+    /**
+     * Configures SSLEngine to honor cipher suites ordering based upon
+     * endpoint configuration.
+     */
+    protected void configureUseServerCipherSuitesOrder(SSLEngine engine) {
+        String useServerCipherSuitesOrderStr = this
+                .getUseServerCipherSuitesOrder().trim();
+
+        SSLParameters sslParameters = engine.getSSLParameters();
+        boolean useServerCipherSuitesOrder =
+            ("true".equalsIgnoreCase(useServerCipherSuitesOrderStr)
+                || "yes".equalsIgnoreCase(useServerCipherSuitesOrderStr));
+
+        sslParameters.setUseCipherSuitesOrder(useServerCipherSuitesOrder);
+        engine.setSSLParameters(sslParameters);
+    }
 
     /**
      * The async timeout thread.

==================================================
NioEndpoint.java
index 18b44ac7b7..6ab16fd16e 100644
--- a/java/org/apache/tomcat/util/net/Nio2Endpoint.java
+++ b/java/org/apache/tomcat/util/net/Nio2Endpoint.java
@@ -545,6 +545,8 @@ public class Nio2Endpoint extends AbstractEndpoint<Nio2Channel> {
         engine.setEnabledCipherSuites(enabledCiphers);
         engine.setEnabledProtocols(enabledProtocols);
 
+        configureUseServerCipherSuitesOrder(engine);
+
         return engine;
     }
 

==================================================
