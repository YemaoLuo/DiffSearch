c88e4ca0d85d0dd48659b8d1818ee9f9775193e4
==================================================
Improve TaskQueue.
==================================================
lihan lihan@apache.org
==================================================
Wed Nov 2 17:01:29 2022 +0800
==================================================
TaskQueue.java
Improve TaskQueue.

Reduce the performance overhead of
unnecessary locks by customizing a
lock-free method for obtaining pool size



==================================================
ThreadPoolExecutor.java
index 7104280027..7ff4e3e586 100644
--- a/java/org/apache/tomcat/util/threads/TaskQueue.java
+++ b/java/org/apache/tomcat/util/threads/TaskQueue.java
@@ -77,15 +77,15 @@ public class TaskQueue extends LinkedBlockingQueue<Runnable> {
             return super.offer(o);
         }
         //we are maxed out on threads, simply queue the object
-        if (parent.getPoolSize() == parent.getMaximumPoolSize()) {
+        if (parent.getPoolSizeNoLock() == parent.getMaximumPoolSize()) {
             return super.offer(o);
         }
         //we have idle threads, just add it to the queue
-        if (parent.getSubmittedCount()<=(parent.getPoolSize())) {
+        if (parent.getSubmittedCount() <= parent.getPoolSizeNoLock()) {
             return super.offer(o);
         }
         //if we have less threads than maximum force creation of a new thread
-        if (parent.getPoolSize()<parent.getMaximumPoolSize()) {
+        if (parent.getPoolSizeNoLock() < parent.getMaximumPoolSize()) {
             return false;
         }
         //if we reached here, we need to add it to the queue

==================================================
