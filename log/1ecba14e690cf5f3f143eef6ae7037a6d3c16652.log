1ecba14e690cf5f3f143eef6ae7037a6d3c16652
==================================================
Refactor so Principal is never cached in session with cache==false
==================================================
Mark Thomas
==================================================
Thu Dec 5 23:25:37 2019 +0000
==================================================
AuthenticatorBase.java
Refactor so Principal is never cached in session with cache==false



==================================================
Constants.java
index b64493491c..0b63fd9575 100644
--- a/java/org/apache/catalina/authenticator/AuthenticatorBase.java
+++ b/java/org/apache/catalina/authenticator/AuthenticatorBase.java
@@ -1133,10 +1133,11 @@ public abstract class AuthenticatorBase extends ValveBase
         }
 
         // Cache the authentication information in our session, if any
-        if (cache) {
-            if (session != null) {
+        if (session != null) {
+            if (cache) {
                 session.setAuthType(authType);
                 session.setPrincipal(principal);
+            } else {
                 if (username != null) {
                     session.setNote(Constants.SESS_USERNAME_NOTE, username);
                 } else {

==================================================
FormAuthenticator.java
index 69b6066e0e..9857c0975c 100644
--- a/java/org/apache/catalina/authenticator/Constants.java
+++ b/java/org/apache/catalina/authenticator/Constants.java
@@ -77,7 +77,10 @@ public class Constants {
 
     /**
      * The previously authenticated principal (if caching is disabled).
+     *
+     * @deprecated Unused. Will be removed in Tomcat 10.
      */
+    @Deprecated
     public static final String FORM_PRINCIPAL_NOTE = "org.apache.catalina.authenticator.PRINCIPAL";
 
     /**

==================================================
