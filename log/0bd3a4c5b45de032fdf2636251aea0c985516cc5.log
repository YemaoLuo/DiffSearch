0bd3a4c5b45de032fdf2636251aea0c985516cc5
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57626
==================================================
Mark Thomas
==================================================
Wed Feb 25 11:23:00 2015 +0000
==================================================
JspCompilationContext.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57626
Ensure that when processing a tag file within a Jar that the JspComppilationContext always has the latest, opened Jar instance to work with.
Add a unit test for recompilation of a modified JSOP that depends on a tag file packaged in a Jar.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1662200 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TagFileProcessor.java
index 01473b0b50..672e37612f 100644
--- a/java/org/apache/jasper/JspCompilationContext.java
+++ b/java/org/apache/jasper/JspCompilationContext.java
@@ -89,7 +89,7 @@ public class JspCompilationContext {
     private final boolean isTagFile;
     private boolean protoTypeMode;
     private TagInfo tagInfo;
-    private final Jar tagJar;
+    private Jar tagJar;
 
     // jspURI _must_ be relative to the context
     public JspCompilationContext(String jspUri, Options options,
@@ -310,6 +310,10 @@ public class JspCompilationContext {
         return this.tagJar;
     }
 
+    public void setTagFileJar(Jar tagJar) {
+        this.tagJar = tagJar;
+    }
+
     /* ==================== Common implementation ==================== */
 
     /**

==================================================
TestJspCompilationContext.java
index a04cb4381d..87af167b67 100644
--- a/java/org/apache/jasper/compiler/TagFileProcessor.java
+++ b/java/org/apache/jasper/compiler/TagFileProcessor.java
@@ -554,6 +554,10 @@ class TagFileProcessor {
                     // time the tag file was scanned for directives, and the tag
                     // file may have been modified since then.
                     wrapper.getJspEngineContext().setTagInfo(tagInfo);
+                    // The tagJar passed to to the JspCompilationContext will
+                    // have been closed (see the finally block at the end of
+                    // this method) so update the the tagJar to one opened above
+                    wrapper.getJspEngineContext().setTagFileJar(tagJar);
                 }
 
                 Class<?> tagClazz;

==================================================
