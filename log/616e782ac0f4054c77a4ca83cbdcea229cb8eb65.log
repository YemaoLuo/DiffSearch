616e782ac0f4054c77a4ca83cbdcea229cb8eb65
==================================================
Get responses without bodies working (e.g. redirect)
==================================================
Mark Thomas
==================================================
Wed May 20 22:21:41 2015 +0000
==================================================
ByteUtil.java
Get responses without bodies working (e.g. redirect)
Lots of TODOs remain including fixing a couple of hacks that will only work when there is no response body.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1680690 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http2UpgradeHandler.java
index 0183607a77..5a95fa56d8 100644
--- a/java/org/apache/coyote/http2/ByteUtil.java
+++ b/java/org/apache/coyote/http2/ByteUtil.java
@@ -37,6 +37,14 @@ public class ByteUtil {
     }
 
 
+    public static void set31Bits(byte[] input, int firstByte, int value) {
+        input[firstByte] = (byte) ((value & 0x7F000000) >> 24);
+        input[firstByte + 1] = (byte) ((value & 0xFF0000) >> 16);
+        input[firstByte + 2] = (byte) ((value & 0xFF00) >> 8);
+        input[firstByte + 3] = (byte) (value & 0xFF);
+    }
+
+
     public static int getOneByte(byte[] input, int pos) {
         return (input[pos] & 0xFF);
     }
@@ -53,6 +61,13 @@ public class ByteUtil {
     }
 
 
+    public static void setThreeBytes(byte[] input, int firstByte, int value) {
+        input[firstByte] = (byte) ((value & 0xFF0000) >> 16);
+        input[firstByte + 1] = (byte) ((value & 0xFF00) >> 8);
+        input[firstByte + 2] = (byte) (value & 0xFF);
+    }
+
+
     public static int getFourBytes(byte[] input, int firstByte) {
         return ((input[firstByte] & 0xFF) << 24) + ((input[firstByte + 1] & 0xFF) << 16) +
                 ((input[firstByte + 2] & 0xFF) << 8) + (input[firstByte + 3] & 0xFF);

==================================================
Stream.java
index bd491ecddc..77afee462d 100644
--- a/java/org/apache/coyote/http2/LocalStrings.properties
+++ b/java/org/apache/coyote/http2/LocalStrings.properties
@@ -38,9 +38,9 @@ streamProcessor.httpupgrade.notsupported=HTTP upgrade is not supported within HT
 
 upgradeHandler.connectionError=An error occurred that requires the HTTP/2 connection to be closed.
 upgradeHandler.init=Connection [{0}]
+upgradeHandler.ioerror=Connection [{0}]
 upgradeHandler.payloadTooBig=The payload is [{0}] bytes long but the maximum frame size is [{1}]
 upgradeHandler.processFrame=Connection [{0}], Stream [{1}], Flags [{2}], Payload size [{3}]
-upgradeHandler.processFrame.ioerror=An I/O error occurred while reading an incoming HTTP/2 frame
 upgradeHandler.processFrameHeaders.invalidStream=Headers frame received for stream [0]
 upgradeHandler.processFrameHeaders.decodingFailed=There was an error during the HPACK decoding of HTTP headers
 upgradeHandler.processFrameHeaders.decodingDataLeft=Data left over after HPACK decoding - it should have been consumed
@@ -59,7 +59,7 @@ upgradeHandler.unexpectedEos=Unexpected end of stream
 upgradeHandler.unexpectedStatus=An unexpected value of status ([{0}]) was passed to this method
 upgradeHandler.upgradeDispatch.entry=Entry, Connection [{0}], SocketStatus [{1}]
 upgradeHandler.upgradeDispatch.exit=Exit, Connection [{0}], SocketState [{1}]
-
+upgradeHandler.writeHeaders=Connection [{0}], Stream [{1}]
 
 writeStateMachine.endWrite.ise=It is illegal to specify [{0}] for the new state once a write has completed
 writeStateMachine.ise=It is illegal to call [{0}()] in state [{1}]
\ No newline at end of file

==================================================
