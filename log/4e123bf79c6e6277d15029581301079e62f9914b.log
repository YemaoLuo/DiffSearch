4e123bf79c6e6277d15029581301079e62f9914b
==================================================
Refactor
==================================================
Mark Thomas
==================================================
Tue Dec 6 12:39:29 2016 +0000
==================================================
Nio2Endpoint.java
Refactor
- reduce duplication
- better alignment with APR

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1772881 13f79535-47bb-0310-9956-ffa450edef68



==================================================
NioEndpoint.java
index 548c7e2e8f..6a6cc6fe86 100644
--- a/java/org/apache/tomcat/util/net/Nio2Endpoint.java
+++ b/java/org/apache/tomcat/util/net/Nio2Endpoint.java
@@ -449,11 +449,9 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel> {
                         // setSocketOptions() will hand the socket off to
                         // an appropriate processor if successful
                         if (!setSocketOptions(socket)) {
-                            countDownConnection();
                             closeSocket(socket);
                        }
                     } else {
-                        countDownConnection();
                         closeSocket(socket);
                     }
                 } catch (Throwable t) {
@@ -466,6 +464,7 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel> {
 
 
         private void closeSocket(AsynchronousSocketChannel socket) {
+            countDownConnection();
             try {
                 socket.close();
             } catch (IOException ioe) {

==================================================
