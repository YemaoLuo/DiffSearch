0fa991f0e0c7e51dbdae836e917e28671292e2ec
==================================================
Send a close frame telling the client why the connection is being closed if the server buffers can't cope.
==================================================
Mark Emlyn
==================================================
Fri Dec 21 23:02:35 2012 +0000
==================================================
WsFrame.java
Send a close frame telling the client why the connection is being closed if the server buffers can't cope.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1425175 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsRemoteEndpoint.java
index ea924190f0..94e399c49b 100644
--- a/java/org/apache/tomcat/websocket/WsFrame.java
+++ b/java/org/apache/tomcat/websocket/WsFrame.java
@@ -327,9 +327,13 @@ public class WsFrame {
                 return;
             }
             if (inputBuffer.length < frameSize) {
-                // Never going to work
                 // TODO i18n - buffer too small
-                throw new IOException();
+                CloseReason cr = new CloseReason(CloseCodes.TOO_BIG,
+                        "Buffer size: [" + inputBuffer.length +
+                        "], frame size: [" + frameSize + "]");
+                wsSession.close(cr);
+                wsSession.onClose(cr);
+                throw new IOException(cr.getReasonPhrase());
             }
             makeRoom();
         }

==================================================
