00ef32f848d0ebd4bbd3df2ca2ccb400e681f865
==================================================
Add suspect test and also allow connections to be unwrapped
==================================================
Filip Hanik
==================================================
Fri Nov 13 22:22:50 2009 +0000
==================================================
JdbcInterceptor.java
Add suspect test and also allow connections to be unwrapped


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@836028 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ProxyConnection.java
index 71311bf087..b6215ecfa2 100644
--- a/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/JdbcInterceptor.java
+++ b/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/JdbcInterceptor.java
@@ -52,6 +52,15 @@ public abstract class JdbcInterceptor implements InvocationHandler {
      * {@link javax.sql.PooledConnection#getConnection()} method name
      */
     public static final String GETCONNECTION_VAL = "getConnection";
+    /**
+     * {@link java.sql.Wrapper#unwrap(Class)} method name
+     */
+    public static final String UNWRAP_VAL = "unwrap";
+    /**
+     * {@link java.sql.Wrapper#isWrapperFor(Class)} method name
+     */
+    public static final String ISWRAPPERFOR_VAL = "isWrapperFor";
+
     
     /**
      * Properties for this interceptor.

==================================================
TestSuspectTimeout.java
index 8357846ba1..6d8ef5b1f2 100644
--- a/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ProxyConnection.java
+++ b/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ProxyConnection.java
@@ -71,7 +71,9 @@ public class ProxyConnection extends JdbcInterceptor {
 
 
     public Object unwrap(Class<?> iface) throws SQLException {
-        if (isWrapperFor(iface)) {
+        if (iface == PooledConnection.class) {
+            return connection;
+        } else if (isWrapperFor(iface)) {
             return connection.getConnection();
         } else {
             throw new SQLException("Not a wrapper of "+iface.getName());
@@ -95,6 +97,11 @@ public class ProxyConnection extends JdbcInterceptor {
             return connection.getConnection();
         }
         if (isClosed()) throw new SQLException("Connection has already been closed.");
+        if (compare(UNWRAP_VAL,method)) {
+            return unwrap((Class<?>)args[0]);
+        } else if (compare(ISWRAPPERFOR_VAL,method)) {
+            return this.isWrapperFor((Class<?>)args[0]);
+        }
         try {
             return method.invoke(connection.getConnection(),args);
         }catch (Throwable t) {

==================================================
