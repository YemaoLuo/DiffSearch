33772dbad8e7521a0b4845b24fd3293da43690a9
==================================================
- Some small comet fixes.
==================================================
Remy Maucherat
==================================================
Fri May 26 16:39:08 2006 +0000
==================================================
CoyoteAdapter.java
- Some small comet fixes.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@409696 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CometServlet.java
index 7faa471137..737f2e0eb8 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -116,12 +116,22 @@ public class CoyoteAdapter
         Response response = (Response) res.getNote(ADAPTER_NOTES);
 
         if (request.getWrapper() != null) {
+            
+            // Bind the context CL to the current thread
+            if (request.getContext().getLoader() != null ) {
+                Thread.currentThread().setContextClassLoader
+                        (request.getContext().getLoader().getClassLoader());
+            }
+            
             CometProcessor servlet = null;
             try {
                 servlet = (CometProcessor) request.getWrapper().allocate();
             } catch (Throwable t) {
                 log.error(sm.getString("coyoteAdapter.service"), t);
                 request.removeAttribute("org.apache.tomcat.comet");
+                // Restore the context classloader
+                Thread.currentThread().setContextClassLoader
+                    (CoyoteAdapter.class.getClassLoader());
                 return false;
             }
             try {
@@ -156,6 +166,9 @@ public class CoyoteAdapter
                     request.recycle();
                     response.recycle();
                 }
+                // Restore the context classloader
+                Thread.currentThread().setContextClassLoader
+                    (CoyoteAdapter.class.getClassLoader());
             }
         }
         return true;

==================================================
