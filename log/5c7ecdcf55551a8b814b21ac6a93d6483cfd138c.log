5c7ecdcf55551a8b814b21ac6a93d6483cfd138c
==================================================
Fix three edgy async context bugs.
==================================================
Remy Maucherat
==================================================
Wed Oct 29 17:29:19 2014 +0000
==================================================
AsyncContextImpl.java
Fix three edgy async context bugs.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1635215 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AsyncStateMachine.java
index 6350021e90..221bd0614d 100644
--- a/java/org/apache/catalina/core/AsyncContextImpl.java
+++ b/java/org/apache/catalina/core/AsyncContextImpl.java
@@ -84,7 +84,6 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
         }
         check();
         request.getCoyoteRequest().action(ActionCode.ASYNC_COMPLETE, null);
-        clearServletRequestResponse();
     }
 
     @Override
@@ -104,6 +103,7 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
                 }
             }
         } finally {
+            clearServletRequestResponse();
             context.unbind(Globals.IS_SECURITY_ENABLED, oldCL);
         }
 
@@ -290,6 +290,10 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
         } catch (ClassNotFoundException e) {
             ServletException se = new ServletException(e);
             throw se;
+        } catch (Exception e) {
+            ExceptionUtils.handleThrowable(e.getCause());
+            ServletException se = new ServletException(e);
+            throw se;
         }
         return listener;
     }

==================================================
