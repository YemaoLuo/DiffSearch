12f76463de8037d810ec78690b8cc2e232aab978
==================================================
path adjustments
==================================================
Filip Hanik
==================================================
Wed Aug 5 23:58:18 2009 +0000
==================================================
AsyncContextImpl.java
path adjustments


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@801472 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Async0.java
index 8e232bdfa8..b6abc96cf8 100644
--- a/java/org/apache/catalina/connector/AsyncContextImpl.java
+++ b/java/org/apache/catalina/connector/AsyncContextImpl.java
@@ -84,6 +84,8 @@ public class AsyncContextImpl implements AsyncContext {
     public void dispatch() {
         HttpServletRequest sr = (HttpServletRequest)getServletRequest();
         String path = sr.getRequestURI();
+        String cpath = sr.getContextPath();
+        if (cpath.length()>1) path = path.substring(cpath.length());
         dispatch(path);
     }
 
@@ -267,8 +269,7 @@ public class AsyncContextImpl implements AsyncContext {
             //this is the same as
             //request.startAsync().complete();
             recycle();
-        } else if (state.compareAndSet(AsyncState.DISPATCHED, AsyncState.NOT_STARTED) ||
-                   state.compareAndSet(AsyncState.COMPLETING, AsyncState.NOT_STARTED)) {
+        } else if (state.compareAndSet(AsyncState.COMPLETING, AsyncState.NOT_STARTED)) {
             for (AsyncListenerWrapper wrapper : listeners) {
                 try {
                     wrapper.fireOnComplete();

==================================================
