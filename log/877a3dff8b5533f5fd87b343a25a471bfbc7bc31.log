877a3dff8b5533f5fd87b343a25a471bfbc7bc31
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50771
==================================================
Keiichi Fujino
==================================================
Mon Feb 14 08:47:49 2011 +0000
==================================================
DeltaRequest.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50771
Ensure HttpServletRequest#getAuthType() returns the name of the authentication scheme 
if request has already been authenticated.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1070409 13f79535-47bb-0310-9956-ffa450edef68



==================================================
DeltaSession.java
index 1cddf2be56..6f02cdd094 100644
--- a/java/org/apache/catalina/ha/session/DeltaRequest.java
+++ b/java/org/apache/catalina/ha/session/DeltaRequest.java
@@ -53,6 +53,7 @@ public class DeltaRequest implements Externalizable {
     public static final int TYPE_PRINCIPAL = 1;
     public static final int TYPE_ISNEW = 2;
     public static final int TYPE_MAXINTERVAL = 3;
+    public static final int TYPE_AUTHTYPE = 4;
 
     public static final int ACTION_SET = 0;
     public static final int ACTION_REMOVE = 1;
@@ -60,6 +61,7 @@ public class DeltaRequest implements Externalizable {
     public static final String NAME_PRINCIPAL = "__SET__PRINCIPAL__";
     public static final String NAME_MAXINTERVAL = "__SET__MAXINTERVAL__";
     public static final String NAME_ISNEW = "__SET__ISNEW__";
+    public static final String NAME_AUTHTYPE = "__SET__AUTHTYPE__";
 
     private String sessionId;
     private LinkedList<AttributeInfo> actions = new LinkedList<AttributeInfo>();
@@ -119,6 +121,11 @@ public class DeltaRequest implements Externalizable {
         addAction(TYPE_ISNEW,action,NAME_ISNEW,Boolean.valueOf(n));
     }
 
+    public void setAuthType(String authType) {
+        int action = (authType==null)?ACTION_REMOVE:ACTION_SET;
+        addAction(TYPE_AUTHTYPE,action,NAME_AUTHTYPE, authType);
+    }
+
     protected void addAction(int type,
                              int action,
                              String name,
@@ -185,6 +192,14 @@ public class DeltaRequest implements Externalizable {
                     session.setPrincipal(p,false);
                     break;
                 }//case
+                case TYPE_AUTHTYPE: {
+                    String authType = null;
+                    if ( info.getAction() == ACTION_SET ) {
+                        authType = (String)info.getValue();
+                    }
+                    session.setAuthType(authType,false);
+                    break;
+                }//case
                 default : throw new java.lang.IllegalArgumentException("Invalid attribute info type="+info);
             }//switch
         }//for

==================================================
