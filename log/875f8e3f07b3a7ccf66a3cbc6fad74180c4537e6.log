875f8e3f07b3a7ccf66a3cbc6fad74180c4537e6
==================================================
Rework r1515612
==================================================
Mark Emlyn
==================================================
Mon Aug 19 23:32:28 2013 +0000
==================================================
WsHttpUpgradeHandler.java
Rework r1515612
Avoid ISE when session is closed.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1515664 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsServerContainer.java
index 9db3cca574..932e4cb392 100644
--- a/java/org/apache/tomcat/websocket/server/WsHttpUpgradeHandler.java
+++ b/java/org/apache/tomcat/websocket/server/WsHttpUpgradeHandler.java
@@ -128,15 +128,7 @@ public class WsHttpUpgradeHandler implements HttpUpgradeHandler {
             sos.setWriteListener(
                     new WsWriteListener(this, wsRemoteEndpointServer));
             ep.onOpen(wsSession, endpointConfig);
-            // If onOpen event throws an exception, the session will be closed.
-            if (wsSession.isOpen()) {
-                webSocketContainer.registerSession(ep, wsSession);
-            } else {
-                // Have to throw a RuntimeException to signal that init() failed
-                // as API offers no other options.
-                throw new IllegalStateException(
-                        sm.getString("wsHttpUpgradeHandler.initFailed"));
-            }
+            webSocketContainer.registerSession(ep, wsSession);
         } catch (DeploymentException e) {
             throw new IllegalArgumentException(e);
         } finally {

==================================================
