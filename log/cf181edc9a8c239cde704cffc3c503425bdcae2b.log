cf181edc9a8c239cde704cffc3c503425bdcae2b
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=61120
==================================================
Mark Thomas
==================================================
Wed May 24 19:35:00 2017 +0000
==================================================
Stream.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=61120
Do not ignore path parameters when processing HTTP/2 requests.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1796090 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestStream.java
index 2e795cc94b..0a0e208f0c 100644
--- a/java/org/apache/coyote/http2/Stream.java
+++ b/java/org/apache/coyote/http2/Stream.java
@@ -18,6 +18,7 @@ package org.apache.coyote.http2;
 
 import java.io.IOException;
 import java.nio.ByteBuffer;
+import java.nio.charset.StandardCharsets;
 import java.security.AccessController;
 import java.security.PrivilegedActionException;
 import java.security.PrivilegedExceptionAction;
@@ -299,18 +300,18 @@ class Stream extends AbstractStream implements HeaderEmitter {
                         getConnectionId(), getIdentifier()));
             }
             int queryStart = value.indexOf('?');
+            String uri;
             if (queryStart == -1) {
-                coyoteRequest.requestURI().setString(value);
-                coyoteRequest.decodedURI().setString(
-                        coyoteRequest.getURLDecoder().convert(value, false));
+                uri = value;
             } else {
-                String uri = value.substring(0, queryStart);
+                uri = value.substring(0, queryStart);
                 String query = value.substring(queryStart + 1);
-                coyoteRequest.requestURI().setString(uri);
-                coyoteRequest.decodedURI().setString(
-                        coyoteRequest.getURLDecoder().convert(uri, false));
                 coyoteRequest.queryString().setString(query);
             }
+            // Bug 61120. Set the URI as bytes rather than String so any path
+            // parameters are correctly processed
+            byte[] uriBytes = uri.getBytes(StandardCharsets.ISO_8859_1);
+            coyoteRequest.requestURI().setBytes(uriBytes, 0, uriBytes.length);
             break;
         }
         case ":authority": {

==================================================
