9a6bc65e50df5b8d138b5373e48575d043981c24
==================================================
Refactor WebDAV servlet escaping for XML. Add test case.
==================================================
Mark Thomas
==================================================
Wed May 24 14:16:13 2023 +0100
==================================================
WebdavServlet.java
Refactor WebDAV servlet escaping for XML. Add test case.


==================================================
XMLWriter.java
index 096ed5a84f..38448532aa 100644
--- a/java/org/apache/catalina/servlets/WebdavServlet.java
+++ b/java/org/apache/catalina/servlets/WebdavServlet.java
@@ -52,7 +52,6 @@ import jakarta.servlet.http.HttpServletResponse;
 import org.apache.catalina.WebResource;
 import org.apache.catalina.connector.RequestFacade;
 import org.apache.catalina.util.DOMWriter;
-import org.apache.catalina.util.URLEncoder;
 import org.apache.catalina.util.XMLWriter;
 import org.apache.tomcat.util.buf.HexUtils;
 import org.apache.tomcat.util.http.ConcurrentDateFormat;
@@ -140,15 +139,6 @@ public class WebdavServlet extends DefaultServlet {
 
     // -------------------------------------------------------------- Constants
 
-    private static final URLEncoder URL_ENCODER_XML;
-    static {
-        URL_ENCODER_XML = (URLEncoder) URLEncoder.DEFAULT.clone();
-        // Remove '&' from the safe character set since while it it permitted
-        // in a URI path, it is not permitted in XML and encoding it is a simple
-        // way to address this.
-        URL_ENCODER_XML.removeSafeCharacter('&');
-    }
-
     private static final String METHOD_PROPFIND = "PROPFIND";
     private static final String METHOD_PROPPATCH = "PROPPATCH";
     private static final String METHOD_MKCOL = "MKCOL";
@@ -390,18 +380,6 @@ public class WebdavServlet extends DefaultServlet {
     }
 
 
-    /**
-     * URL rewriter.
-     *
-     * @param path Path which has to be rewritten
-     * @return the rewritten path
-     */
-    @Override
-    protected String rewriteUrl(String path) {
-        return URL_ENCODER_XML.encode(path, StandardCharsets.UTF_8);
-    }
-
-
     /**
      * Override the DefaultServlet implementation and only use the PathInfo. If
      * the ServletPath is non-null, it will be because the WebDAV servlet has

==================================================
TestWebdavServlet.java
index 019c4b98cd..8290b73943 100644
--- a/java/org/apache/catalina/util/XMLWriter.java
+++ b/java/org/apache/catalina/util/XMLWriter.java
@@ -19,6 +19,8 @@ package org.apache.catalina.util;
 import java.io.IOException;
 import java.io.Writer;
 
+import org.apache.tomcat.util.security.Escape;
+
 /**
  * XMLWriter helper class.
  */
@@ -199,7 +201,7 @@ public class XMLWriter {
      * @param text Text to append
      */
     public void writeText(String text) {
-        buffer.append(text);
+        buffer.append(Escape.xml(text));
     }
 
 

==================================================
