6c1ec0aafa2d2446c7a50e12b6ec5fbd59ae2cc2
==================================================
Fix BZ 65387 - fix regression in generated code clean-up
==================================================
Mark Thomas
==================================================
Fri Jun 18 14:45:55 2021 +0100
==================================================
Generator.java
Fix BZ 65387 - fix regression in generated code clean-up

Local variable out is required for TryCatchFinally tags
https://bz.apache.org/bugzilla/show_bug.cgi?id=65387


==================================================
TestGenerator.java
index 198632e984..66ff231868 100644
--- a/java/org/apache/jasper/compiler/Generator.java
+++ b/java/org/apache/jasper/compiler/Generator.java
@@ -1859,9 +1859,10 @@ class Generator {
                 if (!isTagFile) {
                     out.printil("jakarta.servlet.jsp.PageContext pageContext = _jspx_page_context;");
                 }
-                // Only need to define out if the tag has a non-empty body or
-                // uses <jsp:attribute>...</jsp:attribute> nodes
-                if (!n.hasEmptyBody() || n.getNamedAttributeNodes().size() > 0) {
+                // Only need to define out if the tag has a non-empty body,
+                // implements TryCtachFinally or uses
+                // <jsp:attribute>...</jsp:attribute> nodes
+                if (!n.hasEmptyBody() || n.implementsTryCatchFinally() || n.getNamedAttributeNodes().size() > 0) {
                     out.printil("jakarta.servlet.jsp.JspWriter out = _jspx_page_context.getOut();");
                 }
                 generateLocalVariables(out, n);

==================================================
