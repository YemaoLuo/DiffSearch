abff9cabd0e6452245b2312f0afe4189e78494a5
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=46339
==================================================
Mark Emlyn
==================================================
Fri Jan 9 15:53:50 2009 +0000
==================================================
Generator.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=46339
Before the invocation of a fragment, AT_BEGIN and NESTED variables should be copied from the current JspContext to the JspContext of the fragment (*instead* of the JspContext of the calling page or tag file).
Patch provided by kinman@a.o
TCK passes with this patch applied.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@733072 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JspContextWrapper.java
index 8804f5e222..495981d50f 100644
--- a/java/org/apache/jasper/compiler/Generator.java
+++ b/java/org/apache/jasper/compiler/Generator.java
@@ -2032,9 +2032,6 @@ class Generator {
 
             n.setBeginJavaLine(out.getJavaLine());
 
-            // Copy virtual page scope of tag file to page scope of invoking
-            // page
-            out.printil("((org.apache.jasper.runtime.JspContextWrapper) this.jspContext).syncBeforeInvoke();");
             String varReaderAttr = n.getTextAttribute("varReader");
             String varAttr = n.getTextAttribute("var");
             if (varReaderAttr != null || varAttr != null) {
@@ -2048,6 +2045,11 @@ class Generator {
             out.print(toGetterMethod(n.getTextAttribute("fragment")));
             out.println(" != null) {");
             out.pushIndent();
+            // Copy virtual page scope of tag file to page scope of invoking
+            // page
+            out.printil("((org.apache.jasper.runtime.JspContextWrapper) this.jspContext).syncBeforeInvoke(");
+            out.print(toGetterMethod(n.getTextAttribute("fragment")));
+            out.println(".getJspContext());");
             out.printin(toGetterMethod(n.getTextAttribute("fragment")));
             out.println(".invoke(_jspx_sout);");
             out.popIndent();

==================================================
