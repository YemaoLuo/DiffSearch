9a80d06d2077265d45e0bc7c8593925c7d65e0ee
==================================================
Partial fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=53469
==================================================
Mark Emlyn
==================================================
Sun Jul 29 20:29:20 2012 +0000
==================================================
Response.java
Partial fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=53469
If the relative URL can't be made absolute, do not encode it and return it as is

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1366945 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestResponse.java
index c1e005bed4..aedbd6e11c 100644
--- a/java/org/apache/catalina/connector/Response.java
+++ b/java/org/apache/catalina/connector/Response.java
@@ -1134,7 +1134,14 @@ public class Response
     @Override
     public String encodeURL(String url) {
 
-        String absolute = toAbsolute(url);
+        String absolute;
+        try {
+            absolute = toAbsolute(url);
+        } catch (IllegalArgumentException iae) {
+            // Relative URL
+            return url;
+        }
+
         if (isEncodeable(absolute)) {
             // W3c spec clearly said
             if (url.equalsIgnoreCase("")) {
@@ -1702,7 +1709,7 @@ public class Response
             if (index < 0) {
                 break;
             }
-            // Prevent from going outside our context
+            // Can't go above the server root
             if (index == startIndex) {
                 throw new IllegalArgumentException();
             }
@@ -1719,7 +1726,7 @@ public class Response
             index = index2;
         }
 
-        // Add the query string (if present) back in
+        // Add the query string and/or fragment (if present) back in
         if (truncateCC != null) {
             try {
                 cc.append(truncateCC, 0, truncateCC.length);

==================================================
