08d73e063cbc4a48190b71be93fd929058be09e2
==================================================
Unit tests pass. Still stack traces in test logs to resolve.
==================================================
Mark Thomas
==================================================
Fri Feb 27 15:00:23 2015 +0000
==================================================
UpgradeProcessorBase.java
Unit tests pass. Still stack traces in test logs to resolve.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1662695 13f79535-47bb-0310-9956-ffa450edef68



==================================================
UpgradeProcessorExternal.java
index 7429933f39..faa80a6113 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeProcessorBase.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeProcessorBase.java
@@ -32,6 +32,8 @@ import org.apache.tomcat.util.net.SocketWrapperBase;
 
 public abstract class UpgradeProcessorBase implements Processor, WebConnection {
 
+    protected static final int INFINITE_TIMEOUT = -1;
+
     public UpgradeProcessorBase(SocketWrapperBase<?> wrapper, ByteBuffer leftOverInput) {
         wrapper.unRead(leftOverInput);
     }

==================================================
UpgradeProcessorInternal.java
index 3fab01d019..f4429b9d82 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeProcessorExternal.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeProcessorExternal.java
@@ -32,8 +32,6 @@ import org.apache.tomcat.util.res.StringManager;
 
 public class UpgradeProcessorExternal extends UpgradeProcessorBase {
 
-    private static final int INFINITE_TIMEOUT = -1;
-
     private static final Log log = LogFactory.getLog(UpgradeProcessorExternal.class);
     private static final StringManager sm = StringManager.getManager(UpgradeProcessorExternal.class);
 

==================================================
WsRemoteEndpointImplServer.java
index b3e287521c..fb9366a9bb 100644
--- a/java/org/apache/coyote/http11/upgrade/UpgradeProcessorInternal.java
+++ b/java/org/apache/coyote/http11/upgrade/UpgradeProcessorInternal.java
@@ -34,7 +34,14 @@ public class UpgradeProcessorInternal extends UpgradeProcessorBase {
             InternalHttpUpgradeHandler internalHttpUpgradeHandler) {
         super(wrapper, leftOverInput);
         this.internalHttpUpgradeHandler = internalHttpUpgradeHandler;
+        /*
+         * Leave timeouts in the hands of the upgraded protocol.
+         */
+        wrapper.setReadTimeout(INFINITE_TIMEOUT);
+        wrapper.setWriteTimeout(INFINITE_TIMEOUT);
+
         internalHttpUpgradeHandler.setSocketWrapper(wrapper);
+        wrapper.setInternalUpgrade(true);
     }
 
 

==================================================
