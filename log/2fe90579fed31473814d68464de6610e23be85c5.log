2fe90579fed31473814d68464de6610e23be85c5
==================================================
Refactor passing of the latch to improve robustness on test failure. Once the session is closed, user properties are no longer accessible.
==================================================
Mark Emlyn
==================================================
Wed May 22 23:52:28 2013 +0000
==================================================
TestWsRemoteEndpoint.java
Refactor passing of the latch to improve robustness on test failure. Once the session is closed, user properties are no longer accessible.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1485512 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestWsWebSocketContainer.java
index 71c7e18424..ea29ccec98 100644
--- a/test/org/apache/tomcat/websocket/TestWsRemoteEndpoint.java
+++ b/test/org/apache/tomcat/websocket/TestWsRemoteEndpoint.java
@@ -38,6 +38,7 @@ import org.apache.catalina.startup.TomcatBaseTest;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.AsyncHandler;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.AsyncText;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.TesterAnnotatedEndpoint;
+import org.apache.tomcat.websocket.TesterSingleMessageClient.TesterEndpoint;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.TesterProgrammaticEndpoint;
 
 public class TestWsRemoteEndpoint extends TomcatBaseTest {
@@ -92,7 +93,9 @@ public class TestWsRemoteEndpoint extends TomcatBaseTest {
         }
 
         CountDownLatch latch = new CountDownLatch(1);
-        wsSession.getUserProperties().put("latch", latch);
+        TesterEndpoint tep =
+                (TesterEndpoint) wsSession.getUserProperties().get("endpoint");
+        tep.setLatch(latch);
         AsyncHandler<?> handler = new AsyncText(latch);
 
         wsSession.addMessageHandler(handler);

==================================================
TesterSingleMessageClient.java
index f47de61f20..91f9009425 100644
--- a/test/org/apache/tomcat/websocket/TestWsWebSocketContainer.java
+++ b/test/org/apache/tomcat/websocket/TestWsWebSocketContainer.java
@@ -52,6 +52,7 @@ import org.apache.tomcat.util.net.TesterSupport;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.BasicBinary;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.BasicHandler;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.BasicText;
+import org.apache.tomcat.websocket.TesterSingleMessageClient.TesterEndpoint;
 import org.apache.tomcat.websocket.TesterSingleMessageClient.TesterProgrammaticEndpoint;
 import org.apache.tomcat.websocket.server.Constants;
 import org.apache.tomcat.websocket.server.WsListener;
@@ -235,7 +236,9 @@ public class TestWsWebSocketContainer extends TomcatBaseTest {
                                 TesterEchoServer.Config.PATH_BASIC));
         BasicHandler<?> handler;
         CountDownLatch latch = new CountDownLatch(1);
-        wsSession.getUserProperties().put("latch", latch);
+        TesterEndpoint tep =
+                (TesterEndpoint) wsSession.getUserProperties().get("endpoint");
+        tep.setLatch(latch);
         if (isTextMessage) {
             handler = new BasicText(latch);
         } else {

==================================================
