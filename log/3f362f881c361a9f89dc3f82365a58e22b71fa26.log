3f362f881c361a9f89dc3f82365a58e22b71fa26
==================================================
 Principal cache settings moved into parent class 
==================================================
Mark Thomas
==================================================
Fri Jul 3 19:57:38 2015 +0000
==================================================
FormAuthModule.java
 Principal cache settings moved into parent class 

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1689075 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TomcatAuthModule.java
index 89db853fc5..6f2abaea71 100644
--- a/java/org/apache/catalina/authenticator/jaspic/provider/modules/FormAuthModule.java
+++ b/java/org/apache/catalina/authenticator/jaspic/provider/modules/FormAuthModule.java
@@ -107,7 +107,7 @@ public class FormAuthModule extends TomcatAuthModule {
         HttpServletResponse response = (HttpServletResponse) messageInfo.getResponseMessage();
 
         // Have we authenticated this user before but have caching disabled?
-        if (!isCache()) { //TODO Ask is it required? May be principal must be always cached
+        if (!cachePrincipalsInSession) {
             Session session = request.getSessionInternal(true);
             if (log.isDebugEnabled()) {
                 log.debug("Checking for reauthenticate in session " + session);
@@ -125,14 +125,12 @@ public class FormAuthModule extends TomcatAuthModule {
                 }
 
                 session.setNote(Constants.FORM_PRINCIPAL_NOTE, principal);
-                if (!isMatchingSavedRequest(request)) {
-                    handlePrincipalCallbacks(clientSubject, principal);
-                    return AuthStatus.SUCCESS;
+                if (isMatchingSavedRequest(request)) {
+                    return submitSavedRequest(clientSubject, request, response);
                 }
 
-                if (log.isDebugEnabled()) {
-                    log.debug("Reauthentication failed, proceed normally");
-                }
+                handlePrincipalCallbacks(clientSubject, principal);
+                return AuthStatus.SUCCESS;
             }
         }
 
@@ -163,7 +161,7 @@ public class FormAuthModule extends TomcatAuthModule {
         // If we're caching principals we no longer need getPrincipal the
         // username
         // and password in the session, so remove them
-        if (isCache()) {
+        if (cachePrincipalsInSession) {
             session.removeNote(Constants.SESS_USERNAME_NOTE);
             session.removeNote(Constants.SESS_PASSWORD_NOTE);
         }
@@ -324,11 +322,6 @@ public class FormAuthModule extends TomcatAuthModule {
     }
 
 
-    private boolean isCache() {
-        return true;
-    }
-
-
     @Override
     public AuthStatus secureResponse(MessageInfo messageInfo, Subject serviceSubject)
             throws AuthException {

==================================================
