fdf7bec47088a5ea795ef7871fdb9e0bf0dbb1e6
==================================================
Fix BZ 66277 - fix regressions in Stack -> Deque refactoring
==================================================
Mark Thomas
==================================================
Tue Sep 27 10:03:06 2022 +0100
==================================================
StandardContext.java
Fix BZ 66277 - fix regressions in Stack -> Deque refactoring


==================================================
WebdavServlet.java
index 3b9c12d4be..d64f676f9a 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -28,6 +28,7 @@ import java.util.ArrayDeque;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collection;
+import java.util.Deque;
 import java.util.Enumeration;
 import java.util.EventListener;
 import java.util.HashMap;
@@ -37,7 +38,6 @@ import java.util.List;
 import java.util.Locale;
 import java.util.Map;
 import java.util.Map.Entry;
-import java.util.Queue;
 import java.util.Set;
 import java.util.TreeMap;
 import java.util.concurrent.ConcurrentHashMap;
@@ -5857,10 +5857,10 @@ public class StandardContext extends ContainerBase
             if (parent == null) {
             namingContextName = getName();
             } else {
-            Queue<String> stk = new ArrayDeque<>();
+            Deque<String> stk = new ArrayDeque<>();
             StringBuilder buff = new StringBuilder();
             while (parent != null) {
-                stk.add(parent.getName());
+                stk.addFirst(parent.getName());
                 parent = parent.getParent();
             }
             while (!stk.isEmpty()) {

==================================================
ParserController.java
index 405a281b48..a93492c606 100644
--- a/java/org/apache/catalina/servlets/WebdavServlet.java
+++ b/java/org/apache/catalina/servlets/WebdavServlet.java
@@ -29,12 +29,12 @@ import java.util.ArrayDeque;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Date;
+import java.util.Deque;
 import java.util.HashMap;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Locale;
 import java.util.Map;
-import java.util.Queue;
 import java.util.TimeZone;
 import java.util.concurrent.ConcurrentHashMap;
 
@@ -618,11 +618,11 @@ public class WebdavServlet extends DefaultServlet {
             parseProperties(req, generatedXML, path, type, properties);
         } else {
             // The stack always contains the object of the current level
-            Queue<String> stack = new ArrayDeque<>();
-            stack.add(path);
+            Deque<String> stack = new ArrayDeque<>();
+            stack.addFirst(path);
 
             // Stack of the objects one level below
-            Queue<String> stackBelow = new ArrayDeque<>();
+            Deque<String> stackBelow = new ArrayDeque<>();
 
             while ((!stack.isEmpty()) && (depth >= 0)) {
 
@@ -640,7 +640,7 @@ public class WebdavServlet extends DefaultServlet {
                             newPath += "/";
                         }
                         newPath += entry;
-                        stackBelow.add(newPath);
+                        stackBelow.addFirst(newPath);
                     }
 
                     // Displaying the lock-null resources present in that

==================================================
SystemLogHandler.java
index 362e5ae2f4..e32d24c1bf 100644
--- a/java/org/apache/jasper/compiler/ParserController.java
+++ b/java/org/apache/jasper/compiler/ParserController.java
@@ -21,7 +21,7 @@ import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.io.InputStreamReader;
 import java.util.ArrayDeque;
-import java.util.Queue;
+import java.util.Deque;
 
 import org.apache.jasper.JasperException;
 import org.apache.jasper.JspCompilationContext;
@@ -56,7 +56,7 @@ class ParserController implements TagConstants {
      * A stack to keep track of the 'current base directory'
      * for include directives that refer to relative paths.
      */
-    private final Queue<String> baseDirStack = new ArrayDeque<>();
+    private final Deque<String> baseDirStack = new ArrayDeque<>();
 
     private boolean isEncodingSpecifiedInProlog;
     private boolean isBomPresent;
@@ -519,9 +519,9 @@ class ParserController implements TagConstants {
     private String resolveFileName(String inFileName) {
         String fileName = inFileName.replace('\\', '/');
         boolean isAbsolute = fileName.startsWith("/");
-        fileName = isAbsolute ? fileName : baseDirStack.peek() + fileName;
+        fileName = isAbsolute ? fileName : baseDirStack.peekFirst() + fileName;
         String baseDir = fileName.substring(0, fileName.lastIndexOf('/') + 1);
-        baseDirStack.add(baseDir);
+        baseDirStack.addFirst(baseDir);
         return fileName;
     }
 

==================================================
TestStandardContext.java
index 746ae4ffb0..2293f349af 100644
--- a/java/org/apache/tomcat/util/log/SystemLogHandler.java
+++ b/java/org/apache/tomcat/util/log/SystemLogHandler.java
@@ -19,6 +19,7 @@ package org.apache.tomcat.util.log;
 import java.io.IOException;
 import java.io.PrintStream;
 import java.util.ArrayDeque;
+import java.util.Deque;
 import java.util.EmptyStackException;
 import java.util.Queue;
 import java.util.concurrent.ConcurrentLinkedQueue;
@@ -62,7 +63,7 @@ public class SystemLogHandler extends PrintStream {
     /**
      * Thread &lt;-&gt; CaptureLog associations.
      */
-    private static final ThreadLocal<Queue<CaptureLog>> logs = new ThreadLocal<>();
+    private static final ThreadLocal<Deque<CaptureLog>> logs = new ThreadLocal<>();
 
 
     /**
@@ -88,12 +89,12 @@ public class SystemLogHandler extends PrintStream {
         } else {
             log = new CaptureLog();
         }
-        Queue<CaptureLog> stack = logs.get();
+        Deque<CaptureLog> stack = logs.get();
         if (stack == null) {
             stack = new ArrayDeque<>();
             logs.set(stack);
         }
-        stack.add(log);
+        stack.addFirst(log);
     }
 
 

==================================================
