eb37d0d806b038c61268b2d95244764cd05ca365
==================================================
Add support for using 'war:file:...' URLs to refer to WAR files rather than 'jar:file:...'
==================================================
Mark Thomas
==================================================
Wed Oct 5 09:40:54 2016 +0000
==================================================
WarURLConnection.java
index 6fa8dc0542..9a827ecef0 100644
--- a/build.xml
+++ b/build.xml
@@ -339,6 +339,7 @@
     <include name="org/apache/catalina/startup/Tool.*" />
     <include name="org/apache/catalina/security/SecurityClassLoad.*" />
     <include name="org/apache/catalina/webresources/war/**" />
+    <include name="org/apache/tomcat/util/buf/UriUtil.*" />
   </patternset>
 
   <patternset id="files.tomcat-juli">

==================================================
UriUtil.java
index 82c4bd6ec8..5c74a9cc06 100644
--- a/java/org/apache/catalina/webresources/war/WarURLConnection.java
+++ b/java/org/apache/catalina/webresources/war/WarURLConnection.java
@@ -22,6 +22,8 @@ import java.net.URL;
 import java.net.URLConnection;
 import java.security.Permission;
 
+import org.apache.tomcat.util.buf.UriUtil;
+
 
 public class WarURLConnection extends URLConnection {
 
@@ -30,18 +32,7 @@ public class WarURLConnection extends URLConnection {
 
     protected WarURLConnection(URL url) throws IOException {
         super(url);
-
-        // Need to make this look like a JAR URL for the WAR file
-        // Assumes that the spec is absolute and starts war:file:/...
-        String file = url.getFile();
-        if (file.contains("*/")) {
-            file = file.replaceFirst("\\*/", "!/");
-        } else {
-            file = file.replaceFirst("\\^/", "!/");
-        }
-
-        URL innerJarUrl = new URL("jar", url.getHost(), url.getPort(), file);
-
+        URL innerJarUrl = UriUtil.warToJar(url);
         wrappedJarUrlConnection = innerJarUrl.openConnection();
     }
 

==================================================
JarFactory.java
index 4e959ff26d..6728ca20a4 100644
--- a/java/org/apache/tomcat/util/buf/UriUtil.java
+++ b/java/org/apache/tomcat/util/buf/UriUtil.java
@@ -128,4 +128,27 @@ public final class UriUtil {
         tmp = PATTERN_CARET.matcher(tmp).replaceAll("%5e/");
         return PATTERN_ASTERISK.matcher(tmp).replaceAll("%2a/");
     }
+
+
+    /**
+     * Convert a URL of the form <code>war:file:...</code> to
+     * <code>war:file:...</code>.
+     *
+     * @param warUrl The WAR URL to convert
+     *
+     * @return The equivalent JAR URL
+     *
+     * @throws MalformedURLException If the conversion fails
+     */
+    public static URL warToJar(URL warUrl) throws MalformedURLException {
+        // Assumes that the spec is absolute and starts war:file:/...
+        String file = warUrl.getFile();
+        if (file.contains("*/")) {
+            file = file.replaceFirst("\\*/", "!/");
+        } else {
+            file = file.replaceFirst("\\^/", "!/");
+        }
+
+        return new URL("jar", warUrl.getHost(), warUrl.getPort(), file);
+    }
 }

==================================================
