8dda192ef095e2fcbb25f6e3d61c9f51a325b228
==================================================
Revert 1589666. Default linger setting is required.
==================================================
Mark Emlyn
==================================================
Thu Apr 24 13:33:19 2014 +0000
==================================================
AjpAprProtocol.java
Revert 1589666. Default linger setting is required.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1589725 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AjpNio2Protocol.java
index 8fb6557437..2e79cadd93 100644
--- a/java/org/apache/coyote/ajp/AjpAprProtocol.java
+++ b/java/org/apache/coyote/ajp/AjpAprProtocol.java
@@ -63,6 +63,7 @@ public class AjpAprProtocol extends AbstractAjpProtocol<Long> {
         endpoint = new AprEndpoint();
         cHandler = new AjpConnectionHandler(this);
         ((AprEndpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
         // AJP does not use Send File

==================================================
AjpNioProtocol.java
index 77774b5e5e..93c0d7fcf6 100644
--- a/java/org/apache/coyote/ajp/AjpNio2Protocol.java
+++ b/java/org/apache/coyote/ajp/AjpNio2Protocol.java
@@ -58,6 +58,7 @@ public class AjpNio2Protocol extends AbstractAjpProtocol<Nio2Channel> {
         endpoint = new Nio2Endpoint();
         cHandler = new AjpConnectionHandler(this);
         ((Nio2Endpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
         // AJP does not use Send File

==================================================
AjpProtocol.java
index 6993e796db..8b521ff936 100644
--- a/java/org/apache/coyote/ajp/AjpNioProtocol.java
+++ b/java/org/apache/coyote/ajp/AjpNioProtocol.java
@@ -60,6 +60,7 @@ public class AjpNioProtocol extends AbstractAjpProtocol<NioChannel> {
         endpoint = new NioEndpoint();
         cHandler = new AjpConnectionHandler(this);
         ((NioEndpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
         // AJP does not use Send File

==================================================
Constants.java
index 8bfb356ea4..3a3cc0d2c0 100644
--- a/java/org/apache/coyote/ajp/AjpProtocol.java
+++ b/java/org/apache/coyote/ajp/AjpProtocol.java
@@ -59,6 +59,7 @@ public class AjpProtocol extends AbstractAjpProtocol<Socket> {
         endpoint = new JIoEndpoint();
         cHandler = new AjpConnectionHandler(this);
         ((JIoEndpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
     }

==================================================
Constants.java
index 9bb9859a57..d3492ea753 100644
--- a/java/org/apache/coyote/ajp/Constants.java
+++ b/java/org/apache/coyote/ajp/Constants.java
@@ -30,6 +30,7 @@ public final class Constants {
      */
     public static final String Package = "org.apache.coyote.ajp";
 
+    public static final int DEFAULT_CONNECTION_LINGER = -1;
     public static final int DEFAULT_CONNECTION_TIMEOUT = -1;
     public static final boolean DEFAULT_TCP_NO_DELAY = true;
 

==================================================
Http11AprProtocol.java
index f20bd56195..15e26eac30 100644
--- a/java/org/apache/coyote/http11/Constants.java
+++ b/java/org/apache/coyote/http11/Constants.java
@@ -36,6 +36,7 @@ public final class Constants {
      */
     public static final String Package = "org.apache.coyote.http11";
 
+    public static final int DEFAULT_CONNECTION_LINGER = -1;
     public static final int DEFAULT_CONNECTION_TIMEOUT = 60000;
     public static final boolean DEFAULT_TCP_NO_DELAY = true;
 

==================================================
Http11Nio2Protocol.java
index 2cf8a86ba8..49a5bc7fd0 100644
--- a/java/org/apache/coyote/http11/Http11AprProtocol.java
+++ b/java/org/apache/coyote/http11/Http11AprProtocol.java
@@ -67,6 +67,7 @@ public class Http11AprProtocol extends AbstractHttp11Protocol<Long> {
         endpoint = new AprEndpoint();
         cHandler = new Http11ConnectionHandler(this);
         ((AprEndpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
     }

==================================================
Http11NioProtocol.java
index b0047b7b5f..477a76fa2e 100644
--- a/java/org/apache/coyote/http11/Http11Nio2Protocol.java
+++ b/java/org/apache/coyote/http11/Http11Nio2Protocol.java
@@ -59,6 +59,7 @@ public class Http11Nio2Protocol extends AbstractHttp11JsseProtocol<Nio2Channel>
         endpoint=new Nio2Endpoint();
         cHandler = new Http11ConnectionHandler(this);
         ((Nio2Endpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
     }

==================================================
Http11Protocol.java
index 664889426f..fb7149b992 100644
--- a/java/org/apache/coyote/http11/Http11NioProtocol.java
+++ b/java/org/apache/coyote/http11/Http11NioProtocol.java
@@ -65,6 +65,7 @@ public class Http11NioProtocol extends AbstractHttp11JsseProtocol<NioChannel> {
         endpoint=new NioEndpoint();
         cHandler = new Http11ConnectionHandler(this);
         ((NioEndpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
     }

==================================================
SpdyProxyProtocol.java
index c21ee11e0c..162f3f7ea8 100644
--- a/java/org/apache/coyote/http11/Http11Protocol.java
+++ b/java/org/apache/coyote/http11/Http11Protocol.java
@@ -64,6 +64,7 @@ public class Http11Protocol extends AbstractHttp11JsseProtocol<Socket> {
         endpoint = new JIoEndpoint();
         cHandler = new Http11ConnectionHandler(this);
         ((JIoEndpoint) endpoint).setHandler(cHandler);
+        setSoLinger(Constants.DEFAULT_CONNECTION_LINGER);
         setSoTimeout(Constants.DEFAULT_CONNECTION_TIMEOUT);
         setTcpNoDelay(Constants.DEFAULT_TCP_NO_DELAY);
     }

==================================================
