6952814e58620719693311339bb81faa577958bb
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=61948
==================================================
Mark Thomas
==================================================
Tue Jan 2 21:32:41 2018 +0000
==================================================
TLSClientHelloExtractor.java
index 2831481d02..9ec8559051 100644
--- a/java/org/apache/tomcat/util/net/LocalStrings.properties
+++ b/java/org/apache/tomcat/util/net/LocalStrings.properties
@@ -126,6 +126,7 @@ jsse.invalid_truststore_password=The provided trust store password could not be
 jsse.keystore_load_failed=Failed to load keystore type [{0}] with path [{1}] due to [{2}]
 jsse.ssl3=SSLv3 has been explicitly enabled. This protocol is known to be insecure.
 
+sniExtractor.clientHelloInvalid=The ClientHello message was not correctly formatted
 sniExtractor.clientHelloTooBig=The ClientHello was not presented in a single TLS record so no SNI information could be extracted
 
 socket.closed=The socket associated with this connection has been closed.

==================================================
TestTLSClientHelloExtractor.java
index d5d9b942cf..4a83335cf2 100644
--- a/java/org/apache/tomcat/util/net/TLSClientHelloExtractor.java
+++ b/java/org/apache/tomcat/util/net/TLSClientHelloExtractor.java
@@ -16,6 +16,8 @@
  */
 package org.apache.tomcat.util.net;
 
+import java.io.IOException;
+import java.nio.BufferUnderflowException;
 import java.nio.ByteBuffer;
 import java.nio.charset.StandardCharsets;
 import java.util.ArrayList;
@@ -52,8 +54,9 @@ public class TLSClientHelloExtractor {
      * exits.
      *
      * @param netInBuffer The buffer containing the TLS data to process
+     * @throws IOException If the client hello message is malformed
      */
-    public TLSClientHelloExtractor(ByteBuffer netInBuffer) {
+    public TLSClientHelloExtractor(ByteBuffer netInBuffer) throws IOException {
         // TODO: Detect use of http on a secure connection and provide a simple
         //       error page.
 
@@ -143,6 +146,8 @@ public class TLSClientHelloExtractor {
                 }
             }
             result = ExtractorResult.COMPLETE;
+        } catch (BufferUnderflowException | IllegalArgumentException e) {
+            throw new IOException(sm.getString("sniExtractor.clientHelloInvalid"), e);
         } finally {
             this.result = result;
             this.clientRequestedCiphers = clientRequestedCiphers;

==================================================
