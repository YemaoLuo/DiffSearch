24e39c9ef650cfd36dd5ad5795b2617d3d0de928
==================================================
Fix BZ 65460
==================================================
Mark Thomas
==================================================
Fri Jul 23 14:28:38 2021 +0100
==================================================
Http2AsyncUpgradeHandler.java
Fix BZ 65460

https://bz.apache.org/bugzilla/show_bug.cgi?id=65460
Correct a regression introduced in 10.1.0-M2, 10.0.8, 9.0.51 and 8.5.69
in the change to reduce the number of small HTTP/2 window updates sent
for streams. A logic error meant that small window updates for the
connection were dropped. This meant that the connection flow window
slowly reduced over time until nothing could be sent.


==================================================
Http2UpgradeHandler.java
index 2ff351a411..5d11879164 100644
--- a/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
@@ -240,6 +240,7 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
         ByteUtil.setThreeBytes(frame, 0,  4);
         frame[3] = FrameType.WINDOW_UPDATE.getIdByte();
         ByteUtil.set31Bits(frame, 9, increment);
+        boolean neetToWriteConnectionUpdate = true;
         // No need to send update from closed stream
         if (stream instanceof Stream && ((Stream) stream).canWrite()) {
             int streamIncrement = ((Stream) stream).getWindowUpdateSizeToWrite(increment);
@@ -256,8 +257,10 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
                 socketWrapper.write(BlockingMode.SEMI_BLOCK, protocol.getWriteTimeout(),
                         TimeUnit.MILLISECONDS, null, SocketWrapperBase.COMPLETE_WRITE, errorCompletion,
                         ByteBuffer.wrap(frame), ByteBuffer.wrap(frame2));
+                neetToWriteConnectionUpdate = false;
             }
-        } else {
+        }
+        if (neetToWriteConnectionUpdate) {
             socketWrapper.write(BlockingMode.SEMI_BLOCK, protocol.getWriteTimeout(),
                     TimeUnit.MILLISECONDS, null, SocketWrapperBase.COMPLETE_WRITE, errorCompletion,
                     ByteBuffer.wrap(frame));

==================================================
