898c64a09de630caca32c171c70c3658923393ad
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56501
==================================================
Mark Emlyn
==================================================
Fri May 9 21:02:10 2014 +0000
==================================================
Request.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56501
HttpServletRequest.getContextPath() should return the undecoded context path used by the user agent.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1593621 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Mapper.java
index 33c911a7d2..5482ffa271 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -1894,7 +1894,17 @@ public class Request
      */
     @Override
     public String getContextPath() {
-        return mappingData.contextPath.toString();
+        String uri = getRequestURI();
+        int lastSlash = mappingData.contextSlashCount;
+        int pos = 0;
+        while (lastSlash > 0) {
+            pos = uri.indexOf('/', pos + 1);
+            if (pos == -1) {
+                return uri;
+            }
+            lastSlash--;
+        }
+        return uri.substring(0, pos);
     }
 
 

==================================================
MappingData.java
index ef7073d136..5e3040c9dd 100644
--- a/java/org/apache/catalina/mapper/Mapper.java
+++ b/java/org/apache/catalina/mapper/Mapper.java
@@ -229,6 +229,7 @@ public final class Mapper {
                     new ContextVersion[contextVersions.length + 1];
                 ContextVersion newContextVersion = new ContextVersion();
                 newContextVersion.path = path;
+                newContextVersion.slashCount = slashCount;
                 newContextVersion.name = version;
                 newContextVersion.object = context;
                 newContextVersion.welcomeResources = welcomeResources;
@@ -799,6 +800,7 @@ public final class Mapper {
                 }
             }
             mappingData.context = contextVersion.object;
+            mappingData.contextSlashCount = contextVersion.slashCount;
         }
 
         // Wrapper mapping
@@ -1480,6 +1482,7 @@ public final class Mapper {
 
     protected static final class ContextVersion extends MapElement<Context> {
         public String path = null;
+        public int slashCount;
         public String[] welcomeResources = new String[0];
         public WebResourceRoot resources = null;
         public MappedWrapper defaultWrapper = null;

==================================================
TestRequest.java
index bf1a8180bb..d6fdea0492 100644
--- a/java/org/apache/catalina/mapper/MappingData.java
+++ b/java/org/apache/catalina/mapper/MappingData.java
@@ -31,6 +31,7 @@ public class MappingData {
 
     public Host host = null;
     public Context context = null;
+    public int contextSlashCount = 0;
     public Context[] contexts = null;
     public Wrapper wrapper = null;
     public boolean jspWildCard = false;
@@ -45,6 +46,7 @@ public class MappingData {
     public void recycle() {
         host = null;
         context = null;
+        contextSlashCount = 0;
         contexts = null;
         wrapper = null;
         jspWildCard = false;

==================================================
