47c3514d2140bc731b0de9e7339bd6f37b22ba90
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58414
==================================================
Mark Thomas
==================================================
Sat Sep 19 07:36:27 2015 +0000
==================================================
PerMessageDeflate.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58414
Don't try and compress zero length messages
Expand the unit test to cover this case

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1703948 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestWsWebSocketContainer.java
index 3b20d804d3..1007272db0 100644
--- a/java/org/apache/tomcat/websocket/PerMessageDeflate.java
+++ b/java/org/apache/tomcat/websocket/PerMessageDeflate.java
@@ -321,6 +321,10 @@ public class PerMessageDeflate implements Transformation {
                 // Control messages can appear in the middle of other messages
                 // and must not be compressed. Pass it straight through
                 allCompressedParts.add(uncompressedPart);
+            } else if (uncompressedPart.getPayload().limit() == 0) {
+                // Zero length messages can't be compressed so pass them
+                // straight through.
+                allCompressedParts.add(uncompressedPart);
             } else {
                 List<MessagePart> compressedParts = new ArrayList<>();
                 ByteBuffer uncompressedPayload = uncompressedPart.getPayload();

==================================================
