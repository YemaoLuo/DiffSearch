95925db487bd0d133a8b61af3d5b31d33cdd7deb
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57863
==================================================
Mark Thomas
==================================================
Tue Apr 28 20:35:21 2015 +0000
==================================================
Substitution.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=57863
Correct RewriteMap support
Based on a patch provided by Tatsuya Bessho.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1676615 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestRewriteValve.java
index cb7d235f3a..0f84792597 100644
--- a/java/org/apache/catalina/valves/rewrite/Substitution.java
+++ b/java/org/apache/catalina/valves/rewrite/Substitution.java
@@ -30,8 +30,7 @@ public class Substitution {
         public String value;
 
         @Override
-        public String evaluate
-            (Matcher rule, Matcher cond, Resolver resolver) {
+        public String evaluate(Matcher rule, Matcher cond, Resolver resolver) {
             return value;
         }
 
@@ -89,9 +88,10 @@ public class Substitution {
         public RewriteMap map = null;
         public String key;
         public String defaultValue = null;
+        public int n;
         @Override
         public String evaluate(Matcher rule, Matcher cond, Resolver resolver) {
-            String result = map.lookup(key);
+            String result = map.lookup(rule.group(n));
             if (result == null) {
                 result = defaultValue;
             }
@@ -162,6 +162,9 @@ public class Substitution {
                     } else {
                         newElement.key = sub.substring(colon + 1, close);
                     }
+                    if (newElement.key.startsWith("$")) {
+                        newElement.n = Integer.parseInt(newElement.key.substring(1));
+                    }
                     pos = close + 1;
                     elements.add(newElement);
                 }

==================================================
TesterRewriteMapA.java
index 256c939a9c..0603515815 100644
--- a/test/org/apache/catalina/valves/rewrite/TestRewriteValve.java
+++ b/test/org/apache/catalina/valves/rewrite/TestRewriteValve.java
@@ -46,6 +46,19 @@ public class TestRewriteValve extends TomcatBaseTest {
         doTestRewrite("RewriteRule ^/b/(.*) /b/../a/$1", "/b/%255A", "/b/../a/%255A");
     }
 
+    // BZ 57863
+    @Test
+    public void testRewriteMap01() throws Exception {
+        doTestRewrite("RewriteMap mapa org.apache.catalina.valves.rewrite.TesterRewriteMapA\n" +
+                "RewriteRule /b/(.*).html$ /c/${mapa:$1}", "/b/a.html", "/c/aa");
+    }
+
+    @Test
+    public void testRewriteMap02() throws Exception {
+        doTestRewrite("RewriteMap mapa org.apache.catalina.valves.rewrite.TesterRewriteMapA\n" +
+                "RewriteRule /b/(.*).html$ /c/${mapa:$1|dd}", "/b/x.html", "/c/dd");
+    }
+
     private void doTestRewrite(String config, String request, String expectedURI) throws Exception {
         Tomcat tomcat = getTomcatInstance();
 
@@ -61,6 +74,7 @@ public class TestRewriteValve extends TomcatBaseTest {
         //       (http://svn.apache.org/r285186)
         Tomcat.addServlet(ctx, "snoop", new SnoopServlet());
         ctx.addServletMapping("/a/%255A", "snoop");
+        ctx.addServletMapping("/c/*", "snoop");
 
         tomcat.start();
 

==================================================
