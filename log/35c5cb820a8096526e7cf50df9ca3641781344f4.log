35c5cb820a8096526e7cf50df9ca3641781344f4
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=59317
==================================================
Mark Thomas
==================================================
Tue Apr 26 13:20:32 2016 +0000
==================================================
ApplicationContext.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=59317
After a dispatch (async and non-async) ensure that getRequestURI() returns an encoded URI.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1741015 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index f8692fad85..21ede856d8 100644
--- a/java/org/apache/catalina/core/ApplicationContext.java
+++ b/java/org/apache/catalina/core/ApplicationContext.java
@@ -65,6 +65,7 @@ import org.apache.catalina.Wrapper;
 import org.apache.catalina.connector.Connector;
 import org.apache.catalina.mapper.MappingData;
 import org.apache.catalina.util.ServerInfo;
+import org.apache.catalina.util.URLEncoder;
 import org.apache.tomcat.util.ExceptionUtils;
 import org.apache.tomcat.util.buf.CharChunk;
 import org.apache.tomcat.util.buf.MessageBytes;
@@ -465,11 +466,11 @@ public class ApplicationContext
 
         mappingData.recycle();
 
-        // Construct a RequestDispatcher to process this request
-        return new ApplicationDispatcher
-            (wrapper, uriCC.toString(), wrapperPath, pathInfo,
-             queryString, mapping, null);
+        String encodedUri = URLEncoder.DEFAULT.encode(uriCC.toString());
 
+        // Construct a RequestDispatcher to process this request
+        return new ApplicationDispatcher(wrapper, encodedUri, wrapperPath, pathInfo,
+                queryString, mapping, null);
     }
 
 

==================================================
