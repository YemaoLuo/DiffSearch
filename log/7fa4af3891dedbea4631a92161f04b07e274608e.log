7fa4af3891dedbea4631a92161f04b07e274608e
==================================================
Simplify code that waits for threads to finish. This allows to shorten wait time if threads finish earlier.
==================================================
Konstantin Kolinko
==================================================
Sun Oct 26 12:31:59 2014 +0000
==================================================
TestCometProcessor.java
Simplify code that waits for threads to finish. This allows to shorten wait time if threads finish earlier.
A subtle difference is that Thread.join() is a synchronized method while Thread.isAlive() is not one.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1634312 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestCoyoteAdapter.java
index cc5ec81fc6..86ce56fa9a 100644
--- a/test/org/apache/catalina/comet/TestCometProcessor.java
+++ b/test/org/apache/catalina/comet/TestCometProcessor.java
@@ -392,19 +392,9 @@ public class TestCometProcessor extends TomcatBaseTest {
 
         tomcat.getConnector().stop();
 
-        int count = 0;
-        // Wait for the read thread to stop
-        while (readThread.isAlive() && count < 50) {
-            Thread.sleep(100);
-            count ++;
-        }
-
-        // Wait for the write thread to stop
-        count = 0;
-        while (writeThread.isAlive() && count < 50) {
-            Thread.sleep(100);
-            count ++;
-        }
+        // Wait for the read and write threads to stop
+        readThread.join(5000);
+        writeThread.join(5000);
 
         // Destroy the connector once the executor has sent the end event
         tomcat.getConnector().destroy();

==================================================
TestWebappClassLoaderMemoryLeak.java
index f603a17229..0a4775b852 100644
--- a/test/org/apache/catalina/connector/TestCoyoteAdapter.java
+++ b/test/org/apache/catalina/connector/TestCoyoteAdapter.java
@@ -317,12 +317,7 @@ public class TestCoyoteAdapter extends TomcatBaseTest {
         // Wait for server thread to stop
         Thread t = servlet.getThread();
         long startTime = System.nanoTime();
-        for (int count = 0; t.isAlive() && count < 20; count++) {
-            t.join(250);
-            if (!t.isAlive()) {
-                break;
-            }
-        }
+        t.join(5000);
         long endTime = System.nanoTime();
         log.info("Waited for servlet thread to stop for "
                 + (endTime - startTime) / 1000000 + " ms");

==================================================
TestClassLoaderLogManager.java
index e2253c71fe..aaae042eba 100644
--- a/test/org/apache/catalina/loader/TestWebappClassLoaderMemoryLeak.java
+++ b/test/org/apache/catalina/loader/TestWebappClassLoaderMemoryLeak.java
@@ -63,11 +63,7 @@ public class TestWebappClassLoaderMemoryLeak extends TomcatBaseTest {
         for (Thread thread : threads) {
             if (thread != null && thread.isAlive() &&
                     TaskServlet.TIMER_THREAD_NAME.equals(thread.getName())) {
-                int count = 0;
-                while (count < 50 && thread.isAlive()) {
-                    Thread.sleep(100);
-                    count++;
-                }
+                thread.join(5000);
                 if (thread.isAlive()) {
                     fail("Timer thread still running");
                 }

==================================================
