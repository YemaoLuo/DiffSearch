5a2118f90e2d8ee7ebc9f7453622e857c133961c
==================================================
Fix HTTP/2 tests broken by changes to small window update frames
==================================================
Mark Thomas
==================================================
Tue Jun 15 09:16:31 2021 +0100
==================================================
TestHttp2Limits.java
Fix HTTP/2 tests broken by changes to small window update frames


==================================================
TestHttp2Section_6_1.java
index 1be65cbfc4..bd7578c47a 100644
--- a/test/org/apache/coyote/http2/TestHttp2Limits.java
+++ b/test/org/apache/coyote/http2/TestHttp2Limits.java
@@ -476,6 +476,8 @@ public class TestHttp2Limits extends Http2TestBase {
         ((AbstractHttp11Protocol<?>) http2Protocol.getHttp11Protocol()).setAllowedTrailerHeaders(TRAILER_HEADER_NAME);
         http2Protocol.setMaxTrailerCount(maxTrailerCount);
         ((AbstractHttp11Protocol<?>) http2Protocol.getHttp11Protocol()).setMaxTrailerSize(maxTrailerSize);
+        // Disable overhead protection for window update as it breaks some tests
+        http2Protocol.setOverheadWindowUpdateThreshold(0);
 
         openClientConnection();
         doHttpUpgrade();

==================================================
TestHttp2Section_6_9.java
index 8e3d948b8e..27a622380f 100644
--- a/test/org/apache/coyote/http2/TestHttp2Section_6_1.java
+++ b/test/org/apache/coyote/http2/TestHttp2Section_6_1.java
@@ -35,6 +35,9 @@ public class TestHttp2Section_6_1 extends Http2TestBase {
     public void testDataFrame() throws Exception {
         http2Connect();
 
+        // Disable overhead protection for window update as it breaks the test
+        http2Protocol.setOverheadWindowUpdateThreshold(0);
+
         sendSimplePostRequest(3, null);
         readSimplePostResponse(false);
 
@@ -57,6 +60,10 @@ public class TestHttp2Section_6_1 extends Http2TestBase {
         try {
             http2Connect();
 
+            // Disable overhead protection for window update as it breaks the
+            // test
+            http2Protocol.setOverheadWindowUpdateThreshold(0);
+
             byte[] padding = new byte[8];
 
             sendSimplePostRequest(3, padding);
@@ -159,6 +166,9 @@ public class TestHttp2Section_6_1 extends Http2TestBase {
     public void testDataFrameWithZeroLengthPadding() throws Exception {
         http2Connect();
 
+        // Disable overhead protection for window update as it breaks the test
+        http2Protocol.setOverheadWindowUpdateThreshold(0);
+
         byte[] padding = new byte[0];
 
         sendSimplePostRequest(3, padding);

==================================================
TestHttp2Section_8_1.java
index 02d24ebf60..dd7722020e 100644
--- a/test/org/apache/coyote/http2/TestHttp2Section_6_9.java
+++ b/test/org/apache/coyote/http2/TestHttp2Section_6_9.java
@@ -152,6 +152,9 @@ public class TestHttp2Section_6_9 extends Http2TestBase {
     public void testWindowSizeAndSettingsFrame() throws Exception {
         http2Connect();
 
+        // Disable overhead protection for window update as it breaks the test
+        http2Protocol.setOverheadWindowUpdateThreshold(0);
+
         // Set up a POST request that echoes the body back
         byte[] headersFrameHeader = new byte[9];
         ByteBuffer headersPayload = ByteBuffer.allocate(128);

==================================================
