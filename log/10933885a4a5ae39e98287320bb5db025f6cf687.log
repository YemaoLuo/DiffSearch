10933885a4a5ae39e98287320bb5db025f6cf687
==================================================
- As redoing the encoders and decoders won't happen immediately, save some memory by cleaning the
==================================================
Remy Maucherat
==================================================
Tue Jun 27 13:48:36 2006 +0000
==================================================
CoyoteAdapter.java
- As redoing the encoders and decoders won't happen immediately, save some memory by cleaning the
  cache when starting a Comet request (which is supposed to last for a while).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@417457 13f79535-47bb-0310-9956-ffa450edef68



==================================================
InputBuffer.java
index 737f2e0eb8..6c9696b438 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -241,6 +241,11 @@ public class CoyoteAdapter
             if (!comet) {
                 request.recycle();
                 response.recycle();
+            } else {
+                // Clear converters so that the minimum amount of memory 
+                // is used by this processor
+                request.clearEncoders();
+                response.clearEncoders();
             }
         }
 

==================================================
OutputBuffer.java
index cbc3847929..b02c613743 100644
--- a/java/org/apache/catalina/connector/InputBuffer.java
+++ b/java/org/apache/catalina/connector/InputBuffer.java
@@ -236,6 +236,14 @@ public class InputBuffer extends Reader
     }
 
 
+    /**
+     * Clear cached encoders (to save memory for Comet requests).
+     */
+    public void clearEncoders() {
+        encoders.clear();
+    }
+    
+    
     /**
      * Close the input buffer.
      * 
@@ -494,5 +502,4 @@ public class InputBuffer extends Reader
 
     }
 
-
 }

==================================================
Request.java
index a18e4b30f9..18a1a33b8c 100644
--- a/java/org/apache/catalina/connector/OutputBuffer.java
+++ b/java/org/apache/catalina/connector/OutputBuffer.java
@@ -227,6 +227,14 @@ public class OutputBuffer extends Writer
     }
 
 
+    /**
+     * Clear cached encoders (to save memory for Comet requests).
+     */
+    public void clearEncoders() {
+        encoders.clear();
+    }
+    
+    
     /**
      * Close the output buffer. This tries to calculate the response size if 
      * the response has not been committed yet.

==================================================
Response.java
index d46e66e675..0066c5de26 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -357,8 +357,10 @@ public class Request
      */
     protected String localName = null;
 
+
     // --------------------------------------------------------- Public Methods
 
+
     /**
      * Release all object references, and initialize instance variables, in
      * preparation for reuse of this object.
@@ -425,6 +427,14 @@ public class Request
     }
 
 
+    /**
+     * Clear cached encoders (to save memory for Comet requests).
+     */
+    public void clearEncoders() {
+        inputBuffer.clearEncoders();
+    }
+    
+
     // -------------------------------------------------------- Request Methods
 
 

==================================================
