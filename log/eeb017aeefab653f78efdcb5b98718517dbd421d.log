eeb017aeefab653f78efdcb5b98718517dbd421d
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48421
==================================================
Mark Emlyn
==================================================
Tue Jan 12 19:06:48 2010 +0000
==================================================
ClassLoaderLogManager.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=48421
Clean up a web application's logs and handlers when it stops. This involved modifying the fix that prevented log messages being lost in shutdown.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@898468 13f79535-47bb-0310-9956-ffa450edef68



==================================================
LogFactory.java
index 32effe8b23..96ddf1725a 100644
--- a/java/org/apache/juli/ClassLoaderLogManager.java
+++ b/java/org/apache/juli/ClassLoaderLogManager.java
@@ -46,6 +46,46 @@ import java.util.logging.Logger;
  */
 public class ClassLoaderLogManager extends LogManager {
 
+    private final class Cleaner extends Thread {
+        
+        @Override
+        public void run() {
+            // The JVM us being shutdown. Make sure all loggers for all class
+            // loaders are shutdown
+            for (ClassLoaderLogInfo clLogInfo : classLoaderLoggers.values()) {
+                for (Logger logger : clLogInfo.loggers.values()) {
+                    resetLogger(logger);
+                }
+            }
+        }
+            
+        private void resetLogger(Logger logger) {
+            
+            Handler[] handlers = logger.getHandlers();
+            for (Handler handler : handlers) {
+                logger.removeHandler(handler);
+                try {
+                    handler.close();
+                } catch (Exception e) {
+                    // Ignore
+                }
+            }
+        }
+
+    }
+
+    
+    // ------------------------------------------------------------Constructors
+
+    public ClassLoaderLogManager() {
+        super();
+        try { 
+            Runtime.getRuntime().addShutdownHook(new Cleaner());
+        } catch (IllegalStateException ise) {
+            // We are probably already being shutdown. Ignore this error.
+        }
+    }
+
 
     // -------------------------------------------------------------- Variables
 
@@ -485,33 +525,6 @@ public class ClassLoaderLogManager extends LogManager {
     }
     
 
-    /**
-     * Need to override reset so the loggers loaded by the web applications can
-     * be shutdown.
-     */
-    @Override
-    public void reset() {
-        super.reset();
-        for (ClassLoaderLogInfo classLoaderLogInfo : classLoaderLoggers.values()) {
-            for (Logger logger : classLoaderLogInfo.loggers.values()) {
-                resetLogger(logger);
-            }
-        }
-    }
-    
-    private void resetLogger(Logger logger) {
-        
-        Handler[] handlers = logger.getHandlers();
-        for (Handler handler : handlers) {
-            logger.removeHandler(handler);
-            try {
-                handler.close();
-            } catch (Exception e) {
-                // Ignore
-            }
-        }
-    }
-
     // ---------------------------------------------------- LogNode Inner Class
 
 

==================================================
