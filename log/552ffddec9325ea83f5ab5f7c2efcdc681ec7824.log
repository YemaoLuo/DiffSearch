552ffddec9325ea83f5ab5f7c2efcdc681ec7824
==================================================
Fix remainder of https://issues.apache.org/bugzilla/show_bug.cgi?id=49181
==================================================
Mark Emlyn
==================================================
Wed May 12 10:24:00 2010 +0000
==================================================
ApplicationContext.java
Fix remainder of https://issues.apache.org/bugzilla/show_bug.cgi?id=49181
Add additional check to prevent adding Servlet context listeners once the calls to the Servlet Context listeners start

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@943432 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardContext.java
index 47b18b1e5d..d901b1a193 100644
--- a/java/org/apache/catalina/core/ApplicationContext.java
+++ b/java/org/apache/catalina/core/ApplicationContext.java
@@ -184,6 +184,13 @@ public class ApplicationContext
     private Set<SessionTrackingMode> defaultSessionTrackingModes = null;
     private Set<SessionTrackingMode> supportedSessionTrackingModes = null;
 
+    /**
+     * Flag that indicates if a new {@link ServletContextListener} may be added
+     * to the application. Once the first {@link ServletContextListener} is
+     * called, not more may be added.
+     */
+    private boolean newServletContextListenerAllowed = true;
+
     // --------------------------------------------------------- Public Methods
 
 
@@ -1275,8 +1282,8 @@ public class ApplicationContext
         }
         
         if (t instanceof HttpSessionListener
-                || t instanceof ServletContextListener) {
-            // TODO SERVLET3 - if ServletContextListener then also need to check caller? spec isn't clear
+                || (t instanceof ServletContextListener &&
+                        newServletContextListenerAllowed)) {
             context.addApplicationLifecycleListener(t);
             match = true;
         }
@@ -1471,6 +1478,10 @@ public class ApplicationContext
     }
 
 
+    protected void setNewServletContextListenerAllowed(boolean allowed) {
+        this.newServletContextListenerAllowed = allowed;
+    }
+    
     // -------------------------------------------------------- Private Methods
 
 

==================================================
