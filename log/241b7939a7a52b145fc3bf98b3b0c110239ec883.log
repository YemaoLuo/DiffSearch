241b7939a7a52b145fc3bf98b3b0c110239ec883
==================================================
Make the execution of the OpenSSL tests depend on the presence of an OpenSSL binary.
==================================================
Mark Emlyn
==================================================
Wed Jul 30 06:44:00 2014 +0000
==================================================
TestCipher.java
index 04c66a5915..e902a2b00f 100644
--- a/build.xml
+++ b/build.xml
@@ -1336,25 +1336,25 @@
   </target>
 
   <target name="test-bio" description="Runs the JUnit test cases for BIO. Does not stop on errors."
-          depends="test-compile,deploy,cobertura-instrument" if="${execute.test.bio}">
+          depends="test-compile,deploy,cobertura-instrument,test-openssl-exists" if="${execute.test.bio}">
     <runtests protocol="org.apache.coyote.http11.Http11Protocol"
               extension=".BIO" />
   </target>
 
   <target name="test-nio" description="Runs the JUnit test cases for NIO. Does not stop on errors."
-          depends="test-compile,deploy,cobertura-instrument" if="${execute.test.nio}">
+          depends="test-compile,deploy,cobertura-instrument,test-openssl-exists" if="${execute.test.nio}">
     <runtests protocol="org.apache.coyote.http11.Http11NioProtocol"
               extension=".NIO" />
   </target>
 
   <target name="test-nio2" description="Runs the JUnit test cases for NIO2. Does not stop on errors."
-          depends="test-compile,deploy,cobertura-instrument" if="${execute.test.nio2}">
+          depends="test-compile,deploy,cobertura-instrument,test-openssl-exists" if="${execute.test.nio2}">
     <runtests protocol="org.apache.coyote.http11.Http11Nio2Protocol"
               extension=".NIO2" />
   </target>
 
   <target name="test-apr" description="Runs the JUnit test cases for APR. Does not stop on errors."
-          depends="test-compile,deploy,test-apr-exists,cobertura-instrument"
+          depends="test-compile,deploy,test-apr-exists,cobertura-instrument,test-openssl-exists"
           if="${apr.exists}">
     <runtests protocol="org.apache.coyote.http11.Http11AprProtocol"
               extension=".APR" />
@@ -1365,6 +1365,24 @@
     <available file="${test.apr.loc}" property="apr.exists" />
   </target>
 
+  <target name="test-openssl-exists" description="Checks for the OpenSSL binary">
+    <property environment="env" />
+    <condition property="test.openssl.exists">
+      <or>
+        <and>
+          <isset property="test.openssl.path"/>
+          <available file="${test.openssl.path}" property="test.openssl.exists"/>
+        </and>
+        <and>
+          <not>
+            <isset property="test.openssl.path"/>
+          </not>
+          <available file="openssl" filepath="${env.PATH}" property="test.openssl.exists"/>
+        </and>
+      </or>
+    </condition>
+  </target>
+
   <macrodef name="runtests"
             description="Runs the unit tests using the specified connector.
               Does not stop on errors, but sets 'test.result.error' and 'test.result.failure' properties.">
@@ -1393,6 +1411,7 @@
         <sysproperty key="tomcat.test.protocol" value="@{protocol}" />
         <sysproperty key="tomcat.test.accesslog" value="${test.accesslog}" />
         <sysproperty key="tomcat.test.reports" value="${test.reports}" />
+        <sysproperty key="tomcat.test.openssl.path" value="${test.openssl.path}" />
         <!-- File for Cobertura to write coverage results to -->
         <sysproperty key="net.sourceforge.cobertura.datafile" file="${cobertura.datafile}" />
 
@@ -1415,6 +1434,8 @@
             <exclude name="**/Tester*.java" />
             <!-- Exclude the tests known to fail -->
             <exclude name="org/apache/catalina/tribes/test/**" />
+            <!-- Exclude the OpenSSL tests unless OpenSSL is available -->
+            <exclude name="org/apache/tomcat/util/net/jsse/openssl/**" unless="${test.openssl.exists}"/>
           </fileset>
         </batchtest>
       </junit>

==================================================
