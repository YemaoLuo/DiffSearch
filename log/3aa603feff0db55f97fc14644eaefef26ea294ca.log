3aa603feff0db55f97fc14644eaefef26ea294ca
==================================================
According to JavaEE specification (EE.5.4.1.3) when an env entry is specified in the web deployment descriptor and with annotation then the definition in the web deployment descriptor is with priority.
==================================================
Violeta Georgieva
==================================================
Tue Feb 4 20:18:35 2014 +0000
==================================================
WebRuleSet.java
According to JavaEE specification (EE.5.4.1.3) when an env entry is specified in the web deployment descriptor and with annotation then the definition in the web deployment descriptor is with priority.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1564461 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestContextConfig.java
index cc3f6a5c4c..e864ac7aba 100644
--- a/java/org/apache/tomcat/util/descriptor/web/WebRuleSet.java
+++ b/java/org/apache/tomcat/util/descriptor/web/WebRuleSet.java
@@ -526,6 +526,7 @@ public class WebRuleSet extends RuleSetBase {
         digester.addSetNext(fullPrefix + "/env-entry",
                             "addEnvEntry",
                             "org.apache.tomcat.util.descriptor.web.ContextEnvironment");
+        digester.addRule(fullPrefix + "/env-entry", new SetOverrideRule());
         digester.addCallMethod(fullPrefix + "/env-entry/description",
                                "setDescription", 0);
         digester.addCallMethod(fullPrefix + "/env-entry/env-entry-name",
@@ -1350,3 +1351,19 @@ final class LifecycleCallbackRule extends CallMethodRule {
         super.end(namespace, name);
     }
 }
+
+final class SetOverrideRule extends Rule {
+
+    public SetOverrideRule() {
+        // no-op
+    }
+
+    @Override
+    public void begin(String namespace, String name, Attributes attributes) throws Exception {
+        ContextEnvironment envEntry = (ContextEnvironment) digester.peek();
+        envEntry.setOverride(false);
+        if (digester.getLogger().isDebugEnabled()) {
+            digester.getLogger().debug(envEntry.getClass().getName() + ".setOverride(false)");
+        }
+    }
+}

==================================================
TesterServletWithAnnotations.java
index 215ad217b2..e1a8d9f9f3 100644
--- a/test/org/apache/catalina/startup/TestContextConfig.java
+++ b/test/org/apache/catalina/startup/TestContextConfig.java
@@ -143,7 +143,7 @@ public class TestContextConfig extends TomcatBaseTest {
         tomcat.start();
 
         assertPageContains("/test/testServlet",
-                "envEntry1: 1 envEntry2: 2 envEntry3: 33 envEntry4: 4");
+                "envEntry1: 1 envEntry2: 2 envEntry3: 33 envEntry4: 4 envEntry5: 55 envEntry6: 66");
     }
 
     @Test

==================================================
