6c3076613322857da9d6f000966841049be90588
==================================================
66031: Fix NPE when using a custom JspFactory
==================================================
remm remm@apache.org
==================================================
Mon Apr 25 18:01:36 2022 +0200
==================================================
JasperInitializer.java
66031: Fix NPE when using a custom JspFactory

Patch by Jean-Louis Monteiro.


==================================================
TestJasperInitializer.java
index f2f3700e67..c23d74e5ee 100644
--- a/java/org/apache/jasper/servlet/JasperInitializer.java
+++ b/java/org/apache/jasper/servlet/JasperInitializer.java
@@ -43,7 +43,6 @@ public class JasperInitializer implements ServletContainerInitializer {
     private static final String MSG = "org.apache.jasper.servlet.JasperInitializer";
     private final Log log = LogFactory.getLog(JasperInitializer.class); // must not be static
 
-    private static JspFactoryImpl defaultFactory;
     /**
      * Preload classes required at runtime by a JSP servlet so that
      * we don't get a defineClassInPackage security exception.
@@ -53,7 +52,6 @@ public class JasperInitializer implements ServletContainerInitializer {
         SecurityClassLoad.securityClassLoad(factory.getClass().getClassLoader());
         if (JspFactory.getDefaultFactory() == null) {
             JspFactory.setDefaultFactory(factory);
-            defaultFactory = factory;
         }
     }
 
@@ -105,7 +103,10 @@ public class JasperInitializer implements ServletContainerInitializer {
                 throw new ServletException(e);
             }
         }
-        defaultFactory.setPoolSize(poolSize);
+        JspFactory factory = JspFactory.getDefaultFactory();
+        if (factory instanceof JspFactoryImpl) {
+            ((JspFactoryImpl) factory).setPoolSize(poolSize);
+        }
 
     }
 

==================================================
