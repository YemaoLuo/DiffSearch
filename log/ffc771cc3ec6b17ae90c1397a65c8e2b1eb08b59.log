ffc771cc3ec6b17ae90c1397a65c8e2b1eb08b59
==================================================
58621: Add back the certificate chain attribute. Testing with the test keys, the chain includes the main cert as the first one, so in that case the "strip first" argument should be true.
==================================================
Remy Maucherat
==================================================
Fri Nov 20 14:07:10 2015 +0000
==================================================
AbstractHttp11Protocol.java
58621: Add back the certificate chain attribute. Testing with the test keys, the chain includes the main cert as the first one, so in that case the "strip first" argument should be true.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1715365 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AprEndpoint.java
index 535d91bc43..759939a12e 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Protocol.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Protocol.java
@@ -434,6 +434,10 @@ public abstract class AbstractHttp11Protocol<S> extends AbstractProtocol<S> {
         registerDefaultSSLHostConfig();
         defaultSSLHostConfig.setCertificateKeystoreFile(keystoreFile);
     }
+    public void setSSLCertificateChainFile(String certificateChainFile) {
+        registerDefaultSSLHostConfig();
+        defaultSSLHostConfig.setCertificateChainFile(certificateChainFile);
+    }
     public void setSSLCertificateFile(String certificateFile) {
         registerDefaultSSLHostConfig();
         defaultSSLHostConfig.setCertificateFile(certificateFile);

==================================================
SSLHostConfig.java
index e3dd9adb8f..710e9b3586 100644
--- a/java/org/apache/tomcat/util/net/AprEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AprEndpoint.java
@@ -488,6 +488,9 @@ public class AprEndpoint extends AbstractEndpoint<Long> implements SNICallBack {
                             SSLHostConfig.adjustRelativePath(certificate.getCertificateFile()),
                             SSLHostConfig.adjustRelativePath(certificate.getCertificateKeyFile()),
                             certificate.getCertificateKeyPassword(), idx++);
+                    // Set certificate chain file
+                    SSLContext.setCertificateChainFile(ctx,
+                            SSLHostConfig.adjustRelativePath(certificate.getCertificateChainFile()), false);
                 }
                 // Support Client Certificates
                 SSLContext.setCACertificate(ctx,

==================================================
SSLHostConfigCertificate.java
index b084c71113..8042d30b7c 100644
--- a/java/org/apache/tomcat/util/net/SSLHostConfig.java
+++ b/java/org/apache/tomcat/util/net/SSLHostConfig.java
@@ -525,6 +525,12 @@ public class SSLHostConfig {
     // TODO: These certificate setters can be removed once it is no longer
     // necessary to support the old configuration attributes (Tomcat 10?).
 
+    public void setCertificateChainFile(String certificateChainFile) {
+        registerDefaultCertificate();
+        defaultCertificate.setCertificateChainFile(certificateChainFile);
+    }
+
+
     public void setCertificateFile(String certificateFile) {
         registerDefaultCertificate();
         defaultCertificate.setCertificateFile(certificateFile);

==================================================
OpenSSLContext.java
index 438fc72c00..97815c2576 100644
--- a/java/org/apache/tomcat/util/net/SSLHostConfigCertificate.java
+++ b/java/org/apache/tomcat/util/net/SSLHostConfigCertificate.java
@@ -50,6 +50,7 @@ public class SSLHostConfigCertificate {
     private String certificateKeystoreType = DEFAULT_KEYSTORE_TYPE;
 
     // OpenSSL
+    private String certificateChainFile;
     private String certificateFile;
     private String certificateKeyFile;
 
@@ -155,6 +156,18 @@ public class SSLHostConfigCertificate {
 
     // OpenSSL
 
+    public void setCertificateChainFile(String certificateChainFile) {
+        sslHostConfig.setProperty(
+                "Certificate.certificateChainFile", SSLHostConfig.Type.OPENSSL);
+        this.certificateChainFile = certificateChainFile;
+    }
+
+
+    public String getCertificateChainFile() {
+        return certificateChainFile;
+    }
+
+
     public void setCertificateFile(String certificateFile) {
         sslHostConfig.setProperty(
                 "Certificate.certificateFile", SSLHostConfig.Type.OPENSSL);

==================================================
