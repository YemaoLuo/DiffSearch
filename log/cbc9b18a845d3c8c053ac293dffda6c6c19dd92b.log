cbc9b18a845d3c8c053ac293dffda6c6c19dd92b
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=60409
==================================================
Violeta Georgieva
==================================================
Tue Nov 29 08:34:19 2016 +0000
==================================================
NioEndpoint.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=60409
When unable to complete sendfile request, ensure the Processor will be added to the cache only once. Patch by markt.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1771853 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestSendFile.java
index 5833b5dd03..2266a213c0 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -888,7 +888,6 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel> {
                     // Setup the file channel
                     File f = new File(sd.fileName);
                     if (!f.exists()) {
-                        cancelledKey(sk);
                         return SendfileState.ERROR;
                     }
                     @SuppressWarnings("resource") // Closed when channel is closed
@@ -962,16 +961,12 @@ public class NioEndpoint extends AbstractJsseEndpoint<NioChannel> {
                 if (log.isDebugEnabled()) log.debug("Unable to complete sendfile request:", x);
                 if (!calledByProcessor && sc != null) {
                     close(sc, sk);
-                } else {
-                    cancelledKey(sk);
                 }
                 return SendfileState.ERROR;
             } catch (Throwable t) {
                 log.error("", t);
                 if (!calledByProcessor && sc != null) {
                     close(sc, sk);
-                } else {
-                    cancelledKey(sk);
                 }
                 return SendfileState.ERROR;
             }

==================================================
