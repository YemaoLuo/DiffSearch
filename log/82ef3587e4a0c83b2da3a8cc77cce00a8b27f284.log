82ef3587e4a0c83b2da3a8cc77cce00a8b27f284
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56042
==================================================
Mark Emlyn
==================================================
Thu Jan 23 22:43:27 2014 +0000
==================================================
ErrorReportValve.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56042
If a request in async mode has an error but has already been dispatched don't generate an error page in the ErrorReportValve so the dispatch target can handle it.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1560838 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestErrorReportValve.java
index b4b40d67fd..9969aee6d8 100644
--- a/java/org/apache/catalina/valves/ErrorReportValve.java
+++ b/java/org/apache/catalina/valves/ErrorReportValve.java
@@ -82,8 +82,8 @@ public class ErrorReportValve extends ValveBase {
         Throwable throwable =
                 (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);
 
-        if (request.isAsyncStarted() && response.getStatus() < 400 &&
-                throwable == null) {
+        if (request.isAsyncStarted() && ((response.getStatus() < 400 &&
+                throwable == null) || request.isAsyncDispatching())) {
             return;
         }
 

==================================================
