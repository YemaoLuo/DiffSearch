39b11dc314db8b78c0a9ac67eda5cb0179462eb2
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63210
==================================================
Mark Thomas
==================================================
Mon Mar 4 20:23:09 2019 +0000
==================================================
NamingContextListener.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63210

Ensure that the Apache Commons DBCP 2 based default connection pool is
correctly shutdown when it is no longer required. This ensures that a
non-daemon thread is not left running that will prevent Tomcat from
shutting down cleanly.


==================================================
ContextResource.java
index 7bd69cdc3b..5c124c882d 100644
--- a/java/org/apache/catalina/core/NamingContextListener.java
+++ b/java/org/apache/catalina/core/NamingContextListener.java
@@ -60,6 +60,7 @@ import org.apache.naming.ResourceLinkRef;
 import org.apache.naming.ResourceRef;
 import org.apache.naming.ServiceRef;
 import org.apache.naming.TransactionRef;
+import org.apache.naming.factory.Constants;
 import org.apache.naming.factory.ResourceLinkFactory;
 import org.apache.tomcat.util.descriptor.web.ContextEjb;
 import org.apache.tomcat.util.descriptor.web.ContextEnvironment;
@@ -1010,6 +1011,13 @@ public class NamingContextListener
         if (("javax.sql.DataSource".equals(ref.getClassName())  ||
             "javax.sql.XADataSource".equals(ref.getClassName())) &&
                 resource.getSingleton()) {
+            String factory = (String) resource.getProperty("factory");
+            if ((factory == null || factory.equals(Constants.DBCP_DATASOURCE_FACTORY)) &&
+                    !resource.getCloseMethodConfigured()) {
+                // Using Tomcat's built-in factory (DBCP2) and DBCP2 DataSources
+                // require an explicit close
+                resource.setCloseMethod("close");
+            }
             try {
                 ObjectName on = createObjectName(resource);
                 Object actualResource = envCtx.lookup(resource.getName());

==================================================
