43f2ef34c651728e074d7e6fdc9178abea3aad45
==================================================
JASPIC callback management moved to parent class
==================================================
Mark Thomas
==================================================
Fri Jul 3 20:00:56 2015 +0000
==================================================
BasicAuthModule.java
JASPIC callback management moved to parent class
Patch by fjodorver

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1689078 13f79535-47bb-0310-9956-ffa450edef68



==================================================
DigestAuthModule.java
index f044fdbbd0..f7b5f0fce4 100644
--- a/java/org/apache/catalina/authenticator/jaspic/provider/modules/BasicAuthModule.java
+++ b/java/org/apache/catalina/authenticator/jaspic/provider/modules/BasicAuthModule.java
@@ -29,8 +29,6 @@ import javax.security.auth.message.AuthException;
 import javax.security.auth.message.AuthStatus;
 import javax.security.auth.message.MessageInfo;
 import javax.security.auth.message.MessagePolicy;
-import javax.security.auth.message.callback.CallerPrincipalCallback;
-import javax.security.auth.message.callback.GroupPrincipalCallback;
 import javax.security.auth.message.callback.PasswordValidationCallback;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
@@ -91,14 +89,7 @@ public class BasicAuthModule extends TomcatAuthModule {
             if (!passwordCallback.getResult()) {
                 sendUnauthorizedError(response, realmName);
             }
-
-            GenericPrincipal principal = getPrincipal(passwordCallback);
-
-            CallerPrincipalCallback principalCallback = new CallerPrincipalCallback(clientSubject,
-                    principal);
-            GroupPrincipalCallback groupCallback = new GroupPrincipalCallback(clientSubject,
-                    principal.getRoles());
-            handler.handle(new Callback[] { principalCallback, groupCallback });
+            handlePrincipalCallbacks(clientSubject, getPrincipal(passwordCallback));
             return AuthStatus.SUCCESS;
 
         } catch (Exception e) {

==================================================
FormAuthModule.java
index 7d78db7d88..fb9c566fcc 100644
--- a/java/org/apache/catalina/authenticator/jaspic/provider/modules/DigestAuthModule.java
+++ b/java/org/apache/catalina/authenticator/jaspic/provider/modules/DigestAuthModule.java
@@ -25,15 +25,12 @@ import java.util.LinkedHashMap;
 import java.util.Map;
 
 import javax.security.auth.Subject;
-import javax.security.auth.callback.Callback;
 import javax.security.auth.callback.CallbackHandler;
 import javax.security.auth.callback.UnsupportedCallbackException;
 import javax.security.auth.message.AuthException;
 import javax.security.auth.message.AuthStatus;
 import javax.security.auth.message.MessageInfo;
 import javax.security.auth.message.MessagePolicy;
-import javax.security.auth.message.callback.CallerPrincipalCallback;
-import javax.security.auth.message.callback.GroupPrincipalCallback;
 import javax.servlet.http.HttpServletRequest;
 import javax.servlet.http.HttpServletResponse;
 
@@ -259,11 +256,7 @@ public class DigestAuthModule extends TomcatAuthModule {
         }
 
         try {
-            CallerPrincipalCallback principalCallback = new CallerPrincipalCallback(clientSubject,
-                    principal);
-            String[] roles = realm.getRoles(principal);
-            GroupPrincipalCallback groupCallback = new GroupPrincipalCallback(clientSubject, roles);
-            handler.handle(new Callback[] { principalCallback, groupCallback });
+            handlePrincipalCallbacks(clientSubject, principal);
         } catch (IOException | UnsupportedCallbackException e) {
             throw new AuthException(e.getMessage());
         }

==================================================
TomcatAuthModule.java
index f053c996ba..c714e30f0e 100644
--- a/java/org/apache/catalina/authenticator/jaspic/provider/modules/FormAuthModule.java
+++ b/java/org/apache/catalina/authenticator/jaspic/provider/modules/FormAuthModule.java
@@ -25,15 +25,12 @@ import java.util.Locale;
 import java.util.Map;
 
 import javax.security.auth.Subject;
-import javax.security.auth.callback.Callback;
 import javax.security.auth.callback.CallbackHandler;
 import javax.security.auth.callback.UnsupportedCallbackException;
 import javax.security.auth.message.AuthException;
 import javax.security.auth.message.AuthStatus;
 import javax.security.auth.message.MessageInfo;
 import javax.security.auth.message.MessagePolicy;
-import javax.security.auth.message.callback.CallerPrincipalCallback;
-import javax.security.auth.message.callback.GroupPrincipalCallback;
 import javax.security.auth.message.callback.PasswordValidationCallback;
 import javax.servlet.RequestDispatcher;
 import javax.servlet.http.Cookie;
@@ -312,16 +309,6 @@ public class FormAuthModule extends TomcatAuthModule {
     }
 
 
-    private void handlePrincipalCallbacks(Subject clientSubject, Principal principal)
-            throws IOException, UnsupportedCallbackException {
-        CallerPrincipalCallback principalCallback = new CallerPrincipalCallback(clientSubject,
-                principal);
-        GroupPrincipalCallback groupCallback = new GroupPrincipalCallback(clientSubject, context
-                .getRealm().getRoles(principal));
-        handler.handle(new Callback[] { principalCallback, groupCallback });
-    }
-
-
     @Override
     public AuthStatus secureResponse(MessageInfo messageInfo, Subject serviceSubject)
             throws AuthException {

==================================================
