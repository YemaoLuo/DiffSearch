2d30290b42f67395ae655fbf66da7628cd6c6fb0
==================================================
Further fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=51197
==================================================
Mark Emlyn
==================================================
Mon Mar 5 12:05:25 2012 +0000
==================================================
ErrorReportValve.java
Further fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=51197
Allow the ErrorReportValve to write a response body if sendError() is
called during an async request if it is being handled on a container
thread. As per SRV 10.9.2, if an error occurs during an async request on
an application thread, writing the response body - if any - is entirely
an application responsibility.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1297017 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index 17a68d1748..e330152d6f 100644
--- a/java/org/apache/catalina/valves/ErrorReportValve.java
+++ b/java/org/apache/catalina/valves/ErrorReportValve.java
@@ -77,13 +77,14 @@ public class ErrorReportValve extends ValveBase {
             return;
         }
 
-        if (request.isAsyncStarted()) {
+        Throwable throwable =
+                (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);
+
+        if (request.isAsyncStarted() && response.getStatus() < 400 &&
+                throwable == null) {
             return;
         }
 
-        Throwable throwable =
-            (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);
-
         if (throwable != null) {
 
             // The response is an error
@@ -109,6 +110,9 @@ public class ErrorReportValve extends ValveBase {
             ExceptionUtils.handleThrowable(tt);
         }
 
+        if (request.isAsyncStarted()) {
+            request.getAsyncContext().complete();
+        }
     }
 
 

==================================================
