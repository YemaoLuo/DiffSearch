59d02008c33e0fa5cedd0182db2a98989e8754dc
==================================================
- Fix capacity check algorithm (overflow isn't the right result in that case).
==================================================
Remy Maucherat
==================================================
Mon Oct 26 15:10:53 2015 +0000
==================================================
SecureNio2Channel.java
- Fix capacity check algorithm (overflow isn't the right result in that case).
- Unwrap first in NIO2 and wait for an explicit underflow to read on the socket (I'll test adding a flag to optimize this since this is likely a bit expensive, but commit it for now since everything's now working).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1710618 13f79535-47bb-0310-9956-ffa450edef68



==================================================
OpenSSLEngine.java
index 7161a45572..2a9eb844bc 100644
--- a/java/org/apache/tomcat/util/net/SecureNio2Channel.java
+++ b/java/org/apache/tomcat/util/net/SecureNio2Channel.java
@@ -572,14 +572,9 @@ public class SecureNio2Channel extends Nio2Channel  {
 
     private class FutureRead implements Future<Integer> {
         private final ByteBuffer dst;
-        private final Future<Integer> integer;
+        private final Future<Integer> integer = null;
         private FutureRead(ByteBuffer dst) {
             this.dst = dst;
-            if (netInBuffer.position() > 0) {
-                this.integer = null;
-            } else {
-                this.integer = sc.read(netInBuffer);
-            }
         }
         @Override
         public boolean cancel(boolean mayInterruptIfRunning) {
@@ -837,11 +832,7 @@ public class SecureNio2Channel extends Nio2Channel  {
                 handler.failed(exc, attach);
             }
         };
-        if (netInBuffer.position() > 0) {
-            readCompletionHandler.completed(Integer.valueOf(netInBuffer.position()), attachment);
-        } else {
-            sc.read(netInBuffer, timeout, unit, attachment, readCompletionHandler);
-        }
+        readCompletionHandler.completed(Integer.valueOf(netInBuffer.position()), attachment);
     }
 
     @Override

==================================================
