9496e5270a8b0a96851855c69ed4183f7b5f37b6
==================================================
Since comet event can be closed async, for example after we have exited the CoyoteAdapter.service method, but before the HTTP processor, the processor will recycle on its end, but the catalina request/response will never be recycled and cause invalid data.
==================================================
Filip Hanik
==================================================
Fri Aug 31 21:42:31 2007 +0000
==================================================
CoyoteAdapter.java
Since comet event can be closed async, for example after we have exited the CoyoteAdapter.service method, but before the HTTP processor, the processor will recycle on its end, but the catalina request/response will never be recycled and cause invalid data.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@571602 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Request.java
index 268302e510..458b891304 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -265,7 +265,7 @@ public class CoyoteAdapter
 
         Request request = (Request) req.getNote(ADAPTER_NOTES);
         Response response = (Response) res.getNote(ADAPTER_NOTES);
-
+        
         if (request == null) {
 
             // Create objects
@@ -286,8 +286,14 @@ public class CoyoteAdapter
             req.getParameters().setQueryStringEncoding
                 (connector.getURIEncoding());
 
+        } else if (request.wasComet()) {
+            //if we enter here, means that the
+            //request response was not recycled
+            //do to an async close of the CometEvent
+            request.recycle();
+            response.recycle();
         }
-
+        
         if (connector.getXpoweredBy()) {
             response.addHeader("X-Powered-By", "Servlet/2.5");
         }

==================================================
