5d70642f972dba5adc65a87628876fe29405e8a2
==================================================
String unescaping modifies the buffer used for the cookie, and will corrupt the original cookie header
==================================================
Remy Maucherat
==================================================
Thu Feb 21 15:22:42 2013 +0000
==================================================
CookieSupport.java
String unescaping modifies the buffer used for the cookie, and will corrupt the original cookie header
[visible when displaying them using getHeader]. Experiment with an option to preserve them. I don't think
this should be the default, as it is almost never useful, and can be a bit wasteful.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1448679 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Cookies.java
index 453302ab41..173cd1cda0 100644
--- a/java/org/apache/tomcat/util/http/CookieSupport.java
+++ b/java/org/apache/tomcat/util/http/CookieSupport.java
@@ -62,6 +62,12 @@ public final class CookieSupport {
      */
     public static final boolean ALLOW_NAME_ONLY;
 
+    /**
+     * If set to true, the cookie header will be preserved. In most cases 
+     * except debugging, this is not useful.
+     */
+    public static final boolean PRESERVE_COOKIE_HEADER;
+
     /**
      * The list of separators that apply to version 0 cookies. To quote the
      * spec, these are comma, semi-colon and white-space. The HTTP spec
@@ -100,6 +106,15 @@ public final class CookieSupport {
                 Boolean.valueOf(alwaysAddExpires).booleanValue();
         }
 
+        String preserveCookieHeader = System.getProperty(
+                "org.apache.tomcat.util.http.ServerCookie.PRESERVE_COOKIE_HEADER");
+        if (preserveCookieHeader == null) {
+            PRESERVE_COOKIE_HEADER = STRICT_SERVLET_COMPLIANCE;
+        } else {
+            PRESERVE_COOKIE_HEADER =
+                Boolean.valueOf(preserveCookieHeader).booleanValue();
+        }
+
         String  fwdSlashIsSeparator = System.getProperty(
                 "org.apache.tomcat.util.http.ServerCookie.FWD_SLASH_IS_SEPARATOR");
         if (fwdSlashIsSeparator == null) {

==================================================
