b00e0f7ff3c8d53edf6c2fc0150751f27978039e
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56199
==================================================
Mark Emlyn
==================================================
Wed Mar 5 21:01:50 2014 +0000
==================================================
Constants.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=56199
Restore validateXml option to JspC

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1574657 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JspC.java
index d802201459..22338e89f6 100644
--- a/java/org/apache/jasper/Constants.java
+++ b/java/org/apache/jasper/Constants.java
@@ -161,6 +161,16 @@ public class Constants {
     public static final String XML_VALIDATION_TLD_INIT_PARAM =
             "org.apache.jasper.XML_VALIDATE_TLD";
 
+    /**
+     * Name of the ServletContext init-param that determines if the XML parser
+     * used for web.xml files will be validating or not. Note that this is only
+     * used when using JspC. In normal operation, Jasper obtains the JspConfig
+     * information directly from the ServletContext and therefore does not need
+     * to parse web.xml.
+     */
+    public static final String XML_VALIDATION_INIT_PARAM =
+            "org.apache.jasper.XML_VALIDATE";
+
     /**
      * Name of the ServletContext init-param that determines if the XML parsers
      * will block the resolution of external entities.

==================================================
JspCServletContext.java
index bf2ea8b839..92c454bc6c 100644
--- a/java/org/apache/jasper/JspC.java
+++ b/java/org/apache/jasper/JspC.java
@@ -134,6 +134,7 @@ public class JspC extends Task implements Options {
     protected static final String SWITCH_SMAP = "-smap";
     protected static final String SWITCH_DUMP_SMAP = "-dumpsmap";
     protected static final String SWITCH_VALIDATE_TLD = "-validateTld";
+    protected static final String SWITCH_VALIDATE_XML = "-validateXml";
     protected static final String SWITCH_BLOCK_EXTERNAL = "-blockExternal";
     protected static final String SWITCH_NO_BLOCK_EXTERNAL = "-no-blockExternal";
     protected static final String SHOW_SUCCESS ="-s";
@@ -167,6 +168,7 @@ public class JspC extends Task implements Options {
     protected boolean trimSpaces = false;
     protected boolean genStringAsCharArray = false;
     protected boolean validateTld;
+    protected boolean validateXml;
     protected boolean blockExternal = true;
     protected boolean xpoweredBy;
     protected boolean mappedFile = false;
@@ -376,6 +378,8 @@ public class JspC extends Task implements Options {
                 smapDumped = true;
             } else if (tok.equals(SWITCH_VALIDATE_TLD)) {
                 setValidateTld(true);
+            } else if (tok.equals(SWITCH_VALIDATE_XML)) {
+                setValidateXml(true);
             } else if (tok.equals(SWITCH_BLOCK_EXTERNAL)) {
                 setBlockExternal(true);
             } else if (tok.equals(SWITCH_NO_BLOCK_EXTERNAL)) {
@@ -867,6 +871,14 @@ public class JspC extends Task implements Options {
         return validateTld;
     }
 
+    public void setValidateXml( boolean b ) {
+        this.validateXml = b;
+    }
+
+    public boolean isValidateXml() {
+        return validateXml;
+    }
+
     public void setBlockExternal( boolean b ) {
         this.blockExternal = b;
     }
@@ -1455,9 +1467,14 @@ public class JspC extends Task implements Options {
         if (isValidateTld()) {
             context.setInitParameter(Constants.XML_VALIDATION_TLD_INIT_PARAM, "true");
         }
+        if (isValidateXml()) {
+            context.setInitParameter(Constants.XML_VALIDATION_INIT_PARAM, "true");
+        }
         context.setInitParameter(Constants.XML_BLOCK_EXTERNAL_INIT_PARAM,
                 String.valueOf(isBlockExternal()));
 
+        context.processWebXml();
+
         TldScanner scanner = new TldScanner(
                 context, true, isValidateTld(), isBlockExternal());
         scanner.setClassLoader(classLoader);

==================================================
