f4970a728c6516b6801c7efdf62e91437379f4be
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55842
==================================================
Mark Emlyn
==================================================
Fri Dec 6 12:12:15 2013 +0000
==================================================
OutputBuffer.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55842
Check if the output buffer can grow before flushing it when using a writer.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1548498 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ByteChunk.java
index 0e72d322c7..048bff3d56 100644
--- a/java/org/apache/catalina/connector/OutputBuffer.java
+++ b/java/org/apache/catalina/connector/OutputBuffer.java
@@ -467,7 +467,12 @@ public class OutputBuffer extends Writer
                 break;
             }
             if (outputCharChunk.getLength() > 0) {
-                bb.flushBuffer();
+                if (bb.getBuffer().length == bb.getEnd() && bb.getLength() < bb.getLimit()) {
+                    // Need to expand output buffer
+                    bb.makeSpace(outputCharChunk.getLength());
+                } else {
+                    bb.flushBuffer();
+                }
             }
         }
 

==================================================
