85e0a1875c08d40945fe4aeda6da0a3401328567
==================================================
Ensure the overhead check runs after every frame
==================================================
Mark Thomas
==================================================
Tue Sep 8 22:29:07 2020 +0100
==================================================
Http2UpgradeHandler.java
Ensure the overhead check runs after every frame



==================================================
TestHttp2Limits.java
index 99792dc98c..b4b6fdae51 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -340,11 +340,12 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
                             } else {
                                 stream.close(se);
                             }
-                        }
-                        if (overheadCount.get() > 0) {
-                            throw new ConnectionException(
-                                    sm.getString("upgradeHandler.tooMuchOverhead", connectionId),
-                                    Http2Error.ENHANCE_YOUR_CALM);
+                        } finally {
+                            if (overheadCount.get() > 0) {
+                                throw new ConnectionException(
+                                        sm.getString("upgradeHandler.tooMuchOverhead", connectionId),
+                                        Http2Error.ENHANCE_YOUR_CALM);
+                            }
                         }
                     }
 

==================================================
