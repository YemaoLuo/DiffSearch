92904878edb804b3fc1a35ddf6b674e99307bf7e
==================================================
Add final zero padding test
==================================================
Mark Emlyn
==================================================
Mon Mar 4 00:56:09 2013 +0000
==================================================
Utf8Decoder.java
Add final zero padding test
Associated fix to my tweaks to Harmony's decoder

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1452162 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestUtf8Extended.java
index 66708cc9c0..44bdd25939 100644
--- a/java/org/apache/tomcat/util/buf/Utf8Decoder.java
+++ b/java/org/apache/tomcat/util/buf/Utf8Decoder.java
@@ -188,11 +188,11 @@ public class Utf8Decoder extends CharsetDecoder {
                         }
                     }
                     if (jchar == 0x70 && inIndexLimit > inIndex + 1) {
-                        if ((bArr[inIndex + 1] & 0x7F) < 0x10) {
+                        if ((bArr[inIndex + 1] & 0x70) == 0) {
                             // 11110000 1000zzzz 1oyyyyyy 1oxxxxxx
                             // should have been
                             // 111ozzzz 1oyyyyyy 1oxxxxxx
-                            return CoderResult.malformedForLength(4);
+                            return CoderResult.malformedForLength(1);
                         }
                     }
                     break;

==================================================
