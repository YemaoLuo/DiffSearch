ccc04a08b90a25c4bcd11c77d7150557e42c16ee
==================================================
Do not flip the buffer let the caller to flip it.
==================================================
Violeta Georgieva
==================================================
Sat Sep 10 18:28:37 2016 +0000
==================================================
AprEndpoint.java
Do not flip the buffer let the caller to flip it.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1760200 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Nio2Endpoint.java
index fa9ccf58c4..4095232794 100644
--- a/java/org/apache/tomcat/util/net/AprEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AprEndpoint.java
@@ -2310,7 +2310,6 @@ public class AprEndpoint extends AbstractEndpoint<Long> implements SNICallBack {
         public int read(boolean block, ByteBuffer to) throws IOException {
             int nRead = populateReadBuffer(to);
             if (nRead > 0) {
-                to.flip();
                 return nRead;
                 /*
                  * Since more bytes may have arrived since the buffer was last
@@ -2326,7 +2325,6 @@ public class AprEndpoint extends AbstractEndpoint<Long> implements SNICallBack {
             if (to.isDirect() && to.remaining() >= limit) {
                 to.limit(to.position() + limit);
                 nRead = fillReadBuffer(block, to);
-                to.flip();
             } else {
                 // Fill the read buffer as best we can.
                 nRead = fillReadBuffer(block);
@@ -2335,7 +2333,6 @@ public class AprEndpoint extends AbstractEndpoint<Long> implements SNICallBack {
                 // data that was just read
                 if (nRead > 0) {
                     nRead = populateReadBuffer(to);
-                    to.flip();
                 }
             }
             return nRead;

==================================================
NioEndpoint.java
index 75e1fc73e4..22abb57cc4 100644
--- a/java/org/apache/tomcat/util/net/Nio2Endpoint.java
+++ b/java/org/apache/tomcat/util/net/Nio2Endpoint.java
@@ -899,7 +899,6 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel> {
                 // don't want to trigger another read since if there is no
                 // more data to read and this request takes a while to
                 // process the read will timeout triggering an error.
-                to.flip();
                 readPending.release();
                 return nRead;
             }
@@ -910,7 +909,6 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel> {
                 if (block && to.remaining() >= limit) {
                     to.limit(to.position() + limit);
                     nRead = fillReadBuffer(block, to);
-                    to.flip();
                 } else {
                     // Fill the read buffer as best we can.
                     nRead = fillReadBuffer(block);
@@ -919,7 +917,6 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel> {
                     // data that was just read
                     if (nRead > 0) {
                         nRead = populateReadBuffer(to);
-                        to.flip();
                     } else if (nRead == 0 && !block) {
                         readInterest = true;
                     }

==================================================
