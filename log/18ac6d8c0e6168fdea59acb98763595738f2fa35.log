18ac6d8c0e6168fdea59acb98763595738f2fa35
==================================================
Readd blocking (for now) and fix loop indexes (ooops).
==================================================
Remy Maucherat
==================================================
Thu Mar 9 11:19:55 2017 +0000
==================================================
Nio2Endpoint.java
Readd blocking (for now) and fix loop indexes (ooops).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1786137 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SocketWrapperBase.java
index 2d6dfac6c7..5b4a2b7e9c 100644
--- a/java/org/apache/tomcat/util/net/Nio2Endpoint.java
+++ b/java/org/apache/tomcat/util/net/Nio2Endpoint.java
@@ -1031,6 +1031,12 @@ public class Nio2Endpoint extends AbstractJsseEndpoint<Nio2Channel,AsynchronousS
             Nio2Endpoint.startInline();
             getSocket().write(srcs, offset, length, timeout, unit, state, new GatherWriteCompletionHandler<>());
             Nio2Endpoint.endInline();
+            if (block && state.state == CompletionState.PENDING) {
+                if (!awaitWriteComplete(timeout, unit)) {
+                    handler.failed(new SocketTimeoutException(), attachment);
+                    return CompletionState.ERROR;
+                }
+            }
             return state.state;
         }
 

==================================================
