136e721c4d07448664e653f78d3cf17a12350c84
==================================================
Add a simple unit test for async writes.
==================================================
Mark Emlyn
==================================================
Tue Apr 30 14:13:28 2013 +0000
==================================================
Http11NioProcessor.java
Add a simple unit test for async writes.
This (unexpectedly) passes on all three connectors.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1477644 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestCoyoteOutputStream.java
index 50c2d2ed2a..8cb4f2d75e 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -615,15 +615,10 @@ public class Http11NioProcessor extends AbstractHttp11Processor<NioChannel> {
                 return;
             }
             AtomicBoolean canWrite = (AtomicBoolean)param;
-            RequestInfo rp = request.getRequestProcessor();
-            if (rp.getStage() == org.apache.coyote.Constants.STAGE_SERVICE) {
-                if (outputBuffer.isWritable()) {
-                    canWrite.set(true);
-                } else {
-                    canWrite.set(false);
-                }
+            if (outputBuffer.isWritable()) {
+                canWrite.set(true);
             } else {
-                throw new IllegalStateException("Calling canWrite asynchronously is illegal.");
+                canWrite.set(false);
             }
         }
     }

==================================================
