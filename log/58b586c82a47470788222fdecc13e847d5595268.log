58b586c82a47470788222fdecc13e847d5595268
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58545
==================================================
Violeta Georgieva
==================================================
Mon Oct 26 15:41:58 2015 +0000
==================================================
ApplicationHttpRequest.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58545
Use entrySet() instead of keySet() when one need to obtain the value for a corresponding key. Based on a patch provided by Anthony Whitford.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1710632 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardContext.java
index 53aca1aba9..a36b036328 100644
--- a/java/org/apache/catalina/core/ApplicationHttpRequest.java
+++ b/java/org/apache/catalina/core/ApplicationHttpRequest.java
@@ -24,8 +24,8 @@ import java.util.ArrayList;
 import java.util.Collections;
 import java.util.Enumeration;
 import java.util.HashMap;
-import java.util.Iterator;
 import java.util.Map;
+import java.util.Map.Entry;
 import java.util.NoSuchElementException;
 
 import javax.servlet.DispatcherType;
@@ -887,16 +887,16 @@ class ApplicationHttpRequest extends HttpServletRequestWrapper {
             encoding = "ISO-8859-1";
         RequestUtil.parseParameters(queryParameters, queryParamString,
                 encoding);
-        Iterator<String> keys = parameters.keySet().iterator();
-        while (keys.hasNext()) {
-            String key = keys.next();
-            Object value = queryParameters.get(key);
+        for (Entry<String, String[]> entry : parameters.entrySet()) {
+            String entryKey = entry.getKey();
+            String[] entryValue = entry.getValue();
+            Object value = queryParameters.get(entryKey);
             if (value == null) {
-                queryParameters.put(key, parameters.get(key));
+                queryParameters.put(entryKey, entryValue);
                 continue;
             }
             queryParameters.put
-                (key, mergeValues(value, parameters.get(key)));
+                (entryKey, mergeValues(value, entryValue));
         }
         parameters = queryParameters;
 

==================================================
JNDIRealm.java
index c322a4338c..bdab298ab3 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -4606,12 +4606,10 @@ public class StandardContext extends ContainerBase
 
         // Release all Filter and FilterConfig instances
         synchronized (filterConfigs) {
-            Iterator<String> names = filterConfigs.keySet().iterator();
-            while (names.hasNext()) {
-                String name = names.next();
+            for (Entry<String, ApplicationFilterConfig> entry : filterConfigs.entrySet()) {
                 if (getLogger().isDebugEnabled())
-                    getLogger().debug(" Stopping filter '" + name + "'");
-                ApplicationFilterConfig filterConfig = filterConfigs.get(name);
+                    getLogger().debug(" Stopping filter '" + entry.getKey() + "'");
+                ApplicationFilterConfig filterConfig = entry.getValue();
                 filterConfig.release();
             }
             filterConfigs.clear();

==================================================
TagFileProcessor.java
index 3335c87c33..ac82841ce1 100644
--- a/java/org/apache/catalina/realm/JNDIRealm.java
+++ b/java/org/apache/catalina/realm/JNDIRealm.java
@@ -1999,11 +1999,11 @@ public class JNDIRealm extends RealmBase {
                 throw ex;
         }
 
-        Set<String> keys = groupMap.keySet();
         if (containerLog.isTraceEnabled()) {
-            containerLog.trace("  Found " + keys.size() + " direct roles");
-            for (String key: keys) {
-                containerLog.trace(  "  Found direct role " + key + " -> " + groupMap.get(key));
+            Set<Entry<String, String>> entries = groupMap.entrySet();
+            containerLog.trace("  Found " + entries.size() + " direct roles");
+            for (Entry<String, String> entry : entries) {
+                containerLog.trace(  "  Found direct role " + entry.getKey() + " -> " + entry.getValue());
             }
         }
 

==================================================
WsHandshakeRequest.java
index 66212a814f..e2eb678cf9 100644
--- a/java/org/apache/jasper/compiler/TagFileProcessor.java
+++ b/java/org/apache/jasper/compiler/TagFileProcessor.java
@@ -442,15 +442,14 @@ class TagFileProcessor {
          */
         void postCheck() throws JasperException {
             // Check that var.name-from-attributes has valid values.
-            Iterator<String> iter = nameFromTable.keySet().iterator();
-            while (iter.hasNext()) {
-                String nameFrom = iter.next();
-                NameEntry nameEntry = nameTable.get(nameFrom);
-                NameEntry nameFromEntry = nameFromTable.get(nameFrom);
+            for (Entry<String, NameEntry> entry : nameFromTable.entrySet()) {
+                String key = entry.getKey();
+                NameEntry nameEntry = nameTable.get(key);
+                NameEntry nameFromEntry = entry.getValue();
                 Node nameFromNode = nameFromEntry.getNode();
                 if (nameEntry == null) {
                     err.jspError(nameFromNode,
-                            "jsp.error.tagfile.nameFrom.noAttribute", nameFrom);
+                            "jsp.error.tagfile.nameFrom.noAttribute", key);
                 } else {
                     Node node = nameEntry.getNode();
                     TagAttributeInfo tagAttr = nameEntry.getTagAttributeInfo();
@@ -459,7 +458,7 @@ class TagFileProcessor {
                             || tagAttr.canBeRequestTime()) {
                         err.jspError(nameFromNode,
                                 "jsp.error.tagfile.nameFrom.badAttribute",
-                                nameFrom, Integer.toString(node.getStart()
+                                key, Integer.toString(node.getStart()
                                         .getLineNumber()));
                     }
                 }

==================================================
