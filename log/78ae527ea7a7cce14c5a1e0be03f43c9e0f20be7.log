78ae527ea7a7cce14c5a1e0be03f43c9e0f20be7
==================================================
Add some tests. Fix a bug and handle an edge case.
==================================================
Mark Emlyn
==================================================
Thu Sep 25 19:32:45 2014 +0000
==================================================
CredentialHandlerBase.java
Add some tests. Fix a bug and handle an edge case.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1627602 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestMessageDigestCredentialHandler.java
index 8b79353588..ba52bc1487 100644
--- a/java/org/apache/catalina/realm/CredentialHandlerBase.java
+++ b/java/org/apache/catalina/realm/CredentialHandlerBase.java
@@ -45,7 +45,9 @@ public abstract class CredentialHandlerBase implements CredentialHandler {
     public String generate(int saltLength, String userCredential) {
         byte[] salt = null;
         int iterations = getIterations();
-        if (saltLength > 0) {
+        if (saltLength == 0) {
+            salt = new byte[0];
+        } else if (saltLength > 0) {
             if (random == null) {
                 random = new SecureRandom();
             }
@@ -62,7 +64,7 @@ public abstract class CredentialHandlerBase implements CredentialHandler {
     protected boolean matchesSaltIterationsEncoded(String inputCredentials, String storedCredentials) {
 
         int sep1 = storedCredentials.indexOf('$');
-        int sep2 = storedCredentials.indexOf('$', sep1);
+        int sep2 = storedCredentials.indexOf('$', sep1 + 1);
 
         String hexSalt = storedCredentials.substring(0,  sep1);
 

==================================================
