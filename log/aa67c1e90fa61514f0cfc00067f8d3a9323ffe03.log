aa67c1e90fa61514f0cfc00067f8d3a9323ffe03
==================================================
Some more ServerFactory removal.
==================================================
Mark Emlyn
==================================================
Sun May 24 18:39:52 2009 +0000
==================================================
MBeanFactory.java
Some more ServerFactory removal.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@778207 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ServerLifecycleListener.java
index 9113279f00..b4f90c4ca9 100644
--- a/java/org/apache/catalina/mbeans/MBeanFactory.java
+++ b/java/org/apache/catalina/mbeans/MBeanFactory.java
@@ -97,11 +97,20 @@ public class MBeanFactory extends BaseModelMBean {
 
     // ------------------------------------------------------------- Attributes
 
-
+    /**
+     * The container (Server/Service) for which this factory was created.
+     */
+    private Object container;
 
 
     // ------------------------------------------------------------- Operations
 
+    /**
+     * Set the container that this factory was created for.
+     */
+    public void setContainer(Object container) {
+        this.container = container;
+    }
 
     /**
      * Return the managed bean definition for the specified bean type
@@ -202,17 +211,25 @@ public class MBeanFactory extends BaseModelMBean {
     
     private Service getService(ObjectName oname) throws Exception {
     
-        String domain = oname.getDomain();
-        Server server = ServerFactory.getServer();
-        Service[] services = server.findServices();
+        if (container instanceof Service) {
+            // Don't bother checking the domain - this is the only option
+            return (Service) container;
+        }
+
         StandardService service = null;
-        for (int i = 0; i < services.length; i++) {
-            service = (StandardService) services[i];
-            if (domain.equals(service.getObjectName().getDomain())) {
-                break;
+        String domain = oname.getDomain();
+        if (container instanceof Service) {
+            Server server = ServerFactory.getServer();
+            Service[] services = server.findServices();
+            for (int i = 0; i < services.length; i++) {
+                service = (StandardService) services[i];
+                if (domain.equals(service.getObjectName().getDomain())) {
+                    break;
+                }
             }
         }
-        if (!service.getObjectName().getDomain().equals(domain)) {
+        if (service == null ||
+                !service.getObjectName().getDomain().equals(domain)) {
             throw new Exception("Service with the domain is not found");
         }        
         return service;

==================================================
