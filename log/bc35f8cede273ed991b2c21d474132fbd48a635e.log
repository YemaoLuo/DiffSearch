bc35f8cede273ed991b2c21d474132fbd48a635e
==================================================
More clearly differentiate between resetting the stream and just sending the reset frame. Ensure that the correct approach is taken. This reduces the instance of NPEs when running unit tests as reported by rjung.
==================================================
Mark Thomas
==================================================
Mon May 23 11:31:05 2016 +0000
==================================================
Http2UpgradeHandler.java
More clearly differentiate between resetting the stream and just sending the reset frame. Ensure that the correct approach is taken. This reduces the instance of NPEs when running unit tests as reported by rjung.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1745145 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Stream.java
index 99bed99841..ce22357d34 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -293,7 +293,12 @@ public class Http2UpgradeHandler extends AbstractStream implements InternalHttpU
                         } catch (StreamException se) {
                             // Stream errors are not fatal to the connection so
                             // continue reading frames
-                            resetStream(se);
+                            Stream stream = getStream(se.getStreamId(), false);
+                            if (stream == null) {
+                                sendStreamReset(se);
+                            } else {
+                                stream.close(se);
+                            }
                         }
                     }
                     // No more frames to read so switch to the keep-alive
@@ -384,7 +389,7 @@ public class Http2UpgradeHandler extends AbstractStream implements InternalHttpU
     }
 
 
-    void resetStream(StreamException se) throws IOException {
+    void sendStreamReset(StreamException se) throws IOException {
 
         if (log.isDebugEnabled()) {
             log.debug(sm.getString("upgradeHandler.rst.debug", connectionId,
@@ -1234,17 +1239,11 @@ public class Http2UpgradeHandler extends AbstractStream implements InternalHttpU
                 try {
                     stream.incrementWindowSize(diff);
                 } catch (Http2Exception h2e) {
-                    try {
-                        resetStream(new StreamException(sm.getString(
-                                "upgradeHandler.windowSizeTooBig", connectionId,
-                                stream.getIdentifier()),
-                                h2e.getError(), stream.getIdentifier().intValue()));
-                    } catch (IOException ioe) {
-                        if (log.isDebugEnabled()) {
-                            log.debug(sm.getString("upgradeHandler.socketCloseFailed"), ioe);
-                        }
-                    }
-                }
+                    stream.close(new StreamException(sm.getString(
+                            "upgradeHandler.windowSizeTooBig", connectionId,
+                            stream.getIdentifier()),
+                            h2e.getError(), stream.getIdentifier().intValue()));
+               }
             }
         } else {
             remoteSettings.set(setting, value);

==================================================
