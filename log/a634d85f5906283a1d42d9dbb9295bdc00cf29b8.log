a634d85f5906283a1d42d9dbb9295bdc00cf29b8
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55183
==================================================
Mark Emlyn
==================================================
Tue Jul 2 16:13:13 2013 +0000
==================================================
Constants.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55183
Header names are case insensitive
Based on a patch by Niki Dokovski.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1498994 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsWebSocketContainer.java
index 7326947089..280eb073d0 100644
--- a/java/org/apache/tomcat/websocket/Constants.java
+++ b/java/org/apache/tomcat/websocket/Constants.java
@@ -16,6 +16,8 @@
  */
 package org.apache.tomcat.websocket;
 
+import java.util.Locale;
+
 /**
  * Internal implementation constants.
  */
@@ -50,6 +52,8 @@ public class Constants {
     public static final String WS_KEY_HEADER_NAME = "Sec-WebSocket-Key";
     public static final String WS_PROTOCOL_HEADER_NAME =
             "Sec-WebSocket-Protocol";
+    public static final String WS_PROTOCOL_HEADER_NAME_LOWER =
+            WS_PROTOCOL_HEADER_NAME.toLowerCase(Locale.ENGLISH);
     public static final String WS_EXTENSIONS_HEADER_NAME =
             "Sec-WebSocket-Extensions";
 

==================================================
TestWsSubprotocols.java
index cfdf1da165..822099f2a8 100644
--- a/java/org/apache/tomcat/websocket/WsWebSocketContainer.java
+++ b/java/org/apache/tomcat/websocket/WsWebSocketContainer.java
@@ -308,8 +308,9 @@ public class WsWebSocketContainer
                     afterResponse(handshakeResponse);
 
             // Sub-protocol
+            // Header names are always stored in lower case
             List<String> values = handshakeResponse.getHeaders().get(
-                    Constants.WS_PROTOCOL_HEADER_NAME);
+                    Constants.WS_PROTOCOL_HEADER_NAME_LOWER);
             if (values == null || values.size() == 0) {
                 subProtocol = null;
             } else if (values.size() == 1) {
@@ -591,6 +592,7 @@ public class WsWebSocketContainer
             log.warn(sm.getString("wsWebSocketContainer.invalidHeader", line));
             return;
         }
+        // Header names are case insensitive so always use lower case
         String headerName = line.substring(0, index).trim().toLowerCase();
         // TODO handle known multi-value headers
         String headerValue = line.substring(index + 1).trim();

==================================================
