15a5b06de66e59537c10192b19c6e55fe9bbc2f4
==================================================
Remove unnecessary privileged block from handlePageException.
==================================================
Mark Thomas
==================================================
Thu Apr 6 20:47:38 2017 +0000
==================================================
PageContextImpl.java
Remove unnecessary privileged block from handlePageException.
I can't see anything in doHandlePageException that would trigger a security check.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1790461 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SecurityClassLoad.java
index 2009a764a8..79e35e121a 100644
--- a/java/org/apache/jasper/runtime/PageContextImpl.java
+++ b/java/org/apache/jasper/runtime/PageContextImpl.java
@@ -676,39 +676,12 @@ public class PageContextImpl extends PageContext {
     }
 
     @Override
-    public void handlePageException(final Throwable t) throws IOException,
-            ServletException {
-        if (t == null)
+    @SuppressWarnings("deprecation") // Still jave to support old JSP EL
+    public void handlePageException(final Throwable t) throws IOException, ServletException {
+        if (t == null) {
             throw new NullPointerException("null Throwable");
-
-        if (SecurityUtil.isPackageProtectionEnabled()) {
-            try {
-                AccessController.doPrivileged(
-                        new PrivilegedExceptionAction<Void>() {
-                    @Override
-                    public Void run() throws Exception {
-                        doHandlePageException(t);
-                        return null;
-                    }
-                });
-            } catch (PrivilegedActionException e) {
-                Exception ex = e.getException();
-                if (ex instanceof IOException) {
-                    throw (IOException) ex;
-                } else {
-                    throw (ServletException) ex;
-                }
-            }
-        } else {
-            doHandlePageException(t);
         }
 
-    }
-
-    @SuppressWarnings("deprecation") // Still jave to support old JSP EL
-    private void doHandlePageException(Throwable t) throws IOException,
-            ServletException {
-
         if (errorPageURL != null && !errorPageURL.equals("")) {
 
             /*
@@ -735,8 +708,7 @@ public class PageContextImpl extends PageContext {
 
             // The error page could be inside an include.
 
-            Object newException =
-                    request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);
+            Object newException = request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);
 
             // t==null means the attribute was not set.
             if ((newException != null) && (newException == t)) {
@@ -763,12 +735,12 @@ public class PageContextImpl extends PageContext {
             Throwable rootCause = null;
             if (t instanceof JspException || t instanceof ELException ||
                     t instanceof javax.servlet.jsp.el.ELException) {
-                rootCause =t.getCause();
+                rootCause = t.getCause();
             }
 
             if (rootCause != null) {
-                throw new ServletException(t.getClass().getName() + ": "
-                        + t.getMessage(), rootCause);
+                throw new ServletException(
+                        t.getClass().getName() + ": " + t.getMessage(), rootCause);
             }
 
             throw new ServletException(t);

==================================================
