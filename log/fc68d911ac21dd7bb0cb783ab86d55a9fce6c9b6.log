fc68d911ac21dd7bb0cb783ab86d55a9fce6c9b6
==================================================
Change Request API to use Servlet 3.1 API for HTTP Upgrade
==================================================
Mark Emlyn
==================================================
Sat Nov 24 17:11:29 2012 +0000
==================================================
HttpServletRequest.java
Change Request API to use Servlet 3.1 API for HTTP Upgrade
- WebSocket is now broken
- Upgrade process is broken / incomplete

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1413205 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Request.java
index be38adb078..cb9690f69e 100644
--- a/java/javax/servlet/http/HttpServletRequest.java
+++ b/java/javax/servlet/http/HttpServletRequest.java
@@ -494,7 +494,10 @@ public interface HttpServletRequest extends ServletRequest {
     /**
      * Start the HTTP upgrade process and pass the connection to the provided
      * protocol handler once the current request/response pair has completed
-     * processing.
+     * processing. Calling this method sets the response status to {@link
+     * HttpServletResponse#SC_SWITCHING_PROTOCOLS} and flushes the response.
+     * Protocol specific headers must have already been set before this method
+     * is called.
      *
      * @since Servlet 3.1
      */

==================================================
RequestFacade.java
index f26d3d0b5e..235b0c6f42 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -76,7 +76,6 @@ import org.apache.catalina.mapper.MappingData;
 import org.apache.catalina.util.ParameterMap;
 import org.apache.catalina.util.StringParser;
 import org.apache.coyote.ActionCode;
-import org.apache.coyote.http11.upgrade.UpgradeInbound;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.apache.tomcat.util.ExceptionUtils;
@@ -1862,12 +1861,18 @@ public class Request
     // --------------------------------------------- HttpServletRequest Methods
 
     /**
-     * TODO SERVLET 3.1
+     * {@inheritDoc}
+     *
+     * @since Servlet 3.1
      */
     @Override
     public void upgrade(ProtocolHandler handler) throws IOException {
-        // TODO Auto-generated method stub
+        coyoteRequest.action(ActionCode.UPGRADE, handler);
 
+        // Output required by RFC2616. Protocol specific headers should have
+        // already been set.
+        response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);
+        response.flushBuffer();
     }
 
     /**
@@ -2639,23 +2644,8 @@ public class Request
     }
 
 
-    // --------------------------------------------------------- Upgrade Methods
-
-    public void doUpgrade(UpgradeInbound inbound)
-            throws IOException {
-
-        coyoteRequest.action(ActionCode.UPGRADE, inbound);
-
-        // Output required by RFC2616. Protocol specific headers should have
-        // already been set.
-        response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);
-        response.flushBuffer();
-    }
-
-
     // ------------------------------------------------------ Protected Methods
 
-
     protected Session doGetSession(boolean create) {
 
         // There cannot be a session if no context has been assigned yet

==================================================
