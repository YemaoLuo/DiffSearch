5070d89d9a2c60d9039a6ef2fdb1a8aee5c794ce
==================================================
Better fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=48660
==================================================
Mark Emlyn
==================================================
Tue Mar 2 16:02:25 2010 +0000
==================================================
Http11AprProcessor.java
Better fix for https://issues.apache.org/bugzilla/show_bug.cgi?id=48660
As per Konstantin's comments, ensure a single Vary header is used and take account of * if present

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@918093 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11NioProcessor.java
index 6d73e6ef4d..4c35bf1ce8 100644
--- a/java/org/apache/coyote/http11/Http11AprProcessor.java
+++ b/java/org/apache/coyote/http11/Http11AprProcessor.java
@@ -1660,7 +1660,17 @@ public class Http11AprProcessor implements ActionHook {
             outputBuffer.addActiveFilter(outputFilters[Constants.GZIP_FILTER]);
             headers.setValue("Content-Encoding").setString("gzip");
             // Make Proxies happy via Vary (from mod_deflate)
-            headers.addValue("Vary").setString("Accept-Encoding");
+            MessageBytes vary = headers.getValue("Vary");
+            if (vary == null) {
+                // Add a new Vary header
+                headers.setValue("Vary").setString("Accept-Encoding");
+            } else if (vary.equals("*")) {
+                // No action required
+            } else {
+                // Merge into current header
+                headers.setValue("Vary").setString(
+                        vary.getString() + ",Accept-Encoding");
+            }
         }
 
         // Add date header

==================================================
Http11Processor.java
index 506cfd8f40..5c313728e4 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -1159,7 +1159,17 @@ public class Http11NioProcessor extends AbstractHttp11Processor implements Actio
             outputBuffer.addActiveFilter(outputFilters[Constants.GZIP_FILTER]);
             headers.setValue("Content-Encoding").setString("gzip");
             // Make Proxies happy via Vary (from mod_deflate)
-            headers.addValue("Vary").setString("Accept-Encoding");
+            MessageBytes vary = headers.getValue("Vary");
+            if (vary == null) {
+                // Add a new Vary header
+                headers.setValue("Vary").setString("Accept-Encoding");
+            } else if (vary.equals("*")) {
+                // No action required
+            } else {
+                // Merge into current header
+                headers.setValue("Vary").setString(
+                        vary.getString() + ",Accept-Encoding");
+            }
         }
 
         // Add date header

==================================================
