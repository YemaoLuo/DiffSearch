354cde4e96e434dc26db0edf4ff27b82a23493d3
==================================================
https://issues.apache.org/bugzilla/show_bug.cgi?id=52002
==================================================
Filip Hanik
==================================================
Tue Mar 27 15:04:29 2012 +0000
==================================================
DisposableConnectionFacade.java
https://issues.apache.org/bugzilla/show_bug.cgi?id=52002
Improvements to the pool - the default should be that multi thread close should not affect the connection
isValid should return false if a connection has been closed



git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1305861 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JdbcInterceptor.java
index d167d90601..fe7d2a73ad 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/DisposableConnectionFacade.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/DisposableConnectionFacade.java
@@ -48,6 +48,9 @@ public class DisposableConnectionFacade extends JdbcInterceptor {
         if (compare(CLOSE_VAL, method) && getNext() == null) {
             return null;
         }
+        if (compare(ISVALID_VAL, method) && getNext() == null) {
+            return Boolean.FALSE;
+        }
 
         try {
             return super.invoke(proxy, method, args);
@@ -56,7 +59,7 @@ public class DisposableConnectionFacade extends JdbcInterceptor {
                 if (compare(TOSTRING_VAL, method)) {
                     return "DisposableConnectionFacade[null]";
                 }
-                throw new SQLException("Connection has already been closed.");
+                throw new SQLException("PooledConnection has already been closed.");
             }
 
             throw e;

==================================================
PoolProperties.java
index e75088bb27..3ed85441ee 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/JdbcInterceptor.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/JdbcInterceptor.java
@@ -61,6 +61,10 @@ public abstract class JdbcInterceptor implements InvocationHandler {
      */
     public static final String ISWRAPPERFOR_VAL = "isWrapperFor";
 
+    /**
+     * {@link java.sql.Connection#isValid(boolean)} method name
+     */
+    public static final String ISVALID_VAL = "isValid";
 
     /**
      * Properties for this interceptor.

==================================================
