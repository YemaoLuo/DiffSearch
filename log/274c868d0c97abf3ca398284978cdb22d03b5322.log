274c868d0c97abf3ca398284978cdb22d03b5322
==================================================
Move stream reading logic into AnnotationEntry and ElementValue constructors.
==================================================
Konstantin Kolinko
==================================================
Fri Sep 12 17:15:31 2014 +0000
==================================================
AnnotationEntry.java
Move stream reading logic into AnnotationEntry and ElementValue constructors.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1624594 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Annotations.java
index 43f67df39d..44f159a9f4 100644
--- a/java/org/apache/tomcat/util/bcel/classfile/AnnotationEntry.java
+++ b/java/org/apache/tomcat/util/bcel/classfile/AnnotationEntry.java
@@ -35,32 +35,26 @@ public class AnnotationEntry implements Constants {
     private final int type_index;
     private final ConstantPool constant_pool;
 
-    // FIXME: add 'final'
-    private List<ElementValuePair> element_value_pairs;
+    private final List<ElementValuePair> element_value_pairs;
 
     /**
-     * Factory method to create an AnnotionEntry from a DataInputStream
+     * Creates an AnnotationEntry from a DataInputStream
      *
      * @param file
      * @param constant_pool
-     * @return the entry
      * @throws IOException
      */
-    public static AnnotationEntry read(DataInputStream file, ConstantPool constant_pool) throws IOException {
+    AnnotationEntry(DataInputStream file, ConstantPool constant_pool) throws IOException {
 
-        final AnnotationEntry annotationEntry = new AnnotationEntry(file.readUnsignedShort(), constant_pool);
-        final int num_element_value_pairs = (file.readUnsignedShort());
-        annotationEntry.element_value_pairs = new ArrayList<>();
+        this.constant_pool = constant_pool;
+
+        type_index = file.readUnsignedShort();
+        int num_element_value_pairs = file.readUnsignedShort();
+
+        element_value_pairs = new ArrayList<>(num_element_value_pairs);
         for (int i = 0; i < num_element_value_pairs; i++) {
-            annotationEntry.element_value_pairs.add(new ElementValuePair(file.readUnsignedShort(), ElementValue.readElementValue(file, constant_pool),
-                    constant_pool));
+            element_value_pairs.add(new ElementValuePair(file, constant_pool));
         }
-        return annotationEntry;
-    }
-
-    AnnotationEntry(int type_index, ConstantPool constant_pool) {
-        this.type_index = type_index;
-        this.constant_pool = constant_pool;
     }
 
     /**

==================================================
ElementValue.java
index 5d71602d46..2cfea6f1d6 100644
--- a/java/org/apache/tomcat/util/bcel/classfile/Annotations.java
+++ b/java/org/apache/tomcat/util/bcel/classfile/Annotations.java
@@ -39,7 +39,7 @@ public abstract class Annotations extends Attribute {
         final int annotation_table_length = (file.readUnsignedShort());
         annotation_table = new AnnotationEntry[annotation_table_length];
         for (int i = 0; i < annotation_table_length; i++) {
-            annotation_table[i] = AnnotationEntry.read(file, constant_pool);
+            annotation_table[i] = new AnnotationEntry(file, constant_pool);
         }
     }
 

==================================================
ElementValuePair.java
index 64a7d2b685..aa6c6a3d47 100644
--- a/java/org/apache/tomcat/util/bcel/classfile/ElementValue.java
+++ b/java/org/apache/tomcat/util/bcel/classfile/ElementValue.java
@@ -105,7 +105,7 @@ public abstract class ElementValue
             return new ClassElementValue(CLASS, dis.readUnsignedShort(), cpool);
         case '@': // Annotation
             // TODO isRuntimeVisible
-            return new AnnotationElementValue(ANNOTATION, AnnotationEntry.read(
+            return new AnnotationElementValue(ANNOTATION, new AnnotationEntry(
                     dis, cpool), cpool);
         case '[': // Array
             int numArrayVals = dis.readUnsignedShort();

==================================================
ParameterAnnotationEntry.java
index 656c6c3d16..5fca5c0241 100644
--- a/java/org/apache/tomcat/util/bcel/classfile/ElementValuePair.java
+++ b/java/org/apache/tomcat/util/bcel/classfile/ElementValuePair.java
@@ -17,6 +17,9 @@
  */
 package org.apache.tomcat.util.bcel.classfile;
 
+import java.io.DataInputStream;
+import java.io.IOException;
+
 import org.apache.tomcat.util.bcel.Constants;
 
 /**
@@ -33,11 +36,10 @@ public class ElementValuePair
 
     private final int elementNameIndex;
 
-    ElementValuePair(int elementNameIndex, ElementValue elementValue,
-            ConstantPool constantPool) {
-        this.elementValue = elementValue;
-        this.elementNameIndex = elementNameIndex;
+    ElementValuePair(DataInputStream file, ConstantPool constantPool) throws IOException {
         this.constantPool = constantPool;
+        this.elementNameIndex = file.readUnsignedShort();
+        this.elementValue = ElementValue.readElementValue(file, constantPool);
     }
 
     public String getNameString()

==================================================
