bad572da9eeefb43bcea174cfc966e1c248868e0
==================================================
Restore pero's timeout fix for the BIO connector. Add configuration of the timeout.
==================================================
Mark Emlyn
==================================================
Sat Jul 17 23:57:23 2010 +0000
==================================================
Connector.java
Restore pero's timeout fix for the BIO connector. Add configuration of the timeout.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@965150 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Request.java
index 9fab8124a8..2ae9b673a8 100644
--- a/java/org/apache/catalina/connector/Connector.java
+++ b/java/org/apache/catalina/connector/Connector.java
@@ -94,6 +94,12 @@ public class Connector extends LifecycleMBeanBase  {
     protected boolean allowTrace = false;
 
 
+    /**
+     * Default timeout for asynchronous requests (ms).
+     */
+    protected  long asyncTimeout = 10000;
+
+
     /**
      * The "enable DNS lookups" flag for this Connector.
      */
@@ -338,6 +344,29 @@ public class Connector extends LifecycleMBeanBase  {
     }
 
     
+    /**
+     * Return the default timeout for async requests in ms.
+     */
+    public long getAsyncTimeout() {
+
+        return asyncTimeout;
+
+    }
+
+
+    /**
+     * Set the default timeout for async requests.
+     *
+     * @param allowTrace The new timeout in ms.
+     */
+    public void setAsyncTimeout(long asyncTimeout) {
+
+        this.asyncTimeout= asyncTimeout;
+        setProperty("asyncTimeout", String.valueOf(asyncTimeout));
+
+    }
+
+    
     /**
      * Return the "enable DNS lookups" flag.
      */

==================================================
JIoEndpoint.java
index c4c5d5dc36..168484ecd8 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -1560,7 +1560,11 @@ public class Request
         //TODO SERVLET3 - async - need to retrieve the ServletContext here
         //or just the webapp classloader associated with to do 
         //run with start(Runnable)
-        asyncContext.setHasOriginalRequestAndResponse(request==getRequest() && response==getResponse().getResponse());
+        asyncContext.setHasOriginalRequestAndResponse(request==getRequest() &&
+                response==getResponse().getResponse());
+        
+        asyncContext.setTimeout(getConnector().getAsyncTimeout());
+        
         return asyncContext;
     }
 

==================================================
