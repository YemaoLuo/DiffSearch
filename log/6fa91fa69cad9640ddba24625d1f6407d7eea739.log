6fa91fa69cad9640ddba24625d1f6407d7eea739
==================================================
Fixed UnsupportedOperationException when releasing an user-provided URLStreamHandlerFactory. Patch provided by Cristian Talau via github.
==================================================
Violeta Georgieva
==================================================
Wed Nov 4 08:17:10 2015 +0000
==================================================
TomcatURLStreamHandlerFactory.java
Fixed UnsupportedOperationException when releasing an user-provided URLStreamHandlerFactory. Patch provided by Cristian Talau via github.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1712489 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestTomcatURLStreamHandlerFactory.java
index 434d2cac22..f11356b018 100644
--- a/java/org/apache/catalina/webresources/TomcatURLStreamHandlerFactory.java
+++ b/java/org/apache/catalina/webresources/TomcatURLStreamHandlerFactory.java
@@ -102,10 +102,11 @@ public class TomcatURLStreamHandlerFactory implements URLStreamHandlerFactory {
     public static void release(ClassLoader classLoader) {
         Iterator<URLStreamHandlerFactory> iter = instance.userFactories.iterator();
         while (iter.hasNext()) {
-            ClassLoader factoryLoader = iter.next().getClass().getClassLoader();
+            URLStreamHandlerFactory candidate = iter.next();
+            ClassLoader factoryLoader = candidate.getClass().getClassLoader();
             while (factoryLoader != null) {
                 if (classLoader.equals(factoryLoader)) {
-                    iter.remove();
+                    instance.userFactories.remove(candidate);
                     break;
                 }
                 factoryLoader = factoryLoader.getParent();

==================================================
