567d1862bbc3c22557765055c4cab0d25bd0efdd
==================================================
Allow files bigger than 2G to be deployed using ant tasks.
==================================================
Violeta Georgieva
==================================================
Thu Jul 30 17:20:16 2015 +0000
==================================================
AbstractCatalinaTask.java
Allow files bigger than 2G to be deployed using ant tasks.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1693461 13f79535-47bb-0310-9956-ffa450edef68



==================================================
DeployTask.java
index 5cea98d437..362f2d6b2d 100644
--- a/java/org/apache/catalina/ant/AbstractCatalinaTask.java
+++ b/java/org/apache/catalina/ant/AbstractCatalinaTask.java
@@ -185,7 +185,7 @@ public abstract class AbstractCatalinaTask extends BaseRedirectorHelperTask {
      * @exception BuildException if an error occurs
      */
     public void execute(String command, InputStream istream,
-                        String contentType, int contentLength)
+                        String contentType, long contentLength)
         throws BuildException {
 
         URLConnection conn = null;

==================================================
TestDeployTask.java
index 848641934a..03683b4ed8 100644
--- a/java/org/apache/catalina/ant/DeployTask.java
+++ b/java/org/apache/catalina/ant/DeployTask.java
@@ -140,13 +140,13 @@ public class DeployTask extends AbstractCatalinaCommandTask {
         // Building an input stream on the WAR to upload, if any
         BufferedInputStream stream = null;
         String contentType = null;
-        int contentLength = -1;
+        long contentLength = -1;
         if (war != null) {
             if (PROTOCOL_PATTERN.matcher(war).lookingAt()) {
                 try {
                     URL url = new URL(war);
                     URLConnection conn = url.openConnection();
-                    contentLength = conn.getContentLength();
+                    contentLength = conn.getContentLengthLong();
                     stream = new BufferedInputStream
                         (conn.getInputStream(), 1024);
                 } catch (IOException e) {
@@ -156,16 +156,8 @@ public class DeployTask extends AbstractCatalinaCommandTask {
                 FileInputStream fsInput = null;
                 try {
                     fsInput = new FileInputStream(war);
-                    long size = fsInput.getChannel().size();
-
-                    if (size > Integer.MAX_VALUE)
-                        throw new UnsupportedOperationException(
-                                "DeployTask does not support WAR files " +
-                                "greater than 2 Gb");
-                    contentLength = (int) size;
-
+                    contentLength = fsInput.getChannel().size();
                     stream = new BufferedInputStream(fsInput, 1024);
-
                 } catch (IOException e) {
                     if (fsInput != null) {
                         try {

==================================================
