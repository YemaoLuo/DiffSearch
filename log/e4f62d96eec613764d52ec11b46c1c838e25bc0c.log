e4f62d96eec613764d52ec11b46c1c838e25bc0c
==================================================
Move stage update to before point where we might break out of the keep-alive loop
==================================================
Mark Emlyn
==================================================
Mon Sep 5 13:21:28 2011 +0000
==================================================
Http11AprProcessor.java
Move stage update to before point where we might break out of the keep-alive loop

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1165273 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11NioProcessor.java
index fa6a1f1cc4..22725ec039 100644
--- a/java/org/apache/coyote/http11/Http11AprProcessor.java
+++ b/java/org/apache/coyote/http11/Http11AprProcessor.java
@@ -316,7 +316,9 @@ public class Http11AprProcessor extends AbstractHttp11Processor<Long> {
                 inputBuffer.nextRequest();
                 outputBuffer.nextRequest();
             }
-            
+
+            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);
+
             // Do sendfile as needed: add socket to sendfile and end
             if (sendfileData != null && !error) {
                 sendfileData.socket = socketRef;
@@ -339,8 +341,6 @@ public class Http11AprProcessor extends AbstractHttp11Processor<Long> {
                     break;
                 }
             }
-            
-            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);
         }
 
         rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);

==================================================
Http11Processor.java
index 6d68bdd2ca..ae746cb6c0 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -377,7 +377,9 @@ public class Http11NioProcessor extends AbstractHttp11Processor<NioChannel> {
                 inputBuffer.nextRequest();
                 outputBuffer.nextRequest();
             }
-            
+
+            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);
+
             // Do sendfile as needed: add socket to sendfile and end
             if (sendfileData != null && !error) {
                 ((KeyAttachment) socketWrapper).setSendfileData(sendfileData);
@@ -389,8 +391,6 @@ public class Http11NioProcessor extends AbstractHttp11Processor<NioChannel> {
                         (KeyAttachment) socketWrapper, true, true);
                 break;
             }
-
-            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);
         }
 
         rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);

==================================================
