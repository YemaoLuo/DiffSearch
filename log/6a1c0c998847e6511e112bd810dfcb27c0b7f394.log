6a1c0c998847e6511e112bd810dfcb27c0b7f394
==================================================
Improve logging of error conditions
==================================================
Mark Emlyn
==================================================
Mon Jul 11 16:08:23 2011 +0000
==================================================
CoyoteAdapter.java
Improve logging of error conditions

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1145224 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index 789ef8d993..7f6bd4ff00 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -493,8 +493,24 @@ public class CoyoteAdapter implements Adapter {
         }
         
         try {
-            connector.getService().getContainer().logAccess(
-                    request, response, time, true);
+            // Log at the lowest level available. logAccess() will be
+            // automatically called on parent containers.
+            boolean logged = false;
+            if (request.mappingData != null) {
+                if (request.mappingData.context != null) {
+                    logged = true;
+                    ((Context) request.mappingData.context).logAccess(
+                            request, response, time, true);
+                } else if (request.mappingData.host != null) {
+                    logged = true;
+                    ((Context) request.mappingData.context).logAccess(
+                            request, response, time, true);
+                }
+            }
+            if (!logged) {
+                connector.getService().getContainer().logAccess(
+                        request, response, time, true);
+            }
         } catch (Throwable t) {
             ExceptionUtils.handleThrowable(t);
             log.warn(sm.getString("coyoteAdapter.accesslogFail"), t);

==================================================
