9a2fd759e955c83d4c2145f686e60dcf8522211c
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50535
==================================================
Mark Emlyn
==================================================
Thu Jan 20 16:35:55 2011 +0000
==================================================
StandardContext.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50535
Provid an option (disabled by default) to serve resources from /WEB-INF/classes/META-INF/resources

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1061376 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ContextConfig.java
index 71a2a5fdc8..c2e5b97b66 100644
--- a/java/org/apache/catalina/core/StandardContext.java
+++ b/java/org/apache/catalina/core/StandardContext.java
@@ -817,9 +817,22 @@ public class StandardContext extends ContainerBase
 
     private String webappVersion = "";
 
+    private boolean addWebinfClassesResources = false;
+
     // ----------------------------------------------------- Context Properties
 
 
+    public void setAddWebinfClassesResources(
+            boolean addWebinfClassesResources) {
+        this.addWebinfClassesResources = addWebinfClassesResources;
+    }
+
+
+    public boolean getAddWebinfClassesResources() {
+        return addWebinfClassesResources;
+    }
+
+
     @Override
     public void setWebappVersion(String webappVersion) {
         if (null == webappVersion) {
@@ -4640,6 +4653,20 @@ public class StandardContext extends ContainerBase
                 ((BaseDirContext) webappResources).allocate();
                 // Alias support
                 ((BaseDirContext) webappResources).setAliases(getAliases());
+                
+                if (effectiveMajorVersion >=3 && addWebinfClassesResources) {
+                    try {
+                        DirContext webInfCtx =
+                            (DirContext) webappResources.lookup(
+                                    "/WEB-INF/classes");
+                        // Do the lookup to make sure it exists
+                        webInfCtx.lookup("META-INF/resources");
+                        ((BaseDirContext) webappResources).addAltDirContext(
+                                webInfCtx);
+                    } catch (NamingException e) {
+                        // Doesn't exist - ignore and carry on
+                    }
+                }
             }
             // Register the cache in JMX
             if (isCachingAllowed()) {

==================================================
BaseDirContext.java
index 2c5e5d138f..3170279eab 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -1294,6 +1294,8 @@ public class ContextConfig
                     }
                 }
                 processResourceJARs(resourceJars);
+                // See also StandardContext.resourcesStart() for
+                // WEB-INF/classes/META-INF/resources configuration
             }
             
             // Only look for ServletContainerInitializer if metadata is not

==================================================
TestStandardContextResources.java
index 1158107c45..ea09c726d5 100644
--- a/java/org/apache/naming/resources/BaseDirContext.java
+++ b/java/org/apache/naming/resources/BaseDirContext.java
@@ -167,7 +167,15 @@ public abstract class BaseDirContext implements DirContext {
         }
     }
     
-    
+
+    /**
+     * Add an alternative DirContext (must contain META-INF/resources) directly.
+     */
+    public void addAltDirContext(DirContext altDirContext) {
+        altDirContexts.add(altDirContext);
+    }
+
+
     /**
      * Add an alias.
      */

==================================================
