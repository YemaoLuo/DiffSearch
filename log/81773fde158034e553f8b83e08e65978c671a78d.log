81773fde158034e553f8b83e08e65978c671a78d
==================================================
Ensure that if asyncDispatch() is called during an onTimeout event and the target Servlet does not call startAsync() or complete() that Tomcat calls complete() (or does the equivalent) once the target Servlet exits.
==================================================
Mark Emlyn
==================================================
Wed Jun 29 12:57:50 2011 +0000
==================================================
AsyncContextImpl.java
Ensure that if asyncDispatch() is called during an onTimeout event and the target Servlet does not call startAsync() or complete() that Tomcat calls complete() (or does the equivalent) once the target Servlet exits.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1141079 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestAsyncContextImpl.java
index 2e6d6e0ca3..33c6fb1e0d 100644
--- a/java/org/apache/catalina/core/AsyncContextImpl.java
+++ b/java/org/apache/catalina/core/AsyncContextImpl.java
@@ -312,6 +312,9 @@ public class AsyncContextImpl implements AsyncContext, AsyncContextCallback {
         }
         try {
             dispatch.run();
+            if (!request.isAsync()) {
+                fireOnComplete();
+            }
         } catch (RuntimeException x) {
             // doInternalComplete(true);
             if (x.getCause() instanceof ServletException) {

==================================================
