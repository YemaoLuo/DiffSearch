cc7c12993bb43bafbdcc209d145e65e32025e3ab
==================================================
NIO writes don't return -1 so neither should CLOSED_NIO_CHANNEL
==================================================
Mark Thomas
==================================================
Mon Nov 7 13:32:20 2022 +0000
==================================================
NioSender.java
NIO writes don't return -1 so neither should CLOSED_NIO_CHANNEL


==================================================
NioChannel.java
index 252dc4d183..82e7149222 100644
--- a/java/org/apache/catalina/tribes/transport/nio/NioSender.java
+++ b/java/org/apache/catalina/tribes/transport/nio/NioSender.java
@@ -16,7 +16,6 @@
  */
 package org.apache.catalina.tribes.transport.nio;
 
-import java.io.EOFException;
 import java.io.IOException;
 import java.net.InetSocketAddress;
 import java.nio.ByteBuffer;
@@ -206,9 +205,6 @@ public class NioSender extends AbstractSender {
                 //we have written everything, or we are starting a new package
                 //protect against buffer overwrite
                 int byteswritten = isUdpBased()?dataChannel.write(writebuf) : socketChannel.write(writebuf);
-                if (byteswritten == -1 ) {
-                    throw new EOFException();
-                }
                 remaining -= byteswritten;
                 //if the entire message was written from the buffer
                 //reset the position counter

==================================================
NioEndpoint.java
index 9a22906914..d263ce9ae6 100644
--- a/java/org/apache/tomcat/util/net/NioChannel.java
+++ b/java/org/apache/tomcat/util/net/NioChannel.java
@@ -19,6 +19,7 @@ package org.apache.tomcat.util.net;
 import java.io.IOException;
 import java.nio.ByteBuffer;
 import java.nio.channels.ByteChannel;
+import java.nio.channels.ClosedChannelException;
 import java.nio.channels.GatheringByteChannel;
 import java.nio.channels.ScatteringByteChannel;
 import java.nio.channels.SocketChannel;
@@ -260,12 +261,12 @@ public class NioChannel implements ByteChannel, ScatteringByteChannel, Gathering
         @Override
         public int write(ByteBuffer src) throws IOException {
             checkInterruptStatus();
-            return -1;
+            throw new ClosedChannelException();
         }
         @Override
         public long write(ByteBuffer[] srcs, int offset, int length)
                 throws IOException {
-            return -1L;
+            throw new ClosedChannelException();
         }
         @Override
         public String toString() {

==================================================
