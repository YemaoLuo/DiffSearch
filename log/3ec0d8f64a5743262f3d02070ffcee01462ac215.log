3ec0d8f64a5743262f3d02070ffcee01462ac215
==================================================
Fix another BZ 49464 regression.
==================================================
Mark Thomas
==================================================
Sun Jul 30 18:18:36 2017 +0000
==================================================
DefaultServlet.java
Fix another BZ 49464 regression.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1803444 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestDefaultServlet.java
index 32c8a11a48..78d3f41636 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -974,7 +974,18 @@ public class DefaultServlet extends HttpServlet {
         String outputEncoding = response.getCharacterEncoding();
         Charset charset = B2CConverter.getCharset(outputEncoding);
         boolean conversionRequired;
+        /*
+         * The test below deliberately uses != to compare two Strings. This is
+         * because the code is looking to see if the default character encoding
+         * has been returned because no explicit character encoding has been
+         * defined. There is no clean way of doing this via the Servlet API. It
+         * would be possible to add a Tomcat specific API but that would require
+         * quite a bit of code to get to the Tomcat specific request object that
+         * may have been wrapped. The != test is a (slightly hacky) quick way of
+         * doing this.
+         */
         if (!usingPrecompressedVersion && isText(contentType) &&
+                outputEncoding != org.apache.coyote.Constants.DEFAULT_BODY_CHARSET.name() &&
                 !charset.equals(fileEncodingCharset)) {
             conversionRequired = true;
             // Conversion often results fewer/more/different bytes.

==================================================
