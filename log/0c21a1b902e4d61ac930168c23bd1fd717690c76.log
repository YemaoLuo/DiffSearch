0c21a1b902e4d61ac930168c23bd1fd717690c76
==================================================
Review of Parameters and query string encoding
==================================================
Mark Thomas
==================================================
Thu May 4 18:29:49 2017 +0000
==================================================
FormAuthenticator.java
Review of Parameters and query string encoding
Clean-up / clarification
No functional change

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1793844 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CoyoteAdapter.java
index b3056a0366..3920590474 100644
--- a/java/org/apache/catalina/authenticator/FormAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/FormAuthenticator.java
@@ -590,8 +590,6 @@ public class FormAuthenticator
         }
 
         request.getCoyoteRequest().getParameters().recycle();
-        request.getCoyoteRequest().getParameters().setQueryStringEncoding(
-                request.getConnector().getURIEncoding());
 
         ByteChunk body = saved.getBody();
 

==================================================
Request.java
index 9a907d4087..db56f56d37 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -447,8 +447,7 @@ public class CoyoteAdapter implements Adapter {
             res.setNote(ADAPTER_NOTES, response);
 
             // Set query string encoding
-            req.getParameters().setQueryStringEncoding
-                (connector.getURIEncoding());
+            req.getParameters().setQueryStringEncoding(connector.getURIEncoding());
         }
 
         try {

==================================================
ApplicationHttpRequest.java
index 083f39c222..fcde33e9e3 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -3134,13 +3134,14 @@ public class Request implements HttpServletRequest {
                     parameters.setQueryStringEncoding(enc);
                 }
             } else {
-                parameters.setEncoding
-                    (org.apache.coyote.Constants.DEFAULT_CHARACTER_ENCODING);
+                parameters.setEncoding(org.apache.coyote.Constants.DEFAULT_CHARACTER_ENCODING);
                 if (useBodyEncodingForURI) {
-                    parameters.setQueryStringEncoding
-                        (org.apache.coyote.Constants.DEFAULT_CHARACTER_ENCODING);
+                    parameters.setQueryStringEncoding(
+                            org.apache.coyote.Constants.DEFAULT_CHARACTER_ENCODING);
                 }
             }
+            // Note: If !useBodyEncodingForURI, the query string encoding is
+            //       that set towards the start of CoyoyeAdapter.service()
 
             parameters.handleQueryParameters();
 

==================================================
