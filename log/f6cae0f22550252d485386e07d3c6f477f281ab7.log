f6cae0f22550252d485386e07d3c6f477f281ab7
==================================================
Added test case to test two concurrent datasources, fixed the flag to turn on the sweeper
==================================================
Filip Hanik
==================================================
Mon Nov 10 17:09:40 2008 +0000
==================================================
PoolProperties.java
index 93157c37f9..9930b5a995 100644
--- a/modules/jdbc-pool/.classpath
+++ b/modules/jdbc-pool/.classpath
@@ -3,9 +3,9 @@
 	<classpathentry kind="src" path="java"/>
 	<classpathentry kind="src" path="test"/>
 	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER"/>
-	<classpathentry kind="var" path="TOMCAT_LIBS_BASE/tomcat6-deps/dbcp/tomcat-dbcp.jar"/>
-	<classpathentry kind="var" path="TOMCAT_LIBS_BASE"/>
 	<classpathentry combineaccessrules="false" kind="src" path="/tomcat-trunk"/>
 	<classpathentry kind="con" path="org.eclipse.jdt.junit.JUNIT_CONTAINER/3"/>
+	<classpathentry kind="var" path="TOMCAT_LIBS_BASE/tomcat6-deps/dbcp/tomcat-dbcp.jar"/>
+	<classpathentry kind="lib" path="mysql-connector-java-5.1.6-bin.jar"/>
 	<classpathentry kind="output" path="bin"/>
 </classpath>

==================================================
DefaultTestCase.java
index 1ddbc404f6..3a6e2a8df3 100644
--- a/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/PoolProperties.java
+++ b/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/PoolProperties.java
@@ -391,7 +391,7 @@ public class PoolProperties {
     public boolean isPoolSweeperEnabled() {
         boolean result = getTimeBetweenEvictionRunsMillis()>0;
         result = result && (isRemoveAbandoned() && getRemoveAbandonedTimeout()>0);
-        result = result && (isTestWhileIdle() && getValidationQuery()!=null);
+        result = result || (isTestWhileIdle() && getValidationQuery()!=null);
         return result;
     }
 }

==================================================
TwoDataSources.java
index 5de13e0969..b7377b63b1 100644
--- a/modules/jdbc-pool/test/org/apache/tomcat/jdbc/test/DefaultTestCase.java
+++ b/modules/jdbc-pool/test/org/apache/tomcat/jdbc/test/DefaultTestCase.java
@@ -39,7 +39,8 @@ public class DefaultTestCase extends TestCase {
         super(name);
     }
 
-    protected void init() throws Exception {
+    public DataSourceProxy createDefaultDataSource() {
+        DataSourceProxy datasource = null;
         PoolProperties p = new DefaultProperties();
         p.setJmxEnabled(false);
         p.setTestWhileIdle(false);
@@ -57,6 +58,11 @@ public class DefaultTestCase extends TestCase {
         p.setRemoveAbandoned(false);
         datasource = new org.apache.tomcat.jdbc.pool.DataSourceProxy();
         datasource.setPoolProperties(p);
+        return datasource;
+    }
+    
+    protected void init() throws Exception {
+        this.datasource = createDefaultDataSource();
     }
 
     protected void transferProperties() {
@@ -92,6 +98,7 @@ public class DefaultTestCase extends TestCase {
 
 
     protected void tearDown() throws Exception {
+        try {datasource.close();}catch(Exception ignore){}
         datasource = null;
         tDatasource = null;
         System.gc();

==================================================
