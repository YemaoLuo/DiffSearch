22d1ad7f2599f4f6eed090399be58cac65415406
==================================================
Port fix for bug 34956. Enforce requirements of SRV.8.2 / SRV.14.2.5.1
==================================================
Mark Emlyn
==================================================
Sat Nov 4 22:35:15 2006 +0000
==================================================
ApplicationDispatcher.java
Port fix for bug 34956. Enforce requirements of SRV.8.2 / SRV.14.2.5.1

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@471281 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ApplicationFilterChain.java
index b0bec2f2e0..f5e8e1dee1 100644
--- a/java/org/apache/catalina/core/ApplicationDispatcher.java
+++ b/java/org/apache/catalina/core/ApplicationDispatcher.java
@@ -325,6 +325,11 @@ final class ApplicationDispatcher
         // Set up to handle the specified request and response
         setup(request, response, false);
 
+        if (Globals.STRICT_SERVLET_COMPLIANCE) {
+            // Check SRV.8.2 / SRV.14.2.5.1 compliance
+            checkSameObjects();
+        }
+
         // Identify the HTTP-specific request and response objects (if any)
         HttpServletRequest hrequest = null;
         if (request instanceof HttpServletRequest)
@@ -507,6 +512,11 @@ final class ApplicationDispatcher
         // Set up to handle the specified request and response
         setup(request, response, true);
 
+        if (Globals.STRICT_SERVLET_COMPLIANCE) {
+            // Check SRV.8.2 / SRV.14.2.5.1 compliance
+            checkSameObjects();
+        }
+        
         // Create a wrapped response to use for this request
         // ServletResponse wresponse = null;
         ServletResponse wresponse = wrapResponse();
@@ -958,5 +968,55 @@ final class ApplicationDispatcher
 
     }
 
+    private void checkSameObjects() throws ServletException {
+        ServletRequest originalRequest =
+            ApplicationFilterChain.getLastServicedRequest();
+        ServletResponse originalResponse =
+            ApplicationFilterChain.getLastServicedResponse();
+        
+        // Some forwards, eg from valves will not set original values 
+        if (originalRequest == null || originalResponse == null) {
+            return;
+        }
+        
+        boolean same = false;
+        ServletRequest dispatchedRequest = appRequest;
+        
+        while (!same) {
+            if (originalRequest.equals(dispatchedRequest)) {
+                same = true;
+            }
+            if (!same && dispatchedRequest instanceof ServletRequestWrapper) {
+                dispatchedRequest =
+                    ((ServletRequestWrapper) dispatchedRequest).getRequest();
+            } else {
+                break;
+            }
+        }
+        if (!same) {
+            throw new ServletException(sm.getString(
+                    "applicationDispatcher.specViolation.request"));
+        }
+        
+        same = false;
+        ServletResponse dispatchedResponse = appResponse;
+        
+        while (!same) {
+            if (originalResponse.equals(dispatchedResponse)) {
+                same = true;
+            }
+            
+            if (!same && dispatchedResponse instanceof ServletResponseWrapper) {
+                dispatchedResponse =
+                    ((ServletResponseWrapper) dispatchedResponse).getResponse();
+            } else {
+                break;
+            }
+        }
 
+        if (!same) {
+            throw new ServletException(sm.getString(
+                    "applicationDispatcher.specViolation.response"));
+        }
+    }
 }

==================================================
