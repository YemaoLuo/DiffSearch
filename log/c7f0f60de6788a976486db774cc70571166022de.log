c7f0f60de6788a976486db774cc70571166022de
==================================================
- Separate processing of exceptions from the servlet (so that IOE doesn't cause problems anymore: bug 38713).
==================================================
Remy Maucherat
==================================================
Sat Sep 2 09:28:35 2006 +0000
==================================================
JspCompilationContext.java
- Separate processing of exceptions from the servlet (so that IOE doesn't cause problems anymore: bug 38713).
- Only Compiler will attempt to remove the files (before the compilation), otherwise multiple things can happen
  in parallel.
- Code cleanup (I suppose I'll have to do a big cleanup soon ...).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@439565 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Compiler.java
index 344d29fbb4..97687a2920 100644
--- a/java/org/apache/jasper/JspCompilationContext.java
+++ b/java/org/apache/jasper/JspCompilationContext.java
@@ -1,5 +1,5 @@
 /*
- * Copyright 1999,2004 The Apache Software Foundation.
+ * Copyright 1999,2004-2006 The Apache Software Foundation.
  * 
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -73,7 +73,6 @@ public class JspCompilationContext {
     private String classPath;
 
     private String baseURI;
-    private String baseOutputDir;
     private String outputDir;
     private ServletContext context;
     private URLClassLoader loader;
@@ -538,10 +537,8 @@ public class JspCompilationContext {
     // ==================== Removal ==================== 
 
     public void incrementRemoved() {
-        if (removed > 1) {
-            jspCompiler.removeGeneratedFiles();
-            if( rctxt != null )
-                rctxt.removeWrapper(jspUri);
+        if (removed == 0 && rctxt != null) {
+            rctxt.removeWrapper(jspUri);
         }
         removed++;
     }
@@ -559,6 +556,7 @@ public class JspCompilationContext {
         createCompiler();
         if (isPackagedTagFile || jspCompiler.isOutDated()) {
             try {
+                jspCompiler.removeGeneratedFiles();
                 jspLoader = null;
                 jspCompiler.compile();
                 jsw.setReload(true);
@@ -568,7 +566,6 @@ public class JspCompilationContext {
                 jsw.setCompilationException(ex);
                 throw ex;
             } catch (Exception ex) {
-                ex.printStackTrace();
                 JasperException je = new JasperException(
                             Localizer.getMessage("jsp.error.unable.compile"),
                             ex);

==================================================
JspServletWrapper.java
index f2d43bf940..5e697d28e1 100644
--- a/java/org/apache/jasper/compiler/Compiler.java
+++ b/java/org/apache/jasper/compiler/Compiler.java
@@ -1,5 +1,5 @@
 /*
- * Copyright 1999,2004-2005 The Apache Software Foundation.
+ * Copyright 1999,2004-2006 The Apache Software Foundation.
  * 
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -373,7 +373,6 @@ public abstract class Compiler {
             jspRealLastModified = uc.getLastModified();
             uc.getInputStream().close();
         } catch (Exception e) {
-            e.printStackTrace();
             return true;
         }
 
@@ -430,7 +429,6 @@ public abstract class Compiler {
                     return true;
                 }
             } catch (Exception e) {
-                e.printStackTrace();
                 return true;
             }
         }

==================================================
