f234a9e289481aadcfa6a2e47efe024e01fa0e3f
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63056
==================================================
Mark Thomas
==================================================
Fri Jan 4 17:06:12 2019 +0000
==================================================
JspC.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63056
Correct a regression in the fix for bug 53737 that did not correctly scan the web application directory structure for JSPs.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1850403 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JspCServletContext.java
index e0ac7c2d32..bfd102171b 100644
--- a/java/org/apache/jasper/JspC.java
+++ b/java/org/apache/jasper/JspC.java
@@ -1426,13 +1426,13 @@ public class JspC extends Task implements Options {
         Set<String> paths = context.getResourcePaths(input);
         for (String path : paths) {
             if (path.endsWith("/")) {
-                scanFilesInternal(input.substring(0, input.length() -1) + path);
-            } else if (jspConfig.isJspPage(input + path)) {
+                scanFilesInternal(path);
+            } else if (jspConfig.isJspPage(path)) {
                 pages.add(path);
             } else {
                 String ext = path.substring(path.lastIndexOf('.') + 1);
                 if (extensions.contains(ext)) {
-                    pages.add(input + path.substring(1));
+                    pages.add(path);
                 }
             }
         }

==================================================
TestJspCServletContext.java
index cf976a2d25..f35d0d7508 100644
--- a/java/org/apache/jasper/servlet/JspCServletContext.java
+++ b/java/org/apache/jasper/servlet/JspCServletContext.java
@@ -475,11 +475,11 @@ public class JspCServletContext implements ServletContext {
                             // Let the Set implementation handle duplicates
                             int sep = entryName.indexOf("/", jarPath.length());
                             if (sep < 0) {
-                                // This is a file
-                                thePaths.add(entryName.substring(jarPath.length() - 1));
+                                // This is a file - strip leading "META-INF/resources"
+                                thePaths.add(entryName.substring(18));
                             } else {
-                                // This is a directory
-                                thePaths.add(entryName.substring(jarPath.length() - 1, sep + 1));
+                                // This is a directory - strip leading "META-INF/resources"
+                                thePaths.add(entryName.substring(18, sep + 1));
                             }
                         }
                     }

==================================================
