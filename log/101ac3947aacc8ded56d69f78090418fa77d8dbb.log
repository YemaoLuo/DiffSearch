101ac3947aacc8ded56d69f78090418fa77d8dbb
==================================================
Refactor Vary parser to the more generic TokenList parser
==================================================
Mark Thomas
==================================================
Wed Oct 16 17:38:53 2019 +0100
==================================================
ResponseUtil.java
Refactor Vary parser to the more generic TokenList parser



==================================================
TokenList.java
index 025bd49244..295e7b7ff7 100644
--- a/java/org/apache/tomcat/util/http/ResponseUtil.java
+++ b/java/org/apache/tomcat/util/http/ResponseUtil.java
@@ -27,7 +27,7 @@ import java.util.Set;
 
 import javax.servlet.http.HttpServletResponse;
 
-import org.apache.tomcat.util.http.parser.Vary;
+import org.apache.tomcat.util.http.parser.TokenList;
 
 public class ResponseUtil {
 
@@ -81,7 +81,7 @@ public class ResponseUtil {
         for (String varyHeader : varyHeaders) {
             StringReader input = new StringReader(varyHeader);
             try {
-                Vary.parseVary(input, fieldNames);
+                TokenList.parseTokenList(input, fieldNames);
             } catch (IOException ioe) {
                 // Should never happen
             }

==================================================
Vary.java
new file mode 100644
index 0000000000..9ba88b0b3f
--- /dev/null
+++ b/java/org/apache/tomcat/util/http/parser/TokenList.java
@@ -0,0 +1,70 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.tomcat.util.http.parser;
+
+import java.io.IOException;
+import java.io.Reader;
+import java.util.Collection;
+import java.util.Locale;
+
+public class TokenList {
+
+    private TokenList() {
+        // Utility class. Hide default constructor.
+    }
+
+
+    /**
+     * Parses a header of the form 1#token.
+     *
+     * @param input  The header to parse
+     * @param result The Collection (usually a list of a set) to which the
+     *                  parsed token should be added
+     *
+     * @throws IOException If an I/O error occurs reading the header
+     */
+    public static void parseTokenList(Reader input, Collection<String> result) throws IOException {
+
+        do {
+            String fieldName = HttpParser.readToken(input);
+            if (fieldName == null) {
+                // Invalid field-name, skip to the next one
+                HttpParser.skipUntil(input, 0, ',');
+                continue;
+            }
+
+            if (fieldName.length() == 0) {
+                // No more data to read
+                break;
+            }
+
+            SkipResult skipResult = HttpParser.skipConstant(input, ",");
+            if (skipResult == SkipResult.EOF) {
+                // EOF
+                result.add(fieldName.toLowerCase(Locale.ENGLISH));
+                break;
+            } else if (skipResult == SkipResult.FOUND) {
+                result.add(fieldName.toLowerCase(Locale.ENGLISH));
+                continue;
+            } else {
+                // Not a token - ignore it
+                HttpParser.skipUntil(input, 0, ',');
+                continue;
+            }
+        } while (true);
+    }
+}

==================================================
TestTokenList.java
index 130ddcf07c..e064620417 100644
--- a/java/org/apache/tomcat/util/http/parser/Vary.java
+++ b/java/org/apache/tomcat/util/http/parser/Vary.java
@@ -18,9 +18,12 @@ package org.apache.tomcat.util.http.parser;
 
 import java.io.IOException;
 import java.io.StringReader;
-import java.util.Locale;
 import java.util.Set;
 
+/**
+ * @deprecated  Use {@link TokenList}.
+ */
+@Deprecated
 public class Vary {
 
     private Vary() {
@@ -29,33 +32,6 @@ public class Vary {
 
 
     public static void parseVary(StringReader input, Set<String> result) throws IOException {
-
-        do {
-            String fieldName = HttpParser.readToken(input);
-            if (fieldName == null) {
-                // Invalid field-name, skip to the next one
-                HttpParser.skipUntil(input, 0, ',');
-                continue;
-            }
-
-            if (fieldName.length() == 0) {
-                // No more data to read
-                break;
-            }
-
-            SkipResult skipResult = HttpParser.skipConstant(input, ",");
-            if (skipResult == SkipResult.EOF) {
-                // EOF
-                result.add(fieldName.toLowerCase(Locale.ENGLISH));
-                break;
-            } else if (skipResult == SkipResult.FOUND) {
-                result.add(fieldName.toLowerCase(Locale.ENGLISH));
-                continue;
-            } else {
-                // Not a token - ignore it
-                HttpParser.skipUntil(input, 0, ',');
-                continue;
-            }
-        } while (true);
+        TokenList.parseTokenList(input, result);
     }
 }

==================================================
