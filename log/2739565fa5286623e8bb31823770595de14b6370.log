2739565fa5286623e8bb31823770595de14b6370
==================================================
Fix regression of bugfix 65757
==================================================
remm remm@apache.org
==================================================
Mon Feb 28 17:25:37 2022 +0100
==================================================
CoyoteAdapter.java
Fix regression of bugfix 65757

With sequential use, the id needs to be reset to be accurate.
Test case code submitted by Istvan Szekely.


==================================================
Request.java
index 50cb5a6610..5b5660159f 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -297,6 +297,7 @@ public class CoyoteAdapter implements Adapter {
             }
 
             req.getRequestProcessor().setWorkerThreadName(null);
+            req.clearRequestThread();
             // Recycle the wrapper request and response
             if (!success || !request.isAsync()) {
                 updateWrapperErrorCount(request, response);
@@ -429,6 +430,7 @@ public class CoyoteAdapter implements Adapter {
             }
 
             req.getRequestProcessor().setWorkerThreadName(null);
+            req.clearRequestThread();
 
             // Recycle the wrapper request and response
             if (!async) {

==================================================
TestNonBlockingAPI.java
index 0cb4dbe902..8a289966d7 100644
--- a/java/org/apache/coyote/Request.java
+++ b/java/org/apache/coyote/Request.java
@@ -742,6 +742,10 @@ public final class Request {
         return threadId;
     }
 
+    public void clearRequestThread() {
+        threadId = 0;
+    }
+
     public void setRequestThread() {
         threadId = Thread.currentThread().getId();
     }

==================================================
