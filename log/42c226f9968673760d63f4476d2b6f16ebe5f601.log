42c226f9968673760d63f4476d2b6f16ebe5f601
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49726
==================================================
Mark Emlyn
==================================================
Mon Aug 23 19:23:28 2010 +0000
==================================================
Compiler.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49726
Specifying a default content type via a JSP property group should not prevent a page from setting some other content type
Includes test cases

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@988262 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestCompiler.java
index 0c02fbda59..7b9e03c4f4 100644
--- a/java/org/apache/jasper/compiler/Compiler.java
+++ b/java/org/apache/jasper/compiler/Compiler.java
@@ -140,9 +140,8 @@ public abstract class Compiler {
             pageInfo.setTrimDirectiveWhitespaces(JspUtil.booleanValue(jspProperty
                     .isTrimDirectiveWhitespaces()));
         }
-        if (jspProperty.getDefaultContentType() != null) {
-            pageInfo.setContentType(jspProperty.getDefaultContentType());
-        }
+        // Default ContentType processing is deferred until after the page has
+        // been parsed
         if (jspProperty.getBuffer() != null) {
             pageInfo.setBufferValue(jspProperty.getBuffer(), null,
                     errDispatcher);
@@ -197,6 +196,12 @@ public abstract class Compiler {
             // Pass 2 - the whole translation unit
             pageNodes = parserCtl.parse(ctxt.getJspFile());
 
+            // Leave this until now since it can only be set once - bug 49726
+            if (pageInfo.getContentType() == null &&
+                    jspProperty.getDefaultContentType() != null) {
+                pageInfo.setContentType(jspProperty.getDefaultContentType());
+            }
+
             if (ctxt.isPrototypeMode()) {
                 // generate prototype .java file for the tag file
                 writer = setupContextWriter(javaFileName);

==================================================
