07304aa93289d9f7328444c6d2e241a9607b21f3
==================================================
Revert r1643371 pending clarification from the Servlet EG re section 6.2.3 and threading requirements.
==================================================
Mark Thomas
==================================================
Fri Dec 5 23:58:13 2014 +0000
==================================================
ApplicationDispatcher.java
Revert r1643371 pending clarification from the Servlet EG re section 6.2.3 and threading requirements.
Disable associated test.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1643474 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ApplicationFilterChain.java
index b9160b4d6b..d97e2fb538 100644
--- a/java/org/apache/catalina/core/ApplicationDispatcher.java
+++ b/java/org/apache/catalina/core/ApplicationDispatcher.java
@@ -757,6 +757,17 @@ final class ApplicationDispatcher implements AsyncDispatcher, RequestDispatcher
             runtimeException = e;
         }
 
+        // Release the filter chain (if any) for this request
+        try {
+            if (filterChain != null)
+                filterChain.release();
+        } catch (Throwable e) {
+            ExceptionUtils.handleThrowable(e);
+            wrapper.getLogger().error(sm.getString("standardWrapper.releaseFilters",
+                             wrapper.getName()), e);
+            // FIXME: Exception handling needs to be similar to what is in the StandardWrapperValue
+        }
+
         // Deallocate the allocated servlet instance
         try {
             if (servlet != null) {

==================================================
StandardWrapperValve.java
index 7836b1182d..e981cd0fbd 100644
--- a/java/org/apache/catalina/core/LocalStrings_ja.properties
+++ b/java/org/apache/catalina/core/LocalStrings_ja.properties
@@ -82,6 +82,7 @@ standardWrapper.notClass=\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8 {0} \u306b\u6307\u
 standardWrapper.notContext=\u30e9\u30c3\u30d1\u306e\u89aa\u306e\u30b3\u30f3\u30c6\u30ca\u306f\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3067\u306a\u3051\u308c\u3070\u3044\u3051\u307e\u305b\u3093
 standardWrapper.notFound=\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8 {0} \u304c\u5229\u7528\u3067\u304d\u307e\u305b\u3093
 standardWrapper.notServlet=\u30af\u30e9\u30b9 {0} \u306f\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8\u3067\u306f\u3042\u308a\u307e\u305b\u3093
+standardWrapper.releaseFilters=\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8 {0} \u306e\u30d5\u30a3\u30eb\u30bf\u4f8b\u5916\u3092\u89e3\u9664\u3057\u307e\u3059
 standardWrapper.serviceException=\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8 {0} \u306eServlet.service()\u304c\u4f8b\u5916\u3092\u6295\u3052\u307e\u3057\u305f
 standardWrapper.unavailable=\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8 {0} \u3092\u5229\u7528\u4e0d\u53ef\u80fd\u306b\u30de\u30fc\u30af\u3057\u307e\u3059
 standardWrapper.unloadException=\u30b5\u30fc\u30d6\u30ec\u30c3\u30c8 {0} \u304cunload()\u4f8b\u5916\u3092\u6295\u3052\u307e\u3057\u305f

==================================================
TestApplicationFilterChain.java
index 7c7dfcdb82..9e8b92fdfc 100644
--- a/java/org/apache/catalina/core/StandardWrapperValve.java
+++ b/java/org/apache/catalina/core/StandardWrapperValve.java
@@ -251,6 +251,11 @@ final class StandardWrapperValve
             exception(request, response, e);
         }
 
+        // Release the filter chain (if any) for this request
+        if (filterChain != null) {
+            filterChain.release();
+        }
+
         // Deallocate the allocated servlet instance
         try {
             if (servlet != null) {

==================================================
