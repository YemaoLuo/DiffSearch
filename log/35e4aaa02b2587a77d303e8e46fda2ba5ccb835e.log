35e4aaa02b2587a77d303e8e46fda2ba5ccb835e
==================================================
Fix SpotBugs warnings
==================================================
Mark Thomas
==================================================
Wed Nov 13 17:59:04 2019 +0000
==================================================
ContextConfig.java
Fix SpotBugs warnings


==================================================
Utils.java
index c35c3548bf..39fb25ddda 100644
--- a/java/org/apache/catalina/startup/ContextConfig.java
+++ b/java/org/apache/catalina/startup/ContextConfig.java
@@ -2692,7 +2692,7 @@ public class ContextConfig implements LifecycleListener {
         @Override
         public void lifecycleEvent(LifecycleEvent event) {
 
-            if (event.getType() == Lifecycle.AFTER_DESTROY_EVENT) {
+            if (Lifecycle.AFTER_DESTROY_EVENT.equals(event.getType())) {
                 Host host = (Host) event.getSource();
                 hostWebXmlCache.remove(host);
             }

==================================================
TestAsyncContextImpl.java
index 1c290b255b..7fcc6bd1d8 100644
--- a/res/findbugs/filter-false-positives.xml
+++ b/res/findbugs/filter-false-positives.xml
@@ -835,6 +835,18 @@
       <Bug pattern="NO_NOTIFY_NOT_NOTIFYALL" />
     </Or>
   </Match>
+  <Match>
+    <!-- Monitor is used for a single condition. -->
+    <Class name="org.apache.coyote.http2.WindowAllocationManager" />
+    <Method name="notify" />
+    <Bug pattern="NO_NOTIFY_NOT_NOTIFYALL" />
+  </Match>
+  <Match>
+    <!-- Monitor is used for a single condition. -->
+    <Class name="org.apache.coyote.http2.WindowAllocationManager" />
+    <Method name="waitFor" />
+    <Bug pattern="WA_NOT_IN_LOOP" />
+  </Match>
   <Match>
     <!-- Returning null is required by the EL specification -->
     <Class name="org.apache.el.lang.ELSupport" />
@@ -1388,6 +1400,13 @@
     <Method name="run"/>
     <Bug code="ML" />
   </Match>
+  <Match>
+    <!-- Sync is on closed to ensure that actions taken because the socket  -->
+    <!-- open remain valid until the action is completed.                   -->
+    <Class name="org.apache.tomcat.util.net.AprEndpoint$AprSocketWrapper"/>
+    <Field name="closed"/>
+    <Bug pattern="JLM_JSR166_UTILCONCURRENT_MONITORENTER"/>
+  </Match>
   <Match>
     <!-- Return value is ignored at this point but logic further up call     -->
     <!-- stack will ensure that a SocketTimeoutException is thrown           -->
@@ -1439,6 +1458,21 @@
     <Method name="processSNI"/>
     <Bug code="SF" />
   </Match>
+  <Match>
+  <!-- Single condition so fine -->
+    <Class name="org.apache.tomcat.util.net.SocketWrapperBase" />
+    <Method name="vectoredOperation"/>
+    <Bug pattern="WA_NOT_IN_LOOP" />
+  </Match>
+  <Match>
+  <!-- Single condition so notify is fine -->
+    <Class name="org.apache.tomcat.util.net.SocketWrapperBase$VectoredIOCompletionHandler" />
+    <Or>
+      <Method name="completed"/>
+      <Method name="failed"/>
+    </Or>
+    <Bug pattern="NO_NOTIFY_NOT_NOTIFYALL" />
+  </Match>
   <Match>
     <!-- Stream will be closed -->
     <Class name="org.apache.tomcat.util.net.jsse.PEMFile" />
@@ -1551,10 +1585,18 @@
     </Or>
     <Bug pattern="DLS_DEAD_LOCAL_STORE"/>
   </Match>
+  <Match>
+    <!-- Name is consistent in context -->
+     <Class name="javax.servlet.http.TestHttpServletResponseSendError$ErrorServletStaticException" />
+    <Bug pattern="NM_CLASS_NOT_EXCEPTION"/>
+  </Match>
   <Match>
     <!-- Code is intentionally unused -->
     <Class name="org.apache.catalina.authenticator.TestBasicAuthParser"/>
-    <Method name="testAuthMethodBadMethod"/>
+    <Or>
+      <Method name="testAuthMethodBadMethod"/>
+      <Method name="testBadBase64Char"/>
+    </Or>
     <Bug pattern="DLS_DEAD_LOCAL_STORE"/>
   </Match>
   <Match>
@@ -1604,12 +1646,24 @@
     <Field name="isAsyncWhenExpected"/>
     <Bug pattern="MSF_MUTABLE_SERVLET_FIELD"/>
   </Match>
+  <Match>
+    <!-- Deliberate hack for the purposes of the test -->
+    <Class name="org.apache.catalina.core.TestAsyncContextImpl$AsyncIoEndServlet"/>
+    <Field name="asyncIoEndWriteListener"/>
+    <Bug pattern="MSF_MUTABLE_SERVLET_FIELD"/>
+  </Match>
   <Match>
     <!-- Deliberate hack for the purposes of the test -->
     <Class name="org.apache.catalina.core.TestAsyncContextImpl$AsyncISEServlet"/>
     <Field name="asyncContext"/>
     <Bug pattern="MSF_MUTABLE_SERVLET_FIELD"/>
   </Match>
+  <Match>
+    <!-- Deliberate use of run() for the purposes of the test -->
+    <Class name="org.apache.catalina.core.TestAsyncContextStateChanges$AsyncServlet"/>
+    <Method name="doGet"/>
+    <Bug pattern="RU_INVOKE_RUN"/>
+  </Match>
   <Match>
     <!-- Hard-coded absolute path is intentional -->
     <Class name="org.apache.catalina.core.TestStandardContext"/>
@@ -1687,6 +1741,12 @@
     <Field name="used"/>
     <Bug pattern="ST_WRITE_TO_STATIC_FROM_INSTANCE_METHOD"/>
   </Match>
+  <Match>
+    <!-- Test code - array is safe -->
+    <Class name="org.apache.catalina.startup.TomcatBaseTest"/>
+    <Field name="booleans"/>
+    <Bug pattern="MS_MUTABLE_ARRAY"/>
+  </Match>
   <Match>
     <Class name="org.apache.catalina.tribes.demos.EchoRpcTest" />
     <Method name="run"/>

==================================================
