102e4cd26c9eeb116617d1b6c6821b37a028ece8
==================================================
Remove singleThreaded support - align with JSP 4.0
==================================================
Mark Thomas
==================================================
Wed Oct 19 12:05:05 2022 +0100
==================================================
Generator.java
Remove singleThreaded support - align with JSP 4.0



==================================================
PageInfo.java
index af6f9fc1af..158cfb5f1e 100644
--- a/java/org/apache/jasper/compiler/Generator.java
+++ b/java/org/apache/jasper/compiler/Generator.java
@@ -52,8 +52,6 @@ import org.apache.jasper.TrimSpacesOption;
 import org.apache.jasper.compiler.Node.ChildInfoBase;
 import org.apache.jasper.compiler.Node.NamedAttribute;
 import org.apache.jasper.runtime.JspRuntimeLibrary;
-import org.apache.juli.logging.Log;
-import org.apache.juli.logging.LogFactory;
 import org.xml.sax.Attributes;
 
 /**
@@ -79,8 +77,6 @@ import org.xml.sax.Attributes;
 
 class Generator {
 
-    private final Log log = LogFactory.getLog(Generator.class); // must not be static
-
     private static final Class<?>[] OBJECT_CLASS = { Object.class };
 
     private static final Pattern PRE_TAG_PATTERN = Pattern.compile("(?s).*(<pre>|</pre>).*");
@@ -757,14 +753,7 @@ class Generator {
         genPreambleMethods();
 
         // Now the service method
-        if (pageInfo.isThreadSafe()) {
-            out.printin("public void ");
-        } else {
-            // This is unlikely to perform well.
-            out.printin("public synchronized void ");
-            // As required by JSP 3.1, log a warning
-            log.warn(Localizer.getMessage("jsp.warning.isThreadSafe", ctxt.getJspFile()));
-        }
+        out.printin("public void ");
         out.print(serviceMethodName);
         out.println("(final jakarta.servlet.http.HttpServletRequest request, final jakarta.servlet.http.HttpServletResponse response)");
         out.pushIndent();

==================================================
Validator.java
index b0c5832ae1..2d24d98427 100644
--- a/java/org/apache/jasper/compiler/PageInfo.java
+++ b/java/org/apache/jasper/compiler/PageInfo.java
@@ -62,8 +62,6 @@ class PageInfo {
     private int buffer = 8*1024;
     private String autoFlush;
     private boolean isAutoFlush = true;
-    private String isThreadSafeValue;
-    private boolean isThreadSafe = true;
     private String isErrorPageValue;
     private boolean isErrorPage = false;
     private String errorPage = null;
@@ -543,32 +541,6 @@ class PageInfo {
     }
 
 
-    /*
-     * isThreadSafe
-     */
-    public void setIsThreadSafe(String value, Node n, ErrorDispatcher err)
-        throws JasperException {
-
-        if ("true".equalsIgnoreCase(value)) {
-            isThreadSafe = true;
-        } else if ("false".equalsIgnoreCase(value)) {
-            isThreadSafe = false;
-        } else {
-            err.jspError(n, "jsp.error.page.invalid.isthreadsafe");
-        }
-
-        isThreadSafeValue = value;
-    }
-
-    public String getIsThreadSafe() {
-        return isThreadSafeValue;
-    }
-
-    public boolean isThreadSafe() {
-        return isThreadSafe;
-    }
-
-
     /*
      * info
      */

==================================================
TestGenerator.java
index 3afd804d30..ab341603ce 100644
--- a/java/org/apache/jasper/resources/LocalStrings_zh_CN.properties
+++ b/java/org/apache/jasper/resources/LocalStrings_zh_CN.properties
@@ -149,7 +149,6 @@ jsp.error.page.conflict.extends=页面指令：“ extends”非法多次出现
 jsp.error.page.conflict.info=页面指令：“ info”非法多次出现不同值（旧值: [{0}], 新值: [{1}]）
 jsp.error.page.conflict.iselignored=页面指令：“ isELIgnored”非法多次出现不同值（旧值: [{0}], 新值: [{1}]）
 jsp.error.page.conflict.iserrorpage=页面指令：“ isErrorPage”非法多次出现不同值（旧值: [{0}], 新值: [{1}]）
-jsp.error.page.conflict.isthreadsafe=页面指令：“ isThreadSafe”非法多次出现不同值（旧值: [{0}], 新值: [{1}]）
 jsp.error.page.conflict.language=页面指令：“ language” 非法多次出现不同值（ 旧值：[{0}]，新值：[{1}] ）
 jsp.error.page.conflict.session=页面指令：“session” 非法多次出现不同值（ 旧值：[{0}]，新值：[{1}] ）
 jsp.error.page.conflict.trimdirectivewhitespaces=页面指令：违法出现多个有不同的值（旧值：[{0}]，新值：[{1}]）的''trimDirectiveWhitespaces''
@@ -159,7 +158,6 @@ jsp.error.page.invalid.errorOnELNotFound=页面指​​令：errorOnELNotFound
 jsp.error.page.invalid.import=页面指令：import 值无效
 jsp.error.page.invalid.iselignored=页面指令：isELIgnored 值无效
 jsp.error.page.invalid.iserrorpage=页面指令：isErrorPage 值无效
-jsp.error.page.invalid.isthreadsafe=页面指令：isThreadSafe 值无效
 jsp.error.page.invalid.scope=无效的作用域
 jsp.error.page.invalid.session=页面指令：session 值无效
 jsp.error.page.invalid.trimdirectivewhitespaces=页面指令：trimDirectiveWhitespaces 值无效
@@ -289,7 +287,6 @@ jsp.warning.enablePooling=警告：initParam enablePooling的值无效。将使
 jsp.warning.engineOptionsClass=未能加载引擎选项类[{0}]
 jsp.warning.fork=警告：initParam的值无效。将使用“true”的默认值
 jsp.warning.genchararray=警告：initParam genstringascharray的值无效。将使用默认值“false”
-jsp.warning.isThreadSafe=警告：在[{0}] 中使用的“isThreadSafe”页面指令属性已被弃用，并将在 JSP 规范的 4.0 版中删除\n
 jsp.warning.jspIdleTimeout=警告：initParam jspIdleTimeout的值无效。将使用默认值“-1”
 jsp.warning.keepgen=警告：initParam keepgenerated的值无效。将使用默认值“false”
 jsp.warning.loadSmap=无法加载类[{0}]的SMAP数据

==================================================
