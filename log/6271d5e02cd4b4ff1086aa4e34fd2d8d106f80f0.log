6271d5e02cd4b4ff1086aa4e34fd2d8d106f80f0
==================================================
Porting large-file support for the AJP Connectors from 5.5
==================================================
William Barker
==================================================
Thu Jun 14 02:55:26 2007 +0000
==================================================
AjpAprProcessor.java
Porting large-file support for the AJP Connectors from 5.5

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@547096 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AjpProcessor.java
index 786b32943c..72c9d78a15 100644
--- a/java/org/apache/coyote/ajp/AjpAprProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpAprProcessor.java
@@ -680,7 +680,9 @@ public class AjpAprProcessor implements ActionHook {
             if (hId == Constants.SC_REQ_CONTENT_LENGTH ||
                     (hId == -1 && tmpMB.equalsIgnoreCase("Content-Length"))) {
                 // just read the content-length header, so set it
-                request.setContentLength( vMB.getInt() );
+                long cl = vMB.getLong();
+                if(cl < Integer.MAX_VALUE)
+                    request.setContentLength( (int)cl );
             } else if (hId == Constants.SC_REQ_CONTENT_TYPE ||
                     (hId == -1 && tmpMB.equalsIgnoreCase("Content-Type"))) {
                 // just read the content-type header, so set it
@@ -1204,7 +1206,7 @@ public class AjpAprProcessor implements ActionHook {
             if (endOfStream) {
                 return -1;
             }
-            if (first && req.getContentLength() > 0) {
+            if (first && req.getContentLengthLong() > 0) {
                 // Handle special first-body-chunk
                 if (!receive()) {
                     return 0;

==================================================
HandlerRequest.java
index 5f4a3a3f02..7f7e853308 100644
--- a/java/org/apache/coyote/ajp/AjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpProcessor.java
@@ -688,7 +688,9 @@ public class AjpProcessor implements ActionHook {
             if (hId == Constants.SC_REQ_CONTENT_LENGTH ||
                     (hId == -1 && tmpMB.equalsIgnoreCase("Content-Length"))) {
                 // just read the content-length header, so set it
-                request.setContentLength( vMB.getInt() );
+                long cl = vMB.getLong();
+                if(cl < Integer.MAX_VALUE)
+                    request.setContentLength( (int)cl );
             } else if (hId == Constants.SC_REQ_CONTENT_TYPE ||
                     (hId == -1 && tmpMB.equalsIgnoreCase("Content-Type"))) {
                 // just read the content-type header, so set it
@@ -1144,7 +1146,7 @@ public class AjpProcessor implements ActionHook {
             if (endOfStream) {
                 return -1;
             }
-            if (first && req.getContentLength() > 0) {
+            if (first && req.getContentLengthLong() > 0) {
                 // Handle special first-body-chunk
                 if (!receive()) {
                     return 0;

==================================================
