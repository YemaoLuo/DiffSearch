af131dbd7bc445979dc039c5dfb3ac505e3bb2dc
==================================================
Align ActionCode.REQ_SET_BODY_REPLAY
==================================================
Mark Thomas
==================================================
Fri Aug 12 07:46:06 2016 +0000
==================================================
AjpProcessor.java
Align ActionCode.REQ_SET_BODY_REPLAY

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1756088 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11Processor.java
index 9be1e9a363..e80ee97c4d 100644
--- a/java/org/apache/coyote/ajp/AjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpProcessor.java
@@ -396,15 +396,8 @@ public class AjpProcessor extends AbstractProcessor {
             break;
         }
         case REQ_SET_BODY_REPLAY: {
-            // Set the given bytes as the content
-            ByteChunk bc = (ByteChunk) param;
-            int length = bc.getLength();
-            bodyBytes.setBytes(bc.getBytes(), bc.getStart(), length);
-            request.setContentLength(length);
-            first = false;
-            empty = false;
-            replay = true;
-            endOfStream = false;
+            ByteChunk body = (ByteChunk) param;
+            setRequestBody(body);
             break;
         }
         case RESET: {
@@ -1468,6 +1461,17 @@ public class AjpProcessor extends AbstractProcessor {
     }
 
 
+    private void setRequestBody(ByteChunk body) {
+        int length = body.getLength();
+        bodyBytes.setBytes(body.getBytes(), body.getStart(), length);
+        request.setContentLength(length);
+        first = false;
+        empty = false;
+        replay = true;
+        endOfStream = false;
+    }
+    
+    
     /**
      * Read at least the specified amount of bytes, and place them
      * in the input buffer. Note that if any data is available to read then this

==================================================
StreamProcessor.java
index 4439578170..36f7cf0384 100644
--- a/java/org/apache/coyote/http11/Http11Processor.java
+++ b/java/org/apache/coyote/http11/Http11Processor.java
@@ -690,12 +690,7 @@ public class Http11Processor extends AbstractProcessor {
         }
         case REQ_SET_BODY_REPLAY: {
             ByteChunk body = (ByteChunk) param;
-
-            InputFilter savedBody = new SavedRequestInputFilter(body);
-            savedBody.setRequest(request);
-
-            Http11InputBuffer internalBuffer = (Http11InputBuffer) request.getInputBuffer();
-            internalBuffer.addActiveFilter(savedBody);
+            setRequestBody(body);
             break;
         }
         case RESET: {
@@ -1817,6 +1812,15 @@ public class Http11Processor extends AbstractProcessor {
     }
     
     
+    private void setRequestBody(ByteChunk body) {
+        InputFilter savedBody = new SavedRequestInputFilter(body);
+        savedBody.setRequest(request);
+    
+        Http11InputBuffer internalBuffer = (Http11InputBuffer) request.getInputBuffer();
+        internalBuffer.addActiveFilter(savedBody);
+    }
+    
+    
     /**
      * Checks to see if the keep-alive loop should be broken, performing any
      * processing (e.g. sendfile handling) that may have an impact on whether

==================================================
