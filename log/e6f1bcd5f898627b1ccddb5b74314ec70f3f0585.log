e6f1bcd5f898627b1ccddb5b74314ec70f3f0585
==================================================
Partial fix for https://bz.apache.org/bugzilla/show_bug.cgi?id=59219
==================================================
Mark Thomas
==================================================
Mon Apr 18 19:58:18 2016 +0000
==================================================
ErrorReportValve.java
Partial fix for https://bz.apache.org/bugzilla/show_bug.cgi?id=59219
If an exception is throw in the service() method after startAsync() is called, trigger the Async error handling process

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1739814 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AsyncStateMachine.java
index 359eed9e2a..47af60a52a 100644
--- a/java/org/apache/catalina/valves/ErrorReportValve.java
+++ b/java/org/apache/catalina/valves/ErrorReportValve.java
@@ -98,9 +98,13 @@ public class ErrorReportValve extends ValveBase {
         Throwable throwable = (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);
 
         // If an async request is in progress and is not going to end once this
-        // container thread finishes, do not trigger error page handling - it
-        // will be triggered later if required.
+        // container thread finishes, do not process the error page here but
+        // trigger an error dispatch so the additional async processing such as
+        // firing onError() occurs.
         if (request.isAsync() && !request.isAsyncCompleting()) {
+            if (throwable != null) {
+                request.getAsyncContextInternal().setErrorState(throwable, true);
+            }
             return;
         }
 

==================================================
