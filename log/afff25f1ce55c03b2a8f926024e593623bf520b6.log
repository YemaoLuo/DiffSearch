afff25f1ce55c03b2a8f926024e593623bf520b6
==================================================
Fix various data races reported by RV-Predict.
==================================================
Mark Thomas
==================================================
Fri Sep 18 14:12:41 2015 +0000
==================================================
WsFrameBase.java
Fix various data races reported by RV-Predict.
Mostly caused by completion handlers that execute in a new thread

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1703865 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsFrameClient.java
index e521bd6756..c5515bfc27 100644
--- a/java/org/apache/tomcat/websocket/WsFrameBase.java
+++ b/java/org/apache/tomcat/websocket/WsFrameBase.java
@@ -78,13 +78,13 @@ public abstract class WsFrameBase {
     private final byte[] mask = new byte[4];
     private int maskIndex = 0;
     private long payloadLength = 0;
-    private long payloadWritten = 0;
+    private volatile long payloadWritten = 0;
 
     // Attributes tracking state
-    private State state = State.NEW_FRAME;
+    private volatile State state = State.NEW_FRAME;
     private volatile boolean open = true;
-    private int readPos = 0;
-    protected int writePos = 0;
+    private volatile int readPos = 0;
+    protected volatile int writePos = 0;
 
     public WsFrameBase(WsSession wsSession, Transformation transformation) {
         inputBuffer = new byte[Constants.DEFAULT_BUFFER_SIZE];

==================================================
WsSession.java
index 3fdbd06d7f..d01dc8e4a0 100644
--- a/java/org/apache/tomcat/websocket/WsFrameClient.java
+++ b/java/org/apache/tomcat/websocket/WsFrameClient.java
@@ -37,7 +37,7 @@ public class WsFrameClient extends WsFrameBase {
     private final AsyncChannelWrapper channel;
     private final CompletionHandler<Integer,Void> handler;
     // Not final as it may need to be re-sized
-    private ByteBuffer response;
+    private volatile ByteBuffer response;
 
     public WsFrameClient(ByteBuffer response, AsyncChannelWrapper channel,
             WsSession wsSession, Transformation transformation) {

==================================================
