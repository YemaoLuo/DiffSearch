14129352e6201ea1e1c5c4d22261d1326f34b590
==================================================
https://issues.apache.org/bugzilla/show_bug.cgi?id=53367
==================================================
Filip Hanik
==================================================
Wed Jun 6 01:02:41 2012 +0000
==================================================
ConnectionPool.java
https://issues.apache.org/bugzilla/show_bug.cgi?id=53367
Avoid pool hanging when database fails



git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1346691 13f79535-47bb-0310-9956-ffa450edef68



==================================================
PooledConnection.java
index e9524edbf8..c0d0c79730 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
@@ -750,7 +750,19 @@ public class ConnectionPool {
 
             if (!con.isDiscarded() && !con.isInitialized()) {
                 //attempt to connect
-                con.connect();
+                try {
+                    con.connect();
+                } catch (Exception x) {
+                    release(con);
+                    setToNull = true;
+                    if (x instanceof SQLException) {
+                        throw (SQLException)x;
+                    } else {
+                        SQLException ex  = new SQLException(x.getMessage());
+                        ex.initCause(x);
+                        throw ex;
+                    }
+                }
             }
 
             if (usercheck) {

==================================================
