459cbf6bd96a0488f205f090efba34520186066e
==================================================
Add available flag for UserDatabase
==================================================
remm remm@apache.org
==================================================
Wed Aug 25 22:36:17 2021 +0200
==================================================
UserDatabase.java
Add available flag for UserDatabase

Also avoid loading the whole database as MBeans, the behavior is fancy
but only makes sense for a memory user database.


==================================================
GlobalResourcesLifecycleListener.java
index 9242170929..713cc1d324 100644
--- a/java/org/apache/catalina/UserDatabase.java
+++ b/java/org/apache/catalina/UserDatabase.java
@@ -198,4 +198,26 @@ public interface UserDatabase {
     public default void backgroundProcess() {
         // NO-OP by default
     }
+
+
+    /**
+     * Is the database available.
+     *
+     * @return true
+     */
+    public default boolean isAvailable() {
+        return true;
+    }
+
+
+    /**
+     * Is the database data loaded on demand. This is used to avoid eager
+     * loading of the full database data, for example for JMX registration of
+     * all objects.
+     *
+     * @return false
+     */
+    public default boolean isSparse() {
+        return false;
+    }
 }

==================================================
UserDatabaseRealm.java
index a86b486a01..bca1ed7b21 100644
--- a/java/org/apache/catalina/mbeans/GlobalResourcesLifecycleListener.java
+++ b/java/org/apache/catalina/mbeans/GlobalResourcesLifecycleListener.java
@@ -168,6 +168,11 @@ public class GlobalResourcesLifecycleListener implements LifecycleListener {
             throw new IllegalArgumentException(sm.getString("globalResources.createError.userDatabase", name), e);
         }
 
+        if (database.isSparse()) {
+            // Avoid loading all the database as mbeans
+            return;
+        }
+
         // Create the MBeans for each defined Role
         Iterator<Role> roles = database.getRoles();
         while (roles.hasNext()) {

==================================================
