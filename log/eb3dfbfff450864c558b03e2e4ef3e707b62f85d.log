eb3dfbfff450864c558b03e2e4ef3e707b62f85d
==================================================
Avoid possible NPE
==================================================
remm remm@apache.org
==================================================
Tue Feb 9 13:19:11 2021 +0100
==================================================
SecureNio2Channel.java
Avoid possible NPE

Very early unexpected exceptions could lead to a null sslEngine, nothing
to do in that case on close. Seen in BZ65131.


==================================================
SecureNioChannel.java
index 611038ebbb..b2d94d1126 100644
--- a/java/org/apache/tomcat/util/net/SecureNio2Channel.java
+++ b/java/org/apache/tomcat/util/net/SecureNio2Channel.java
@@ -596,8 +596,15 @@ public class SecureNio2Channel extends Nio2Channel  {
      */
     @Override
     public void close() throws IOException {
-        if (closing) return;
+        if (closing) {
+            return;
+        }
         closing = true;
+        if (sslEngine == null) {
+            netOutBuffer.clear();
+            closed = true;
+            return;
+        }
         sslEngine.closeOutbound();
         long timeout = endpoint.getConnectionTimeout();
 

==================================================
