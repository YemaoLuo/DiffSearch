979262dbf6e3cf79550df09d752bbe8e34bdbd2b
==================================================
Additional debug logging
==================================================
Mark Thomas
==================================================
Fri Aug 17 08:56:50 2018 +0000
==================================================
AbstractProcessorLight.java
Additional debug logging

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1838243 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http2UpgradeHandler.java
index a6acd1f3d1..340c986f6e 100644
--- a/java/org/apache/coyote/AbstractProcessorLight.java
+++ b/java/org/apache/coyote/AbstractProcessorLight.java
@@ -70,16 +70,20 @@ public abstract class AbstractProcessorLight implements Processor {
                 state = SocketState.CLOSED;
             }
 
-            if (state != SocketState.CLOSED && isAsync()) {
-                state = asyncPostProcess();
-            }
-
             if (getLog().isDebugEnabled()) {
                 getLog().debug("Socket: [" + socketWrapper +
                         "], Status in: [" + status +
                         "], State out: [" + state + "]");
             }
 
+            if (state != SocketState.CLOSED && isAsync()) {
+                state = asyncPostProcess();
+                if (getLog().isDebugEnabled()) {
+                    getLog().debug("Socket: [" + socketWrapper +
+                            "], State after async post processing: [" + state + "]");
+                }
+            }
+
             if (dispatches == null || !dispatches.hasNext()) {
                 // Only returns non-null iterator if there are
                 // dispatches to process.

==================================================
StreamProcessor.java
index db3e6926cd..bb57b2b3e8 100644
--- a/java/org/apache/coyote/http2/LocalStrings.properties
+++ b/java/org/apache/coyote/http2/LocalStrings.properties
@@ -104,6 +104,7 @@ stream.outputBuffer.flush.debug=Connection [{0}], Stream [{1}], flushing output
 
 streamProcessor.error.connection=Connection [{0}], Stream [{1}], An error occurred during processing that was fatal to the connection
 streamProcessor.error.stream=Connection [{0}], Stream [{1}], An error occurred during processing that was fatal to the stream
+streamProcessor.flushBufferedWrite.entry=Connection [{0}], Stream [{1}], Flushing buffered writes
 streamProcessor.service.error=Error during request processing
 
 streamStateMachine.debug.change=Connection [{0}], Stream [{1}], State changed from [{2}] to [{3}]
@@ -115,12 +116,14 @@ upgradeHandler.allocate.left=Connection [{0}], Stream [{1}], [{2}] bytes unalloc
 upgradeHandler.allocate.recipient=Connection [{0}], Stream [{1}], potential recipient [{2}] with weight [{3}]
 upgradeHandler.connectionError=Connection error
 upgradeHandler.dependency.invalid=Connection [{0}], Stream [{1}], Streams may not depend on themselves
+upgradeHandler.dispatchWrite=Connection [{0}], Stream [{1}], Dispatching to container thread for async write
 upgradeHandler.goaway.debug=Connection [{0}], Goaway, Last stream [{1}], Error code [{2}], Debug data [{3}]
 upgradeHandler.init=Connection [{0}], State [{1}]
 upgradeHandler.initialWindowSize.invalid=Connection [{0}], Illegal value of [{1}] ignored for initial window size
 upgradeHandler.invalidPreface=Connection [{0}], Invalid connection preface
 upgradeHandler.ioerror=Connection [{0}]
 upgradeHandler.noNewStreams=Connection [{0}], Stream [{1}], Stream ignored as no new streams are permitted on this connection
+upgradeHandler.notifyAll=Connection [{0}], Stream [{1}], notifyAll() called to release StreamOutputBuffer
 upgradeHandler.pause.entry=Connection [{0}] Pausing
 upgradeHandler.prefaceReceived=Connection [{0}], Connection preface received from client
 upgradeHandler.pingFailed=Connection [{0}] Failed to send ping to client

==================================================
