d4151abe024b0741b680b92f33f48ea9fdc2c5d3
==================================================
Add an undocumented option for use when running test suites that disables server initiated ping frames since some test suites don't expect them .
==================================================
Mark Thomas
==================================================
Fri Mar 24 22:47:41 2017 +0000
==================================================
Http2AsyncUpgradeHandler.java
Add an undocumented option for use when running test suites that disables server initiated ping frames since some test suites don't expect them .

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1788554 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http2Protocol.java
index 5724fbf47c..95658d4a3d 100644
--- a/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2AsyncUpgradeHandler.java
@@ -308,6 +308,9 @@ public class Http2AsyncUpgradeHandler extends Http2UpgradeHandler {
     protected class AsyncPingManager extends PingManager {
         @Override
         public void sendPing(boolean force) throws IOException {
+            if (initiateDisabled) {
+                return;
+            }
             long now = System.nanoTime();
             if (force || now - lastPingNanoTime > pingIntervalNano) {
                 lastPingNanoTime = now;

==================================================
Http2UpgradeHandler.java
index eca0ce071d..c9a9cbd92c 100644
--- a/java/org/apache/coyote/http2/Http2Protocol.java
+++ b/java/org/apache/coyote/http2/Http2Protocol.java
@@ -69,7 +69,7 @@ public class Http2Protocol implements UpgradeProtocol {
     private int maxHeaderSize = Constants.DEFAULT_MAX_HEADER_SIZE;
     private int maxTrailerCount = Constants.DEFAULT_MAX_TRAILER_COUNT;
     private int maxTrailerSize = Constants.DEFAULT_MAX_TRAILER_SIZE;
-
+    private boolean initiatePingDisabled = false;
 
     @Override
     public String getHttpUpgradeName(boolean isSSLEnabled) {
@@ -116,6 +116,7 @@ public class Http2Protocol implements UpgradeProtocol {
         result.setMaxHeaderSize(getMaxHeaderSize());
         result.setMaxTrailerCount(getMaxTrailerCount());
         result.setMaxTrailerSize(getMaxTrailerSize());
+        result.setInitiatePingDisabled(initiatePingDisabled);
         return result;
     }
 
@@ -269,4 +270,9 @@ public class Http2Protocol implements UpgradeProtocol {
     public int getMaxTrailerSize() {
         return maxTrailerSize;
     }
+
+
+    public void setInitiatePingDisabled(boolean initiatePingDisabled) {
+        this.initiatePingDisabled = initiatePingDisabled;
+    }
 }

==================================================
