400745e03208eeb8ccad37ccc52d43efbe8ed9d4
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51509
==================================================
Mark Emlyn
==================================================
Tue Jul 19 18:20:23 2011 +0000
==================================================
CsrfPreventionFilter.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=51509
Fix potential concurrency issue in CSRF prevention filter that may lead to some requests failing that should not.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1148471 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestCsrfPreventionFilter2.java
index 0189632561..0ef0b84f39 100644
--- a/java/org/apache/catalina/filters/CsrfPreventionFilter.java
+++ b/java/org/apache/catalina/filters/CsrfPreventionFilter.java
@@ -310,11 +310,15 @@ public class CsrfPreventionFilter extends FilterBase {
         }
         
         public void add(T key) {
-            cache.put(key, null);
+            synchronized (cache) {
+                cache.put(key, null);
+            }
         }
-        
+
         public boolean contains(T key) {
-            return cache.containsKey(key);
+            synchronized (cache) {
+                return cache.containsKey(key);
+            }
         }
     }
 }

==================================================
