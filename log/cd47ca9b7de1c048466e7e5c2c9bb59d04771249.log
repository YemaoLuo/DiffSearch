cd47ca9b7de1c048466e7e5c2c9bb59d04771249
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63964 Cached URLs
==================================================
Mark Thomas
==================================================
Tue Nov 26 18:49:07 2019 +0000
==================================================
CachedResource.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63964 Cached URLs

Correct a regression in the static resource caching changes introduced
to fix an issue with Jasper not showing updated JSOP files. URLs
constructed from URLs obtained from the cache could not be used to
access resources.


==================================================
TestCachedResource.java
index b1caf07d2b..6b3e615b21 100644
--- a/java/org/apache/catalina/webresources/CachedResource.java
+++ b/java/org/apache/catalina/webresources/CachedResource.java
@@ -423,7 +423,17 @@ public class CachedResource implements WebResource {
 
         @Override
         protected URLConnection openConnection(URL u) throws IOException {
-            return new CachedResourceURLConnection(resourceURL, root, webAppPath, usesClassLoaderResources);
+            // This deliberately uses ==. If u isn't the URL object this
+            // URLStreamHandler was constructed for we do not want to use this
+            // URLStreamHandler to create a connection.
+            if (u == resourceURL) {
+                return new CachedResourceURLConnection(resourceURL, root, webAppPath, usesClassLoaderResources);
+            } else {
+                // The stream handler has been inherited by a URL that was
+                // constructed from a cache URL. We need to break that link.
+                URL constructedURL = new URL(u.toExternalForm());
+                return constructedURL.openConnection();
+            }
         }
     }
 

==================================================
