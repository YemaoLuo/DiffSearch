044987365a41167083d2c9d3b73a43ebfa2567b9
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63608 -ve pattern
==================================================
Mark Thomas
==================================================
Mon Jul 29 15:38:05 2019 +0100
==================================================
RewriteRule.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63608 -ve pattern

Align the implementation of the negative match feature for patterns used
with the RewriteValve with the description in the documentation.


==================================================
TestRewriteValve.java
index 0bee31f380..450877db73 100644
--- a/java/org/apache/catalina/valves/rewrite/RewriteRule.java
+++ b/java/org/apache/catalina/valves/rewrite/RewriteRule.java
@@ -32,6 +32,7 @@ public class RewriteRule {
     protected String patternString = null;
     protected String substitutionString = null;
     protected String flagsString = null;
+    protected boolean positive = true;
 
     public void parse(Map<String, RewriteMap> maps) {
         // Parse the substitution
@@ -42,6 +43,10 @@ public class RewriteRule {
             substitution.setEscapeBackReferences(isEscapeBackReferences());
         }
         // Parse the pattern
+        if (patternString.startsWith("!")) {
+            positive = false;
+            patternString = patternString.substring(1);
+        }
         int flags = 0;
         if (isNocase()) {
             flags |= Pattern.CASE_INSENSITIVE;
@@ -92,7 +97,8 @@ public class RewriteRule {
             this.pattern.set(pattern);
         }
         Matcher matcher = pattern.matcher(url);
-        if (!matcher.matches()) {
+        // Use XOR
+        if (positive ^ matcher.matches()) {
             // Evaluation done
             return null;
         }

==================================================
