842e4e8226bd044940f9f78e997454515b023d88
==================================================
Revert r1667314. I discovered I need this for the fix for BZ 57708
==================================================
Mark Thomas
==================================================
Wed Mar 18 11:05:29 2015 +0000
==================================================
AuthenticatorBase.java
Revert r1667314. I discovered I need this for the fix for BZ 57708

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1667496 13f79535-47bb-0310-9956-ffa450edef68



==================================================
BasicAuthenticator.java
index eb50c4abc4..a92abee21f 100644
--- a/java/org/apache/catalina/authenticator/AuthenticatorBase.java
+++ b/java/org/apache/catalina/authenticator/AuthenticatorBase.java
@@ -783,20 +783,22 @@ public abstract class AuthenticatorBase extends ValveBase implements Authenticat
      * @param request The servlet request we are processing
      * @param response The servlet response we are generating
      * @param principal The authenticated Principal to be registered
+     * @param authType The authentication type to be registered
      * @param username Username used to authenticate (if any)
      * @param password Password used to authenticate (if any)
      */
-    public void register(Request request, HttpServletResponse response, Principal principal,
+    public void register(Request request, HttpServletResponse response,
+                            Principal principal, String authType,
                             String username, String password) {
 
         if (log.isDebugEnabled()) {
             String name = (principal == null) ? "none" : principal.getName();
-            log.debug("Authenticated '" + name + "' with type '" + getAuthMethod() +
+            log.debug("Authenticated '" + name + "' with type '" + authType +
                     "'");
         }
 
         // Cache the authentication information in our request
-        request.setAuthType(getAuthMethod());
+        request.setAuthType(authType);
         request.setUserPrincipal(principal);
 
         Session session = request.getSessionInternal(false);
@@ -822,7 +824,7 @@ public abstract class AuthenticatorBase extends ValveBase implements Authenticat
         // Cache the authentication information in our session, if any
         if (cache) {
             if (session != null) {
-                session.setAuthType(getAuthMethod());
+                session.setAuthType(authType);
                 session.setPrincipal(principal);
                 if (username != null) {
                     session.setNote(Constants.SESS_USERNAME_NOTE, username);
@@ -871,7 +873,7 @@ public abstract class AuthenticatorBase extends ValveBase implements Authenticat
             response.addCookie(cookie);
 
             // Register this principal with our SSO valve
-            sso.register(ssoId, principal, getAuthMethod(), username, password);
+            sso.register(ssoId, principal, authType, username, password);
             request.setNote(Constants.REQ_SSOID_NOTE, ssoId);
 
         } else {
@@ -882,7 +884,7 @@ public abstract class AuthenticatorBase extends ValveBase implements Authenticat
                 return;
             } else {
                 // Update the SSO session with the latest authentication data
-                sso.update(ssoId, principal, getAuthMethod(), username, password);
+                sso.update(ssoId, principal, authType, username, password);
             }
         }
 
@@ -903,7 +905,8 @@ public abstract class AuthenticatorBase extends ValveBase implements Authenticat
     public void login(String username, String password, Request request)
             throws ServletException {
         Principal principal = doLogin(request, username, password);
-        register(request, request.getResponse(), principal, username, password);
+        register(request, request.getResponse(), principal,
+                    getAuthMethod(), username, password);
     }
 
     protected abstract String getAuthMethod();
@@ -928,7 +931,9 @@ public abstract class AuthenticatorBase extends ValveBase implements Authenticat
 
     @Override
     public void logout(Request request) {
-        register(request, request.getResponse(), null, null, null);
+        register(request, request.getResponse(), null,
+                null, null, null);
+
     }
 
     /**

==================================================
DigestAuthenticator.java
index 3ba55b089a..a8100ccb98 100644
--- a/java/org/apache/catalina/authenticator/BasicAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/BasicAuthenticator.java
@@ -83,8 +83,9 @@ public class BasicAuthenticator extends AuthenticatorBase {
 
                 Principal principal = context.getRealm().authenticate(username, password);
                 if (principal != null) {
-                    register(request, response, principal, username, password);
-                    return true;
+                    register(request, response, principal,
+                        HttpServletRequest.BASIC_AUTH, username, password);
+                    return (true);
                 }
             }
             catch (IllegalArgumentException iae) {
@@ -101,7 +102,7 @@ public class BasicAuthenticator extends AuthenticatorBase {
         value.append('\"');
         response.setHeader(AUTH_HEADER_NAME, value.toString());
         response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
-        return false;
+        return (false);
 
     }
 

==================================================
FormAuthenticator.java
index b43729f37a..1b62024233 100644
--- a/java/org/apache/catalina/authenticator/DigestAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/DigestAuthenticator.java
@@ -221,7 +221,9 @@ public class DigestAuthenticator extends AuthenticatorBase {
                 }
 
                 if (principal != null && !digestInfo.isNonceStale()) {
-                    register(request, response, principal, digestInfo.getUsername(), null);
+                    register(request, response, principal,
+                            HttpServletRequest.DIGEST_AUTH,
+                            digestInfo.getUsername(), null);
                     return true;
                 }
             }

==================================================
SSLAuthenticator.java
index 482c733559..9bfac7eae4 100644
--- a/java/org/apache/catalina/authenticator/FormAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/FormAuthenticator.java
@@ -161,7 +161,9 @@ public class FormAuthenticator
                 if (principal != null) {
                     session.setNote(Constants.FORM_PRINCIPAL_NOTE, principal);
                     if (!matchRequest(request)) {
-                        register(request, response, principal, username, password);
+                        register(request, response, principal,
+                                HttpServletRequest.FORM_AUTH,
+                                username, password);
                         return true;
                     }
                 }
@@ -182,7 +184,7 @@ public class FormAuthenticator
             }
             principal = (Principal)
                 session.getNote(Constants.FORM_PRINCIPAL_NOTE);
-            register(request, response, principal,
+            register(request, response, principal, HttpServletRequest.FORM_AUTH,
                      (String) session.getNote(Constants.SESS_USERNAME_NOTE),
                      (String) session.getNote(Constants.SESS_PASSWORD_NOTE));
             // If we're caching principals we no longer need the username

==================================================
SpnegoAuthenticator.java
index 5e1514fe84..2d184bbb8f 100644
--- a/java/org/apache/catalina/authenticator/SSLAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/SSLAuthenticator.java
@@ -85,12 +85,13 @@ public class SSLAuthenticator extends AuthenticatorBase {
             }
             response.sendError(HttpServletResponse.SC_UNAUTHORIZED,
                                sm.getString("authenticator.unauthorized"));
-            return false;
+            return (false);
         }
 
         // Cache the principal (if requested) and record this authentication
-        register(request, response, principal, null, null);
-        return true;
+        register(request, response, principal,
+                HttpServletRequest.CLIENT_CERT_AUTH, null, null);
+        return (true);
 
     }
 

==================================================
