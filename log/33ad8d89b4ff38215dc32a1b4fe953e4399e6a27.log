33ad8d89b4ff38215dc32a1b4fe953e4399e6a27
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58605
==================================================
Mark Thomas
==================================================
Thu Nov 12 12:49:33 2015 +0000
==================================================
Http11Processor.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=58605
Provide a value for request.getProtocol()
Ensure access log reports HTTP/1.1 upgrade and initial HTTP/2.0 request separately.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1714031 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http2UpgradeHandler.java
index 4e5793fac3..4f74dbf7c4 100644
--- a/java/org/apache/coyote/http11/Http11Processor.java
+++ b/java/org/apache/coyote/http11/Http11Processor.java
@@ -1032,6 +1032,11 @@ public class Http11Processor extends AbstractProcessor {
                     if (upgradeProtocol.accept(request)) {
                         // TODO Figure out how to handle request bodies at this
                         // point.
+                        response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);
+                        response.setHeader("Connection", "Upgrade");
+                        response.setHeader("Upgrade", requestedProtocol);
+                        action(ActionCode.CLOSE,  null);
+                        getAdapter().log(request, response, 0);
 
                         InternalHttpUpgradeHandler upgradeHandler =
                                 upgradeProtocol.getInternalUpgradeHandler(

==================================================
