fa3eefece1b5b3ecf2622a35a16651576350023d
==================================================
Better fix for BZ56199
==================================================
Mark Emlyn
==================================================
Thu Mar 6 07:40:12 2014 +0000
==================================================
JspC.java
Better fix for BZ56199
Fix failing unit tests caused by original fix.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1574785 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JspCServletContext.java
index 92c454bc6c..54db693c93 100644
--- a/java/org/apache/jasper/JspC.java
+++ b/java/org/apache/jasper/JspC.java
@@ -1463,17 +1463,11 @@ public class JspC extends Task implements Options {
         PrintWriter log = new PrintWriter(System.out);
         URL resourceBase = new File(uriRoot).getCanonicalFile().toURI().toURL();
 
-        context = new JspCServletContext(log, resourceBase, classLoader);
+        context = new JspCServletContext(log, resourceBase, classLoader,
+                isValidateXml(), isBlockExternal());
         if (isValidateTld()) {
             context.setInitParameter(Constants.XML_VALIDATION_TLD_INIT_PARAM, "true");
         }
-        if (isValidateXml()) {
-            context.setInitParameter(Constants.XML_VALIDATION_INIT_PARAM, "true");
-        }
-        context.setInitParameter(Constants.XML_BLOCK_EXTERNAL_INIT_PARAM,
-                String.valueOf(isBlockExternal()));
-
-        context.processWebXml();
 
         TldScanner scanner = new TldScanner(
                 context, true, isValidateTld(), isBlockExternal());

==================================================
TestJspCServletContext.java
index 8ba67b136f..b1d7f96206 100644
--- a/java/org/apache/jasper/servlet/JspCServletContext.java
+++ b/java/org/apache/jasper/servlet/JspCServletContext.java
@@ -45,7 +45,6 @@ import javax.servlet.SessionCookieConfig;
 import javax.servlet.SessionTrackingMode;
 import javax.servlet.descriptor.JspConfigDescriptor;
 
-import org.apache.jasper.Constants;
 import org.apache.jasper.JasperException;
 import org.apache.jasper.compiler.Localizer;
 import org.apache.jasper.util.ExceptionUtils;
@@ -115,35 +114,28 @@ public class JspCServletContext implements ServletContext {
      *
      * @param aLogWriter PrintWriter which is used for <code>log()</code> calls
      * @param aResourceBaseURL Resource base URL
+     * @param classLoader   Class loader for this {@link ServletContext}
+     * @param validate      Should a validating parser be used to parse web.xml?
+     * @param blockExternal Should external entities be blocked when parsing
+     *                      web.xml?
      * @throws JasperException
      */
-    public JspCServletContext(PrintWriter aLogWriter, URL aResourceBaseURL, ClassLoader classLoader)
-        throws JasperException {
+    public JspCServletContext(PrintWriter aLogWriter, URL aResourceBaseURL,
+            ClassLoader classLoader, boolean validate, boolean blockExternal)
+            throws JasperException {
 
         myAttributes = new HashMap<>();
         myParameters = new ConcurrentHashMap<>();
         myLogWriter = aLogWriter;
         myResourceBaseURL = aResourceBaseURL;
         this.loader = classLoader;
-    }
-
-    public void processWebXml() throws JasperException {
-        this.webXml = buildMergedWebXml();
+        this.webXml = buildMergedWebXml(validate, blockExternal);
         jspConfigDescriptor = webXml.getJspConfigDescriptor();
     }
 
-    private WebXml buildMergedWebXml() throws JasperException {
+    private WebXml buildMergedWebXml(boolean validate, boolean blockExternal)
+            throws JasperException {
         WebXml webXml = new WebXml();
-        String blockExternalString = getInitParameter(
-                Constants.XML_BLOCK_EXTERNAL_INIT_PARAM);
-        boolean blockExternal;
-        if (blockExternalString == null) {
-            blockExternal = true;
-        } else {
-            blockExternal = Boolean.parseBoolean(blockExternalString);
-        }
-        boolean validate = Boolean.parseBoolean(
-                getInitParameter(Constants.XML_VALIDATION_INIT_PARAM));
         WebXmlParser webXmlParser = new WebXmlParser(validate, validate, blockExternal);
         // Use this class's classloader as Ant will have set the TCCL to its own
         webXmlParser.setClassLoader(getClass().getClassLoader());

==================================================
