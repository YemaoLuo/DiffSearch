22494d3b5e82714383a286f145ce881e61cd48e5
==================================================
- Packet must be ended before sending.
==================================================
Remy Maucherat
==================================================
Fri Oct 13 11:39:30 2006 +0000
==================================================
AjpMessage.java
- Packet must be ended before sending.
- Fix off by one check bug in AjpMessage.
- Fix recycling bug (setting streams to null when doing keepalive is not a good idea).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@463652 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AjpProcessor.java
index ec5e69ea04..7b3bfd22bb 100644
--- a/java/org/apache/coyote/ajp/AjpMessage.java
+++ b/java/org/apache/coyote/ajp/AjpMessage.java
@@ -275,7 +275,7 @@ public class AjpMessage {
      * @param numBytes The number of bytes to copy.  
      */
     public void appendBytes(byte[] b, int off, int numBytes) {
-        if (pos + numBytes + 3 >= buf.length) {
+        if (pos + numBytes + 3 > buf.length) {
             log.error(sm.getString("ajpmessage.overflow", "" + numBytes, "" + pos),
                     new ArrayIndexOutOfBoundsException());
             if (log.isDebugEnabled()) {
@@ -382,6 +382,11 @@ public class AjpMessage {
     }
 
     
+    public int getPacketSize() {
+        return buf.length;
+    }
+    
+    
     public int processHeader() {
         pos = 0;
         int mark = getInt();

==================================================
