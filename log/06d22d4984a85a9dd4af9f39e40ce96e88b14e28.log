06d22d4984a85a9dd4af9f39e40ce96e88b14e28
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49000
==================================================
Mark Emlyn
==================================================
Tue Jan 4 19:20:28 2011 +0000
==================================================
CookieSupport.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=49000
Make accepting name only cookies configurable, defaulting to disabled.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1055143 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Cookies.java
index e03043c67d..6456de3606 100644
--- a/java/org/apache/tomcat/util/http/CookieSupport.java
+++ b/java/org/apache/tomcat/util/http/CookieSupport.java
@@ -59,6 +59,11 @@ public final class CookieSupport {
      */
     public static final boolean FWD_SLASH_IS_SEPARATOR;
 
+    /**
+     * If true, name only cookies will be permitted.
+     */
+    public static final boolean ALLOW_NAME_ONLY;
+
     /**
      * The list of separators that apply to version 0 cookies. To quote the
      * spec, these are comma, semi-colon and white-space. The HTTP spec
@@ -106,6 +111,11 @@ public final class CookieSupport {
                 Boolean.valueOf(fwdSlashIsSeparator).booleanValue();
         }
         
+        ALLOW_NAME_ONLY = Boolean.valueOf(System.getProperty(
+                "org.apache.tomcat.util.http.ServerCookie.ALLOW_NAME_ONLY",
+                "false")).booleanValue();
+        
+
         /*
         Excluding the '/' char by default violates the RFC, but 
         it looks like a lot of people put '/'

==================================================
TestCookies.java
index 39e8edab3d..857d0fdd88 100644
--- a/java/org/apache/tomcat/util/http/Cookies.java
+++ b/java/org/apache/tomcat/util/http/Cookies.java
@@ -422,6 +422,11 @@ public final class Cookies { // extends MultiMap {
                 log.info("Cookies: Unknown Special Cookie");
 
             } else { // Normal Cookie
+                if (valueStart == -1 && !CookieSupport.ALLOW_NAME_ONLY) {
+                    // Skip name only cookies if not supported
+                    continue;
+                }
+
                 sc = addCookie();
                 sc.setVersion( version );
                 sc.getName().setBytes( bytes, nameStart,

==================================================
TestCookiesAllowNameOnly.java
index 0834d34639..a8151b3c94 100644
--- a/test/org/apache/tomcat/util/http/TestCookies.java
+++ b/test/org/apache/tomcat/util/http/TestCookies.java
@@ -102,12 +102,12 @@ public class TestCookies extends TestCase {
 
     public void testNameOnlyCookies() throws Exception {
         // Bug 49000
-        test("fred=1; jim=2; bob", "fred", "1", "jim", "2", "bob", "");
-        test("fred=1; jim=2; bob; george=3", "fred", "1", "jim", "2", "bob", "",
+        test("fred=1; jim=2; bob", "fred", "1", "jim", "2");
+        test("fred=1; jim=2; bob; george=3", "fred", "1", "jim", "2",
                 "george", "3");
         test("fred=1; jim=2; bob=; george=3", "fred", "1", "jim", "2",
-                "bob", "", "george", "3");
-        test("fred=1; jim=2; bob=", "fred", "1", "jim", "2", "bob", "");
+                "george", "3");
+        test("fred=1; jim=2; bob=", "fred", "1", "jim", "2");
     }
 
 

==================================================
