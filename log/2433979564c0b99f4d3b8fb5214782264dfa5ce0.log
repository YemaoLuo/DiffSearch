2433979564c0b99f4d3b8fb5214782264dfa5ce0
==================================================
Improve unit test robustness
==================================================
Mark Thomas
==================================================
Sat Nov 16 13:59:58 2019 +0000
==================================================
TestCoyoteAdapterRequestFuzzing.java
Improve unit test robustness


==================================================
SimpleHttpClient.java
index acd01a75f4..dc8ac5ef80 100644
--- a/test/org/apache/catalina/connector/TestCoyoteAdapterRequestFuzzing.java
+++ b/test/org/apache/catalina/connector/TestCoyoteAdapterRequestFuzzing.java
@@ -16,7 +16,11 @@
  */
 package org.apache.catalina.connector;
 
+import java.io.BufferedOutputStream;
 import java.io.File;
+import java.io.IOException;
+import java.io.OutputStream;
+import java.net.Socket;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.List;
@@ -134,6 +138,19 @@ public class TestCoyoteAdapterRequestFuzzing extends TomcatBaseTest {
             setRequestPause(0);
         }
 
+        @Override
+        protected OutputStream createOutputStream(Socket socket) throws IOException {
+            // Override the default implementation so we can create a large
+            // enough buffer to hold the entire request.
+            // The default implementation uses the 8k buffer in the
+            // StreamEncoder. Since some requests are larger than this, those
+            // requests will be sent in several parts. If the first part is
+            // sufficient for Tomcat to determine the request is invalid, Tomcat
+            // will close the connection, causing the write of the remaining
+            // parts to fail which in turn causes the test to fail.
+            return new BufferedOutputStream(super.createOutputStream(socket), 32 * 1024);
+        }
+
         @Override
         public boolean isResponseBodyOK() {
             // Response body varies. It is the response code that is of interest

==================================================
