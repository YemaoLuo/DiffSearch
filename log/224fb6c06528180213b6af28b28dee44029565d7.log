224fb6c06528180213b6af28b28dee44029565d7
==================================================
Fix bz 64373. Ensure tag file unpacked from WAR can be found.
==================================================
Mark Thomas
==================================================
Mon Apr 27 19:34:25 2020 +0100
==================================================
TagLibraryInfoImpl.java
Fix bz 64373. Ensure tag file unpacked from WAR can be found.

Fixes https://bz.apache.org/bugzilla/show_bug.cgi?id=64373
Patch provided by Karl von Randow


==================================================
TestTagLibraryInfoImpl.java
index 60a9522d31..4a284a8475 100644
--- a/java/org/apache/jasper/compiler/TagLibraryInfoImpl.java
+++ b/java/org/apache/jasper/compiler/TagLibraryInfoImpl.java
@@ -313,6 +313,7 @@ class TagLibraryInfoImpl extends TagLibraryInfo implements TagConstants {
                 tagXml.hasDynamicAttributes());
     }
 
+    @SuppressWarnings("null") // Impossible for path to be null at warning
     private TagFileInfo createTagFileInfo(TagFileXml tagFileXml, Jar jar) throws JasperException {
 
         String name = tagFileXml.getName();
@@ -325,6 +326,13 @@ class TagLibraryInfoImpl extends TagLibraryInfo implements TagConstants {
             err.jspError("jsp.error.tagfile.illegalPath", path);
         }
 
+        if (jar == null && path.startsWith("/META-INF/tags")) {
+            // This is a tag file that was packaged in a JAR that has been
+            // unpacked into /WEB-INF/classes (probably by an IDE). Adjust the
+            // path accordingly.
+            path = "/WEB-INF/classes" + path;
+        }
+
         TagInfo tagInfo =
                 TagFileProcessor.parseTagFileDirectives(parserController, name, path, jar, this);
         return new TagFileInfo(name, path, tagInfo);

==================================================
