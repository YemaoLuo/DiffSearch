4fff1efc7a54381c93485d829cdac22aad5520b6
==================================================
Generate the servlet mapping a little later as we need the published path for the POJO method mapping
==================================================
Mark Emlyn
==================================================
Sat Dec 1 18:01:22 2012 +0000
==================================================
ServerContainerImpl.java
Generate the servlet mapping a little later as we need the published path for the POJO method mapping

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1416031 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsSci.java
index 421393de00..831c4e8de6 100644
--- a/java/org/apache/tomcat/websocket/ServerContainerImpl.java
+++ b/java/org/apache/tomcat/websocket/ServerContainerImpl.java
@@ -106,15 +106,17 @@ public class ServerContainerImpl extends ClientContainerImpl implements
 
         ServerEndpointConfiguration config =
                 (ServerEndpointConfiguration) ep.getEndpointConfiguration();
-        String path = Util.getServletMappingPath(config.getPath());
+        String path = config.getPath();
+        String mappingPath = Util.getServletMappingPath(path);
 
         if (log.isDebugEnabled()) {
             log.debug(sm.getString("serverContainer.endpointDeploy",
                     clazz.getName(), path, servletContext.getContextPath()));
         }
 
-        endpointMap.put(path.substring(0, path.length() - 2), clazz);
-        addWsServletMapping(path);
+        endpointMap.put(
+                mappingPath.substring(0, mappingPath.length() - 2), clazz);
+        addWsServletMapping(mappingPath);
     }
 
 
@@ -148,9 +150,11 @@ public class ServerContainerImpl extends ClientContainerImpl implements
                     path, servletContext.getContextPath()));
         }
 
-        pojoMap.put(path.substring(0, path.length() - 2), pojo);
+        String mappingPath = Util.getServletMappingPath(path);
+
+        pojoMap.put(mappingPath.substring(0, mappingPath.length() - 2), pojo);
         pojoMethodMap.put(pojo, new PojoMethodMapping(pojo, path));
-        addWsServletMapping(path);
+        addWsServletMapping(mappingPath);
     }
 
 

==================================================
