bc9cd75959aabeaecb6eb26f926198a02678b7d3
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53353
==================================================
Mark Emlyn
==================================================
Sun Jun 3 19:55:33 2012 +0000
==================================================
AstMediaType.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=53353
Make the HTTP header parser for ContentType tolerant of invalid parameters with names but no values. The invalid parameters are available in the collection of output nodes but skipped by the various toString() methods.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1345752 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AstParameter.java
index 608f28704e..440a69de65 100644
--- a/java/org/apache/tomcat/util/http/parser/AstMediaType.java
+++ b/java/org/apache/tomcat/util/http/parser/AstMediaType.java
@@ -39,8 +39,12 @@ public class AstMediaType extends SimpleNode {
         sb.append('/');
         sb.append(children[1].toString());
         for (int i = 2; i < children.length; i++) {
-            sb.append(';');
-            sb.append(children[i].toString());
+            String s = children[i].toString();
+            // Invalid parameters will have zero length - skip them
+            if (s.length() > 0) {
+                sb.append(';');
+                sb.append(s);
+            }
         }
         return sb.toString();
     }

==================================================
HttpParser.java
index 4e4ebdbea3..52d2c6ee5a 100644
--- a/java/org/apache/tomcat/util/http/parser/AstParameter.java
+++ b/java/org/apache/tomcat/util/http/parser/AstParameter.java
@@ -31,6 +31,10 @@ public class AstParameter extends SimpleNode {
 
     @Override
     public String toString() {
+        if (children.length != 2) {
+            // Invalid input - swallow it.
+            return "";
+        }
         StringBuilder sb = new StringBuilder();
         sb.append(children[0].toString());
         sb.append("=");

==================================================
TestMediaType.java
index 4f56d99c9a..957155d117 100644
--- a/java/org/apache/tomcat/util/http/parser/HttpParser.jjt
+++ b/java/org/apache/tomcat/util/http/parser/HttpParser.jjt
@@ -29,6 +29,10 @@
  *
  * Provides parsing of the following HTTP header values as per RFC 2616:
  * - Content-Type
+ *     Note: The parser tolerates invalid parameters that do not include a
+ *           value. These parameters are available in the Parser node collection
+ *           but will be skipped by the various toString() methods. See BZ 53353
+ *           for an example.
  *
  * Support for additional headers will be provided as required.
  */
@@ -77,7 +81,7 @@ void SubType() #SubType :{ Token t = null; }
 
 void Parameter() #Parameter : {}
 {
-    Attribute() <EQUALS> Value()
+    Attribute() (<EQUALS> Value())?
 }
 
 void Attribute() # Attribute : { Token t = null; }

==================================================
