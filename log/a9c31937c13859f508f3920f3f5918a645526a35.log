a9c31937c13859f508f3920f3f5918a645526a35
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50802
==================================================
Mark Emlyn
==================================================
Thu Feb 17 20:38:49 2011 +0000
==================================================
BaseDirContext.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=50802
Ensure that ServletContext.getResourcePaths() includes static resources packaged in JAR files in its output. 

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1071774 13f79535-47bb-0310-9956-ffa450edef68



==================================================
FileDirContext.java
index ea09c726d5..4baed1ea61 100644
--- a/java/org/apache/naming/resources/BaseDirContext.java
+++ b/java/org/apache/naming/resources/BaseDirContext.java
@@ -47,6 +47,8 @@ import javax.naming.directory.SearchControls;
 import javax.naming.directory.SearchResult;
 
 import org.apache.naming.NameParserImpl;
+import org.apache.naming.NamingContextBindingsEnumeration;
+import org.apache.naming.NamingEntry;
 import org.apache.naming.StringManager;
 
 /**
@@ -703,25 +705,28 @@ public abstract class BaseDirContext implements DirContext {
         }
         
         // Next do a standard lookup
-        NamingEnumeration<Binding> bindings = doListBindings(name);
+        List<NamingEntry> bindings = doListBindings(name);
 
-        if (bindings != null)
-            return bindings;
-        
         // Check the alternate locations
+        List<NamingEntry> altBindings = null;
+
         for (DirContext altDirContext : altDirContexts) {
-            if (altDirContext instanceof BaseDirContext)
-                bindings = ((BaseDirContext) altDirContext).doListBindings(
+            if (altDirContext instanceof BaseDirContext) {
+                altBindings = ((BaseDirContext) altDirContext).doListBindings(
                         "/META-INF/resources" + name);
-            else {
-                try {
-                    bindings = altDirContext.listBindings(name);
-                } catch (NamingException ne) {
-                    // Ignore
+            }
+            if (altBindings != null) {
+                if (bindings == null) {
+                    bindings = altBindings;
+                } else {
+                    bindings.addAll(altBindings);
                 }
             }
-            if (bindings != null)
-                return bindings;
+        }
+
+        if (bindings != null) {
+            return new NamingContextBindingsEnumeration(bindings.iterator(),
+                    this);
         }
 
         // Really not found
@@ -1590,7 +1595,7 @@ public abstract class BaseDirContext implements DirContext {
 
     protected abstract Object doLookup(String name);
 
-    protected abstract NamingEnumeration<Binding> doListBindings(String name)
+    protected abstract List<NamingEntry> doListBindings(String name)
         throws NamingException;
 
     protected abstract String doGetRealPath(String name);

==================================================
VirtualDirContext.java
index eff0f30f81..b8fdc2c379 100644
--- a/java/org/apache/naming/resources/FileDirContext.java
+++ b/java/org/apache/naming/resources/FileDirContext.java
@@ -27,8 +27,8 @@ import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Date;
 import java.util.Hashtable;
+import java.util.List;
 
-import javax.naming.Binding;
 import javax.naming.NameAlreadyBoundException;
 import javax.naming.NameClassPair;
 import javax.naming.NameNotFoundException;
@@ -42,7 +42,6 @@ import javax.naming.directory.SearchControls;
 import javax.naming.directory.SearchResult;
 
 import org.apache.catalina.util.RequestUtil;
-import org.apache.naming.NamingContextBindingsEnumeration;
 import org.apache.naming.NamingContextEnumeration;
 import org.apache.naming.NamingEntry;
 
@@ -318,7 +317,7 @@ public class FileDirContext extends BaseDirContext {
      * @exception NamingException if a naming exception is encountered
      */
     @Override
-    protected NamingEnumeration<Binding> doListBindings(String name)
+    protected List<NamingEntry> doListBindings(String name)
         throws NamingException {
 
         File file = file(name);
@@ -326,8 +325,7 @@ public class FileDirContext extends BaseDirContext {
         if (file == null)
             return null;
         
-        return new NamingContextBindingsEnumeration(list(file).iterator(),
-                this);
+        return list(file);
 
     }
 
@@ -848,9 +846,9 @@ public class FileDirContext extends BaseDirContext {
      * @param file Collection
      * @return Vector containing NamingEntry objects
      */
-    protected ArrayList<NamingEntry> list(File file) {
+    protected List<NamingEntry> list(File file) {
 
-        ArrayList<NamingEntry> entries = new ArrayList<NamingEntry>();
+        List<NamingEntry> entries = new ArrayList<NamingEntry>();
         if (!file.isDirectory())
             return entries;
         String[] names = file.list();

==================================================
WARDirContext.java
index 6974c09ea3..08dd8347a3 100644
--- a/java/org/apache/naming/resources/VirtualDirContext.java
+++ b/java/org/apache/naming/resources/VirtualDirContext.java
@@ -147,8 +147,8 @@ public class VirtualDirContext extends FileDirContext {
     }
 
     @Override
-    protected ArrayList<NamingEntry> list(File file) {
-        ArrayList<NamingEntry> entries = super.list(file);
+    protected List<NamingEntry> list(File file) {
+        List<NamingEntry> entries = super.list(file);
 
         // adds virtual tlds for WEB-INF listing
         if ("WEB-INF".equals(file.getName())) {

==================================================
