7cca0a94ee12b6bfe3b77811e9257a825c19366c
==================================================
The resource JARs don't contain TLDs so don't scan for them during testing
==================================================
Mark Thomas
==================================================
Tue Jul 5 11:24:21 2016 +0000
==================================================
TestStandardContextResources.java
The resource JARs don't contain TLDs so don't scan for them during testing

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1751447 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestStandardWrapper.java
index 3cc16eafaa..bd003d3d78 100644
--- a/test/org/apache/catalina/core/TestStandardContextResources.java
+++ b/test/org/apache/catalina/core/TestStandardContextResources.java
@@ -211,6 +211,7 @@ public class TestStandardContextResources extends TomcatBaseTest {
         // app dir is relative to server home
         StandardContext ctx = (StandardContext) tomcat.addWebapp(null, "/test",
                 appDir.getAbsolutePath());
+        skipTldsForResourceJars(ctx);
 
         Tomcat.addServlet(ctx, "getresource", new GetResourceServlet());
         ctx.addServletMapping("/getresource", "getresource");

==================================================
TestContextConfig.java
index 74aa33c39f..af88885341 100644
--- a/test/org/apache/catalina/core/TestStandardWrapper.java
+++ b/test/org/apache/catalina/core/TestStandardWrapper.java
@@ -153,7 +153,8 @@ public class TestStandardWrapper extends TomcatBaseTest {
         Tomcat tomcat = getTomcatInstance();
 
         File appDir = new File("test/webapp-fragments");
-        tomcat.addWebapp(null, "", appDir.getAbsolutePath());
+        Context ctx = tomcat.addWebapp(null, "", appDir.getAbsolutePath());
+        skipTldsForResourceJars(ctx);
 
         tomcat.start();
 

==================================================
TomcatBaseTest.java
index a41e2b3cea..0e460040e3 100644
--- a/test/org/apache/catalina/startup/TestContextConfig.java
+++ b/test/org/apache/catalina/startup/TestContextConfig.java
@@ -73,7 +73,8 @@ public class TestContextConfig extends TomcatBaseTest {
 
         File appDir =  new File("test/webapp-fragments");
         // app dir is relative to server home
-        tomcat.addWebapp(null, "/test", appDir.getAbsolutePath());
+        Context ctx = tomcat.addWebapp(null, "/test", appDir.getAbsolutePath());
+        skipTldsForResourceJars(ctx);
 
         tomcat.start();
 

==================================================
TestWarURLStreamHandlerIntegration.java
index ff418cb481..8b53114eec 100644
--- a/test/org/apache/catalina/startup/TomcatBaseTest.java
+++ b/test/org/apache/catalina/startup/TomcatBaseTest.java
@@ -67,6 +67,8 @@ import org.apache.catalina.webresources.StandardRoot;
 import org.apache.coyote.http11.Http11NioProtocol;
 import org.apache.tomcat.util.buf.ByteChunk;
 import org.apache.tomcat.util.collections.CaseInsensitiveKeyMap;
+import org.apache.tomcat.util.scan.StandardJarScanFilter;
+import org.apache.tomcat.util.scan.StandardJarScanner;
 
 /**
  * Base test case that provides a Tomcat instance for each test - mainly so we
@@ -857,4 +859,11 @@ public abstract class TomcatBaseTest extends LoggingBaseTest {
                 return FileVisitResult.CONTINUE;
             }});
     }
+
+
+    public static void skipTldsForResourceJars(Context context) {
+        StandardJarScanner scanner = (StandardJarScanner) context.getJarScanner();
+        StandardJarScanFilter filter = (StandardJarScanFilter) scanner.getJarScanFilter();
+        filter.setTldSkip(filter.getTldSkip() + ",resources*.jar");
+    }
 }

==================================================
TestCompiler.java
index e7d6a587f4..734072b4b4 100644
--- a/test/org/apache/catalina/webresources/TestWarURLStreamHandlerIntegration.java
+++ b/test/org/apache/catalina/webresources/TestWarURLStreamHandlerIntegration.java
@@ -34,13 +34,14 @@ public class TestWarURLStreamHandlerIntegration extends TomcatBaseTest {
         Tomcat tomcat = getTomcatInstance();
 
         File docBase = new File("test/webresources/war-url-connection.war");
-        Context context = tomcat.addWebapp("/test", docBase.getAbsolutePath());
+        Context ctx = tomcat.addWebapp("/test", docBase.getAbsolutePath());
+        skipTldsForResourceJars(ctx);
 
         ((StandardHost) tomcat.getHost()).setUnpackWARs(false);
 
         tomcat.start();
 
-        URL url = context.getServletContext().getResource("/index.html");
+        URL url = ctx.getServletContext().getResource("/index.html");
         try {
             url.toURI();
         } catch (Exception e) {

==================================================
TestWarDirContext.java
index 33baeca70f..49db96fd64 100644
--- a/test/org/apache/jasper/compiler/TestCompiler.java
+++ b/test/org/apache/jasper/compiler/TestCompiler.java
@@ -28,6 +28,7 @@ import static org.junit.Assert.assertTrue;
 
 import org.junit.Test;
 
+import org.apache.catalina.Context;
 import org.apache.catalina.startup.Tomcat;
 import org.apache.catalina.startup.TomcatBaseTest;
 import org.apache.tomcat.util.buf.ByteChunk;
@@ -173,7 +174,9 @@ public class TestCompiler extends TomcatBaseTest {
         Tomcat tomcat = getTomcatInstance();
 
         File appDir = new File("test/webapp-fragments");
-        tomcat.addWebapp(null, "/test", appDir.getAbsolutePath());
+        Context ctx = tomcat.addWebapp(null, "/test", appDir.getAbsolutePath());
+        skipTldsForResourceJars(ctx);
+
         tomcat.start();
 
         // No further tests required. The bug triggers an infinite loop on

==================================================
