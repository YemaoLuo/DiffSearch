4a0472248dbffd4a8d652a4bd79ec55b38807400
==================================================
- 42308: nextRequest recycles the request.
==================================================
Remy Maucherat
==================================================
Tue May 1 12:46:12 2007 +0000
==================================================
Http11AprProcessor.java
- 42308: nextRequest recycles the request.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/tc6.0.x/trunk@534043 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11AprProtocol.java
index 61fc53aaa8..7403fa4a26 100644
--- a/java/org/apache/coyote/http11/Http11AprProcessor.java
+++ b/java/org/apache/coyote/http11/Http11AprProcessor.java
@@ -880,6 +880,12 @@ public class Http11AprProcessor implements ActionHook {
             }
             request.updateCounters();
 
+            if (!comet) {
+                // Next request
+                inputBuffer.nextRequest();
+                outputBuffer.nextRequest();
+            }
+            
             // Do sendfile as needed: add socket to sendfile and end
             if (sendfileData != null && !error) {
                 sendfileData.socket = socket;
@@ -933,10 +939,6 @@ public class Http11AprProcessor implements ActionHook {
             error = true;
         }
 
-        // Next request
-        inputBuffer.nextRequest();
-        outputBuffer.nextRequest();
-        
     }
     
     

==================================================
Http11NioProcessor.java
index 3a659b9fa1..e846b8d13a 100644
--- a/java/org/apache/coyote/http11/Http11AprProtocol.java
+++ b/java/org/apache/coyote/http11/Http11AprProtocol.java
@@ -20,7 +20,6 @@ package org.apache.coyote.http11;
 import java.net.InetAddress;
 import java.net.URLEncoder;
 import java.util.HashMap;
-import java.util.Hashtable;
 import java.util.Iterator;
 import java.util.concurrent.ConcurrentHashMap;
 import java.util.concurrent.ConcurrentLinkedQueue;

==================================================
InternalNioInputBuffer.java
index 9d3f8bc6ea..e6007695ff 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -934,6 +934,12 @@ public class Http11NioProcessor implements ActionHook {
                 response.setStatus(500);
             }
             request.updateCounters();
+
+            if (!comet) {
+                // Next request
+                inputBuffer.nextRequest();
+                outputBuffer.nextRequest();
+            }
             
             // Do sendfile as needed: add socket to sendfile and end
             if (sendfileData != null && !error) {
@@ -990,10 +996,6 @@ public class Http11NioProcessor implements ActionHook {
             error = true;
         }
 
-        // Next request
-        inputBuffer.nextRequest();
-        outputBuffer.nextRequest();
-
     }
 
 

==================================================
