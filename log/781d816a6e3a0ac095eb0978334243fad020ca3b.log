781d816a6e3a0ac095eb0978334243fad020ca3b
==================================================
Align ActionCode.NB_READ_INTEREST
==================================================
Mark Thomas
==================================================
Fri Aug 12 07:47:10 2016 +0000
==================================================
AjpProcessor.java
Align ActionCode.NB_READ_INTEREST

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1756101 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11Processor.java
index 1c76e61013..7f764c269d 100644
--- a/java/org/apache/coyote/ajp/AjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpProcessor.java
@@ -546,8 +546,8 @@ public class AjpProcessor extends AbstractProcessor {
             break;
         }
         case NB_READ_INTEREST: {
-            if (!endOfStream) {
-                socketWrapper.registerReadInterest();
+            if (!isRequestBodyFullyRead()) {
+                registerReadInterest();
             }
             break;
         }
@@ -1512,6 +1512,11 @@ public class AjpProcessor extends AbstractProcessor {
     }
     
     
+    private void registerReadInterest() {
+        socketWrapper.registerReadInterest();
+    }
+    
+    
     /**
      * Read at least the specified amount of bytes, and place them
      * in the input buffer. Note that if any data is available to read then this

==================================================
StreamProcessor.java
index 3d9e9fd6bd..cbfacd77ad 100644
--- a/java/org/apache/coyote/http11/Http11Processor.java
+++ b/java/org/apache/coyote/http11/Http11Processor.java
@@ -839,7 +839,9 @@ public class Http11Processor extends AbstractProcessor {
             break;
         }
         case NB_READ_INTEREST: {
-            socketWrapper.registerReadInterest();
+            if (!isRequestBodyFullyRead()) {
+                registerReadInterest();
+            }
             break;
         }
         case NB_WRITE_INTEREST: {
@@ -1835,6 +1837,11 @@ public class Http11Processor extends AbstractProcessor {
     }
     
     
+    private void registerReadInterest() {
+        socketWrapper.registerReadInterest();
+    }
+    
+    
     /**
      * Checks to see if the keep-alive loop should be broken, performing any
      * processing (e.g. sendfile handling) that may have an impact on whether

==================================================
