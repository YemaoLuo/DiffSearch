e1bf740834a92202bd1b0f16ed7a063507d4063f
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=28852
==================================================
Mark Emlyn
==================================================
Mon Feb 28 18:15:48 2011 +0000
==================================================
JMXGetTask.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=28852
Add URL encoding where missing to parameters in URLs presented by Ant tasks to the Manager application.
Based on a patch by Stephane Bailliez.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1075458 13f79535-47bb-0310-9956-ffa450edef68



==================================================
JMXQueryTask.java
index 2f205e32b4..c5899da04f 100644
--- a/java/org/apache/catalina/ant/JMXGetTask.java
+++ b/java/org/apache/catalina/ant/JMXGetTask.java
@@ -19,6 +19,9 @@
 package org.apache.catalina.ant;
 
 
+import java.io.UnsupportedEncodingException;
+import java.net.URLEncoder;
+
 import org.apache.tools.ant.BuildException;
 
 
@@ -90,8 +93,13 @@ public class JMXGetTask extends AbstractCatalinaTask {
                 ("Must specify 'bean' and 'attribute' attributes");
         }
         log("Getting attribute " + attribute +
-                " in bean " + bean ); 
-        execute("/jmxproxy/?get=" + bean 
-                + "&att=" + attribute );
+                " in bean " + bean );
+        try {
+            execute("/jmxproxy/?get=" + URLEncoder.encode(bean, getCharset()) 
+                    + "&att=" + URLEncoder.encode(attribute, getCharset()));
+        } catch (UnsupportedEncodingException e) {
+            throw new BuildException
+                ("Invalid 'charset' attribute: " + getCharset());
+        }
     }
 }

==================================================
JMXSetTask.java
index 8cd960a5ec..e5f030d4ed 100644
--- a/java/org/apache/catalina/ant/JMXQueryTask.java
+++ b/java/org/apache/catalina/ant/JMXQueryTask.java
@@ -19,6 +19,9 @@
 package org.apache.catalina.ant;
 
 
+import java.io.UnsupportedEncodingException;
+import java.net.URLEncoder;
+
 import org.apache.tools.ant.BuildException;
 
 
@@ -73,7 +76,17 @@ public class JMXQueryTask extends AbstractCatalinaTask {
     @Override
     public void execute() throws BuildException {
         super.execute();
-        String queryString = (query == null) ? "":("?qry="+query);
+        String queryString;
+        if (query == null) {
+            queryString = "";
+        } else {
+            try {
+                queryString = "?qry=" + URLEncoder.encode(query, getCharset());
+            } catch (UnsupportedEncodingException e) {
+                throw new BuildException
+                    ("Invalid 'charset' attribute: " + getCharset());
+            }
+        }
         log("Query string is " + queryString); 
         execute ("/jmxproxy/" + queryString);
     }

==================================================
ResourcesTask.java
index 12c562eaf1..292ce09a43 100644
--- a/java/org/apache/catalina/ant/JMXSetTask.java
+++ b/java/org/apache/catalina/ant/JMXSetTask.java
@@ -19,6 +19,9 @@
 package org.apache.catalina.ant;
 
 
+import java.io.UnsupportedEncodingException;
+import java.net.URLEncoder;
+
 import org.apache.tools.ant.BuildException;
 
 
@@ -113,8 +116,13 @@ public class JMXSetTask extends AbstractCatalinaTask {
         log("Setting attribute " + attribute +
                             " in bean " + bean +
                             " to " + value); 
-        execute("/jmxproxy/?set=" + bean 
-                + "&att=" + attribute 
-                + "&val=" + value);
+        try {
+            execute("/jmxproxy/?set=" + URLEncoder.encode(bean, getCharset()) 
+                    + "&att=" + URLEncoder.encode(attribute, getCharset()) 
+                    + "&val=" + URLEncoder.encode(value, getCharset()));
+        } catch (UnsupportedEncodingException e) {
+            throw new BuildException
+                ("Invalid 'charset' attribute: " + getCharset());
+        }
     }
 }

==================================================
UndeployTask.java
index 43309369ba..a90febde05 100644
--- a/java/org/apache/catalina/ant/ResourcesTask.java
+++ b/java/org/apache/catalina/ant/ResourcesTask.java
@@ -19,6 +19,9 @@
 package org.apache.catalina.ant;
 
 
+import java.io.UnsupportedEncodingException;
+import java.net.URLEncoder;
+
 import org.apache.tools.ant.BuildException;
 
 
@@ -64,7 +67,13 @@ public class ResourcesTask extends AbstractCatalinaTask {
 
         super.execute();
         if (type != null) {
-            execute("/resources?type=" + type);
+            try {
+                execute("/resources?type=" +
+                        URLEncoder.encode(type, getCharset()));
+            } catch (UnsupportedEncodingException e) {
+                throw new BuildException
+                    ("Invalid 'charset' attribute: " + getCharset());
+            }
         } else {
             execute("/resources");
         }

==================================================
