1783fe27ad619cacd4cc952687fe850408e251ad
==================================================
Move crlFile/SSLCARevocationFile & SSLCARevocationPath to SSLHostConfig
==================================================
Mark Thomas
==================================================
Tue May 5 19:23:55 2015 +0000
==================================================
AbstractHttp11JsseProtocol.java
Move crlFile/SSLCARevocationFile & SSLCARevocationPath to SSLHostConfig

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1677881 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AbstractHttp11Protocol.java
index 7d9f917291..df469ef17e 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11JsseProtocol.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11JsseProtocol.java
@@ -64,9 +64,6 @@ public abstract class AbstractHttp11JsseProtocol<S>
         return getEndpoint().getTruststoreAlgorithm();
     }
 
-    public void setCrlFile(String s){getEndpoint().setCrlFile(s);}
-    public String getCrlFile(){ return getEndpoint().getCrlFile();}
-
     public void setSessionCacheSize(String s){getEndpoint().setSessionCacheSize(s);}
     public String getSessionCacheSize(){ return getEndpoint().getSessionCacheSize();}
 

==================================================
Http11AprProtocol.java
index 54fe61f187..f8e3b6c191 100644
--- a/java/org/apache/coyote/http11/AbstractHttp11Protocol.java
+++ b/java/org/apache/coyote/http11/AbstractHttp11Protocol.java
@@ -445,6 +445,19 @@ public abstract class AbstractHttp11Protocol<S> extends AbstractProtocol<S> {
     }
 
 
+    public void setCrlFile(String certificateRevocationListFile){
+        registerDefaultSSLHostConfig();
+        defaultSSLHostConfig.setCertificateRevocationListFile(certificateRevocationListFile);
+    }
+    public void setSSLCARevocationFile(String certificateRevocationListFile) {
+        registerDefaultSSLHostConfig();
+        defaultSSLHostConfig.setCertificateRevocationListFile(certificateRevocationListFile);
+    }
+    public void setSSLCARevocationPath(String certificateRevocationListPath) {
+        registerDefaultSSLHostConfig();
+        defaultSSLHostConfig.setCertificateRevocationListPath(certificateRevocationListPath);
+    }
+
 
     // ------------------------------------------------------------- Common code
 

==================================================
AbstractEndpoint.java
index 40ba12b6fe..9a9760aa40 100644
--- a/java/org/apache/coyote/http11/Http11AprProtocol.java
+++ b/java/org/apache/coyote/http11/Http11AprProtocol.java
@@ -93,20 +93,6 @@ public class Http11AprProtocol extends AbstractHttp11Protocol<Long> {
     public void setSSLCACertificateFile(String SSLCACertificateFile) { ((AprEndpoint)getEndpoint()).setSSLCACertificateFile(SSLCACertificateFile); }
 
 
-    /**
-     * SSL CA revocation path.
-     */
-    public String getSSLCARevocationPath() { return ((AprEndpoint)getEndpoint()).getSSLCARevocationPath(); }
-    public void setSSLCARevocationPath(String SSLCARevocationPath) { ((AprEndpoint)getEndpoint()).setSSLCARevocationPath(SSLCARevocationPath); }
-
-
-    /**
-     * SSL CA revocation file.
-     */
-    public String getSSLCARevocationFile() { return ((AprEndpoint)getEndpoint()).getSSLCARevocationFile(); }
-    public void setSSLCARevocationFile(String SSLCARevocationFile) { ((AprEndpoint)getEndpoint()).setSSLCARevocationFile(SSLCARevocationFile); }
-
-
     /**
      * Disable SSL compression.
      */

==================================================
AprEndpoint.java
index 896252e6d0..c90b0d4536 100644
--- a/java/org/apache/tomcat/util/net/AbstractEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AbstractEndpoint.java
@@ -1037,12 +1037,6 @@ public abstract class AbstractEndpoint<S> {
         this.trustManagerClassName = trustManagerClassName;
     }
 
-    private String crlFile = null;
-    public String getCrlFile() {return crlFile;}
-    public void setCrlFile(String crlFile) {
-        this.crlFile = crlFile;
-    }
-
     private String sessionCacheSize = null;
     public String getSessionCacheSize() { return sessionCacheSize;}
     public void setSessionCacheSize(String s) { sessionCacheSize = s;}

==================================================
SSLHostConfig.java
index 5bf1c35d05..021e090ac1 100644
--- a/java/org/apache/tomcat/util/net/AprEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AprEndpoint.java
@@ -232,21 +232,6 @@ public class AprEndpoint extends AbstractEndpoint<Long> implements SNICallBack {
     public void setSSLCACertificateFile(String SSLCACertificateFile) { this.SSLCACertificateFile = SSLCACertificateFile; }
 
 
-    /**
-     * SSL CA revocation path.
-     */
-    protected String SSLCARevocationPath = null;
-    public String getSSLCARevocationPath() { return SSLCARevocationPath; }
-    public void setSSLCARevocationPath(String SSLCARevocationPath) { this.SSLCARevocationPath = SSLCARevocationPath; }
-
-
-    /**
-     * SSL CA revocation file.
-     */
-    protected String SSLCARevocationFile = null;
-    public String getSSLCARevocationFile() { return SSLCARevocationFile; }
-    public void setSSLCARevocationFile(String SSLCARevocationFile) { this.SSLCARevocationFile = SSLCARevocationFile; }
-
     /**
      * SSL disable TLS Session Tickets (RFC 4507).
      */
@@ -564,7 +549,8 @@ public class AprEndpoint extends AbstractEndpoint<Long> implements SNICallBack {
                 // Support Client Certificates
                 SSLContext.setCACertificate(ctx, SSLCACertificateFile, SSLCACertificatePath);
                 // Set revocation
-                SSLContext.setCARevocation(ctx, SSLCARevocationFile, SSLCARevocationPath);
+                SSLContext.setCARevocation(ctx, sslHostConfig.getCertificateRevocationListFile(),
+                        sslHostConfig.getCertificateRevocationListPath());
                 // Client certificate verification
                 switch (sslHostConfig.getCertificateVerification()) {
                 case NONE:

==================================================
JSSESocketFactory.java
index d57d92b6b4..0c5ad6182e 100644
--- a/java/org/apache/tomcat/util/net/SSLHostConfig.java
+++ b/java/org/apache/tomcat/util/net/SSLHostConfig.java
@@ -50,8 +50,8 @@ public class SSLHostConfig {
     private int certificateVerificationDepth = 10;
     private String ciphers = "HIGH:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!kRSA";
     private boolean honorCipherOrder = false;
-
     private Set<String> protocols = new HashSet<>();
+    private String certificateRevocationListFile;
     // JSSE
     private String certificateKeystorePassword = "changeit";
     private String certificateKeystoreFile = System.getProperty("user.home")+"/.keystore";
@@ -59,6 +59,7 @@ public class SSLHostConfig {
     // OpenSSL
     private String certificateFile;
     private String certificateKeyFile;
+    private String certificateRevocationListPath;
 
     public SSLHostConfig() {
         // Set defaults that can't be (easily) set when defining the fields.
@@ -117,6 +118,16 @@ public class SSLHostConfig {
     }
 
 
+    public void setCertificateRevocationListFile(String certificateRevocationListFile) {
+        this.certificateRevocationListFile = certificateRevocationListFile;
+    }
+
+
+    public String getCertificateRevocationListFile() {
+        return certificateRevocationListFile;
+    }
+
+
     public void setCertificateVerification(String certificateVerification) {
         this.certificateVerification = CertificateVerification.fromString(certificateVerification);
     }
@@ -275,6 +286,17 @@ public class SSLHostConfig {
     }
 
 
+    public void setCertificateRevocationListPath(String certificateRevocationListPath) {
+        setProperty("certificateRevocationListPath", Type.OPENSSL);
+        this.certificateRevocationListPath = certificateRevocationListPath;
+    }
+
+
+    public String getCertificateRevocationListPath() {
+        return certificateRevocationListPath;
+    }
+
+
     // ----------------------------------------------------------- Inner classes
 
     public static enum Type {

==================================================
