519403fb8aace2c64e1ee3999511719418dc6968
==================================================
Fix BZ 66442 - h2 responses without bodies should not use DATA frames
==================================================
Mark Thomas
==================================================
Wed Jan 25 16:28:34 2023 +0000
==================================================
Stream.java
Fix BZ 66442 - h2 responses without bodies should not use DATA frames

https://bz.apache.org/bugzilla/show_bug.cgi?id=66442


==================================================
StreamProcessor.java
index 349e2f5942..a0f997e13a 100644
--- a/java/org/apache/coyote/http2/Stream.java
+++ b/java/org/apache/coyote/http2/Stream.java
@@ -335,8 +335,7 @@ class Stream extends AbstractNonZeroStream implements HeaderEmitter {
                 if (coyoteRequest.method().isNull()) {
                     coyoteRequest.method().setString(value);
                     if ("HEAD".equals(value)) {
-                        addOutputFilter(new VoidOutputFilter());
-                        streamOutputBuffer.closed = true;
+                        configureVoidOutputFilter();
                     }
                 } else {
                     throw new HpackException(
@@ -448,6 +447,12 @@ class Stream extends AbstractNonZeroStream implements HeaderEmitter {
     }
 
 
+    void configureVoidOutputFilter() {
+        addOutputFilter(new VoidOutputFilter());
+        // Prevent further writes by the application
+        streamOutputBuffer.closed = true;
+    }
+
     private void parseAuthority(String value, boolean host) throws HpackException {
         int i;
         try {

==================================================
Http2TestBase.java
index 635949fa34..7398ce0de5 100644
--- a/java/org/apache/coyote/http2/StreamProcessor.java
+++ b/java/org/apache/coyote/http2/StreamProcessor.java
@@ -205,6 +205,10 @@ class StreamProcessor extends AbstractProcessor {
                 headers.addValue("content-length").setLong(contentLength);
             }
         } else {
+            // Disable response body
+            if (stream != null) {
+                stream.configureVoidOutputFilter();
+            }
             if (statusCode == 205) {
                 // RFC 7231 requires the server to explicitly signal an empty
                 // response in this case

==================================================
TestStreamProcessor.java
index 4dc566fb9a..a81a450f6b 100644
--- a/test/org/apache/coyote/http2/Http2TestBase.java
+++ b/test/org/apache/coyote/http2/Http2TestBase.java
@@ -1339,6 +1339,18 @@ public abstract class Http2TestBase extends TomcatBaseTest {
     }
 
 
+    public static class NoContentServlet extends HttpServlet {
+
+        private static final long serialVersionUID = 1L;
+
+        @Override
+        protected void doGet(HttpServletRequest req, HttpServletResponse resp)
+                throws ServletException, IOException {
+            resp.setStatus(HttpServletResponse.SC_NO_CONTENT);
+        }
+    }
+
+
     public static class SimpleServlet extends HttpServlet {
 
         private static final long serialVersionUID = 1L;

==================================================
