b27e898d43631d2da542c830bd0f10595478f8aa
==================================================
Partial fix for re-opened https://issues.apache.org/bugzilla/show_bug.cgi?id=49134
==================================================
Mark Emlyn
==================================================
Sat Oct 5 22:53:05 2013 +0000
==================================================
CombinedRealm.java
Partial fix for re-opened https://issues.apache.org/bugzilla/show_bug.cgi?id=49134
Ensure nested realms are correctly destroyed, ensuring that the associated MBeans are deregistered.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1529546 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestRegistration.java
index 260128f18e..f5cb879090 100644
--- a/java/org/apache/catalina/realm/CombinedRealm.java
+++ b/java/org/apache/catalina/realm/CombinedRealm.java
@@ -244,6 +244,20 @@ public class CombinedRealm extends RealmBase {
     }
 
 
+    /**
+     * Ensure child Realms are destroyed when this Realm is destroyed.
+     */
+    @Override
+    protected void destroyInternal() throws LifecycleException {
+        for (Realm realm : realms) {
+            if (realm instanceof Lifecycle) {
+                ((Lifecycle) realm).destroy();
+            }
+        }
+        super.destroyInternal();
+    }
+
+
     /**
      * Return the Principal associated with the specified chain of X509
      * client certificates.  If there is none, return <code>null</code>.

==================================================
