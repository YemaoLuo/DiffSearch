f98f18acd7993c3b8d45b5837330889ad5be82df
==================================================
Need to be able to close the upgraded input/output streams
==================================================
Mark Emlyn
==================================================
Fri Dec 21 20:49:59 2012 +0000
==================================================
AbstractServletInputStream.java
Need to be able to close the upgraded input/output streams

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1425136 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AbstractServletOutputStream.java
index 56bb1dfd8a..51a82c75c3 100644
--- a/java/org/apache/coyote/http11/upgrade/AbstractServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/AbstractServletInputStream.java
@@ -120,6 +120,13 @@ public abstract class AbstractServletInputStream extends ServletInputStream {
     }
 
 
+
+    @Override
+    public void close() throws IOException {
+        doClose();
+    }
+
+
     private void preReadChecks() {
         if (listener != null && (ready == null || !ready.booleanValue())) {
             throw new IllegalStateException(
@@ -170,4 +177,6 @@ public abstract class AbstractServletInputStream extends ServletInputStream {
 
     protected abstract int doRead(boolean block, byte[] b, int off, int len)
             throws IOException;
+
+    protected abstract void doClose() throws IOException;
 }

==================================================
AprServletInputStream.java
index 00016f9d7d..cf29988a0e 100644
--- a/java/org/apache/coyote/http11/upgrade/AbstractServletOutputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/AbstractServletOutputStream.java
@@ -68,6 +68,11 @@ public abstract class AbstractServletOutputStream extends ServletOutputStream {
     }
 
 
+    @Override
+    public void close() throws IOException {
+        doClose();
+    }
+
     private void preWriteChecks() {
         if (buffer != null) {
             throw new IllegalStateException(
@@ -110,4 +115,6 @@ public abstract class AbstractServletOutputStream extends ServletOutputStream {
             throws IOException;
 
     protected abstract void doFlush() throws IOException;
+
+    protected abstract void doClose() throws IOException;
 }

==================================================
AprServletOutputStream.java
index 22787001b6..e559e68a49 100644
--- a/java/org/apache/coyote/http11/upgrade/AprServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/AprServletInputStream.java
@@ -78,4 +78,8 @@ public class AprServletInputStream extends AbstractServletInputStream {
         return false;
     }
 
+    @Override
+    protected void doClose() throws IOException {
+        // TODO Auto-generated method stub
+    }
 }

==================================================
BioServletInputStream.java
index 2343d3a84d..c9f1a2454d 100644
--- a/java/org/apache/coyote/http11/upgrade/AprServletOutputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/AprServletOutputStream.java
@@ -41,4 +41,10 @@ public class AprServletOutputStream extends AbstractServletOutputStream {
     protected void doFlush() throws IOException {
         // TODO Auto-generated method stub
     }
+
+
+    @Override
+    protected void doClose() throws IOException {
+        // TODO Auto-generated method stub
+    }
 }

==================================================
BioServletOutputStream.java
index 119000ac15..a2048c61b3 100644
--- a/java/org/apache/coyote/http11/upgrade/BioServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/BioServletInputStream.java
@@ -42,4 +42,9 @@ public class BioServletInputStream extends AbstractServletInputStream {
         // Always returns true for BIO
         return true;
     }
+
+    @Override
+    protected void doClose() throws IOException {
+        inputStream.close();
+    }
 }

==================================================
NioServletInputStream.java
index 30178b578c..da5ae78d27 100644
--- a/java/org/apache/coyote/http11/upgrade/BioServletOutputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/BioServletOutputStream.java
@@ -42,4 +42,9 @@ public class BioServletOutputStream extends AbstractServletOutputStream {
     protected void doFlush() throws IOException {
         os.flush();
     }
+
+    @Override
+    protected void doClose() throws IOException {
+        os.close();
+    }
 }

==================================================
NioServletOutputStream.java
index 80b10d54ce..222d474c34 100644
--- a/java/org/apache/coyote/http11/upgrade/NioServletInputStream.java
+++ b/java/org/apache/coyote/http11/upgrade/NioServletInputStream.java
@@ -101,6 +101,14 @@ public class NioServletInputStream extends AbstractServletInputStream {
         return len - leftToWrite;
     }
 
+
+
+    @Override
+    protected void doClose() throws IOException {
+        channel.close();
+    }
+
+
     private int fillReadBuffer(boolean block) throws IOException {
         int nRead;
         if (block) {

==================================================
