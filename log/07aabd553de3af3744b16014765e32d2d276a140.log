07aabd553de3af3744b16014765e32d2d276a140
==================================================
Add a check that the URIEncoding is a superset of US-ASCII.
==================================================
Mark Thomas
==================================================
Fri Mar 13 11:36:54 2020 +0000
==================================================
Connector.java
Add a check that the URIEncoding is a superset of US-ASCII.

This is a requirement of RFC7230, section 3.


==================================================
CharsetUtil.java
index 1cc68af59d..ef7d28f3d1 100644
--- a/java/org/apache/catalina/connector/LocalStrings.properties
+++ b/java/org/apache/catalina/connector/LocalStrings.properties
@@ -24,6 +24,7 @@ coyoteAdapter.nullRequest=An asynchronous dispatch may only happen on an existin
 
 coyoteConnector.invalidEncoding=The encoding [{0}] is not recognised by the JRE. The Connector will continue to use [{1}]
 coyoteConnector.invalidPort=The connector cannot start since the specified port value of [{0}] is invalid
+coyoteConnector.notAsciiSuperset=The encoding [{0}] is not a superset of ASCII as required by RFC 7230. The Connector will continue to use [{1}]
 coyoteConnector.parseBodyMethodNoTrace=TRACE method MUST NOT include an entity (see RFC 2616 Section 9.6)
 coyoteConnector.protocolHandlerDestroyFailed=Protocol handler destroy failed
 coyoteConnector.protocolHandlerInitializationFailed=Protocol handler initialization failed

==================================================
TestCharsetUtil.java
new file mode 100644
index 0000000000..fc0a09e4c1
--- /dev/null
+++ b/java/org/apache/tomcat/util/buf/CharsetUtil.java
@@ -0,0 +1,58 @@
+/*
+ *  Licensed to the Apache Software Foundation (ASF) under one or more
+ *  contributor license agreements.  See the NOTICE file distributed with
+ *  this work for additional information regarding copyright ownership.
+ *  The ASF licenses this file to You under the Apache License, Version 2.0
+ *  (the "License"); you may not use this file except in compliance with
+ *  the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ */
+package org.apache.tomcat.util.buf;
+
+import java.nio.BufferUnderflowException;
+import java.nio.ByteBuffer;
+import java.nio.CharBuffer;
+import java.nio.charset.CharacterCodingException;
+import java.nio.charset.Charset;
+import java.nio.charset.CharsetDecoder;
+
+public class CharsetUtil {
+
+    private CharsetUtil() {
+        // Utility class. Hide default constructor.
+    }
+
+
+    public static boolean isAsciiSuperset(Charset charset) {
+        // Bytes 0x00 to 0x7F must decode to the first 128 Unicode characters
+        CharsetDecoder decoder = charset.newDecoder();
+        ByteBuffer inBytes = ByteBuffer.allocate(1);
+        CharBuffer outChars;
+        for (int i = 0; i < 128; i++) {
+            inBytes.clear();
+            inBytes.put((byte) i);
+            inBytes.flip();
+            try {
+                outChars = decoder.decode(inBytes);
+            } catch (CharacterCodingException e) {
+                return false;
+            }
+            try {
+                if (outChars.get() != i) {
+                    return false;
+                }
+            } catch (BufferUnderflowException e) {
+                return false;
+            }
+        }
+
+        return true;
+    }
+}

==================================================
