023bd52733296f30b351c48b571b44bd635ed34e
==================================================
Followup to r756926 (forward remote port via AJP13).
==================================================
Rainer Jung
==================================================
Sun Mar 22 17:55:35 2009 +0000
==================================================
AjpAprProcessor.java
Followup to r756926 (forward remote port via AJP13).
- Use a more private attribute name and
  define it in the Constants class.
- Do not set the attribute on the request,
  only use it for the remote port.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@757223 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AjpProcessor.java
index 560b457118..98f8799fc9 100644
--- a/java/org/apache/coyote/ajp/AjpAprProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpAprProcessor.java
@@ -715,18 +715,20 @@ public class AjpAprProcessor implements ActionHook {
                 String n = tmpMB.toString();
                 requestHeaderMessage.getBytes(tmpMB);
                 String v = tmpMB.toString();
-                request.setAttribute(n, v);
                 /*
                  * AJP13 misses to forward the remotePort.
-                 * Apache automatically sets REMOTE_PORT to the remote port.
-                 * Allow the user to set "JkEnvVar REMOTE_PORT" and
-                 * let us accept the forwarded port as the remote port.
+                 * Allow the AJP connector to add this info via
+                 * a private request attribute.
+                 * We will accept the forwarded data as the remote port,
+                 * and remove it from the public list of request attributes.
                  */
-                if(n.equals("REMOTE_PORT")) {
+                if(n.equals(Constants.SC_A_REQ_REMOTE_PORT)) {
                     try {
                         request.setRemotePort(Integer.parseInt(v));
                     } catch (NumberFormatException nfe) {
                     }
+                } else {
+                    request.setAttribute(n, v);
                 }
                 break;
 

==================================================
Constants.java
index f4e20b35f9..38f92d5203 100644
--- a/java/org/apache/coyote/ajp/AjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpProcessor.java
@@ -721,18 +721,20 @@ public class AjpProcessor implements ActionHook {
                 String n = tmpMB.toString();
                 requestHeaderMessage.getBytes(tmpMB);
                 String v = tmpMB.toString();
-                request.setAttribute(n, v);
                 /*
                  * AJP13 misses to forward the remotePort.
-                 * Apache automatically sets REMOTE_PORT to the remote port.
-                 * Allow the user to set "JkEnvVar REMOTE_PORT" and
-                 * let us accept the forwarded port as the remote port.
+                 * Allow the AJP connector to add this info via
+                 * a private request attribute.
+                 * We will accept the forwarded data as the remote port,
+                 * and remove it from the public list of request attributes.
                  */
-                if(n.equals("REMOTE_PORT")) {
+                if(n.equals(Constants.SC_A_REQ_REMOTE_PORT)) {
                     try {
                         request.setRemotePort(Integer.parseInt(v));
                     } catch (NumberFormatException nfe) {
                     }
+                } else {
+                    request.setAttribute(n, v );
                 }
                 break;
 

==================================================
AjpConstants.java
index a5d533de9b..007fec9c55 100644
--- a/java/org/apache/coyote/ajp/Constants.java
+++ b/java/org/apache/coyote/ajp/Constants.java
@@ -88,6 +88,11 @@ public final class Constants {
     // Used for attributes which are not in the list above
     public static final byte SC_A_REQ_ATTRIBUTE = 10;
 
+    /**
+     * AJP private request attributes
+     */
+    public static final String SC_A_REQ_REMOTE_PORT = "AJP_REMOTE_PORT";
+
     // Terminates list of attributes
     public static final byte SC_A_ARE_DONE      = (byte)0xFF;
 

==================================================
HandlerRequest.java
index 155c93f573..df16b90217 100644
--- a/java/org/apache/jk/common/AjpConstants.java
+++ b/java/org/apache/jk/common/AjpConstants.java
@@ -96,6 +96,11 @@ public class AjpConstants {
      */
     public static final byte SC_A_REQ_ATTRIBUTE = 10; 
 
+    /**
+     * AJP private request attributes
+     */
+    public static final String SC_A_REQ_REMOTE_PORT = "AJP_REMOTE_PORT";
+
     /**
      * Terminates list of attributes
      */

==================================================
