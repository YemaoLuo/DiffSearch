8ff629904dedd7ff29e9e76200f4107798eecd11
==================================================
Changes to the initial window size need to modify existing flow control windows as if the had started with the new initial size.
==================================================
Mark Thomas
==================================================
Thu Aug 20 11:02:58 2015 +0000
==================================================
Http2UpgradeHandler.java
Changes to the initial window size need to modify existing flow control windows as if the had started with the new initial size.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1696756 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestHttp2Section_6_9.java
index d2f0e7b32d..bb1189f13a 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -983,7 +983,22 @@ public class Http2UpgradeHandler extends AbstractStream implements InternalHttpU
 
     @Override
     public void setting(Setting setting, long value) throws ConnectionException {
-        remoteSettings.set(setting, value);
+        // Special handling required
+        if (setting == Setting.INITIAL_WINDOW_SIZE) {
+            long oldValue = remoteSettings.getInitialWindowSize();
+            // Do this first in case new value is invalid
+            remoteSettings.set(setting, value);
+            int diff = (int) (value - oldValue);
+            for (Stream stream : streams.values()) {
+                try {
+                    stream.incrementWindowSize(diff);
+                } catch (Http2Exception e) {
+                    // Should never happen since the diff should always be valid
+                }
+            }
+        } else {
+            remoteSettings.set(setting, value);
+        }
     }
 
 

==================================================
