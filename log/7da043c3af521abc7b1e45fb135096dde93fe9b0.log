7da043c3af521abc7b1e45fb135096dde93fe9b0
==================================================
Additional fix for http://issues.apache.org/bugzilla/show_bug.cgi?id=53584
==================================================
Mark Emlyn
==================================================
Mon Aug 13 12:25:57 2012 +0000
==================================================
FormAuthenticator.java
Additional fix for http://issues.apache.org/bugzilla/show_bug.cgi?id=53584
Store decoded and original request URI. Restore both. Use decoded for matching.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1372390 13f79535-47bb-0310-9956-ffa450edef68



==================================================
SavedRequest.java
index a16d676df5..7c1f62af02 100644
--- a/java/org/apache/catalina/authenticator/FormAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/FormAuthenticator.java
@@ -475,12 +475,11 @@ public class FormAuthenticator
     }
 
       // Does the request URI match?
-      String requestURI = request.getDecodedRequestURI();
-      if (requestURI == null) {
+      String decodedRequestURI = request.getDecodedRequestURI();
+      if (decodedRequestURI == null) {
         return (false);
     }
-      return (requestURI.equals(sreq.getRequestURI()));
-
+      return (decodedRequestURI.equals(sreq.getDecodedRequestURI()));
     }
 
 
@@ -635,11 +634,11 @@ public class FormAuthenticator
 
         saved.setMethod(request.getMethod());
         saved.setQueryString(request.getQueryString());
-        saved.setRequestURI(request.getDecodedRequestURI());
+        saved.setRequestURI(request.getRequestURI());
+        saved.setDecodedRequestURI(request.getDecodedRequestURI());
 
         // Stash the SavedRequest in our session for later use
         session.setNote(Constants.FORM_REQUEST_NOTE, saved);
-
     }
 
 

==================================================
