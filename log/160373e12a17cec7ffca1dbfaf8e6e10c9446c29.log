160373e12a17cec7ffca1dbfaf8e6e10c9446c29
==================================================
Simplify getContentCount.
==================================================
Mark Emlyn
==================================================
Wed Jan 5 10:10:29 2011 +0000
==================================================
OutputBuffer.java
Simplify getContentCount.
Prep for fixing bug 50496

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1055391 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Response.java
index ef3460f58d..e9bfc2c202 100644
--- a/java/org/apache/catalina/connector/OutputBuffer.java
+++ b/java/org/apache/catalina/connector/OutputBuffer.java
@@ -340,6 +340,7 @@ public class OutputBuffer extends Writer
      * 
      * @throws IOException An underlying IOException occurred
      */
+    @Override
     public void realWriteBytes(byte buf[], int off, int cnt)
             throws IOException {
 
@@ -513,6 +514,7 @@ public class OutputBuffer extends Writer
                     conv = AccessController.doPrivileged(
                             new PrivilegedExceptionAction<C2BConverter>(){
 
+                                @Override
                                 public C2BConverter run() throws IOException{
                                     return new C2BConverter(bb, enc);
                                 }
@@ -547,29 +549,7 @@ public class OutputBuffer extends Writer
 
     }
 
-    public int getBytesWritten() {
-        if (bytesWritten < Integer.MAX_VALUE) {
-            return (int) bytesWritten;
-        }
-        return -1;
-    }
-
-    public int getCharsWritten() {
-        if (charsWritten < Integer.MAX_VALUE) {
-            return (int) charsWritten;
-        }
-        return -1;
-    }
-
-    public int getContentWritten() {
-        long size = bytesWritten + charsWritten ;
-        if (size < Integer.MAX_VALUE) {
-            return (int) size;
-        }
-        return -1;
-    }
-
-    public long getContentWrittenLong() {
+    public long getContentWritten() {
         return bytesWritten + charsWritten;
     }
     

==================================================
AccessLogValve.java
index b7ada95ba4..98d05a3d15 100644
--- a/java/org/apache/catalina/connector/Response.java
+++ b/java/org/apache/catalina/connector/Response.java
@@ -310,16 +310,9 @@ public class Response
     /**
      * Return the number of bytes actually written to the output stream.
      */
-    public int getContentCount() {
+    public long getContentCount() {
         return outputBuffer.getContentWritten();
     }
-    
-    /**
-     * Return the number of bytes actually written to the output stream.
-     */
-    public long getContentCountLong() {
-        return outputBuffer.getContentWrittenLong();
-    }
 
     /**
      * Set the application commit flag.

==================================================
ErrorReportValve.java
index d26f1b6956..b71a89b036 100644
--- a/java/org/apache/catalina/valves/AccessLogValve.java
+++ b/java/org/apache/catalina/valves/AccessLogValve.java
@@ -1057,7 +1057,7 @@ public class AccessLogValve extends ValveBase implements AccessLog {
         @Override
         public void addElement(StringBuilder buf, Date date, Request request,
                 Response response, long time) {
-            long length = response.getContentCountLong() ;
+            long length = response.getContentCount() ;
             if (length <= 0 && conversion) {
                 buf.append('-');
             } else {

==================================================
JDBCAccessLogValve.java
index ec10004c89..5ad3e1ebbd 100644
--- a/java/org/apache/catalina/valves/ErrorReportValve.java
+++ b/java/org/apache/catalina/valves/ErrorReportValve.java
@@ -165,7 +165,7 @@ public class ErrorReportValve extends ValveBase {
 
         // Do nothing on a 1xx, 2xx and 3xx status
         // Do nothing if anything has been written already
-        if ((statusCode < 400) || (response.getContentCountLong() > 0))
+        if ((statusCode < 400) || (response.getContentCount() > 0))
             return;
 
         String message = RequestUtil.filter(response.getMessage());

==================================================
