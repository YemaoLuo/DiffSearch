28c53dacd36c4e1218095fa1202967dd1220a620
==================================================
Fix issues with previous patch to remove use of ThreadLocal
==================================================
Mark Thomas
==================================================
Wed Jun 17 09:01:11 2015 +0000
==================================================
JaspicAuthenticator.java
index cde0f84aa8..9bfd6f3fe4 100644
--- a/java/org/apache/catalina/authenticator/LocalStrings.properties
+++ b/java/org/apache/catalina/authenticator/LocalStrings.properties
@@ -26,7 +26,6 @@ authenticator.noAuthHeader=No authorization header sent by client
 authenticator.notContext=Configuration error:  Must be attached to a Context
 authenticator.requestBodyTooBig=The request body was too large to be cached during the authentication process
 authenticator.sessionExpired=The time allowed for the login process has been exceeded. If you wish to continue you must either click back twice and re-click the link you requested or close and re-open your browser
-authenticator.unauthorized=Cannot authenticate with the provided credentials
 
 digestAuthenticator.cacheRemove=A valid entry has been removed from client nonce cache to make room for new entries. A replay attack is now possible. To prevent the possibility of replay attacks, reduce nonceValidity or increase cnonceCacheSize. Further warnings of this type will be suppressed for 5 minutes.
 

==================================================
JaspicCallbackHandler.java
index 4e7a0a11ca..1eaca0106b 100644
--- a/java/org/apache/catalina/authenticator/jaspic/JaspicAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/jaspic/JaspicAuthenticator.java
@@ -38,9 +38,7 @@ import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 
 /**
- * Security valve which implements JASPIC authentication
- * @author Fjodor Vershinin
- *
+ * Security valve which implements JASPIC authentication.
  */
 public class JaspicAuthenticator extends AuthenticatorBase {
 
@@ -54,12 +52,14 @@ public class JaspicAuthenticator extends AuthenticatorBase {
     @SuppressWarnings("rawtypes")
     private Map authProperties = null;
 
+
     @Override
     protected synchronized void startInternal() throws LifecycleException {
         super.startInternal();
         serviceSubject = new Subject();
     }
 
+
     @Override
     public boolean authenticate(Request request, HttpServletResponse response) throws IOException {
         MessageInfo messageInfo = new MessageInfoImpl(request, response, true);
@@ -98,31 +98,38 @@ public class JaspicAuthenticator extends AuthenticatorBase {
         return false;
     }
 
+
     @Override
     public void login(String userName, String password, Request request) throws ServletException {
         throw new IllegalStateException("not implemented yet!");
     }
 
+
     @Override
     public void logout(Request request) {
         throw new IllegalStateException("not implemented yet!");
     }
 
+
     private void handleUnauthorizedRequest(HttpServletResponse response, AuthException e)
             throws IOException {
-        log.error(sm.getString("authenticator.unauthorized"), e);
-        response.sendError(HttpServletResponse.SC_UNAUTHORIZED,
-                sm.getString("authenticator.unauthorized"));
+        response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
+        if (log.isDebugEnabled()) {
+            log.debug(sm.getString("authenticator.jaspic.unauthorized"), e);
+        }
     }
 
+
     private String getAppContextId(Request request) {
         return request.getServletContext().getVirtualServerName() + " " + request.getContextPath();
     }
 
+
     private JaspicCallbackHandler getJaspicCallbackHandler() {
         return new JaspicCallbackHandler(container.getRealm());
     }
 
+
     @Override
     protected String getAuthMethod() {
         return AUTH_TYPE;

==================================================
PrincipalGroupCallback.java
index 510aa3fa44..8840c3a096 100644
--- a/java/org/apache/catalina/authenticator/jaspic/LocalStrings.properties
+++ b/java/org/apache/catalina/authenticator/jaspic/LocalStrings.properties
@@ -13,4 +13,5 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+authenticator.jaspic.unauthorized=Cannot authenticate with the provided credentials
 authenticator.jaspic.unknownCallback=Unknown JASPIC callback: [{0}]

==================================================
