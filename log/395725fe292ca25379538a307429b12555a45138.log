395725fe292ca25379538a307429b12555a45138
==================================================
APR:
==================================================
Mark Thomas
==================================================
Thu Jan 15 09:20:53 2015 +0000
==================================================
InternalAprInputBuffer.java
APR:
 - Simplify.
 - Correct test for exceeded the max header size.
NIO
 - Use read method from SocketWrapper

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1652000 13f79535-47bb-0310-9956-ffa450edef68



==================================================
InternalNioInputBuffer.java
index f3425a9ad9..c6e05efadf 100644
--- a/java/org/apache/coyote/http11/InternalAprInputBuffer.java
+++ b/java/org/apache/coyote/http11/InternalAprInputBuffer.java
@@ -91,10 +91,8 @@ public class InternalAprInputBuffer extends AbstractInputBuffer<Long> {
     @Override
     protected boolean fill(boolean block) throws IOException {
 
-        int nRead = 0;
-
         if (parsingHeader) {
-            if (lastValid == buf.length) {
+            if (lastValid > headerBufferSize) {
                 throw new IllegalArgumentException
                     (sm.getString("iib.requestheadertoolarge.error"));
             }
@@ -102,7 +100,7 @@ public class InternalAprInputBuffer extends AbstractInputBuffer<Long> {
             lastValid = pos = end;
         }
 
-        nRead = wrapper.read(block, buf, pos, buf.length - pos);
+        int nRead = wrapper.read(block, buf, pos, buf.length - pos);
         if (nRead > 0) {
             lastValid = pos + nRead;
             return true;

==================================================
