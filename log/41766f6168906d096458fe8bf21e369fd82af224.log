41766f6168906d096458fe8bf21e369fd82af224
==================================================
Ensure that SQLWarning has been cleared when connection returns to the pool.
==================================================
Keiichi Fujino
==================================================
Mon Mar 12 06:45:44 2018 +0000
==================================================
ConnectionPool.java
Ensure that SQLWarning has been cleared when connection returns to the pool.
Enable clearing of SQLWarning via JMX.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1826507 13f79535-47bb-0310-9956-ffa450edef68



==================================================
PooledConnection.java
index 5d61f7cffa..74c3f12cf0 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
@@ -934,6 +934,7 @@ public class ConnectionPool {
                 if (busy.remove(con)) {
 
                     if (!shouldClose(con,PooledConnection.VALIDATE_RETURN)) {
+                        con.clearWarnings();
                         con.setStackTrace(null);
                         con.setTimestamp(System.currentTimeMillis());
                         if (((idle.size()>=poolProperties.getMaxIdle()) && !poolProperties.isPoolSweeperEnabled()) || (!idle.offer(con))) {

==================================================
PooledConnectionMBean.java
index 336eeefce4..69df7f81d6 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/PooledConnection.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/PooledConnection.java
@@ -807,6 +807,15 @@ public class PooledConnection implements PooledConnectionMBean {
         return oname;
     }
 
+    @Override
+    public void clearWarnings() {
+        try {
+            connection.clearWarnings();
+        } catch (SQLException e) {
+            log.warn("Unable to clear Warnings, connection will be closed.", e);
+        }
+    }
+
     @Override
     public boolean isClosed() throws SQLException {
         return connection.isClosed();

==================================================
