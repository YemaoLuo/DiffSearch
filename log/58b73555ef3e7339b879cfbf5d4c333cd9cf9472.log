58b73555ef3e7339b879cfbf5d4c333cd9cf9472
==================================================
https://issues.apache.org/bugzilla/show_bug.cgi?id=50805
==================================================
Filip Hanik
==================================================
Tue Feb 22 22:42:44 2011 +0000
==================================================
ConnectionPool.java
https://issues.apache.org/bugzilla/show_bug.cgi?id=50805
Make sure we only call borrowConnection once per connection per checkout



git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1073531 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Bug50805.java
index 3bfc2422cc..1583bf2bad 100644
--- a/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
+++ b/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
@@ -142,6 +142,7 @@ public class ConnectionPool {
     public Future<Connection> getConnectionAsync() throws SQLException {
         PooledConnection pc = this.borrowConnection(0, null, null);
         if (pc!=null) {
+            
             return new ConnectionFuture(pc);
         } 
         //we can only retrieve a future if the underlying queue supports it.
@@ -1054,8 +1055,10 @@ public class ConnectionPool {
             this.pcFuture = pcf;
         }
         
-        public ConnectionFuture(PooledConnection pc) {
+        public ConnectionFuture(PooledConnection pc) throws SQLException {
             this.pc = pc;
+            result = ConnectionPool.this.setupConnection(pc);
+            configured.set(true);
         }
         /**
          * {@inheritDoc}

==================================================
