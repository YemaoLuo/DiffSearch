93bcdde55f62c6598f0dde9de2a575705e6b5abb
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55127
==================================================
Mark Emlyn
==================================================
Sat Jun 22 14:09:34 2013 +0000
==================================================
WsRemoteEndpointImplBase.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55127
Encoders have init() and destroy() methdos that need to be called.
Based on a patch provided by Niki Dokovski.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1495735 13f79535-47bb-0310-9956-ffa450edef68



==================================================
WsRemoteEndpointImplClient.java
index 93b23e2e1c..854331afb7 100644
--- a/java/org/apache/tomcat/websocket/WsRemoteEndpointImplBase.java
+++ b/java/org/apache/tomcat/websocket/WsRemoteEndpointImplBase.java
@@ -38,6 +38,7 @@ import java.util.concurrent.atomic.AtomicBoolean;
 import javax.websocket.DeploymentException;
 import javax.websocket.EncodeException;
 import javax.websocket.Encoder;
+import javax.websocket.EndpointConfig;
 import javax.websocket.RemoteEndpoint;
 import javax.websocket.SendHandler;
 import javax.websocket.SendResult;
@@ -460,13 +461,15 @@ public abstract class WsRemoteEndpointImplBase implements RemoteEndpoint {
     }
 
 
-    protected void setEncoders(List<Class<? extends Encoder>> encoders)
+    protected void setEncoders(EndpointConfig endpointConfig)
             throws DeploymentException {
         encoderEntries.clear();
-        for (Class<? extends Encoder> encoderClazz : encoders) {
+        for (Class<? extends Encoder> encoderClazz :
+                endpointConfig.getEncoders()) {
             Encoder instance;
             try {
                 instance = encoderClazz.newInstance();
+                instance.init(endpointConfig);
             } catch (InstantiationException | IllegalAccessException e) {
                 throw new DeploymentException(
                         sm.getString("wsRemoteEndpoint.invalidEncoder",
@@ -489,10 +492,17 @@ public abstract class WsRemoteEndpointImplBase implements RemoteEndpoint {
     }
 
 
+    protected final void close() {
+        for (EncoderEntry entry : encoderEntries) {
+            entry.getEncoder().destroy();
+        }
+        doClose();
+    }
+
+
     protected abstract void doWrite(SendHandler handler, ByteBuffer... data);
     protected abstract boolean isMasked();
-    protected abstract void close();
-
+    protected abstract void doClose();
 
     private static void writeHeader(ByteBuffer headerBuffer, byte opCode,
             ByteBuffer payload, boolean first, boolean last, boolean masked,

==================================================
WsSession.java
index 2da2768f4d..30d8b5e2c7 100644
--- a/java/org/apache/tomcat/websocket/WsRemoteEndpointImplClient.java
+++ b/java/org/apache/tomcat/websocket/WsRemoteEndpointImplClient.java
@@ -50,7 +50,7 @@ public class WsRemoteEndpointImplClient extends WsRemoteEndpointImplBase {
     }
 
     @Override
-    protected void close() {
+    protected void doClose() {
         channel.close();
     }
 }

==================================================
WsWebSocketContainer.java
index fa0d960a6e..19ca44a77e 100644
--- a/java/org/apache/tomcat/websocket/WsSession.java
+++ b/java/org/apache/tomcat/websocket/WsSession.java
@@ -33,8 +33,8 @@ import java.util.concurrent.atomic.AtomicLong;
 import javax.websocket.CloseReason;
 import javax.websocket.CloseReason.CloseCodes;
 import javax.websocket.DeploymentException;
-import javax.websocket.Encoder;
 import javax.websocket.Endpoint;
+import javax.websocket.EndpointConfig;
 import javax.websocket.Extension;
 import javax.websocket.MessageHandler;
 import javax.websocket.PongMessage;
@@ -100,8 +100,7 @@ public class WsSession implements Session {
             URI requestUri, Map<String,List<String>> requestParameterMap,
             String queryString, Principal userPrincipal, String subProtocol,
             Map<String,String> pathParameters,
-            boolean secure, List<Class<? extends Encoder>> encoders,
-            Map<String,Object> userProperties)
+            boolean secure, EndpointConfig endpointConfig)
                     throws DeploymentException {
         this.localEndpoint = localEndpoint;
         this.wsRemoteEndpoint = wsRemoteEndpoint;
@@ -133,9 +132,9 @@ public class WsSession implements Session {
         }
         this.pathParameters = pathParameters;
         this.secure = secure;
-        this.wsRemoteEndpoint.setEncoders(encoders);
+        this.wsRemoteEndpoint.setEncoders(endpointConfig);
 
-        this.userProperties.putAll(userProperties);
+        this.userProperties.putAll(endpointConfig.getUserProperties());
         this.id = Long.toHexString(ids.getAndIncrement());
     }
 

==================================================
WsHttpUpgradeHandler.java
index 5942ee3caa..d5dd6bdfe9 100644
--- a/java/org/apache/tomcat/websocket/WsWebSocketContainer.java
+++ b/java/org/apache/tomcat/websocket/WsWebSocketContainer.java
@@ -346,8 +346,7 @@ public class WsWebSocketContainer
         WsSession wsSession = new WsSession(endpoint, wsRemoteEndpointClient,
                 this, null, null, null, null, subProtocol,
                 Collections.EMPTY_MAP, false,
-                clientEndpointConfiguration.getEncoders(),
-                clientEndpointConfiguration.getUserProperties());
+                clientEndpointConfiguration);
         endpoint.onOpen(wsSession, clientEndpointConfiguration);
         registerSession(endpoint.getClass(), wsSession);
 

==================================================
WsRemoteEndpointImplServer.java
index cec7bcb885..0246c7e447 100644
--- a/java/org/apache/tomcat/websocket/server/WsHttpUpgradeHandler.java
+++ b/java/org/apache/tomcat/websocket/server/WsHttpUpgradeHandler.java
@@ -113,8 +113,7 @@ public class WsHttpUpgradeHandler implements HttpUpgradeHandler {
                     handshakeRequest.getParameterMap(),
                     handshakeRequest.getQueryString(),
                     handshakeRequest.getUserPrincipal(), subProtocol,
-                    pathParameters, secure, endpointConfig.getEncoders(),
-                    endpointConfig.getUserProperties());
+                    pathParameters, secure, endpointConfig);
             WsFrameServer wsFrame = new WsFrameServer(
                     sis,
                     wsSession);

==================================================
TestEncodingDecoding.java
index e325af2c36..f4b99fbe79 100644
--- a/java/org/apache/tomcat/websocket/server/WsRemoteEndpointImplServer.java
+++ b/java/org/apache/tomcat/websocket/server/WsRemoteEndpointImplServer.java
@@ -124,7 +124,7 @@ public class WsRemoteEndpointImplServer extends WsRemoteEndpointImplBase {
 
 
     @Override
-    protected void close() {
+    protected void doClose() {
         try {
             sos.close();
         } catch (IOException e) {

==================================================
