d0877a698fe23f633747f429e43ce40d5f8d3ed7
==================================================
Remove two system properties used for configuration
==================================================
remm remm@apache.org
==================================================
Wed Mar 25 17:58:08 2020 +0100
==================================================
Connector.java
Remove two system properties used for configuration

Two rarely used properties, both in the connector package:
- org.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH is
replaced by the allowBackslash attribute
- org.apache.catalina.connector.Response.ENFORCE_ENCODING_IN_GET_WRITER
is replaced by the enforceEncodingInGetWriter attribute


==================================================
CoyoteAdapter.java
index 43b9431b55..ec6516308b 100644
--- a/java/org/apache/catalina/connector/Connector.java
+++ b/java/org/apache/catalina/connector/Connector.java
@@ -117,6 +117,14 @@ public class Connector extends LifecycleMBeanBase  {
     protected Service service = null;
 
 
+    /**
+     * If this is <code>true</code> the '\' character will be permitted as a
+     * path delimiter. If not specified, the default value of
+     * <code>false</code> will be used.
+     */
+    protected boolean allowBackslash = false;
+
+
     /**
      * Do we allow TRACE ?
      */
@@ -135,6 +143,19 @@ public class Connector extends LifecycleMBeanBase  {
     protected boolean enableLookups = false;
 
 
+    /**
+     * If this is <code>true</code> then a call to
+     * <code>Response.getWriter()</code> if no character encoding
+     * has been specified will result in subsequent calls to
+     * <code>Response.getCharacterEncoding()</code> returning
+     * <code>ISO-8859-1</code> and the <code>Content-Type</code> response header
+     * will include a <code>charset=ISO-8859-1</code> component.
+     * (SRV.15.2.22.1)
+     * If not specified, the default specification compliant value of
+     * <code>true</code> will be used.
+     */
+    protected boolean enforceEncodingInGetWriter = true;
+
     /*
      * Is generation of X-Powered-By response header enabled/disabled?
      */
@@ -338,6 +359,24 @@ public class Connector extends LifecycleMBeanBase  {
     }
 
 
+    /**
+     * @return <code>true</code> if backslash characters are allowed in URLs.
+     *   Default value is <code>false</code>.
+     */
+    public boolean getAllowBackslash() {
+        return allowBackslash;
+    }
+
+
+    /**
+     * Set the allowBackslash flag.
+     * @param allowBackslash the new flag value
+     */
+    public void setAllowBackslash(boolean allowBackslash) {
+        this.allowBackslash = allowBackslash;
+    }
+
+
     /**
      * @return <code>true</code> if the TRACE method is allowed. Default value
      *         is <code>false</code>.
@@ -415,6 +454,24 @@ public class Connector extends LifecycleMBeanBase  {
     }
 
 
+    /**
+     * @return <code>true</code> if a default character encoding will be set
+     *   when calling Response.getWriter()
+     */
+    public boolean getEnforceEncodingInGetWriter() {
+        return enforceEncodingInGetWriter;
+    }
+
+
+    /**
+     * Set the enforceEncodingInGetWriter flag.
+     * @param enforceEncodingInGetWriter the new flag value
+     */
+    public void setEnforceEncodingInGetWriter(boolean enforceEncodingInGetWriter) {
+        this.enforceEncodingInGetWriter = enforceEncodingInGetWriter;
+    }
+
+
     public int getMaxCookieCount() {
         return maxCookieCount;
     }

==================================================
Response.java
index 3b6f7e9811..9bfe3015e0 100644
--- a/java/org/apache/catalina/connector/CoyoteAdapter.java
+++ b/java/org/apache/catalina/connector/CoyoteAdapter.java
@@ -78,10 +78,6 @@ public class CoyoteAdapter implements Adapter {
     public static final int ADAPTER_NOTES = 1;
 
 
-    protected static final boolean ALLOW_BACKSLASH =
-        Boolean.parseBoolean(System.getProperty("org.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH", "false"));
-
-
     private static final ThreadLocal<String> THREAD_NAME =
             new ThreadLocal<String>() {
 
@@ -635,7 +631,7 @@ public class CoyoteAdapter implements Adapter {
                 response.sendError(400, "Invalid URI: " + ioe.getMessage());
             }
             // Normalization
-            if (normalize(req.decodedURI())) {
+            if (normalize(req.decodedURI(), connector.getAllowBackslash())) {
                 // Character decoding
                 convertURI(decodedURI, request);
                 // URIEncoding values are limited to US-ASCII supersets.
@@ -1127,12 +1123,13 @@ public class CoyoteAdapter implements Adapter {
      * This method normalizes "\", "//", "/./" and "/../".
      *
      * @param uriMB URI to be normalized
+     * @param allowBackslash <code>true</code> if backslash characters are allowed in URLs
      *
      * @return <code>false</code> if normalizing this URI would require going
      *         above the root, or if the URI contains a null byte, otherwise
      *         <code>true</code>
      */
-    public static boolean normalize(MessageBytes uriMB) {
+    public static boolean normalize(MessageBytes uriMB, boolean allowBackslash) {
 
         ByteChunk uriBC = uriMB.getByteChunk();
         final byte[] b = uriBC.getBytes();
@@ -1151,7 +1148,7 @@ public class CoyoteAdapter implements Adapter {
         // Check for null byte
         for (pos = start; pos < end; pos++) {
             if (b[pos] == (byte) '\\') {
-                if (ALLOW_BACKSLASH) {
+                if (allowBackslash) {
                     b[pos] = (byte) '/';
                 } else {
                     return false;

==================================================
TestCoyoteAdapter.java
index 9ec0b5da5f..17d086bc95 100644
--- a/java/org/apache/catalina/connector/Response.java
+++ b/java/org/apache/catalina/connector/Response.java
@@ -74,21 +74,6 @@ public class Response implements HttpServletResponse {
 
     private static final MediaTypeCache MEDIA_TYPE_CACHE = new MediaTypeCache(100);
 
-    /**
-     * Compliance with SRV.15.2.22.1. A call to Response.getWriter() if no
-     * character encoding has been specified will result in subsequent calls to
-     * Response.getCharacterEncoding() returning ISO-8859-1 and the Content-Type
-     * response header will include a charset=ISO-8859-1 component.
-     */
-    private static final boolean ENFORCE_ENCODING_IN_GET_WRITER;
-
-    static {
-        ENFORCE_ENCODING_IN_GET_WRITER = Boolean.parseBoolean(
-                System.getProperty("org.apache.catalina.connector.Response.ENFORCE_ENCODING_IN_GET_WRITER",
-                        "true"));
-    }
-
-
     // ----------------------------------------------------- Instance Variables
 
     public Response() {
@@ -572,7 +557,7 @@ public class Response implements HttpServletResponse {
                 (sm.getString("coyoteResponse.getWriter.ise"));
         }
 
-        if (ENFORCE_ENCODING_IN_GET_WRITER) {
+        if (request.getConnector().getEnforceEncodingInGetWriter()) {
             /*
              * If the response's character encoding has not been specified as
              * described in <code>getCharacterEncoding</code> (i.e., the method

==================================================
