153a786cb8c2a1af48350d215345a520785c9642
==================================================
Fix remaining test case failures after adding date header to response
==================================================
Mark Thomas
==================================================
Wed Nov 11 20:02:31 2015 +0000
==================================================
Http2TestBase.java
Fix remaining test case failures after adding date header to response

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1713924 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestHttp2Section_6_1.java
index 6c73d0dc7e..bf621bc6c7 100644
--- a/test/org/apache/coyote/http2/Http2TestBase.java
+++ b/test/org/apache/coyote/http2/Http2TestBase.java
@@ -55,7 +55,7 @@ public abstract class Http2TestBase extends TomcatBaseTest {
     // Nothing special about this date apart from it being the date I ran the
     // test that demonstrated that most HTTP/2 tests were failing because the
     // response now included a date header
-    private static final String DEFAULT_DATE = "Wed, 11 Nov 2015 19:18:42 GMT";
+    protected static final String DEFAULT_DATE = "Wed, 11 Nov 2015 19:18:42 GMT";
 
     static final String DEFAULT_CONNECTION_HEADER_VALUE = "Upgrade, HTTP2-Settings";
     private static final byte[] EMPTY_SETTINGS_FRAME =
@@ -888,6 +888,7 @@ public abstract class Http2TestBase extends TomcatBaseTest {
         protected void doGet(HttpServletRequest req, HttpServletResponse resp)
                 throws ServletException, IOException {
             // Generate an empty response
+            resp.setContentType("application/octet-stream");
             resp.setContentLength(0);
             resp.flushBuffer();
         }

==================================================
TestHttp2Section_6_9.java
index 2500383162..99fd9cea65 100644
--- a/test/org/apache/coyote/http2/TestHttp2Section_6_1.java
+++ b/test/org/apache/coyote/http2/TestHttp2Section_6_1.java
@@ -35,13 +35,14 @@ public class TestHttp2Section_6_1 extends Http2TestBase {
         sendSimplePostRequest(3, null);
         readSimplePostResponse(false);
 
-        Assert.assertEquals("0-WindowSize-[128]\n"
-                + "3-WindowSize-[128]\n"
-                + "3-HeadersStart\n"
-                + "3-Header-[:status]-[200]\n"
-                + "3-HeadersEnd\n"
-                + "3-Body-128\n"
-                + "3-EndOfStream\n", output.getTrace());
+        Assert.assertEquals("0-WindowSize-[128]\n" +
+                "3-WindowSize-[128]\n" +
+                "3-HeadersStart\n" +
+                "3-Header-[:status]-[200]\n" +
+                "3-Header-[date]-[Wed, 11 Nov 2015 19:18:42 GMT]\n" +
+                "3-HeadersEnd\n" +
+                "3-Body-128\n" +
+                "3-EndOfStream\n", output.getTrace());
     }
 
 
@@ -63,13 +64,14 @@ public class TestHttp2Section_6_1 extends Http2TestBase {
         Assert.assertTrue(trace, trace.contains(paddingWindowUpdate));
         trace = trace.replace(paddingWindowUpdate, "");
 
-        Assert.assertEquals("0-WindowSize-[119]\n"
-                + "3-WindowSize-[119]\n"
-                + "3-HeadersStart\n"
-                + "3-Header-[:status]-[200]\n"
-                + "3-HeadersEnd\n"
-                + "3-Body-119\n"
-                + "3-EndOfStream\n", trace);
+        Assert.assertEquals("0-WindowSize-[119]\n" +
+                "3-WindowSize-[119]\n" +
+                "3-HeadersStart\n" +
+                "3-Header-[:status]-[200]\n" +
+                "3-Header-[date]-[Wed, 11 Nov 2015 19:18:42 GMT]\n" +
+                "3-HeadersEnd\n" +
+                "3-Body-119\n" +
+                "3-EndOfStream\n", trace);
     }
 
 
@@ -154,12 +156,13 @@ public class TestHttp2Section_6_1 extends Http2TestBase {
         // Since padding is zero length, response looks like there is none.
         readSimplePostResponse(false);
 
-        Assert.assertEquals("0-WindowSize-[127]\n"
-                + "3-WindowSize-[127]\n"
-                + "3-HeadersStart\n"
-                + "3-Header-[:status]-[200]\n"
-                + "3-HeadersEnd\n"
-                + "3-Body-127\n"
-                + "3-EndOfStream\n", output.getTrace());
+        Assert.assertEquals("0-WindowSize-[127]\n" +
+                "3-WindowSize-[127]\n" +
+                "3-HeadersStart\n" +
+                "3-Header-[:status]-[200]\n" +
+                "3-Header-[date]-[Wed, 11 Nov 2015 19:18:42 GMT]\n" +
+                "3-HeadersEnd\n" +
+                "3-Body-127\n" +
+                "3-EndOfStream\n", output.getTrace());
     }
 }

==================================================
TestHttp2Section_8_1.java
index 84d4cf355b..9311efee92 100644
--- a/test/org/apache/coyote/http2/TestHttp2Section_6_9.java
+++ b/test/org/apache/coyote/http2/TestHttp2Section_6_9.java
@@ -199,6 +199,7 @@ public class TestHttp2Section_6_9 extends Http2TestBase {
         Assert.assertEquals(
                 "3-HeadersStart\n" +
                 "3-Header-[:status]-[200]\n" +
+                "3-Header-[date]-["+ DEFAULT_DATE + "]\n" +
                 "3-HeadersEnd\n" +
                 "3-Body-4096\n", output.getTrace());
                 output.clearTrace();
@@ -235,6 +236,7 @@ public class TestHttp2Section_6_9 extends Http2TestBase {
         Assert.assertEquals(
                 "5-HeadersStart\n" +
                 "5-Header-[:status]-[200]\n" +
+                "5-Header-[date]-[Wed, 11 Nov 2015 19:18:42 GMT]\n" +
                 "5-HeadersEnd\n" +
                 "5-Body-128\n" +
                 "5-EndOfStream\n", output.getTrace());

==================================================
