8605533afb49bba1fee8b6fef8f951fe308e0bf6
==================================================
Move to org.apache.catalina.ha.session.ClusterManagerBase common logics of org.apache.catalina.ha.session.BackupManager and org.apache.catalina.ha.session.DeltaManager.
==================================================
Keiichi Fujino
==================================================
Thu Apr 3 07:33:04 2014 +0000
==================================================
BackupManager.java
Move to org.apache.catalina.ha.session.ClusterManagerBase common logics of org.apache.catalina.ha.session.BackupManager and org.apache.catalina.ha.session.DeltaManager.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1584274 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ClusterManagerBase.java
index 3eb4faf88a..5c543beb81 100644
--- a/java/org/apache/catalina/ha/session/BackupManager.java
+++ b/java/org/apache/catalina/ha/session/BackupManager.java
@@ -20,12 +20,10 @@ import java.util.HashSet;
 import java.util.Iterator;
 import java.util.Set;
 
-import org.apache.catalina.Cluster;
 import org.apache.catalina.DistributedManager;
 import org.apache.catalina.LifecycleException;
 import org.apache.catalina.LifecycleState;
 import org.apache.catalina.Session;
-import org.apache.catalina.ha.CatalinaCluster;
 import org.apache.catalina.ha.ClusterManager;
 import org.apache.catalina.ha.ClusterMessage;
 import org.apache.catalina.tribes.Channel;
@@ -141,16 +139,7 @@ public class BackupManager extends ClusterManagerBase
         super.startInternal();
 
         try {
-            if (getCluster() == null) {
-                Cluster cluster = getContext().getCluster();
-                if (cluster instanceof CatalinaCluster) {
-                    setCluster((CatalinaCluster)cluster);
-                } else {
-                    throw new LifecycleException(
-                            sm.getString("backupManager.noCluster", getName()));
-                }
-            }
-            cluster.registerManager(this);
+            if (cluster == null) throw new LifecycleException(sm.getString("backupManager.noCluster", getName()));
             LazyReplicatedMap<String,Session> map = new LazyReplicatedMap<>(
                     this, cluster.getChannel(), rpcTimeout, getMapName(),
                     getClassLoaders(), terminateOnStartFailure);
@@ -194,7 +183,6 @@ public class BackupManager extends ClusterManagerBase
             map.breakdown();
         }
 
-        cluster.removeManager(this);
         super.stopInternal();
     }
 

==================================================
DeltaManager.java
index 6f47495f42..f80233e68c 100644
--- a/java/org/apache/catalina/ha/session/ClusterManagerBase.java
+++ b/java/org/apache/catalina/ha/session/ClusterManagerBase.java
@@ -20,6 +20,7 @@ import java.io.ByteArrayInputStream;
 import java.io.IOException;
 import java.util.regex.Pattern;
 
+import org.apache.catalina.Cluster;
 import org.apache.catalina.Context;
 import org.apache.catalina.LifecycleException;
 import org.apache.catalina.Loader;
@@ -227,8 +228,21 @@ public abstract class ClusterManagerBase extends ManagerBase implements ClusterM
         }
     }
 
+    @Override
+    protected void startInternal() throws LifecycleException {
+        super.startInternal();
+        if (getCluster() == null) {
+            Cluster cluster = getContext().getCluster();
+            if (cluster instanceof CatalinaCluster) {
+                setCluster((CatalinaCluster)cluster);
+            }
+        }
+        if (cluster != null) cluster.registerManager(this);
+    }
+
     @Override
     protected void stopInternal() throws LifecycleException {
+        if (cluster != null) cluster.removeManager(this);
         replicationValve = null;
         super.stopInternal();
     }

==================================================
