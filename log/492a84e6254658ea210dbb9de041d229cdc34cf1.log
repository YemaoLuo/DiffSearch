492a84e6254658ea210dbb9de041d229cdc34cf1
==================================================
Fix further regressions in the error handling changes
==================================================
Mark Emlyn
==================================================
Thu Jun 5 10:04:45 2014 +0000
==================================================
Response.java
Fix further regressions in the error handling changes
(r1600449 and r1600495)

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1600580 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StandardWrapperValve.java
index c4f7d47ef3..b506199608 100644
--- a/java/org/apache/catalina/connector/Response.java
+++ b/java/org/apache/catalina/connector/Response.java
@@ -198,6 +198,7 @@ public class Response
      * The error flag.
      */
     protected boolean error = false;
+    private boolean errorAfterCommit = false;
 
 
     /**
@@ -239,6 +240,7 @@ public class Response
         appCommitted = false;
         included = false;
         error = false;
+        errorAfterCommit = false;
         isCharacterEncodingSet = false;
 
         if (Globals.IS_SECURITY_ENABLED || Connector.RECYCLE_FACADES) {
@@ -388,6 +390,7 @@ public class Response
     public void setError() {
         if (!error) {
             error = true;
+            errorAfterCommit = coyoteResponse.isCommitted();
             Wrapper wrapper = getRequest().getWrapper();
             if (wrapper != null) {
                 wrapper.incrementErrorCount();
@@ -404,6 +407,11 @@ public class Response
     }
 
 
+    public boolean isErrorAfterCommit() {
+        return errorAfterCommit;
+    }
+
+
     /**
      * Perform whatever actions are required to flush and close the output
      * stream or writer, in a single operation.
@@ -1775,7 +1783,4 @@ public class Response
         return (sb.toString());
 
     }
-
-
 }
-

==================================================
ErrorReportValve.java
index 4dbc249a4f..67bb01f6e7 100644
--- a/java/org/apache/catalina/core/StandardWrapperValve.java
+++ b/java/org/apache/catalina/core/StandardWrapperValve.java
@@ -508,7 +508,7 @@ final class StandardWrapperValve
                            Throwable exception) {
         request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, exception);
         response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
-
+        response.setError();
     }
 
     public long getProcessingTime() {

==================================================
