380c01129ecd4244d92782b179921172c6d8f6c9
==================================================
Fix failing SSL test
==================================================
Mark Emlyn
==================================================
Mon Nov 23 00:11:11 2009 +0000
==================================================
AbstractEndpoint.java
Fix failing SSL test
Prevent NPE in NIO connector when using SSL and the default keystore password

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@883196 13f79535-47bb-0310-9956-ffa450edef68



==================================================
NioEndpoint.java
index 89e0843460..7796e71eea 100644
--- a/java/org/apache/tomcat/util/net/AbstractEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AbstractEndpoint.java
@@ -26,6 +26,7 @@ import java.util.concurrent.TimeUnit;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.apache.tomcat.util.IntrospectionUtils;
+import org.apache.tomcat.util.net.jsse.JSSESocketFactory;
 import org.apache.tomcat.util.res.StringManager;
 import org.apache.tomcat.util.threads.ResizableExecutor;
 import org.apache.tomcat.util.threads.TaskQueue;
@@ -503,7 +504,7 @@ public abstract class AbstractEndpoint {
     public String getKeyAlias() { return keyAlias;}
     public void setKeyAlias(String s ) { keyAlias = s;}
     
-    private String keyPass = "changeit";
+    private String keyPass = JSSESocketFactory.DEFAULT_KEY_PASS;
     public String getKeyPass() { return keyPass;}
     public void setKeyPass(String s ) { this.keyPass = s;}
 

==================================================
JSSESocketFactory.java
index 99885fde3f..808808f9b1 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -53,6 +53,7 @@ import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.apache.tomcat.util.IntrospectionUtils;
 import org.apache.tomcat.util.net.SecureNioChannel.ApplicationBufferHandler;
+import org.apache.tomcat.util.net.jsse.JSSESocketFactory;
 import org.apache.tomcat.util.net.jsse.NioX509KeyManager;
 
 /**
@@ -504,7 +505,11 @@ public class NioEndpoint extends AbstractEndpoint {
         // Initialize SSL if needed
         if (isSSLEnabled()) {
             // Initialize SSL
-            char[] passphrase = getKeystorePass().toCharArray();
+            String keystorePass = getKeystorePass();
+            if (keystorePass == null) {
+                keystorePass = JSSESocketFactory.DEFAULT_KEY_PASS;
+            }
+            char[] passphrase = keystorePass.toCharArray();
 
             char[] tpassphrase = (getTruststorePass()!=null)?getTruststorePass().toCharArray():passphrase;
             String ttype = (getTruststoreType()!=null)?getTruststoreType():getKeystoreType();

==================================================
