100c015af6a3dda8dda4553f44eecffdc81e082d
==================================================
Improve multi-byte character handling in Coyote
==================================================
Rainer Jung
==================================================
Fri Nov 11 22:07:13 2011 +0000
==================================================
AjpMessage.java
Improve multi-byte character handling in Coyote
output for HTTP and AJP.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1201069 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AbstractOutputBuffer.java
index f67bf5da4d..287c6c6b47 100644
--- a/java/org/apache/coyote/ajp/AjpMessage.java
+++ b/java/org/apache/coyote/ajp/AjpMessage.java
@@ -209,10 +209,8 @@ public class AjpMessage {
             // but is the only consistent approach within the current
             // servlet framework.  It must suffice until servlet output
             // streams properly encode their output.
-            if ((c <= 31) && (c != 9)) {
-                c = ' ';
-            } else if (c == 127) {
-                c = ' ';
+            if (((c <= 31) && (c != 9)) || c == 127 || c > 255) {
+              c = ' ';
             }
             appendByte(c);
         }
@@ -244,10 +242,8 @@ public class AjpMessage {
             // but is the only consistent approach within the current
             // servlet framework.  It must suffice until servlet output
             // streams properly encode their output.
-            if ((c <= 31) && (c != 9)) {
-                c = ' ';
-            } else if (c == 127) {
-                c = ' ';
+            if (((c <= 31) && (c != 9)) || c == 127 || c > 255) {
+              c = ' ';
             }
             appendByte(c);
         }

==================================================
