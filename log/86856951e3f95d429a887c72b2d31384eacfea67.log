86856951e3f95d429a887c72b2d31384eacfea67
==================================================
Correct a regression in the fix for BZ 64110
==================================================
Mark Thomas
==================================================
Thu Jan 28 14:01:35 2021 +0000
==================================================
HexUtils.java
Correct a regression in the fix for BZ 64110

Larger TLS grease values triggered an overflow when being converted to a
String value for logging / reporting purposes. This broke the TLS
handshake which in turn broke the TLS connection.


==================================================
TestHexUtils.java
index c7bada8a86..e4aafdf551 100644
--- a/java/org/apache/tomcat/util/buf/HexUtils.java
+++ b/java/org/apache/tomcat/util/buf/HexUtils.java
@@ -78,8 +78,8 @@ public final class HexUtils {
         // 2 bytes / 4 hex digits
         StringBuilder sb = new StringBuilder(4);
 
-        sb.append(hex[(c & 0xf000) >> 4]);
-        sb.append(hex[(c & 0x0f00)]);
+        sb.append(hex[(c & 0xf000) >> 12]);
+        sb.append(hex[(c & 0x0f00) >> 8]);
 
         sb.append(hex[(c & 0xf0) >> 4]);
         sb.append(hex[(c & 0x0f)]);

==================================================
