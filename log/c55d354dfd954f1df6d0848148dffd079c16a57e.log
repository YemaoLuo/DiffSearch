c55d354dfd954f1df6d0848148dffd079c16a57e
==================================================
Port r742915 to trunk.
==================================================
Mark Emlyn
==================================================
Wed Feb 11 20:42:27 2009 +0000
==================================================
ChannelNioSocket.java
Port r742915 to trunk.
Make sure the 400 is returned to the browser. (like other connectors).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@743497 13f79535-47bb-0310-9956-ffa450edef68



==================================================
ChannelSocket.java
index ffefdd8367..db93c10f1f 100644
--- a/java/org/apache/jk/common/ChannelNioSocket.java
+++ b/java/org/apache/jk/common/ChannelNioSocket.java
@@ -56,6 +56,7 @@ import org.apache.jk.core.WorkerEnv;
 import org.apache.coyote.Request;
 import org.apache.coyote.RequestGroupInfo;
 import org.apache.coyote.RequestInfo;
+import org.apache.coyote.ActionCode;
 import org.apache.tomcat.util.threads.ThreadPool;
 import org.apache.tomcat.util.threads.ThreadPoolRunnable;
 
@@ -854,6 +855,7 @@ public class ChannelNioSocket extends JkHandler
                     status= invoke( recv, ep );
                     if( status != JkHandler.OK ) {
                         log.warn("processCallbacks status " + status );
+                        ep.action(ActionCode.ACTION_CLOSE, ep.getRequest().getResponse());
                         return false;
                     }
                     synchronized(this) {

==================================================
HandlerRequest.java
index 68dbb8ddef..bf49904976 100644
--- a/java/org/apache/jk/common/ChannelSocket.java
+++ b/java/org/apache/jk/common/ChannelSocket.java
@@ -45,6 +45,7 @@ import org.apache.jk.core.WorkerEnv;
 import org.apache.coyote.Request;
 import org.apache.coyote.RequestGroupInfo;
 import org.apache.coyote.RequestInfo;
+import org.apache.coyote.ActionCode;
 import org.apache.tomcat.util.modeler.Registry;
 import org.apache.tomcat.util.threads.ThreadPool;
 import org.apache.tomcat.util.threads.ThreadPoolRunnable;
@@ -697,6 +698,7 @@ public class ChannelSocket extends JkHandler
                 status= this.invoke( recv, ep );
                 if( status!= JkHandler.OK ) {
                     log.warn("processCallbacks status " + status );
+                    ep.action(ActionCode.ACTION_CLOSE, ep.getRequest().getResponse());
                     break;
                 }
             }

==================================================
