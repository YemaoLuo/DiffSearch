2f19d166d4f095d0715bcefd294e87a83f7661ac
==================================================
Refactor Default servlet to simplify support for custom ETag formats
==================================================
Mark Thomas
==================================================
Mon Aug 10 17:19:52 2020 +0100
==================================================
DefaultServlet.java
Refactor Default servlet to simplify support for custom ETag formats


==================================================
WebdavServlet.java
index 5ffc548735..466f1dfb07 100644
--- a/java/org/apache/catalina/servlets/DefaultServlet.java
+++ b/java/org/apache/catalina/servlets/DefaultServlet.java
@@ -905,7 +905,7 @@ public class DefaultServlet extends HttpServlet {
         String eTag = null;
         String lastModifiedHttp = null;
         if (resource.isFile() && !isError) {
-            eTag = resource.getETag();
+            eTag = generateETag(resource);
             lastModifiedHttp = resource.getLastModifiedHttp();
         }
 
@@ -1494,7 +1494,7 @@ public class DefaultServlet extends HttpServlet {
                 // Ignore
             }
 
-            String eTag = resource.getETag();
+            String eTag = generateETag(resource);
             long lastModified = resource.getLastModified();
 
             if (headerValueTime == (-1L)) {
@@ -2161,7 +2161,7 @@ public class DefaultServlet extends HttpServlet {
             HttpServletResponse response, WebResource resource)
             throws IOException {
 
-        String eTag = resource.getETag();
+        String eTag = generateETag(resource);
         // Default servlet uses weak matching so we strip any leading "W/" and
         // then compare using equals
         if (eTag.startsWith("W/")) {
@@ -2222,7 +2222,7 @@ public class DefaultServlet extends HttpServlet {
                     // The entity has not been modified since the date
                     // specified by the client. This is not an error case.
                     response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
-                    response.setHeader("ETag", resource.getETag());
+                    response.setHeader("ETag", generateETag(resource));
 
                     return false;
                 }
@@ -2249,7 +2249,7 @@ public class DefaultServlet extends HttpServlet {
             HttpServletResponse response, WebResource resource)
             throws IOException {
 
-        String eTag = resource.getETag();
+        String eTag = generateETag(resource);
         String headerValue = request.getHeader("If-None-Match");
         if (headerValue != null) {
 
@@ -2322,6 +2322,21 @@ public class DefaultServlet extends HttpServlet {
     }
 
 
+    /**
+     * Provides the entity tag (the ETag header) for the given resource.
+     * Intended to be over-ridden by custom DefaultServlet implementations that
+     * wish to use an alternative format for the entity tag.
+     *
+     * @param resource  The resource for which an entity tag is required.
+     *
+     * @return The result of calling {@link WebResource#getETag()} on the given
+     *         resource
+     */
+    protected String generateETag(WebResource resource) {
+        return resource.getETag();
+    }
+
+
     /**
      * Copy the contents of the specified input stream to the specified
      * output stream, and ensure that both streams are closed before returning

==================================================
