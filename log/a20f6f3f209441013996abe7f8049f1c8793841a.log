a20f6f3f209441013996abe7f8049f1c8793841a
==================================================
Don't send the Keep-Alive response header is the connection is closed
==================================================
Mark Thomas
==================================================
Mon Sep 28 09:07:00 2020 +0100
==================================================
Http11Processor.java
Don't send the Keep-Alive response header is the connection is closed


==================================================
TesterServlet.java
index 98b1f235a3..22f8787e87 100644
--- a/java/org/apache/coyote/http11/Http11Processor.java
+++ b/java/org/apache/coyote/http11/Http11Processor.java
@@ -924,9 +924,13 @@ public class Http11Processor extends AbstractProcessor {
 
         // FIXME: Add transfer encoding header
 
-        if ((entityBody) && (!contentDelimitation)) {
-            // Mark as close the connection after the request, and add the
-            // connection: close header
+        if ((entityBody) && (!contentDelimitation) || connectionClosePresent) {
+            // Disable keep-alive if:
+            // - there is a response body but way for the client to determine
+            //   the content length information; or
+            // - there is a "connection: close" header present
+            // This will cause the "connection: close" header to be added if it
+            // is not already present.
             keepAlive = false;
         }
 

==================================================
TestHttp11Processor.java
index 79e7328bc7..219c08ab74 100644
--- a/test/org/apache/catalina/startup/TesterServlet.java
+++ b/test/org/apache/catalina/startup/TesterServlet.java
@@ -28,6 +28,19 @@ public class TesterServlet extends HttpServlet {
 
     private static final long serialVersionUID = 1L;
 
+    private final boolean explicitClose;
+
+
+    public TesterServlet() {
+        this(false);
+    }
+
+
+    public TesterServlet(boolean explicitClose) {
+        this.explicitClose = explicitClose;
+    }
+
+
     @Override
     protected void doGet(HttpServletRequest req, HttpServletResponse resp)
             throws ServletException, IOException {
@@ -35,5 +48,9 @@ public class TesterServlet extends HttpServlet {
         resp.setContentType("text/plain");
         PrintWriter out = resp.getWriter();
         out.print("OK");
+
+        if (explicitClose) {
+            resp.setHeader("Connection", "close");
+        }
     }
 }

==================================================
