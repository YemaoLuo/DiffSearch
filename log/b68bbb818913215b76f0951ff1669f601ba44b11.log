b68bbb818913215b76f0951ff1669f601ba44b11
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54521
==================================================
Mark Emlyn
==================================================
Thu Feb 7 11:00:57 2013 +0000
==================================================
DigestAuthenticator.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=54521
Ensure concurrent requests that require DIGEST auth receive unique nonces.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1443405 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestDigestAuthenticator.java
index b0f36ce698..de0531c67e 100644
--- a/java/org/apache/catalina/authenticator/DigestAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/DigestAuthenticator.java
@@ -91,6 +91,14 @@ public class DigestAuthenticator extends AuthenticatorBase {
     protected Map<String,NonceInfo> nonces;
 
 
+    /**
+     * The last timestamp used to generate a nonce. Each nonce should get a
+     * unique timestamp.
+     */
+    protected long lastTimestamp = 0;
+    protected final Object lastTimestampLock = new Object();
+
+
     /**
      * Maximum number of server nonces to keep in the cache. If not specified,
      * the default value of 1000 is used.
@@ -325,6 +333,13 @@ public class DigestAuthenticator extends AuthenticatorBase {
 
         long currentTime = System.currentTimeMillis();
 
+        synchronized (lastTimestampLock) {
+            if (currentTime > lastTimestamp) {
+                lastTimestamp = currentTime;
+            } else {
+                currentTime = ++lastTimestamp;
+            }
+        }
 
         String ipTimeKey =
             request.getRemoteAddr() + ":" + currentTime + ":" + getKey();

==================================================
