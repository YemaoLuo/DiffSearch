fa7ed1d07d48c3da9ddcb9f32d9036dc5eec5996
==================================================
Align keep-alive count tracking for HTTP
==================================================
Mark Emlyn
==================================================
Tue Aug 16 12:19:49 2011 +0000
==================================================
Http11AprProcessor.java
Align keep-alive count tracking for HTTP

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1158227 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Http11NioProcessor.java
index 4a94330f4f..df0076ded0 100644
--- a/java/org/apache/coyote/http11/Http11AprProcessor.java
+++ b/java/org/apache/coyote/http11/Http11AprProcessor.java
@@ -184,8 +184,6 @@ public class Http11AprProcessor extends AbstractHttp11Processor<Long> {
 
         long soTimeout = endpoint.getSoTimeout();
 
-        int keepAliveLeft = maxKeepAliveRequests;
-        
         boolean keptAlive = false;
         boolean openSocket = false;
         boolean sendfileInProgress = false;
@@ -253,8 +251,12 @@ public class Http11AprProcessor extends AbstractHttp11Processor<Long> {
                 }
             }
 
-            if (maxKeepAliveRequests > 0 && --keepAliveLeft == 0)
+            if (maxKeepAliveRequests == 1) {
+                keepAlive = false;
+            } else if (maxKeepAliveRequests > 0 &&
+                    socketWrapper.decrementKeepAlive() <= 0) {
                 keepAlive = false;
+            }
 
             // Process the request in the adapter
             if (!error) {

==================================================
Http11Processor.java
index 78f91e60e6..c0dd5762d4 100644
--- a/java/org/apache/coyote/http11/Http11NioProcessor.java
+++ b/java/org/apache/coyote/http11/Http11NioProcessor.java
@@ -299,10 +299,12 @@ public class Http11NioProcessor extends AbstractHttp11Processor<NioChannel> {
                 }
             }
             
-            if (maxKeepAliveRequests == 1 )
+            if (maxKeepAliveRequests == 1) {
                 keepAlive = false;
-            if (maxKeepAliveRequests > 0 && socketWrapper.decrementKeepAlive() <= 0)
+            } else if (maxKeepAliveRequests > 0 &&
+                    socketWrapper.decrementKeepAlive() <= 0) {
                 keepAlive = false;
+            }
 
             // Process the request in the adapter
             if (!error) {

==================================================
