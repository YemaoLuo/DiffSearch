dc42ad783c15b7792c58eca46509a1f8653c1d44
==================================================
More unit tests for BeanNameELResolver
==================================================
Mark Emlyn
==================================================
Thu Jul 4 19:26:52 2013 +0000
==================================================
TestBeanNameELResolver.java
More unit tests for BeanNameELResolver

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1499845 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TesterBean.java
index e73a12c2a2..9a8f03381a 100644
--- a/test/javax/el/TestBeanNameELResolver.java
+++ b/test/javax/el/TestBeanNameELResolver.java
@@ -26,6 +26,7 @@ public class TestBeanNameELResolver {
     private static final String BEAN02_NAME = "bean02";
     private static final TesterBean BEAN02 = new TesterBean(BEAN02_NAME);
     private static final String BEAN99_NAME = "bean99";
+    private static final TesterBean BEAN99 = new TesterBean(BEAN99_NAME);
 
     /**
      * Creates the resolver that is used for the test. All the tests use a
@@ -37,10 +38,10 @@ public class TestBeanNameELResolver {
 
     private BeanNameELResolver createBeanNameELResolver(boolean allowCreate) {
 
-        BeanNameResolver beanNameResolver =
-                new TesterBeanNameResolver(allowCreate);
+        TesterBeanNameResolver beanNameResolver = new TesterBeanNameResolver();
         beanNameResolver.setBeanValue(BEAN01_NAME, BEAN01);
         beanNameResolver.setBeanValue(BEAN02_NAME, BEAN02);
+        beanNameResolver.setAllowCreate(allowCreate);
 
         BeanNameELResolver beanNameELResolver =
                 new BeanNameELResolver(beanNameResolver);
@@ -181,4 +182,82 @@ public class TestBeanNameELResolver {
         BeanNameELResolver resolver = createBeanNameELResolver();
         resolver.setValue(null, new Object(), new Object(), new Object());
     }
+
+
+    /**
+     * Test replace with create enabled.
+     */
+    @Test
+    public void testSetValue02() {
+        doSetValueCreateReplaceTest(true, BEAN01_NAME);
+    }
+
+
+    /**
+     * Test replace with create disabled.
+     */
+    @Test
+    public void testSetValue03() {
+        doSetValueCreateReplaceTest(false, BEAN01_NAME);
+    }
+
+
+    /**
+     * Test create with create enabled.
+     */
+    @Test
+    public void testSetValue04() {
+        doSetValueCreateReplaceTest(true, BEAN99_NAME);
+    }
+
+
+    /**
+     * Test ceate with create disabled.
+     */
+    @Test
+    public void testSetValue05() {
+        doSetValueCreateReplaceTest(false, BEAN99_NAME);
+    }
+
+
+    /**
+     * Tests adding/replacing beans beans
+     */
+    private void doSetValueCreateReplaceTest(boolean canCreate,
+            String beanName) {
+        BeanNameELResolver resolver = createBeanNameELResolver(canCreate);
+        ELContext context =
+                new StandardELContext(ELManager.getExpressionFactory());
+
+        // Get bean one to be sure it has been replaced when testing replace
+        Object bean = resolver.getValue(context, null, BEAN01_NAME);
+
+        Assert.assertTrue(context.isPropertyResolved());
+        Assert.assertEquals(BEAN01, bean);
+
+        // Reset context
+        context.setPropertyResolved(false);
+
+        // Replace BEAN01
+        resolver.setValue(context, null, beanName, BEAN99);
+        if (canCreate || BEAN01_NAME.equals(beanName)) {
+            Assert.assertTrue(context.isPropertyResolved());
+
+            // Obtain BEAN01 again
+            context.setPropertyResolved(false);
+            bean = resolver.getValue(context, null, beanName);
+
+            Assert.assertTrue(context.isPropertyResolved());
+            Assert.assertEquals(BEAN99, bean);
+        } else {
+            Assert.assertFalse(context.isPropertyResolved());
+
+            // Obtain BEAN01 again
+            context.setPropertyResolved(false);
+            bean = resolver.getValue(context, null, BEAN01_NAME);
+
+            Assert.assertTrue(context.isPropertyResolved());
+            Assert.assertEquals(BEAN01, bean);
+        }
+    }
 }

==================================================
TesterBeanNameResolver.java
index 7f67dff1f6..fe66cfdfc5 100644
--- a/test/javax/el/TesterBean.java
+++ b/test/javax/el/TesterBean.java
@@ -27,4 +27,9 @@ public class TesterBean {
     public String getName() {
         return name;
     }
+
+    @Override
+    public String toString() {
+        return getName();
+    }
 }

==================================================
