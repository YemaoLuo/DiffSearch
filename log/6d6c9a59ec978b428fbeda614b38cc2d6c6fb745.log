6d6c9a59ec978b428fbeda614b38cc2d6c6fb745
==================================================
Add state checks to non-blocking reads that match those for non-blocking writes.
==================================================
Mark Emlyn
==================================================
Tue Sep 3 17:47:24 2013 +0000
==================================================
CoyoteInputStream.java
Add state checks to non-blocking reads that match those for non-blocking writes.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1519766 13f79535-47bb-0310-9956-ffa450edef68



==================================================
InputBuffer.java
index cdb3b360e3..02aad199c1 100644
--- a/java/org/apache/catalina/connector/CoyoteInputStream.java
+++ b/java/org/apache/catalina/connector/CoyoteInputStream.java
@@ -25,6 +25,7 @@ import javax.servlet.ReadListener;
 import javax.servlet.ServletInputStream;
 
 import org.apache.catalina.security.SecurityUtil;
+import org.apache.tomcat.util.res.StringManager;
 
 /**
  * This class handles reading bytes.
@@ -32,27 +33,20 @@ import org.apache.catalina.security.SecurityUtil;
  * @author Remy Maucherat
  * @author Jean-Francois Arcand
  */
-public class CoyoteInputStream
-    extends ServletInputStream {
+public class CoyoteInputStream extends ServletInputStream {
 
-
-    // ----------------------------------------------------- Instance Variables
+    protected static final StringManager sm =
+            StringManager.getManager(Constants.Package);
 
 
     protected InputBuffer ib;
 
 
-    // ----------------------------------------------------------- Constructors
-
-
     protected CoyoteInputStream(InputBuffer ib) {
         this.ib = ib;
     }
 
 
-    // -------------------------------------------------------- Package Methods
-
-
     /**
      * Clear facade.
      */
@@ -61,25 +55,19 @@ public class CoyoteInputStream
     }
 
 
-    // --------------------------------------------------------- Public Methods
-
-
     /**
      * Prevent cloning the facade.
      */
     @Override
-    protected Object clone()
-        throws CloneNotSupportedException {
+    protected Object clone() throws CloneNotSupportedException {
         throw new CloneNotSupportedException();
     }
 
 
-    // --------------------------------------------- ServletInputStream Methods
-
-
     @Override
-    public int read()
-        throws IOException {
+    public int read() throws IOException {
+        checkNonBlockingRead();
+
         if (SecurityUtil.isPackageProtectionEnabled()){
 
             try{
@@ -140,6 +128,7 @@ public class CoyoteInputStream
 
     @Override
     public int read(final byte[] b) throws IOException {
+        checkNonBlockingRead();
 
         if (SecurityUtil.isPackageProtectionEnabled()){
             try{
@@ -173,6 +162,7 @@ public class CoyoteInputStream
     @Override
     public int read(final byte[] b, final int off, final int len)
         throws IOException {
+        checkNonBlockingRead();
 
         if (SecurityUtil.isPackageProtectionEnabled()){
             try{
@@ -258,4 +248,12 @@ public class CoyoteInputStream
     public void setReadListener(ReadListener listener) {
         ib.setReadListener(listener);
     }
+
+
+    private void checkNonBlockingRead() {
+        if (ib.isBlocking() && !ib.isReady()) {
+            throw new IllegalStateException(
+                    sm.getString("coyoteInputStream.nbNotready"));
+        }
+    }
 }

==================================================
TestNonBlockingAPI.java
index 91f40b4f8a..ba5d794338 100644
--- a/java/org/apache/catalina/connector/InputBuffer.java
+++ b/java/org/apache/catalina/connector/InputBuffer.java
@@ -282,6 +282,11 @@ public class InputBuffer extends Reader
     }
 
 
+    boolean isBlocking() {
+        return coyoteRequest.getReadListener() != null;
+    }
+
+
     // ------------------------------------------------- Bytes Handling Methods
 
     /**

==================================================
