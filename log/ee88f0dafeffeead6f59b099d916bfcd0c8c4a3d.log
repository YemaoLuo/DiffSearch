ee88f0dafeffeead6f59b099d916bfcd0c8c4a3d
==================================================
Fix a handful of unit test failures triggered by WebSocket init changes.
==================================================
Mark Emlyn
==================================================
Thu Apr 25 14:38:16 2013 +0000
==================================================
TestFormAuthenticator.java
Fix a handful of unit test failures triggered by WebSocket init changes.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1475800 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestTomcat.java
index 3f45623427..90e0ec9877 100644
--- a/test/org/apache/catalina/authenticator/TestFormAuthenticator.java
+++ b/test/org/apache/catalina/authenticator/TestFormAuthenticator.java
@@ -28,6 +28,7 @@ import org.apache.catalina.startup.SimpleHttpClient;
 import org.apache.catalina.startup.TestTomcat.MapRealm;
 import org.apache.catalina.startup.Tomcat;
 import org.apache.catalina.startup.TomcatBaseTest;
+import org.apache.tomcat.websocket.server.WsListener;
 
 public class TestFormAuthenticator extends TomcatBaseTest {
 
@@ -109,6 +110,7 @@ public class TestFormAuthenticator extends TomcatBaseTest {
             File appDir = new File(getBuildDirectory(), "webapps/examples");
             Context ctx = tomcat.addWebapp(null, "/examples",
                     appDir.getAbsolutePath());
+            ctx.addApplicationListener(WsListener.class.getName());
 
             MapRealm realm = new MapRealm();
             realm.addUser("tomcat", "tomcat");

==================================================
TestCustomSsl.java
index 346771736c..a1fa95e263 100644
--- a/test/org/apache/catalina/startup/TestTomcat.java
+++ b/test/org/apache/catalina/startup/TestTomcat.java
@@ -50,6 +50,7 @@ import org.apache.catalina.deploy.ContextResourceLink;
 import org.apache.catalina.realm.GenericPrincipal;
 import org.apache.catalina.realm.RealmBase;
 import org.apache.tomcat.util.buf.ByteChunk;
+import org.apache.tomcat.websocket.server.WsListener;
 
 public class TestTomcat extends TomcatBaseTest {
 
@@ -259,8 +260,9 @@ public class TestTomcat extends TomcatBaseTest {
 
         File appDir = new File(getBuildDirectory(), "webapps/examples");
         // app dir is relative to server home
-        tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
-
+        org.apache.catalina.Context ctxt  = tomcat.addWebapp(
+                null, "/examples", appDir.getAbsolutePath());
+        ctxt.addApplicationListener(WsListener.class.getName());
         tomcat.start();
 
         ByteChunk res = getUrl("http://localhost:" + getPort() +
@@ -274,7 +276,9 @@ public class TestTomcat extends TomcatBaseTest {
 
         File appDir = new File(getBuildDirectory(), "webapps/examples");
         // app dir is relative to server home
-        tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
+        org.apache.catalina.Context ctxt  = tomcat.addWebapp(
+                null, "/examples", appDir.getAbsolutePath());
+        ctxt.addApplicationListener(WsListener.class.getName());
 
         tomcat.start();
 
@@ -394,6 +398,7 @@ public class TestTomcat extends TomcatBaseTest {
         // app dir is relative to server home
         org.apache.catalina.Context ctx =
             tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
+        ctx.addApplicationListener(WsListener.class.getName());
 
         Tomcat.addServlet(ctx, "testGetResource", new GetResource());
         ctx.addServletMapping("/testGetResource", "testGetResource");

==================================================
TestSsl.java
index aa3ca9531c..554d00e3b8 100644
--- a/test/org/apache/tomcat/util/net/TestCustomSsl.java
+++ b/test/org/apache/tomcat/util/net/TestCustomSsl.java
@@ -27,6 +27,7 @@ import static org.junit.Assert.fail;
 
 import org.junit.Test;
 
+import org.apache.catalina.Context;
 import org.apache.catalina.connector.Connector;
 import org.apache.catalina.startup.Tomcat;
 import org.apache.catalina.startup.TomcatBaseTest;
@@ -34,6 +35,7 @@ import org.apache.coyote.ProtocolHandler;
 import org.apache.coyote.http11.AbstractHttp11JsseProtocol;
 import org.apache.tomcat.util.buf.ByteChunk;
 import org.apache.tomcat.util.net.jsse.TesterBug50640SslImpl;
+import org.apache.tomcat.websocket.server.WsListener;
 
 /**
  * The keys and certificates used in this file are all available in svn and were
@@ -70,7 +72,9 @@ public class TestCustomSsl extends TomcatBaseTest {
         connector.setProperty("SSLEnabled", "true");
 
         File appDir = new File(getBuildDirectory(), "webapps/examples");
-        tomcat.addWebapp(null, "/examples", appDir.getAbsolutePath());
+        Context ctxt  = tomcat.addWebapp(
+                null, "/examples", appDir.getAbsolutePath());
+        ctxt.addApplicationListener(WsListener.class.getName());
 
         tomcat.start();
         ByteChunk res = getUrl("https://localhost:" + getPort() +

==================================================
