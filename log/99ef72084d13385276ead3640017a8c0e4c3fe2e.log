99ef72084d13385276ead3640017a8c0e4c3fe2e
==================================================
Ensure that the toString(), toBytes() and toChars() methods of
==================================================
Mark Thomas
==================================================
Mon Jan 29 11:26:33 2018 +0000
==================================================
MessageBytes.java
Ensure that the toString(), toBytes() and toChars() methods of
MessageBytes behave consistently and do not throw a
NullPointerException both on newly created objects and immediately after
a call to recycle().
This should not impact typical Tomcat users.
It may impact users who use these classes directly in their own code.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1822499 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestMessageBytes.java
index b34b5bae5d..de4942fe44 100644
--- a/java/org/apache/tomcat/util/buf/MessageBytes.java
+++ b/java/org/apache/tomcat/util/buf/MessageBytes.java
@@ -230,10 +230,14 @@ public final class MessageBytes implements Cloneable, Serializable {
         byteC.setCharset(charset);
     }
 
+
     /**
      * Do a char-&gt;byte conversion.
      */
     public void toBytes() {
+        if (isNull()) {
+            return;
+        }
         if (!byteC.isNull()) {
             type = T_BYTES;
             return;
@@ -245,11 +249,15 @@ public final class MessageBytes implements Cloneable, Serializable {
         byteC.setBytes(result.array(), result.arrayOffset(), result.limit());
     }
 
+
     /**
      * Convert to char[] and fill the CharChunk.
      * XXX Not optimized - it converts to String first.
      */
     public void toChars() {
+        if (isNull()) {
+            return;
+        }
         if (!charC.isNull()) {
             type = T_CHARS;
             return;

==================================================
