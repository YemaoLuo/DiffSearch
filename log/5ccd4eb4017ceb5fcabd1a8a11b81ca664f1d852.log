5ccd4eb4017ceb5fcabd1a8a11b81ca664f1d852
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63236
==================================================
Mark Thomas
==================================================
Thu Mar 7 19:36:43 2019 +0000
==================================================
LifecycleMBeanBase.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=63236

Use intern() as suggested by Phillip Webb to reduce memory wasted due to
string duplication. Saves ~254k on a clean install.
Thanks to YourKit for helping to track these down.


==================================================
CallMethodRule.java
index 49770a1baa..def6453668 100644
--- a/java/org/apache/catalina/util/LifecycleMBeanBase.java
+++ b/java/org/apache/catalina/util/LifecycleMBeanBase.java
@@ -271,7 +271,7 @@ public abstract class LifecycleMBeanBase extends LifecycleBase
 
         this.mserver = server;
         this.oname = name;
-        this.domain = name.getDomain();
+        this.domain = name.getDomain().intern();
 
         return oname;
     }

==================================================
Digester.java
index 7651776436..288312eee5 100644
--- a/java/org/apache/tomcat/util/digester/CallMethodRule.java
+++ b/java/org/apache/tomcat/util/digester/CallMethodRule.java
@@ -257,7 +257,7 @@ public class CallMethodRule extends Rule {
             throws Exception {
 
         if (paramCount == 0) {
-            this.bodyText = bodyText.trim();
+            this.bodyText = bodyText.trim().intern();
         }
 
     }

==================================================
ManagedBean.java
index 1bb2d2043f..3b0f35edb5 100644
--- a/java/org/apache/tomcat/util/digester/Digester.java
+++ b/java/org/apache/tomcat/util/digester/Digester.java
@@ -903,7 +903,7 @@ public class Digester extends DefaultHandler2 {
         // Fire "body" events for all relevant rules
         List<Rule> rules = matches.pop();
         if ((rules != null) && (rules.size() > 0)) {
-            String bodyText = this.bodyText.toString();
+            String bodyText = this.bodyText.toString().intern();
             for (int i = 0; i < rules.size(); i++) {
                 try {
                     Rule rule = rules.get(i);
@@ -1917,17 +1917,13 @@ public class Digester extends DefaultHandler2 {
         for (int i = 0; i < nAttributes; ++i) {
             String value = newAttrs.getValue(i);
             try {
-                String newValue = IntrospectionUtils.replaceProperties(value, null, source);
-                if (value != newValue) {
-                    newAttrs.setValue(i, newValue);
-                }
+                newAttrs.setValue(i, IntrospectionUtils.replaceProperties(value, null, source).intern());
             } catch (Exception e) {
                 log.warn(sm.getString("digester.failedToUpdateAttributes", newAttrs.getLocalName(i), value), e);
             }
         }
 
         return newAttrs;
-
     }
 
 

==================================================
MbeansDescriptorsIntrospectionSource.java
index 49af85c390..31e3d209c5 100644
--- a/java/org/apache/tomcat/util/modeler/ManagedBean.java
+++ b/java/org/apache/tomcat/util/modeler/ManagedBean.java
@@ -562,7 +562,7 @@ public class ManagedBean implements java.io.Serializable {
         StringUtils.join(operation.getSignature(), ',', (x) -> x.getType(), key);
         key.append(')');
 
-        return key.toString();
+        return key.toString().intern();
     }
 
 
@@ -572,6 +572,6 @@ public class ManagedBean implements java.io.Serializable {
         StringUtils.join(parameterTypes, ',', key);
         key.append(')');
 
-        return key.toString();
+        return key.toString().intern();
     }
 }

==================================================
