7cc9e07e2672fb4865c7bf266efc96503a8ac2c4
==================================================
More changes for Java 8 as the minimum version
==================================================
Mark Thomas
==================================================
Mon Nov 24 11:19:41 2014 +0000
==================================================
NioReceiver.java
index 8a501af2e2..fda3050e1d 100644
--- a/conf/web.xml
+++ b/conf/web.xml
@@ -137,9 +137,9 @@
   <!--                       pages.  See the jasper documentation for more  -->
   <!--                       information.                                   -->
   <!--                                                                      -->
-  <!--   compilerSourceVM    Compiler source VM. [1.7]                      -->
+  <!--   compilerSourceVM    Compiler source VM. [1.8]                      -->
   <!--                                                                      -->
-  <!--   compilerTargetVM    Compiler target VM. [1.7]                      -->
+  <!--   compilerTargetVM    Compiler target VM. [1.8]                      -->
   <!--                                                                      -->
   <!--   development         Is Jasper used in development mode? If true,   -->
   <!--                       the frequency at which JSPs are checked for    -->

==================================================
ParallelNioSender.java
index a6f6a54070..e428aa837b 100644
--- a/java/org/apache/catalina/tribes/transport/nio/NioReceiver.java
+++ b/java/org/apache/catalina/tribes/transport/nio/NioReceiver.java
@@ -114,12 +114,7 @@ public class NioReceiver extends ReceiverBase implements Runnable {
         // Get the associated ServerSocket to bind it with
         ServerSocket serverSocket = serverChannel.socket();
         // create a new Selector for use below
-        synchronized (Selector.class) {
-            // Selector.open() isn't thread safe
-            // http://bugs.sun.com/view_bug.do?bug_id=6427854
-            // Affects 1.6.0_29, fixed in 1.7.0_01
-            this.selector.set(Selector.open());
-        }
+        this.selector.set(Selector.open());
         // set the port the server channel will listen to
         //serverSocket.bind(new InetSocketAddress(getBind(), getTcpListenPort()));
         bind(serverSocket,getPort(),getAutoBind());

==================================================
EmbeddedServletOptions.java
index 37e6acc341..70b905e67c 100644
--- a/java/org/apache/catalina/tribes/transport/nio/ParallelNioSender.java
+++ b/java/org/apache/catalina/tribes/transport/nio/ParallelNioSender.java
@@ -47,12 +47,7 @@ public class ParallelNioSender extends AbstractSender implements MultiPointSende
     protected final HashMap<Member, NioSender> nioSenders = new HashMap<>();
 
     public ParallelNioSender() throws IOException {
-        synchronized (Selector.class) {
-            // Selector.open() isn't thread safe
-            // http://bugs.sun.com/view_bug.do?bug_id=6427854
-            // Affects 1.6.0_29, fixed in 1.7.0_01
-            selector = Selector.open();
-        }
+        selector = Selector.open();
         setConnected(true);
     }
 

==================================================
JspC.java
index 12b04d3537..138b154817 100644
--- a/java/org/apache/jasper/EmbeddedServletOptions.java
+++ b/java/org/apache/jasper/EmbeddedServletOptions.java
@@ -132,12 +132,12 @@ public final class EmbeddedServletOptions implements Options {
     /**
      * Compiler target VM.
      */
-    private String compilerTargetVM = "1.7";
+    private String compilerTargetVM = "1.8";
 
     /**
      * The compiler source VM.
      */
-    private String compilerSourceVM = "1.7";
+    private String compilerSourceVM = "1.8";
 
     /**
      * The compiler class name.

==================================================
Options.java
index a64f5783f5..2e01cf31ef 100644
--- a/java/org/apache/jasper/JspC.java
+++ b/java/org/apache/jasper/JspC.java
@@ -189,8 +189,8 @@ public class JspC extends Task implements Options {
 
     protected String compiler = null;
 
-    protected String compilerTargetVM = "1.7";
-    protected String compilerSourceVM = "1.7";
+    protected String compilerTargetVM = "1.8";
+    protected String compilerSourceVM = "1.8";
 
     protected boolean classDebugInfo = true;
 

==================================================
JDTCompiler.java
index 2c93e961c7..7f209c1e01 100644
--- a/java/org/apache/jasper/Options.java
+++ b/java/org/apache/jasper/Options.java
@@ -126,12 +126,12 @@ public interface Options {
     public String getCompiler();
 
     /**
-     * The compiler target VM, e.g. 1.1, 1.2, 1.3, 1.4, 1.5 or 1.6.
+     * The compiler target VM, e.g. 1.8.
      */
     public String getCompilerTargetVM();
 
     /**
-     * The compiler source VM, e.g. 1.3, 1.4, 1.5 or 1.6.
+     * The compiler source VM, e.g. 1.8.
      */
     public String getCompilerSourceVM();
 

==================================================
NioEndpoint.java
index 5a68a64f0c..e0ff49936d 100644
--- a/java/org/apache/jasper/resources/LocalStrings_ja.properties
+++ b/java/org/apache/jasper/resources/LocalStrings_ja.properties
@@ -155,8 +155,8 @@ JSP\u30d5\u30a1\u30a4\u30eb\u306e\u5834\u6240\u306f\u6b21\u306e\u30aa\u30d7\u30b
 \    -trimSpaces        \u30a2\u30af\u30b7\u30e7\u30f3\u3084\u6307\u793a\u5b50\u306e\u9593\u306e\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u30c6\u30ad\u30b9\u30c8\u4e2d\u306e\u30b9\u30da\u30fc\u30b9\u3092\u524a\u9664\n\
 \    -trimSpaces        Trim spaces in template text between actions, directives\n\
 \    -javaEncoding <enc> Set the encoding charset for Java classes (default UTF-8)\n\
-\    -source <version>   Set the -source argument to the compiler (default 1.6)\n\
-\    -target <version>   Set the -target argument to the compiler (default 1.6)\n\
+\    -source <version>   Set the -source argument to the compiler (default 1.8)\n\
+\    -target <version>   Set the -target argument to the compiler (default 1.8)\n\
 
 jspc.webxml.header=<?xml version="1.0" encoding="ISO-8859-1"?>\n\
 \n\

==================================================
NioSelectorPool.java
index 7edc88e2d0..fb28cecb21 100644
--- a/java/org/apache/tomcat/util/net/NioEndpoint.java
+++ b/java/org/apache/tomcat/util/net/NioEndpoint.java
@@ -824,12 +824,7 @@ public class NioEndpoint extends AbstractEndpoint<NioChannel> {
         private volatile int keyCount = 0;
 
         public Poller() throws IOException {
-            synchronized (Selector.class) {
-                // Selector.open() isn't thread safe
-                // http://bugs.sun.com/view_bug.do?bug_id=6427854
-                // Affects 1.6.0_29, fixed in 1.7.0_01
-                this.selector = Selector.open();
-            }
+            this.selector = Selector.open();
         }
 
         public int getKeyCount() { return keyCount; }

==================================================
SecureNioChannel.java
index 6cad1112dd..726f641695 100644
--- a/java/org/apache/tomcat/util/net/NioSelectorPool.java
+++ b/java/org/apache/tomcat/util/net/NioSelectorPool.java
@@ -63,12 +63,7 @@ public class NioSelectorPool {
         if (SHARED && SHARED_SELECTOR == null) {
             synchronized ( NioSelectorPool.class ) {
                 if ( SHARED_SELECTOR == null )  {
-                    synchronized (Selector.class) {
-                        // Selector.open() isn't thread safe
-                        // http://bugs.sun.com/view_bug.do?bug_id=6427854
-                        // Affects 1.6.0_29, fixed in 1.7.0_01
-                        SHARED_SELECTOR = Selector.open();
-                    }
+                    SHARED_SELECTOR = Selector.open();
                     log.info("Using a shared selector for servlet write/read");
                 }
             }
@@ -89,23 +84,13 @@ public class NioSelectorPool {
         try {
             s = selectors.size()>0?selectors.poll():null;
             if (s == null) {
-                synchronized (Selector.class) {
-                    // Selector.open() isn't thread safe
-                    // http://bugs.sun.com/view_bug.do?bug_id=6427854
-                    // Affects 1.6.0_29, fixed in 1.7.0_01
-                    s = Selector.open();
-                }
+                s = Selector.open();
             }
             else spare.decrementAndGet();
 
         }catch (NoSuchElementException x ) {
             try {
-                synchronized (Selector.class) {
-                    // Selector.open() isn't thread safe
-                    // http://bugs.sun.com/view_bug.do?bug_id=6427854
-                    // Affects 1.6.0_29, fixed in 1.7.0_01
-                    s = Selector.open();
-                }
+                s = Selector.open();
             } catch (IOException iox) {
             }
         } finally {

==================================================
NioSenderTest.java
index 51bfc2c640..62a752b686 100644
--- a/modules/jdbc-pool/pom.xml
+++ b/modules/jdbc-pool/pom.xml
@@ -90,8 +90,8 @@
         <groupId>org.apache.maven.plugins</groupId>
         <artifactId>maven-compiler-plugin</artifactId>
         <configuration>
-          <source>1.7</source>
-          <target>1.7</target>
+          <source>1.8</source>
+          <target>1.8</target>
           <optimize>true</optimize>
           <debug>true</debug>
           <showDeprecation>true</showDeprecation>

==================================================
SocketNioSend.java
index 01edaa0571..43c7112832 100644
--- a/test/org/apache/catalina/tribes/test/NioSenderTest.java
+++ b/test/org/apache/catalina/tribes/test/NioSenderTest.java
@@ -50,12 +50,7 @@ public class NioSenderTest {
     }
 
     public void init() throws Exception {
-        synchronized (Selector.class) {
-            // Selector.open() isn't thread safe
-            // http://bugs.sun.com/view_bug.do?bug_id=6427854
-            // Affects 1.6.0_29, fixed in 1.7.0_01
-            selector = Selector.open();
-        }
+        selector = Selector.open();
         mbr = new MemberImpl("localhost",4444,0);
         NioSender sender = new NioSender();
         sender.setDestination(mbr);

==================================================
SocketNioValidateSend.java
index 5c71c6da22..e865dd7412 100644
--- a/test/org/apache/catalina/tribes/test/transport/SocketNioSend.java
+++ b/test/org/apache/catalina/tribes/test/transport/SocketNioSend.java
@@ -32,13 +32,7 @@ import org.apache.catalina.tribes.transport.nio.NioSender;
 public class SocketNioSend {
 
     public static void main(String[] args) throws Exception {
-        Selector selector;
-        synchronized (Selector.class) {
-            // Selector.open() isn't thread safe
-            // http://bugs.sun.com/view_bug.do?bug_id=6427854
-            // Affects 1.6.0_29, fixed in 1.7.0_01
-            selector = Selector.open();
-        }
+        Selector selector = Selector.open();
         Member mbr = new MemberImpl("localhost", 9999, 0);
         ChannelData data = new ChannelData();
         data.setOptions(Channel.SEND_OPTIONS_BYTE_MESSAGE);

==================================================
