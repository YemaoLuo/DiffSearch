d5f3c97a05e050a1b38b801e9545b92d97c93407
==================================================
BZ 63684: Wrapper never passed to RealmBase#hasRole() for given security constraints
==================================================
Michael Osipov
==================================================
Thu Aug 22 14:34:31 2019 +0200
==================================================
RealmBase.java
BZ 63684: Wrapper never passed to RealmBase#hasRole() for given security constraints



==================================================
UserDatabaseRealm.java
index 833973af74..aa542a7852 100644
--- a/java/org/apache/catalina/realm/RealmBase.java
+++ b/java/org/apache/catalina/realm/RealmBase.java
@@ -856,7 +856,7 @@ public abstract class RealmBase extends LifecycleMBeanBase implements Realm {
                     log.debug("  No user authenticated, cannot grant access");
             } else {
                 for (int j = 0; j < roles.length; j++) {
-                    if (hasRole(null, principal, roles[j])) {
+                    if (hasRole(request.getWrapper(), principal, roles[j])) {
                         status = true;
                         if( log.isDebugEnabled() )
                             log.debug( "Role found:  " + roles[j]);

==================================================
TestStandardWrapper.java
index a552fc481c..64957a9830 100644
--- a/java/org/apache/catalina/realm/UserDatabaseRealm.java
+++ b/java/org/apache/catalina/realm/UserDatabaseRealm.java
@@ -108,6 +108,8 @@ public class UserDatabaseRealm extends RealmBase {
         }
         if (!(principal instanceof User)) {
             // Play nice with SSO and mixed Realms
+            // No need to pass the wrapper here because role mapping has been
+            // performed already a few lines above
             return super.hasRole(null, principal, role);
         }
         if ("*".equals(role)) {

==================================================
