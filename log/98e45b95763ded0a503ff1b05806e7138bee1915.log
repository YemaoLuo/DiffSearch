98e45b95763ded0a503ff1b05806e7138bee1915
==================================================
BZ 64011: JNDIRealm no longer authenticates to LDAP
==================================================
Michael Osipov
==================================================
Sat Jan 4 14:44:52 2020 +0100
==================================================
JNDIRealm.java
BZ 64011: JNDIRealm no longer authenticates to LDAP


==================================================
RealmBase.java
index b069538488..26c97f1176 100644
--- a/java/org/apache/catalina/realm/JNDIRealm.java
+++ b/java/org/apache/catalina/realm/JNDIRealm.java
@@ -62,6 +62,7 @@ import javax.net.ssl.SSLSocketFactory;
 
 import org.apache.catalina.LifecycleException;
 import org.ietf.jgss.GSSCredential;
+import org.ietf.jgss.GSSName;
 
 /**
  * <p>Implementation of <strong>Realm</strong> that works with a directory
@@ -2244,6 +2245,22 @@ public class JNDIRealm extends RealmBase {
         return getPrincipal(username, null);
     }
 
+    @Override
+    protected Principal getPrincipal(GSSName gssName,
+            GSSCredential gssCredential) {
+        String name = gssName.toString();
+
+        if (isStripRealmForGss()) {
+            int i = name.indexOf('@');
+            if (i > 0) {
+                // Zero so we don't leave a zero length name
+                name = name.substring(0, i);
+            }
+        }
+
+        return getPrincipal(name, gssCredential);
+    }
+
     @Override
     protected Principal getPrincipal(String username,
             GSSCredential gssCredential) {

==================================================
