8b47bc3403b540469e78ac33c82f1e68fd01b4d8
==================================================
Fix a crash with testUpgrade and APR native.
==================================================
Mark Thomas
==================================================
Tue Feb 24 21:04:31 2015 +0000
==================================================
AprEndpoint.java
Fix a crash with testUpgrade and APR native.
There was a small gap between the point where the write thread exited the poller and the connections map was queried for the wrapper that the read thread could close the socket and the write thread would have no visibility of the change. I suspect the converse was also true. This closes the gap.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1662117 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestUpgrade.java
index e948d96009..7ec996c014 100644
--- a/java/org/apache/tomcat/util/net/AprEndpoint.java
+++ b/java/org/apache/tomcat/util/net/AprEndpoint.java
@@ -2341,7 +2341,7 @@ public class AprEndpoint extends AbstractEndpoint<Long> {
 
         private void doRun() {
             // Process the request from this socket
-            if (socket.getSocket() == null) {
+            if (socket.getSocket() == null || !connections.containsKey(socket)) {
                 // Closed in another thread
                 return;
             }

==================================================
