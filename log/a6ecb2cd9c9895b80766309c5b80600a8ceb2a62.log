a6ecb2cd9c9895b80766309c5b80600a8ceb2a62
==================================================
Follow-up to r1663715
==================================================
Mark Thomas
==================================================
Tue Mar 3 17:55:04 2015 +0000
==================================================
ExpandWar.java
Follow-up to r1663715
- use correct method to get the last modified time of the WAR
- set the directory last modified time after it has been updated
- test the correct files to see if an expanded context.xml file should be used

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1663754 13f79535-47bb-0310-9956-ffa450edef68



==================================================
HostConfig.java
index 21e5cf5be7..77a96c4910 100644
--- a/java/org/apache/catalina/startup/ExpandWar.java
+++ b/java/org/apache/catalina/startup/ExpandWar.java
@@ -84,7 +84,7 @@ public class ExpandWar {
         try (JarFile jarFile = juc.getJarFile()) {
 
             // Get the last modified time for the WAR
-            long warLastModified = juc.getContentLengthLong();
+            long warLastModified = juc.getLastModified();
 
             // Check to see of the WAR has been expanded previously
             if (docBase.exists()) {
@@ -99,9 +99,8 @@ public class ExpandWar {
                     return (docBase.getAbsolutePath());
                 }
 
-                log.info(sm.getString("expandWar.deleteOld", docBase));
-
                 // WAR must have been modified. Remove expanded directory.
+                log.info(sm.getString("expandWar.deleteOld", docBase));
                 if (!delete(docBase)) {
                     throw new IOException(sm.getString("expandWar.deleteFailed", docBase));
                 }
@@ -112,10 +111,6 @@ public class ExpandWar {
                 throw new IOException(sm.getString("expandWar.createFailed", docBase));
             }
 
-            // Align the last modified time of the directory with the WAR so
-            // changes to the WAR while Tomcat is stopped can be detected
-            docBase.setLastModified(warLastModified);
-
             // Expand the WAR into the new document base directory
             String canonicalDocBasePrefix = docBase.getCanonicalPath();
             if (!canonicalDocBasePrefix.endsWith(File.separator)) {
@@ -161,6 +156,10 @@ public class ExpandWar {
                         expandedFile.setLastModified(lastModified);
                     }
                 }
+
+                // Align the last modified time of the directory with the WAR so
+                // changes to the WAR while Tomcat is stopped can be detected
+                docBase.setLastModified(warLastModified);
             }
             success = true;
         } catch (IOException e) {

==================================================
