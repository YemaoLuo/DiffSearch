f955308bdce3c37a2b937bc2566222e9d79309c4
==================================================
Use java.nio.file.Files where possible
==================================================
Mark Thomas
==================================================
Thu Jan 7 09:31:50 2016 +0000
==================================================
HostManagerServlet.java
Use java.nio.file.Files where possible

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1723493 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CGIServlet.java
index a5247898a7..2e05230ad9 100644
--- a/java/org/apache/catalina/manager/host/HostManagerServlet.java
+++ b/java/org/apache/catalina/manager/host/HostManagerServlet.java
@@ -17,11 +17,11 @@
 package org.apache.catalina.manager.host;
 
 import java.io.File;
-import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
-import java.io.OutputStream;
 import java.io.PrintWriter;
+import java.nio.file.Files;
+import java.nio.file.Path;
 import java.util.StringTokenizer;
 
 import javax.servlet.ServletException;
@@ -39,7 +39,6 @@ import org.apache.catalina.Wrapper;
 import org.apache.catalina.core.ContainerBase;
 import org.apache.catalina.core.StandardHost;
 import org.apache.catalina.startup.HostConfig;
-import org.apache.catalina.util.IOTools;
 import org.apache.tomcat.util.ExceptionUtils;
 import org.apache.tomcat.util.res.StringManager;
 
@@ -383,11 +382,9 @@ public class HostManagerServlet
                         "hostManagerServlet.configBaseCreateFail", name));
                 return;
             }
-            try (InputStream is = getServletContext().getResourceAsStream("/manager.xml");
-                    OutputStream os = new FileOutputStream(
-                            new File(configBaseFile, "manager.xml"))) {
-                byte buffer[] = new byte[512];
-                IOTools.flow(is, os, buffer);
+            try (InputStream is = getServletContext().getResourceAsStream("/manager.xml")) {
+                Path dest = (new File(configBaseFile, "manager.xml")).toPath();
+                Files.copy(is, dest);
             } catch (IOException e) {
                 writer.println(smClient.getString("hostManagerServlet.managerXml"));
                 return;

==================================================
HostConfig.java
index 5dfef6b4fa..bb054dffec 100644
--- a/java/org/apache/catalina/servlets/CGIServlet.java
+++ b/java/org/apache/catalina/servlets/CGIServlet.java
@@ -21,13 +21,13 @@ package org.apache.catalina.servlets;
 import java.io.BufferedOutputStream;
 import java.io.BufferedReader;
 import java.io.File;
-import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.InputStreamReader;
 import java.io.OutputStream;
 import java.io.UnsupportedEncodingException;
 import java.net.URLDecoder;
+import java.nio.file.Files;
 import java.util.ArrayList;
 import java.util.Date;
 import java.util.Enumeration;
@@ -1166,9 +1166,7 @@ public final class CGIServlet extends HttpServlet {
             }
 
             // create directories
-            String dirPath = destPath.toString().substring(
-                    0,destPath.toString().lastIndexOf('/'));
-            File dir = new File(dirPath);
+            File dir = f.getParentFile();
             if (!dir.mkdirs() && !dir.isDirectory()) {
                 if (debug >= 2) {
                     log("expandCGIScript: failed to create directories for '" +
@@ -1188,19 +1186,13 @@ public final class CGIServlet extends HttpServlet {
                     if (!f.createNewFile()) {
                         return;
                     }
-                    FileOutputStream fos = new FileOutputStream(f);
 
                     try {
-                        // copy data
-                        IOTools.flow(is, fos);
+                        Files.copy(is, f.toPath());
                     } finally {
-                        try {
-                            is.close();
-                        } catch (IOException e) {
-                            log("Could not close is.", e);
-                        }
-                        fos.close();
+                        is.close();
                     }
+
                     if (debug >= 2) {
                         log("expandCGIScript: expanded '" + srcPath + "' to '" + destPath + "'");
                     }

==================================================
DirResourceSet.java
index d43a20ce47..1fb812c8e6 100644
--- a/java/org/apache/catalina/startup/HostConfig.java
+++ b/java/org/apache/catalina/startup/HostConfig.java
@@ -22,8 +22,8 @@ import java.io.FileInputStream;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.InputStream;
-import java.io.OutputStream;
 import java.net.URL;
+import java.nio.file.Files;
 import java.util.ArrayList;
 import java.util.HashMap;
 import java.util.HashSet;
@@ -56,7 +56,6 @@ import org.apache.catalina.Manager;
 import org.apache.catalina.core.StandardContext;
 import org.apache.catalina.core.StandardHost;
 import org.apache.catalina.util.ContextName;
-import org.apache.catalina.util.IOTools;
 import org.apache.juli.logging.Log;
 import org.apache.juli.logging.LogFactory;
 import org.apache.tomcat.util.ExceptionUtils;
@@ -1066,11 +1065,7 @@ public class HostConfig implements LifecycleListener {
                 }
 
                 if (copyThisXml) {
-                    try (InputStream is = new FileInputStream(xml);
-                            OutputStream os = new FileOutputStream(xmlCopy)) {
-                        IOTools.flow(is, os);
-                        // Don't catch IOE - let the outer try/catch handle it
-                    }
+                    Files.copy(xml.toPath(), xmlCopy.toPath());
                     context.setConfigFile(xmlCopy.toURI().toURL());
                 } else {
                     context.setConfigFile(xml.toURI().toURL());

==================================================
