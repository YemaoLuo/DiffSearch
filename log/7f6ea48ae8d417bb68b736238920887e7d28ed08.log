7f6ea48ae8d417bb68b736238920887e7d28ed08
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55438
==================================================
Mark Emlyn
==================================================
Mon Aug 19 14:54:15 2013 +0000
==================================================
InputBuffer.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55438
Don't call onAllDataRead() twice for an empty request body.
Make the non-blocking test more robust as on client disconnect the error may occur in the read or the write listener.
Unit test provided by Daniel Mikusa.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1515454 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Request.java
index e8ad001c0c..91f40b4f8a 100644
--- a/java/org/apache/catalina/connector/InputBuffer.java
+++ b/java/org/apache/catalina/connector/InputBuffer.java
@@ -258,14 +258,14 @@ public class InputBuffer extends Reader
         // Must call isFinished() first as a call to isReady() if the request
         // has been finished will register the socket for read interest and that
         // is not required.
-        if (isFinished() || isReady()) {
+        if (!coyoteRequest.isFinished() && isReady()) {
             coyoteRequest.action(ActionCode.DISPATCH_READ, null);
         }
     }
 
 
     public boolean isFinished() {
-        return available() == 0;
+        return coyoteRequest.isFinished();
     }
 
 

==================================================
Request.java
index 6de5b1063e..039fcedf44 100644
--- a/java/org/apache/catalina/connector/Request.java
+++ b/java/org/apache/catalina/connector/Request.java
@@ -2461,9 +2461,7 @@ public class Request
      * of the request body has been read
      */
     public boolean isFinished() {
-        AtomicBoolean result = new AtomicBoolean(false);
-        coyoteRequest.action(ActionCode.REQUEST_BODY_FULLY_READ, result);
-        return result.get();
+        return coyoteRequest.isFinished();
     }
 
 

==================================================
TestNonBlockingAPI.java
index 6d018040ed..d632a4769e 100644
--- a/java/org/apache/coyote/Request.java
+++ b/java/org/apache/coyote/Request.java
@@ -425,9 +425,15 @@ public final class Request {
         this.available = available;
     }
 
-    // -------------------- Input Buffer --------------------
+    public boolean isFinished() {
+        AtomicBoolean result = new AtomicBoolean(false);
+        action(ActionCode.REQUEST_BODY_FULLY_READ, result);
+        return result.get();
+    }
 
 
+    // -------------------- Input Buffer --------------------
+
     public InputBuffer getInputBuffer() {
         return inputBuffer;
     }

==================================================
