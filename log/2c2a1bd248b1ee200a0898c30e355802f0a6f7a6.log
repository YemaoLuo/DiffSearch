2c2a1bd248b1ee200a0898c30e355802f0a6f7a6
==================================================
Add proxy and redirect error report valve
==================================================
remm remm@apache.org
==================================================
Thu Feb 9 15:45:43 2023 +0100
==================================================
ErrorReportValve.java
Add proxy and redirect error report valve

Although this could be merged in the default valve, I prefer keeping it
separate. The code duplication is minimal after refactoring.
Keep the ability to use a properties file as an option for that (with
URLs, the server.xml could become very verbose very fast), although it
will default to the status code configuration from the superclass.
Based on PR#506 submitted by Max Fortun.


==================================================
ProxyErrorReportValve.java
index 365109ebf9..44548e1170 100644
--- a/java/org/apache/catalina/valves/ErrorReportValve.java
+++ b/java/org/apache/catalina/valves/ErrorReportValve.java
@@ -151,6 +151,29 @@ public class ErrorReportValve extends ValveBase {
     // ------------------------------------------------------ Protected Methods
 
 
+    /**
+     * Return the error page associated with the specified status and exception.
+     *
+     * @param statusCode the status code
+     * @param throwable the exception
+     * @return the associated error page
+     */
+    protected ErrorPage findErrorPage(int statusCode, Throwable throwable) {
+        ErrorPage errorPage = null;
+        if (throwable != null) {
+            errorPage = errorPageSupport.find(throwable);
+        }
+        if (errorPage == null) {
+            errorPage = errorPageSupport.find(statusCode);
+        }
+        if (errorPage == null) {
+            // Default error page
+            errorPage = errorPageSupport.find(0);
+        }
+        return errorPage;
+    }
+
+
     /**
      * Prints out an error report.
      *
@@ -179,18 +202,7 @@ public class ErrorReportValve extends ValveBase {
             return;
         }
 
-        ErrorPage errorPage = null;
-        if (throwable != null) {
-            errorPage = errorPageSupport.find(throwable);
-        }
-        if (errorPage == null) {
-            errorPage = errorPageSupport.find(statusCode);
-        }
-        if (errorPage == null) {
-            // Default error page
-            errorPage = errorPageSupport.find(0);
-        }
-
+        ErrorPage errorPage = findErrorPage(statusCode, throwable);
 
         if (errorPage != null) {
             if (sendErrorPage(errorPage.getLocation(), response)) {

==================================================
