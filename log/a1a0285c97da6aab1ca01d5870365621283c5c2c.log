a1a0285c97da6aab1ca01d5870365621283c5c2c
==================================================
If a file is too big to be cached, return the original resource not the CacheResource instance else the resource content will still be cached.
==================================================
Mark Emlyn
==================================================
Mon Dec 9 23:09:18 2013 +0000
==================================================
Cache.java
If a file is too big to be cached, return the original resource not the CacheResource instance else the resource content will still be cached.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1549704 13f79535-47bb-0310-9956-ffa450edef68



==================================================
CachedResource.java
index 8c6ec4d3ed..f4266af5be 100644
--- a/java/org/apache/catalina/webresources/Cache.java
+++ b/java/org/apache/catalina/webresources/Cache.java
@@ -78,10 +78,12 @@ public class Cache {
                 // newCacheEntry was inserted into the cache - validate it
                 cacheEntry = newCacheEntry;
                 cacheEntry.validate(useClassLoaderResources);
-                if (newCacheEntry.getContentLength() > getMaxSizeBytes()) {
+                if (cacheEntry.getContentLength() > getMaxSizeBytes()) {
                     // Cache size has not been updated at this point
                     removeCacheEntry(path, false);
-                    return newCacheEntry;
+                    // Return the original resource not the one wrapped in the
+                    // cache otherwise content will be cached any way.
+                    return cacheEntry.getWebResource();
                 }
 
                 // Assume that the cache entry will include the content.

==================================================
