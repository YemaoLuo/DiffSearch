06b10032e30af8f7b51636078a9c8db4eea9b6c1
==================================================
Fixed validation when testOnConnect=false. In this case, we need to verify, do we have an init query, if so, do an init validation, otherwise do a borrow validation.
==================================================
Filip Hanik
==================================================
Thu Aug 7 23:16:14 2014 +0000
==================================================
ConnectionPool.java
Fixed validation when testOnConnect=false. In this case, we need to verify, do we have an init query, if so, do an init validation, otherwise do a borrow validation.

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1616625 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Bug54978.java
index 0f7cca7fe2..3292ae9875 100644
--- a/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
+++ b/modules/jdbc-pool/src/main/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
@@ -794,7 +794,11 @@ public class ConnectionPool {
             //the connection shouldn't have to poll again.
             try {
                 con.reconnect();
-                if (con.validate(PooledConnection.VALIDATE_INIT)) {
+                int validationMode = getPoolProperties().isTestOnConnect() || getPoolProperties().getInitSQL()!=null ? 
+                    PooledConnection.VALIDATE_INIT : 
+                    PooledConnection.VALIDATE_BORROW;
+                
+                if (con.validate(validationMode)) {
                     //set the timestamp
                     con.setTimestamp(now);
                     if (getPoolProperties().isLogAbandoned()) {

==================================================
