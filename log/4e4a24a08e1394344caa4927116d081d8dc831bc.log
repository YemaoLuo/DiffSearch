4e4a24a08e1394344caa4927116d081d8dc831bc
==================================================
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55664
==================================================
Mark Emlyn
==================================================
Fri Oct 18 07:40:00 2013 +0000
==================================================
Util.java
Fix https://issues.apache.org/bugzilla/show_bug.cgi?id=55664
Correctly handle Encoder, Decoder and MessageHandler implementations that use a generic type such as Encoder.Text<List<String>>

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1533347 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestUtil.java
index 8c2be55a0a..842be25a75 100644
--- a/java/org/apache/tomcat/websocket/Util.java
+++ b/java/org/apache/tomcat/websocket/Util.java
@@ -164,8 +164,8 @@ public class Util {
     }
 
 
-    public static Class<?> getDecoderType(Class<? extends Decoder> Decoder) {
-        return (Class<?>) Util.getGenericType(Decoder.class, Decoder);
+    public static Class<?> getDecoderType(Class<? extends Decoder> decoder) {
+        return (Class<?>) Util.getGenericType(Decoder.class, decoder);
     }
 
 
@@ -229,6 +229,8 @@ public class Util {
     private static Object getTypeParameter(Class<?> clazz, Type argType) {
         if (argType instanceof Class<?>) {
             return argType;
+        } else if (argType instanceof ParameterizedType) {
+            return ((ParameterizedType) argType).getRawType();
         } else {
             TypeVariable<?>[] tvs = clazz.getTypeParameters();
             for (int i = 0; i < tvs.length; i++) {

==================================================
TestEncodingDecoding.java
index ba6543dec2..37e8bbb53d 100644
--- a/test/org/apache/tomcat/websocket/TestUtil.java
+++ b/test/org/apache/tomcat/websocket/TestUtil.java
@@ -16,6 +16,8 @@
  */
 package org.apache.tomcat.websocket;
 
+import java.util.List;
+
 import javax.websocket.EncodeException;
 import javax.websocket.Encoder;
 import javax.websocket.EndpointConfig;
@@ -101,6 +103,13 @@ public class TestUtil {
     }
 
 
+    @Test
+    public void testGetEncoderTypeSimpleWithGenericType() {
+        Assert.assertEquals(List.class,
+                Util.getEncoderType(SimpleEncoderWithGenericType.class));
+    }
+
+
     private static class SimpleMessageHandler
             implements MessageHandler.Whole<String> {
         @Override
@@ -281,4 +290,24 @@ public class TestUtil {
             // NO-OP
         }
     }
+
+
+    private static class SimpleEncoderWithGenericType
+            implements Encoder.Text<List<String>> {
+
+        @Override
+        public void init(EndpointConfig endpointConfig) {
+            // NO-OP
+        }
+
+        @Override
+        public void destroy() {
+            // NO-OP
+        }
+
+        @Override
+        public String encode(List<String> object) throws EncodeException {
+            return null;
+        }
+    }
 }

==================================================
