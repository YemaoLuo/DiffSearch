1129b48ff7f37c12f903728ca967ee39d242cb7e
==================================================
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=61682
==================================================
Mark Thomas
==================================================
Thu Nov 16 10:14:39 2017 +0000
==================================================
Http2UpgradeHandler.java
Fix https://bz.apache.org/bugzilla/show_bug.cgi?id=61682
When re-prioritising HTTP/2 streams, ensure that both parent and children fields are correctly updated to avoid a possible StackOverflowError

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1815429 13f79535-47bb-0310-9956-ffa450edef68



==================================================
Stream.java
index f49c34171c..6cd619ce00 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -1108,6 +1108,7 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
             }
         }
         streamToRemove.detachFromParent();
+        streamToRemove.getChildStreams().clear();
     }
 
 

==================================================
TestAbstractStream.java
index 34e91abfdf..091c788c1e 100644
--- a/java/org/apache/coyote/http2/Stream.java
+++ b/java/org/apache/coyote/http2/Stream.java
@@ -87,7 +87,7 @@ class Stream extends AbstractStream implements HeaderEmitter {
     Stream(Integer identifier, Http2UpgradeHandler handler, Request coyoteRequest) {
         super(identifier);
         this.handler = handler;
-        setParentStream(handler);
+        handler.addChild(this);
         setWindowSize(handler.getRemoteSettings().getInitialWindowSize());
         state = new StreamStateMachine(this);
         if (coyoteRequest == null) {
@@ -139,6 +139,7 @@ class Stream extends AbstractStream implements HeaderEmitter {
                 this.addChild(parentsChild);
             }
         }
+        detachFromParent();
         parent.addChild(this);
         this.weight = weight;
     }

==================================================
