8cf47cad7ea10d3c87617b4181cd2a40ef5c5900
==================================================
Make utility method static and save a few object instances
==================================================
Mark Emlyn
==================================================
Sun Jul 22 22:17:59 2012 +0000
==================================================
DigestAuthenticator.java
Make utility method static and save a few object instances

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1364448 13f79535-47bb-0310-9956-ffa450edef68



==================================================
RealmBase.java
index 89a930fddf..dfa8bd24b9 100644
--- a/java/org/apache/catalina/authenticator/DigestAuthenticator.java
+++ b/java/org/apache/catalina/authenticator/DigestAuthenticator.java
@@ -58,7 +58,10 @@ public class DigestAuthenticator extends AuthenticatorBase {
 
     /**
      * The MD5 helper object for this class.
+     *
+     * @deprecated  Unused - will be removed in Tomcat 8.0.x
      */
+    @Deprecated
     protected static final MD5Encoder md5Encoder = new MD5Encoder();
 
 
@@ -366,7 +369,7 @@ public class DigestAuthenticator extends AuthenticatorBase {
                     ipTimeKey.getBytes(B2CConverter.ISO_8859_1));
         }
 
-        return currentTime + ":" + md5Encoder.encode(buffer);
+        return currentTime + ":" + MD5Encoder.encode(buffer);
     }
 
 
@@ -621,7 +624,7 @@ public class DigestAuthenticator extends AuthenticatorBase {
                 buffer = md5Helper.digest(
                         serverIpTimeKey.getBytes(B2CConverter.ISO_8859_1));
             }
-            String md5ServerIpTimeKey = md5Encoder.encode(buffer);
+            String md5ServerIpTimeKey = MD5Encoder.encode(buffer);
             if (!md5ServerIpTimeKey.equals(md5clientIpTimeKey)) {
                 return false;
             }
@@ -685,7 +688,7 @@ public class DigestAuthenticator extends AuthenticatorBase {
             synchronized (md5Helper) {
                 buffer = md5Helper.digest(a2.getBytes(B2CConverter.ISO_8859_1));
             }
-            String md5a2 = md5Encoder.encode(buffer);
+            String md5a2 = MD5Encoder.encode(buffer);
 
             return realm.authenticate(userName, response, nonce, nc, cnonce,
                     qop, realmName, md5a2);

==================================================
WebdavServlet.java
index 264a7a68ca..19d3db08fd 100644
--- a/java/org/apache/catalina/realm/RealmBase.java
+++ b/java/org/apache/catalina/realm/RealmBase.java
@@ -109,7 +109,10 @@ public abstract class RealmBase extends LifecycleMBeanBase implements Realm {
 
     /**
      * The MD5 helper object for this class.
+     *
+     * @deprecated  Unused - will be removed in Tomcat 8.0.x
      */
+    @Deprecated
     protected static final MD5Encoder md5Encoder = new MD5Encoder();
 
 
@@ -405,7 +408,7 @@ public abstract class RealmBase extends LifecycleMBeanBase implements Realm {
         String serverDigest = null;
         // Bugzilla 32137
         synchronized(md5Helper) {
-            serverDigest = md5Encoder.encode(md5Helper.digest(valueBytes));
+            serverDigest = MD5Encoder.encode(md5Helper.digest(valueBytes));
         }
 
         if (log.isDebugEnabled()) {
@@ -1206,7 +1209,7 @@ public abstract class RealmBase extends LifecycleMBeanBase implements Realm {
             digest = md5Helper.digest(valueBytes);
         }
 
-        return md5Encoder.encode(digest);
+        return MD5Encoder.encode(digest);
     }
 
 

==================================================
MD5Encoder.java
index 2315d7d484..a4e1734f40 100644
--- a/java/org/apache/catalina/servlets/WebdavServlet.java
+++ b/java/org/apache/catalina/servlets/WebdavServlet.java
@@ -212,7 +212,10 @@ public class WebdavServlet
 
     /**
      * The MD5 helper object for this class.
+     *
+     * @deprecated  Unused - will be removed in Tomcat 8.0.x
      */
+    @Deprecated
     protected static final MD5Encoder md5Encoder = new MD5Encoder();
 
 
@@ -1145,7 +1148,7 @@ public class WebdavServlet
                 + lock.depth + "-" + lock.owner + "-" + lock.tokens + "-"
                 + lock.expiresAt + "-" + System.currentTimeMillis() + "-"
                 + secret;
-            String lockToken = md5Encoder.encode(md5Helper.digest(
+            String lockToken = MD5Encoder.encode(md5Helper.digest(
                     lockTokenStr.getBytes(B2CConverter.ISO_8859_1)));
 
             if ( (exists) && (object instanceof DirContext) &&

==================================================
TestDigestAuthenticator.java
index 8fb3259963..15ecb4f98a 100644
--- a/java/org/apache/catalina/util/MD5Encoder.java
+++ b/java/org/apache/catalina/util/MD5Encoder.java
@@ -33,6 +33,14 @@ package org.apache.catalina.util;
 public final class MD5Encoder {
 
 
+    /**
+     * @deprecated  Will be made private in Tomcat 8.0.x
+     */
+    @Deprecated
+    public MD5Encoder() {
+        // NOOP
+    }
+
     // ----------------------------------------------------- Instance Variables
 
 
@@ -50,7 +58,7 @@ public final class MD5Encoder {
      * @param binaryData Array containing the digest
      * @return Encoded MD5, or null if encoding failed
      */
-    public String encode( byte[] binaryData ) {
+    public static String encode( byte[] binaryData ) {
 
         if (binaryData.length != 16)
             return null;

==================================================
TestSSOnonLoginAndDigestAuthenticator.java
index d1b69b7ced..f2373ec896 100644
--- a/test/org/apache/catalina/authenticator/TestDigestAuthenticator.java
+++ b/test/org/apache/catalina/authenticator/TestDigestAuthenticator.java
@@ -364,9 +364,8 @@ public class TestDigestAuthenticator extends TomcatBaseTest {
     private static String digest(String input) throws NoSuchAlgorithmException {
         // This is slow but should be OK as this is only a test
         MessageDigest md5 = MessageDigest.getInstance("MD5");
-        MD5Encoder encoder = new MD5Encoder();
 
         md5.update(input.getBytes());
-        return encoder.encode(md5.digest());
+        return MD5Encoder.encode(md5.digest());
     }
 }

==================================================
TesterDigestAuthenticatorPerformance.java
index 010baa1aef..9c39c29750 100644
--- a/test/org/apache/catalina/authenticator/TestSSOnonLoginAndDigestAuthenticator.java
+++ b/test/org/apache/catalina/authenticator/TestSSOnonLoginAndDigestAuthenticator.java
@@ -472,10 +472,9 @@ public class TestSSOnonLoginAndDigestAuthenticator extends TomcatBaseTest {
     private static String digest(String input) throws NoSuchAlgorithmException {
         // This is slow but should be OK as this is only a test
         MessageDigest md5 = MessageDigest.getInstance("MD5");
-        MD5Encoder encoder = new MD5Encoder();
 
         md5.update(input.getBytes());
-        return encoder.encode(md5.digest());
+        return MD5Encoder.encode(md5.digest());
     }
 
     /*

==================================================
