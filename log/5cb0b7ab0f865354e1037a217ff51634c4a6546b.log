5cb0b7ab0f865354e1037a217ff51634c4a6546b
==================================================
https://issues.apache.org/bugzilla/show_bug.cgi?id=50613
==================================================
Filip Hanik
==================================================
Wed Jan 19 21:25:08 2011 +0000
==================================================
ConnectionPool.java
https://issues.apache.org/bugzilla/show_bug.cgi?id=50613
Fix concurrency bug around size calculation for the pool


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1060998 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestSizePreservation.java
index 1622c7908f..3bfc2422cc 100644
--- a/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
+++ b/modules/jdbc-pool/java/org/apache/tomcat/jdbc/pool/ConnectionPool.java
@@ -545,7 +545,7 @@ public class ConnectionPool {
         // we could have threads stuck in idle.poll(timeout) that will never be
         // notified
         if (waitcount.get() > 0) {
-            idle.offer(new PooledConnection(poolProperties, this));
+            idle.offer(create(true));
         }
     }
 
@@ -637,7 +637,7 @@ public class ConnectionPool {
      */
     protected PooledConnection createConnection(long now, PooledConnection notUsed, String username, String password) throws SQLException {
         //no connections where available we'll create one
-        PooledConnection con = create();
+        PooledConnection con = create(false);
         if (username!=null) con.getAttributes().put(con.PROP_USER, username);
         if (password!=null) con.getAttributes().put(con.PROP_PASSWORD, password);
         boolean error = false;
@@ -984,7 +984,8 @@ public class ConnectionPool {
      * Create a new pooled connection object. Not connected nor validated.
      * @return a pooled connection object
      */
-    protected PooledConnection create() {
+    protected PooledConnection create(boolean incrementCounter) {
+        if (incrementCounter) size.incrementAndGet();
         PooledConnection con = new PooledConnection(getPoolProperties(), this);
         return con;
     }

==================================================
