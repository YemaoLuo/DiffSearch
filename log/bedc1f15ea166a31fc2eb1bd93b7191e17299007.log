bedc1f15ea166a31fc2eb1bd93b7191e17299007
==================================================
Servlet 3.1. If GET is not protected but other methods are, the redirect after authentication (that now always uses a GET) fails. Because it is unprotected it is not passed to the FORM authenticator for processing (where the original request would be restored).
==================================================
Mark Emlyn
==================================================
Mon Jun 17 15:00:56 2013 +0000
==================================================
AuthenticatorBase.java
Servlet 3.1. If GET is not protected but other methods are, the redirect after authentication (that now always uses a GET) fails. Because it is unprotected it is not passed to the FORM authenticator for processing (where the original request would be restored).

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1493801 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestFormAuthenticator.java
index 5698ac425b..d7044824a1 100644
--- a/java/org/apache/catalina/authenticator/AuthenticatorBase.java
+++ b/java/org/apache/catalina/authenticator/AuthenticatorBase.java
@@ -455,6 +455,36 @@ public abstract class AuthenticatorBase extends ValveBase
             }
         }
 
+        // Special handling for form-based logins to deal with the case where
+        // a resource is protected for some HTTP methods but not protected for
+        // GET which is used after authentication when redirecting to the
+        // protected resource.
+        // TODO: This is similar to the FormAuthenticator.matchRequest() logic
+        //       Is there a way to remove the duplication?
+        Session session = request.getSessionInternal(false);
+        if (session != null) {
+            SavedRequest savedRequest =
+                    (SavedRequest) session.getNote(Constants.FORM_REQUEST_NOTE);
+            if (savedRequest != null) {
+                String decodedRequestURI = request.getDecodedRequestURI();
+                if (decodedRequestURI != null &&
+                        decodedRequestURI.equals(
+                                savedRequest.getDecodedRequestURI())) {
+                    if (!authenticate(request, response)) {
+                        if (log.isDebugEnabled()) {
+                            log.debug(" Failed authenticate() test");
+                        }
+                        /*
+                         * ASSERT: Authenticator already set the appropriate
+                         * HTTP status code, so we do not have to do anything
+                         * special
+                         */
+                        return;
+                    }
+                }
+            }
+        }
+
         // The Servlet may specify security constraints through annotations.
         // Ensure that they have been processed before constraints are checked
         Wrapper wrapper = request.getMappingData().wrapper;

==================================================
