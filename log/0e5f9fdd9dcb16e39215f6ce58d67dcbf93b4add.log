0e5f9fdd9dcb16e39215f6ce58d67dcbf93b4add
==================================================
Partial fix for async with HTTP/2
==================================================
Mark Thomas
==================================================
Mon Dec 5 09:00:52 2016 +0000
==================================================
Http2UpgradeHandler.java
Partial fix for async with HTTP/2

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@1772606 13f79535-47bb-0310-9956-ffa450edef68



==================================================
StreamProcessor.java
index 65d0ea21d0..a3f2643b7a 100644
--- a/java/org/apache/coyote/http2/Http2UpgradeHandler.java
+++ b/java/org/apache/coyote/http2/Http2UpgradeHandler.java
@@ -268,8 +268,13 @@ class Http2UpgradeHandler extends AbstractStream implements InternalHttpUpgradeH
 
     private void processStreamOnContainerThread(Stream stream) {
         StreamProcessor streamProcessor = new StreamProcessor(this, stream, adapter, socketWrapper);
-        StreamRunnable streamRunnable = new StreamRunnable(streamProcessor, SocketEvent.OPEN_READ);
         streamProcessor.setSslSupport(sslSupport);
+        processStreamOnContainerThread(streamProcessor, SocketEvent.OPEN_READ);
+    }
+
+
+    void processStreamOnContainerThread(StreamProcessor streamProcessor, SocketEvent event) {
+        StreamRunnable streamRunnable = new StreamRunnable(streamProcessor, event);
         if (streamConcurrency == null) {
             socketWrapper.getEndpoint().getExecutor().execute(streamRunnable);
         } else {

==================================================
