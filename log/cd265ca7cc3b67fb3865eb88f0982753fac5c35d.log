cd265ca7cc3b67fb3865eb88f0982753fac5c35d
==================================================
Use a connector attribute rather than a system property to control renegotiation
==================================================
Mark Emlyn
==================================================
Tue Nov 10 14:26:01 2009 +0000
==================================================
JSSESocketFactory.java
Use a connector attribute rather than a system property to control renegotiation
Fix some trivial Eclispe warnings in the test
Don't try and invalidate the session in the client - an attacker probably won't do this
Add a test that checks the connector attribute can be used to enable renegotiation

git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@834477 13f79535-47bb-0310-9956-ffa450edef68



==================================================
TestTomcatSSL.java
index 74df1d9ea5..956af3e687 100644
--- a/java/org/apache/tomcat/util/net/jsse/JSSESocketFactory.java
+++ b/java/org/apache/tomcat/util/net/jsse/JSSESocketFactory.java
@@ -95,9 +95,6 @@ public class JSSESocketFactory
     private static final int defaultSessionCacheSize = 0;
     private static final int defaultSessionTimeout = 86400;
     
-    private static final boolean midmMode = 
-        "true".equals(System.getProperty("enable_ssl_mitm_vulnerability"));
-    
     static org.apache.juli.logging.Log log =
         org.apache.juli.logging.LogFactory.getLog(JSSESocketFactory.class);
 
@@ -105,6 +102,7 @@ public class JSSESocketFactory
     protected String clientAuth = "false";
     protected SSLServerSocketFactory sslProxy = null;
     protected String[] enabledCiphers;
+    protected boolean enableMitmVulnerability = false;
 
     /**
      * Flag to state that we require client authentication.
@@ -159,7 +157,7 @@ public class JSSESocketFactory
         SSLSocket asock = null;
         try {
              asock = (SSLSocket)socket.accept();
-             if (!midmMode) {
+             if (!enableMitmVulnerability) {
                  asock.addHandshakeCompletedListener(
                          new DisableSslRenegotiation());
              }
@@ -492,6 +490,9 @@ public class JSSESocketFactory
                 getEnabledCiphers(requestedCiphers,
                         sslProxy.getSupportedCipherSuites());
 
+            enableMitmVulnerability =
+                "true".equals(attributes.get("enableMitmVulnerability"));
+            
             // Check the SSL config is OK
             checkConfig();
 

==================================================
