f25e2ca2ff84dafe433fba576b825413a9114998
==================================================
AJP13 misses to forward the remotePort.
==================================================
Rainer Jung
==================================================
Sat Mar 21 12:51:39 2009 +0000
==================================================
AjpAprProcessor.java
AJP13 misses to forward the remotePort.

Apache automatically sets the env variable
REMOTE_PORT to the remote port.

Allow the user to set "JkEnvVar REMOTE_PORT" and
let us accept the port in the forwarded attribute
as the remote port.


git-svn-id: https://svn.apache.org/repos/asf/tomcat/trunk@756926 13f79535-47bb-0310-9956-ffa450edef68



==================================================
AjpProcessor.java
index 14bcd9fcfb..560b457118 100644
--- a/java/org/apache/coyote/ajp/AjpAprProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpAprProcessor.java
@@ -716,6 +716,18 @@ public class AjpAprProcessor implements ActionHook {
                 requestHeaderMessage.getBytes(tmpMB);
                 String v = tmpMB.toString();
                 request.setAttribute(n, v);
+                /*
+                 * AJP13 misses to forward the remotePort.
+                 * Apache automatically sets REMOTE_PORT to the remote port.
+                 * Allow the user to set "JkEnvVar REMOTE_PORT" and
+                 * let us accept the forwarded port as the remote port.
+                 */
+                if(n.equals("REMOTE_PORT")) {
+                    try {
+                        request.setRemotePort(Integer.parseInt(v));
+                    } catch (NumberFormatException nfe) {
+                    }
+                }
                 break;
 
             case Constants.SC_A_CONTEXT :

==================================================
HandlerRequest.java
index ba2b8810ff..f4e20b35f9 100644
--- a/java/org/apache/coyote/ajp/AjpProcessor.java
+++ b/java/org/apache/coyote/ajp/AjpProcessor.java
@@ -722,6 +722,18 @@ public class AjpProcessor implements ActionHook {
                 requestHeaderMessage.getBytes(tmpMB);
                 String v = tmpMB.toString();
                 request.setAttribute(n, v);
+                /*
+                 * AJP13 misses to forward the remotePort.
+                 * Apache automatically sets REMOTE_PORT to the remote port.
+                 * Allow the user to set "JkEnvVar REMOTE_PORT" and
+                 * let us accept the forwarded port as the remote port.
+                 */
+                if(n.equals("REMOTE_PORT")) {
+                    try {
+                        request.setRemotePort(Integer.parseInt(v));
+                    } catch (NumberFormatException nfe) {
+                    }
+                }
                 break;
 
             case Constants.SC_A_CONTEXT :

==================================================
